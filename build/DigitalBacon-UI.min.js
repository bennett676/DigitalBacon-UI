/*
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at https://mozilla.org/MPL/2.0/.
 */
var e,r;e=void 0,r=function(e,r,s,l,u,h){function _interopDefaultLegacy(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var p=_interopDefaultLegacy(l),v=_interopDefaultLegacy(u);const m=s.defineWorkerModule({name:"Typr Font Parser",dependencies:[
/*!
  Custom build of Typr.ts (https://github.com/fredli74/Typr.ts) for use in Troika text rendering.
  Original MIT license applies: https://github.com/fredli74/Typr.ts/blob/master/LICENSE
  */
function(){return"undefined"==typeof window&&(self.window=self),function(e){var r={parse:function(e){var s=r._bin,l=new Uint8Array(e);if("ttcf"==s.readASCII(l,0,4)){var u=4;s.readUshort(l,u),u+=2,s.readUshort(l,u),u+=2;var h=s.readUint(l,u);u+=4;for(var p=[],v=0;v<h;v++){var m=s.readUint(l,u);u+=4,p.push(r._readFont(l,m))}return p}return[r._readFont(l,0)]},_readFont:function(e,s){var l=r._bin,u=s;l.readFixed(e,s),s+=4;var h=l.readUshort(e,s);s+=2,l.readUshort(e,s),s+=2,l.readUshort(e,s),s+=2,l.readUshort(e,s),s+=2;for(var p=["cmap","head","hhea","maxp","hmtx","name","OS/2","post","loca","glyf","kern","CFF ","GDEF","GPOS","GSUB","SVG "],v={_data:e,_offset:u},m={},S=0;S<h;S++){var x=l.readASCII(e,s,4);s+=4,l.readUint(e,s),s+=4;var b=l.readUint(e,s);s+=4;var F=l.readUint(e,s);s+=4,m[x]={offset:b,length:F}}for(S=0;S<p.length;S++){var C=p[S];m[C]&&(v[C.trim()]=r[C.trim()].parse(e,m[C].offset,m[C].length,v))}return v},_tabOffset:function(e,s,l){for(var u=r._bin,h=u.readUshort(e,l+4),p=l+12,v=0;v<h;v++){var m=u.readASCII(e,p,4);p+=4,u.readUint(e,p),p+=4;var S=u.readUint(e,p);if(p+=4,u.readUint(e,p),p+=4,m==s)return S}return 0}};r._bin={readFixed:function(e,r){return(e[r]<<8|e[r+1])+(e[r+2]<<8|e[r+3])/65540},readF2dot14:function(e,s){return r._bin.readShort(e,s)/16384},readInt:function(e,s){return r._bin._view(e).getInt32(s)},readInt8:function(e,s){return r._bin._view(e).getInt8(s)},readShort:function(e,s){return r._bin._view(e).getInt16(s)},readUshort:function(e,s){return r._bin._view(e).getUint16(s)},readUshorts:function(e,s,l){for(var u=[],h=0;h<l;h++)u.push(r._bin.readUshort(e,s+2*h));return u},readUint:function(e,s){return r._bin._view(e).getUint32(s)},readUint64:function(e,s){return 4294967296*r._bin.readUint(e,s)+r._bin.readUint(e,s+4)},readASCII:function(e,r,s){for(var l="",u=0;u<s;u++)l+=String.fromCharCode(e[r+u]);return l},readUnicode:function(e,r,s){for(var l="",u=0;u<s;u++){var h=e[r++]<<8|e[r++];l+=String.fromCharCode(h)}return l},_tdec:"undefined"!=typeof window&&window.TextDecoder?new window.TextDecoder:null,readUTF8:function(e,s,l){var u=r._bin._tdec;return u&&0==s&&l==e.length?u.decode(e):r._bin.readASCII(e,s,l)},readBytes:function(e,r,s){for(var l=[],u=0;u<s;u++)l.push(e[r+u]);return l},readASCIIArray:function(e,r,s){for(var l=[],u=0;u<s;u++)l.push(String.fromCharCode(e[r+u]));return l},_view:function(e){return e._dataView||(e._dataView=e.buffer?new DataView(e.buffer,e.byteOffset,e.byteLength):new DataView(new Uint8Array(e).buffer))}},r._lctf={},r._lctf.parse=function(e,s,l,u,h){var p=r._bin,v={},m=s;p.readFixed(e,s),s+=4;var S=p.readUshort(e,s);s+=2;var x=p.readUshort(e,s);s+=2;var b=p.readUshort(e,s);return s+=2,v.scriptList=r._lctf.readScriptList(e,m+S),v.featureList=r._lctf.readFeatureList(e,m+x),v.lookupList=r._lctf.readLookupList(e,m+b,h),v},r._lctf.readLookupList=function(e,s,l){var u=r._bin,h=s,p=[],v=u.readUshort(e,s);s+=2;for(var m=0;m<v;m++){var S=u.readUshort(e,s);s+=2;var x=r._lctf.readLookupTable(e,h+S,l);p.push(x)}return p},r._lctf.readLookupTable=function(e,s,l){var u=r._bin,h=s,p={tabs:[]};p.ltype=u.readUshort(e,s),s+=2,p.flag=u.readUshort(e,s),s+=2;var v=u.readUshort(e,s);s+=2;for(var m=p.ltype,S=0;S<v;S++){var x=u.readUshort(e,s);s+=2;var b=l(e,m,h+x,p);p.tabs.push(b)}return p},r._lctf.numOfOnes=function(e){for(var r=0,s=0;s<32;s++)0!=(e>>>s&1)&&r++;return r},r._lctf.readClassDef=function(e,s){var l=r._bin,u=[],h=l.readUshort(e,s);if(s+=2,1==h){var p=l.readUshort(e,s);s+=2;var v=l.readUshort(e,s);s+=2;for(var m=0;m<v;m++)u.push(p+m),u.push(p+m),u.push(l.readUshort(e,s)),s+=2}if(2==h){var S=l.readUshort(e,s);for(s+=2,m=0;m<S;m++)u.push(l.readUshort(e,s)),s+=2,u.push(l.readUshort(e,s)),s+=2,u.push(l.readUshort(e,s)),s+=2}return u},r._lctf.getInterval=function(e,r){for(var s=0;s<e.length;s+=3){var l=e[s],u=e[s+1];if(e[s+2],l<=r&&r<=u)return s}return-1},r._lctf.readCoverage=function(e,s){var l=r._bin,u={};u.fmt=l.readUshort(e,s),s+=2;var h=l.readUshort(e,s);return s+=2,1==u.fmt&&(u.tab=l.readUshorts(e,s,h)),2==u.fmt&&(u.tab=l.readUshorts(e,s,3*h)),u},r._lctf.coverageIndex=function(e,s){var l=e.tab;if(1==e.fmt)return l.indexOf(s);if(2==e.fmt){var u=r._lctf.getInterval(l,s);if(-1!=u)return l[u+2]+(s-l[u])}return-1},r._lctf.readFeatureList=function(e,s){var l=r._bin,u=s,h=[],p=l.readUshort(e,s);s+=2;for(var v=0;v<p;v++){var m=l.readASCII(e,s,4);s+=4;var S=l.readUshort(e,s);s+=2;var x=r._lctf.readFeatureTable(e,u+S);x.tag=m.trim(),h.push(x)}return h},r._lctf.readFeatureTable=function(e,s){var l=r._bin,u=s,h={},p=l.readUshort(e,s);s+=2,p>0&&(h.featureParams=u+p);var v=l.readUshort(e,s);s+=2,h.tab=[];for(var m=0;m<v;m++)h.tab.push(l.readUshort(e,s+2*m));return h},r._lctf.readScriptList=function(e,s){var l=r._bin,u=s,h={},p=l.readUshort(e,s);s+=2;for(var v=0;v<p;v++){var m=l.readASCII(e,s,4);s+=4;var S=l.readUshort(e,s);s+=2,h[m.trim()]=r._lctf.readScriptTable(e,u+S)}return h},r._lctf.readScriptTable=function(e,s){var l=r._bin,u=s,h={},p=l.readUshort(e,s);s+=2,p>0&&(h.default=r._lctf.readLangSysTable(e,u+p));var v=l.readUshort(e,s);s+=2;for(var m=0;m<v;m++){var S=l.readASCII(e,s,4);s+=4;var x=l.readUshort(e,s);s+=2,h[S.trim()]=r._lctf.readLangSysTable(e,u+x)}return h},r._lctf.readLangSysTable=function(e,s){var l=r._bin,u={};l.readUshort(e,s),s+=2,u.reqFeature=l.readUshort(e,s),s+=2;var h=l.readUshort(e,s);return s+=2,u.features=l.readUshorts(e,s,h),u},r.CFF={},r.CFF.parse=function(e,s,l){var u=r._bin;(e=new Uint8Array(e.buffer,s,l))[s=0],e[++s],e[++s],e[++s],s++;var h=[];s=r.CFF.readIndex(e,s,h);for(var p=[],v=0;v<h.length-1;v++)p.push(u.readASCII(e,s+h[v],h[v+1]-h[v]));s+=h[h.length-1];var m=[];s=r.CFF.readIndex(e,s,m);var S=[];for(v=0;v<m.length-1;v++)S.push(r.CFF.readDict(e,s+m[v],s+m[v+1]));s+=m[m.length-1];var x=S[0],b=[];s=r.CFF.readIndex(e,s,b);var F=[];for(v=0;v<b.length-1;v++)F.push(u.readASCII(e,s+b[v],b[v+1]-b[v]));if(s+=b[b.length-1],r.CFF.readSubrs(e,s,x),x.CharStrings){s=x.CharStrings,b=[],s=r.CFF.readIndex(e,s,b);var C=[];for(v=0;v<b.length-1;v++)C.push(u.readBytes(e,s+b[v],b[v+1]-b[v]));x.CharStrings=C}if(x.ROS){s=x.FDArray;var _=[];for(s=r.CFF.readIndex(e,s,_),x.FDArray=[],v=0;v<_.length-1;v++){var D=r.CFF.readDict(e,s+_[v],s+_[v+1]);r.CFF._readFDict(e,D,F),x.FDArray.push(D)}s+=_[_.length-1],s=x.FDSelect,x.FDSelect=[];var G=e[s];if(s++,3!=G)throw G;var A=u.readUshort(e,s);for(s+=2,v=0;v<A+1;v++)x.FDSelect.push(u.readUshort(e,s),e[s+2]),s+=3}return x.Encoding&&(x.Encoding=r.CFF.readEncoding(e,x.Encoding,x.CharStrings.length)),x.charset&&(x.charset=r.CFF.readCharset(e,x.charset,x.CharStrings.length)),r.CFF._readFDict(e,x,F),x},r.CFF._readFDict=function(e,s,l){var u;for(var h in s.Private&&(u=s.Private[1],s.Private=r.CFF.readDict(e,u,u+s.Private[0]),s.Private.Subrs&&r.CFF.readSubrs(e,u+s.Private.Subrs,s.Private)),s)-1!=["FamilyName","FontName","FullName","Notice","version","Copyright"].indexOf(h)&&(s[h]=l[s[h]-426+35])},r.CFF.readSubrs=function(e,s,l){var u=r._bin,h=[];s=r.CFF.readIndex(e,s,h);var p,v=h.length;p=v<1240?107:v<33900?1131:32768,l.Bias=p,l.Subrs=[];for(var m=0;m<h.length-1;m++)l.Subrs.push(u.readBytes(e,s+h[m],h[m+1]-h[m]))},r.CFF.tableSE=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,0,111,112,113,114,0,115,116,117,118,119,120,121,122,0,123,0,124,125,126,127,128,129,130,131,0,132,133,0,134,135,136,137,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,138,0,139,0,0,0,0,140,141,142,143,0,0,0,0,0,144,0,0,0,145,0,0,146,147,148,149,0,0,0,0],r.CFF.glyphByUnicode=function(e,r){for(var s=0;s<e.charset.length;s++)if(e.charset[s]==r)return s;return-1},r.CFF.glyphBySE=function(e,s){return s<0||s>255?-1:r.CFF.glyphByUnicode(e,r.CFF.tableSE[s])},r.CFF.readEncoding=function(e,s,l){r._bin;var u=[".notdef"],h=e[s];if(s++,0!=h)throw"error: unknown encoding format: "+h;var p=e[s];s++;for(var v=0;v<p;v++)u.push(e[s+v]);return u},r.CFF.readCharset=function(e,s,l){var u=r._bin,h=[".notdef"],p=e[s];if(s++,0==p)for(var v=0;v<l;v++){var m=u.readUshort(e,s);s+=2,h.push(m)}else{if(1!=p&&2!=p)throw"error: format: "+p;for(;h.length<l;){m=u.readUshort(e,s),s+=2;var S=0;for(1==p?(S=e[s],s++):(S=u.readUshort(e,s),s+=2),v=0;v<=S;v++)h.push(m),m++}}return h},r.CFF.readIndex=function(e,s,l){var u=r._bin,h=u.readUshort(e,s)+1,p=e[s+=2];if(s++,1==p)for(var v=0;v<h;v++)l.push(e[s+v]);else if(2==p)for(v=0;v<h;v++)l.push(u.readUshort(e,s+2*v));else if(3==p)for(v=0;v<h;v++)l.push(16777215&u.readUint(e,s+3*v-1));else if(1!=h)throw"unsupported offset size: "+p+", count: "+h;return(s+=h*p)-1},r.CFF.getCharString=function(e,s,l){var u=r._bin,h=e[s],p=e[s+1];e[s+2],e[s+3],e[s+4];var v=1,m=null,S=null;h<=20&&(m=h,v=1),12==h&&(m=100*h+p,v=2),21<=h&&h<=27&&(m=h,v=1),28==h&&(S=u.readShort(e,s+1),v=3),29<=h&&h<=31&&(m=h,v=1),32<=h&&h<=246&&(S=h-139,v=1),247<=h&&h<=250&&(S=256*(h-247)+p+108,v=2),251<=h&&h<=254&&(S=256*-(h-251)-p-108,v=2),255==h&&(S=u.readInt(e,s+1)/65535,v=5),l.val=null!=S?S:"o"+m,l.size=v},r.CFF.readCharString=function(e,s,l){for(var u=s+l,h=r._bin,p=[];s<u;){var v=e[s],m=e[s+1];e[s+2],e[s+3],e[s+4];var S=1,x=null,b=null;v<=20&&(x=v,S=1),12==v&&(x=100*v+m,S=2),19!=v&&20!=v||(x=v,S=2),21<=v&&v<=27&&(x=v,S=1),28==v&&(b=h.readShort(e,s+1),S=3),29<=v&&v<=31&&(x=v,S=1),32<=v&&v<=246&&(b=v-139,S=1),247<=v&&v<=250&&(b=256*(v-247)+m+108,S=2),251<=v&&v<=254&&(b=256*-(v-251)-m-108,S=2),255==v&&(b=h.readInt(e,s+1)/65535,S=5),p.push(null!=b?b:"o"+x),s+=S}return p},r.CFF.readDict=function(e,s,l){for(var u=r._bin,h={},p=[];s<l;){var v=e[s],m=e[s+1];e[s+2],e[s+3],e[s+4];var S=1,x=null,b=null;if(28==v&&(b=u.readShort(e,s+1),S=3),29==v&&(b=u.readInt(e,s+1),S=5),32<=v&&v<=246&&(b=v-139,S=1),247<=v&&v<=250&&(b=256*(v-247)+m+108,S=2),251<=v&&v<=254&&(b=256*-(v-251)-m-108,S=2),255==v)throw b=u.readInt(e,s+1)/65535,S=5,"unknown number";if(30==v){var F=[];for(S=1;;){var C=e[s+S];S++;var _=C>>4,D=15&C;if(15!=_&&F.push(_),15!=D&&F.push(D),15==D)break}for(var G="",A=[0,1,2,3,4,5,6,7,8,9,".","e","e-","reserved","-","endOfNumber"],I=0;I<F.length;I++)G+=A[F[I]];b=parseFloat(G)}v<=21&&(x=["version","Notice","FullName","FamilyName","Weight","FontBBox","BlueValues","OtherBlues","FamilyBlues","FamilyOtherBlues","StdHW","StdVW","escape","UniqueID","XUID","charset","Encoding","CharStrings","Private","Subrs","defaultWidthX","nominalWidthX"][v],S=1,12==v&&(x=["Copyright","isFixedPitch","ItalicAngle","UnderlinePosition","UnderlineThickness","PaintType","CharstringType","FontMatrix","StrokeWidth","BlueScale","BlueShift","BlueFuzz","StemSnapH","StemSnapV","ForceBold",0,0,"LanguageGroup","ExpansionFactor","initialRandomSeed","SyntheticBase","PostScript","BaseFontName","BaseFontBlend",0,0,0,0,0,0,"ROS","CIDFontVersion","CIDFontRevision","CIDFontType","CIDCount","UIDBase","FDArray","FDSelect","FontName"][m],S=2)),null!=x?(h[x]=1==p.length?p[0]:p,p=[]):p.push(b),s+=S}return h},r.cmap={},r.cmap.parse=function(e,s,l){e=new Uint8Array(e.buffer,s,l),s=0;var u=r._bin,h={};u.readUshort(e,s),s+=2;var p=u.readUshort(e,s);s+=2;var v=[];h.tables=[];for(var m=0;m<p;m++){var S=u.readUshort(e,s);s+=2;var x=u.readUshort(e,s);s+=2;var b=u.readUint(e,s);s+=4;var F="p"+S+"e"+x,C=v.indexOf(b);if(-1==C){var _;C=h.tables.length,v.push(b);var D=u.readUshort(e,b);0==D?_=r.cmap.parse0(e,b):4==D?_=r.cmap.parse4(e,b):6==D?_=r.cmap.parse6(e,b):12==D?_=r.cmap.parse12(e,b):console.debug("unknown format: "+D,S,x,b),h.tables.push(_)}if(null!=h[F])throw"multiple tables for one platform+encoding";h[F]=C}return h},r.cmap.parse0=function(e,s){var l=r._bin,u={};u.format=l.readUshort(e,s),s+=2;var h=l.readUshort(e,s);s+=2,l.readUshort(e,s),s+=2,u.map=[];for(var p=0;p<h-6;p++)u.map.push(e[s+p]);return u},r.cmap.parse4=function(e,s){var l=r._bin,u=s,h={};h.format=l.readUshort(e,s),s+=2;var p=l.readUshort(e,s);s+=2,l.readUshort(e,s),s+=2;var v=l.readUshort(e,s);s+=2;var m=v/2;h.searchRange=l.readUshort(e,s),s+=2,h.entrySelector=l.readUshort(e,s),s+=2,h.rangeShift=l.readUshort(e,s),s+=2,h.endCount=l.readUshorts(e,s,m),s+=2*m,s+=2,h.startCount=l.readUshorts(e,s,m),s+=2*m,h.idDelta=[];for(var S=0;S<m;S++)h.idDelta.push(l.readShort(e,s)),s+=2;for(h.idRangeOffset=l.readUshorts(e,s,m),s+=2*m,h.glyphIdArray=[];s<u+p;)h.glyphIdArray.push(l.readUshort(e,s)),s+=2;return h},r.cmap.parse6=function(e,s){var l=r._bin,u={};u.format=l.readUshort(e,s),s+=2,l.readUshort(e,s),s+=2,l.readUshort(e,s),s+=2,u.firstCode=l.readUshort(e,s),s+=2;var h=l.readUshort(e,s);s+=2,u.glyphIdArray=[];for(var p=0;p<h;p++)u.glyphIdArray.push(l.readUshort(e,s)),s+=2;return u},r.cmap.parse12=function(e,s){var l=r._bin,u={};u.format=l.readUshort(e,s),s+=2,s+=2,l.readUint(e,s),s+=4,l.readUint(e,s),s+=4;var h=l.readUint(e,s);s+=4,u.groups=[];for(var p=0;p<h;p++){var v=s+12*p,m=l.readUint(e,v+0),S=l.readUint(e,v+4),x=l.readUint(e,v+8);u.groups.push([m,S,x])}return u},r.glyf={},r.glyf.parse=function(e,r,s,l){for(var u=[],h=0;h<l.maxp.numGlyphs;h++)u.push(null);return u},r.glyf._parseGlyf=function(e,s){var l=r._bin,u=e._data,h=r._tabOffset(u,"glyf",e._offset)+e.loca[s];if(e.loca[s]==e.loca[s+1])return null;var p={};if(p.noc=l.readShort(u,h),h+=2,p.xMin=l.readShort(u,h),h+=2,p.yMin=l.readShort(u,h),h+=2,p.xMax=l.readShort(u,h),h+=2,p.yMax=l.readShort(u,h),h+=2,p.xMin>=p.xMax||p.yMin>=p.yMax)return null;if(p.noc>0){p.endPts=[];for(var v=0;v<p.noc;v++)p.endPts.push(l.readUshort(u,h)),h+=2;var m=l.readUshort(u,h);if(h+=2,u.length-h<m)return null;p.instructions=l.readBytes(u,h,m),h+=m;var S=p.endPts[p.noc-1]+1;for(p.flags=[],v=0;v<S;v++){var x=u[h];if(h++,p.flags.push(x),0!=(8&x)){var b=u[h];h++;for(var F=0;F<b;F++)p.flags.push(x),v++}}for(p.xs=[],v=0;v<S;v++){var C=0!=(2&p.flags[v]),_=0!=(16&p.flags[v]);C?(p.xs.push(_?u[h]:-u[h]),h++):_?p.xs.push(0):(p.xs.push(l.readShort(u,h)),h+=2)}for(p.ys=[],v=0;v<S;v++)C=0!=(4&p.flags[v]),_=0!=(32&p.flags[v]),C?(p.ys.push(_?u[h]:-u[h]),h++):_?p.ys.push(0):(p.ys.push(l.readShort(u,h)),h+=2);var D=0,G=0;for(v=0;v<S;v++)D+=p.xs[v],G+=p.ys[v],p.xs[v]=D,p.ys[v]=G}else{var A;p.parts=[];do{A=l.readUshort(u,h),h+=2;var I={m:{a:1,b:0,c:0,d:1,tx:0,ty:0},p1:-1,p2:-1};if(p.parts.push(I),I.glyphIndex=l.readUshort(u,h),h+=2,1&A){var B=l.readShort(u,h);h+=2;var R=l.readShort(u,h);h+=2}else B=l.readInt8(u,h),h++,R=l.readInt8(u,h),h++;2&A?(I.m.tx=B,I.m.ty=R):(I.p1=B,I.p2=R),8&A?(I.m.a=I.m.d=l.readF2dot14(u,h),h+=2):64&A?(I.m.a=l.readF2dot14(u,h),h+=2,I.m.d=l.readF2dot14(u,h),h+=2):128&A&&(I.m.a=l.readF2dot14(u,h),h+=2,I.m.b=l.readF2dot14(u,h),h+=2,I.m.c=l.readF2dot14(u,h),h+=2,I.m.d=l.readF2dot14(u,h),h+=2)}while(32&A);if(256&A){var E=l.readUshort(u,h);for(h+=2,p.instr=[],v=0;v<E;v++)p.instr.push(u[h]),h++}}return p},r.GDEF={},r.GDEF.parse=function(e,s,l,u){var h=s;s+=4;var p=r._bin.readUshort(e,s);return{glyphClassDef:0===p?null:r._lctf.readClassDef(e,h+p)}},r.GPOS={},r.GPOS.parse=function(e,s,l,u){return r._lctf.parse(e,s,l,u,r.GPOS.subt)},r.GPOS.subt=function(e,s,l,u){var h=r._bin,p=l,v={};if(v.fmt=h.readUshort(e,l),l+=2,1==s||2==s||3==s||7==s||8==s&&v.fmt<=2){var m=h.readUshort(e,l);l+=2,v.coverage=r._lctf.readCoverage(e,m+p)}if(1==s&&1==v.fmt){var S=h.readUshort(e,l);l+=2,0!=S&&(v.pos=r.GPOS.readValueRecord(e,l,S))}else if(2==s&&v.fmt>=1&&v.fmt<=2){S=h.readUshort(e,l),l+=2;var x=h.readUshort(e,l);l+=2;var b=r._lctf.numOfOnes(S),F=r._lctf.numOfOnes(x);if(1==v.fmt){v.pairsets=[];var C=h.readUshort(e,l);l+=2;for(var _=0;_<C;_++){var D=p+h.readUshort(e,l);l+=2;var G=h.readUshort(e,D);D+=2;for(var A=[],I=0;I<G;I++){var B=h.readUshort(e,D);D+=2,0!=S&&(j=r.GPOS.readValueRecord(e,D,S),D+=2*b),0!=x&&(H=r.GPOS.readValueRecord(e,D,x),D+=2*F),A.push({gid2:B,val1:j,val2:H})}v.pairsets.push(A)}}if(2==v.fmt){var R=h.readUshort(e,l);l+=2;var E=h.readUshort(e,l);l+=2;var W=h.readUshort(e,l);l+=2;var z=h.readUshort(e,l);for(l+=2,v.classDef1=r._lctf.readClassDef(e,p+R),v.classDef2=r._lctf.readClassDef(e,p+E),v.matrix=[],_=0;_<W;_++){var V=[];for(I=0;I<z;I++){var j=null,H=null;0!=S&&(j=r.GPOS.readValueRecord(e,l,S),l+=2*b),0!=x&&(H=r.GPOS.readValueRecord(e,l,x),l+=2*F),V.push({val1:j,val2:H})}v.matrix.push(V)}}}else if(4==s&&1==v.fmt)v.markCoverage=r._lctf.readCoverage(e,h.readUshort(e,l)+p),v.baseCoverage=r._lctf.readCoverage(e,h.readUshort(e,l+2)+p),v.markClassCount=h.readUshort(e,l+4),v.markArray=r.GPOS.readMarkArray(e,h.readUshort(e,l+6)+p),v.baseArray=r.GPOS.readBaseArray(e,h.readUshort(e,l+8)+p,v.markClassCount);else if(6==s&&1==v.fmt)v.mark1Coverage=r._lctf.readCoverage(e,h.readUshort(e,l)+p),v.mark2Coverage=r._lctf.readCoverage(e,h.readUshort(e,l+2)+p),v.markClassCount=h.readUshort(e,l+4),v.mark1Array=r.GPOS.readMarkArray(e,h.readUshort(e,l+6)+p),v.mark2Array=r.GPOS.readBaseArray(e,h.readUshort(e,l+8)+p,v.markClassCount);else{if(9==s&&1==v.fmt){var N=h.readUshort(e,l);l+=2;var q=h.readUint(e,l);if(l+=4,9==u.ltype)u.ltype=N;else if(u.ltype!=N)throw"invalid extension substitution";return r.GPOS.subt(e,u.ltype,p+q)}console.debug("unsupported GPOS table LookupType",s,"format",v.fmt)}return v},r.GPOS.readValueRecord=function(e,s,l){var u=r._bin,h=[];return h.push(1&l?u.readShort(e,s):0),s+=1&l?2:0,h.push(2&l?u.readShort(e,s):0),s+=2&l?2:0,h.push(4&l?u.readShort(e,s):0),s+=4&l?2:0,h.push(8&l?u.readShort(e,s):0),s+=8&l?2:0,h},r.GPOS.readBaseArray=function(e,s,l){var u=r._bin,h=[],p=s,v=u.readUshort(e,s);s+=2;for(var m=0;m<v;m++){for(var S=[],x=0;x<l;x++)S.push(r.GPOS.readAnchorRecord(e,p+u.readUshort(e,s))),s+=2;h.push(S)}return h},r.GPOS.readMarkArray=function(e,s){var l=r._bin,u=[],h=s,p=l.readUshort(e,s);s+=2;for(var v=0;v<p;v++){var m=r.GPOS.readAnchorRecord(e,l.readUshort(e,s+2)+h);m.markClass=l.readUshort(e,s),u.push(m),s+=4}return u},r.GPOS.readAnchorRecord=function(e,s){var l=r._bin,u={};return u.fmt=l.readUshort(e,s),u.x=l.readShort(e,s+2),u.y=l.readShort(e,s+4),u},r.GSUB={},r.GSUB.parse=function(e,s,l,u){return r._lctf.parse(e,s,l,u,r.GSUB.subt)},r.GSUB.subt=function(e,s,l,u){var h=r._bin,p=l,v={};if(v.fmt=h.readUshort(e,l),l+=2,1!=s&&2!=s&&4!=s&&5!=s&&6!=s)return null;if(1==s||2==s||4==s||5==s&&v.fmt<=2||6==s&&v.fmt<=2){var m=h.readUshort(e,l);l+=2,v.coverage=r._lctf.readCoverage(e,p+m)}if(1==s&&v.fmt>=1&&v.fmt<=2){if(1==v.fmt)v.delta=h.readShort(e,l),l+=2;else if(2==v.fmt){var S=h.readUshort(e,l);l+=2,v.newg=h.readUshorts(e,l,S),l+=2*v.newg.length}}else if(2==s&&1==v.fmt){S=h.readUshort(e,l),l+=2,v.seqs=[];for(var x=0;x<S;x++){var b=h.readUshort(e,l)+p;l+=2;var F=h.readUshort(e,b);v.seqs.push(h.readUshorts(e,b+2,F))}}else if(4==s)for(v.vals=[],S=h.readUshort(e,l),l+=2,x=0;x<S;x++){var C=h.readUshort(e,l);l+=2,v.vals.push(r.GSUB.readLigatureSet(e,p+C))}else if(5==s&&2==v.fmt){if(2==v.fmt){var _=h.readUshort(e,l);l+=2,v.cDef=r._lctf.readClassDef(e,p+_),v.scset=[];var D=h.readUshort(e,l);for(l+=2,x=0;x<D;x++){var G=h.readUshort(e,l);l+=2,v.scset.push(0==G?null:r.GSUB.readSubClassSet(e,p+G))}}}else if(6==s&&3==v.fmt){if(3==v.fmt){for(x=0;x<3;x++){S=h.readUshort(e,l),l+=2;for(var A=[],I=0;I<S;I++)A.push(r._lctf.readCoverage(e,p+h.readUshort(e,l+2*I)));l+=2*S,0==x&&(v.backCvg=A),1==x&&(v.inptCvg=A),2==x&&(v.ahedCvg=A)}S=h.readUshort(e,l),l+=2,v.lookupRec=r.GSUB.readSubstLookupRecords(e,l,S)}}else{if(7==s&&1==v.fmt){var B=h.readUshort(e,l);l+=2;var R=h.readUint(e,l);if(l+=4,9==u.ltype)u.ltype=B;else if(u.ltype!=B)throw"invalid extension substitution";return r.GSUB.subt(e,u.ltype,p+R)}console.debug("unsupported GSUB table LookupType",s,"format",v.fmt)}return v},r.GSUB.readSubClassSet=function(e,s){var l=r._bin.readUshort,u=s,h=[],p=l(e,s);s+=2;for(var v=0;v<p;v++){var m=l(e,s);s+=2,h.push(r.GSUB.readSubClassRule(e,u+m))}return h},r.GSUB.readSubClassRule=function(e,s){var l=r._bin.readUshort,u={},h=l(e,s),p=l(e,s+=2);s+=2,u.input=[];for(var v=0;v<h-1;v++)u.input.push(l(e,s)),s+=2;return u.substLookupRecords=r.GSUB.readSubstLookupRecords(e,s,p),u},r.GSUB.readSubstLookupRecords=function(e,s,l){for(var u=r._bin.readUshort,h=[],p=0;p<l;p++)h.push(u(e,s),u(e,s+2)),s+=4;return h},r.GSUB.readChainSubClassSet=function(e,s){var l=r._bin,u=s,h=[],p=l.readUshort(e,s);s+=2;for(var v=0;v<p;v++){var m=l.readUshort(e,s);s+=2,h.push(r.GSUB.readChainSubClassRule(e,u+m))}return h},r.GSUB.readChainSubClassRule=function(e,s){for(var l=r._bin,u={},h=["backtrack","input","lookahead"],p=0;p<h.length;p++){var v=l.readUshort(e,s);s+=2,1==p&&v--,u[h[p]]=l.readUshorts(e,s,v),s+=2*u[h[p]].length}return v=l.readUshort(e,s),s+=2,u.subst=l.readUshorts(e,s,2*v),s+=2*u.subst.length,u},r.GSUB.readLigatureSet=function(e,s){var l=r._bin,u=s,h=[],p=l.readUshort(e,s);s+=2;for(var v=0;v<p;v++){var m=l.readUshort(e,s);s+=2,h.push(r.GSUB.readLigature(e,u+m))}return h},r.GSUB.readLigature=function(e,s){var l=r._bin,u={chain:[]};u.nglyph=l.readUshort(e,s),s+=2;var h=l.readUshort(e,s);s+=2;for(var p=0;p<h-1;p++)u.chain.push(l.readUshort(e,s)),s+=2;return u},r.head={},r.head.parse=function(e,s,l){var u=r._bin,h={};return u.readFixed(e,s),s+=4,h.fontRevision=u.readFixed(e,s),s+=4,u.readUint(e,s),s+=4,u.readUint(e,s),s+=4,h.flags=u.readUshort(e,s),s+=2,h.unitsPerEm=u.readUshort(e,s),s+=2,h.created=u.readUint64(e,s),s+=8,h.modified=u.readUint64(e,s),s+=8,h.xMin=u.readShort(e,s),s+=2,h.yMin=u.readShort(e,s),s+=2,h.xMax=u.readShort(e,s),s+=2,h.yMax=u.readShort(e,s),s+=2,h.macStyle=u.readUshort(e,s),s+=2,h.lowestRecPPEM=u.readUshort(e,s),s+=2,h.fontDirectionHint=u.readShort(e,s),s+=2,h.indexToLocFormat=u.readShort(e,s),s+=2,h.glyphDataFormat=u.readShort(e,s),s+=2,h},r.hhea={},r.hhea.parse=function(e,s,l){var u=r._bin,h={};return u.readFixed(e,s),s+=4,h.ascender=u.readShort(e,s),s+=2,h.descender=u.readShort(e,s),s+=2,h.lineGap=u.readShort(e,s),s+=2,h.advanceWidthMax=u.readUshort(e,s),s+=2,h.minLeftSideBearing=u.readShort(e,s),s+=2,h.minRightSideBearing=u.readShort(e,s),s+=2,h.xMaxExtent=u.readShort(e,s),s+=2,h.caretSlopeRise=u.readShort(e,s),s+=2,h.caretSlopeRun=u.readShort(e,s),s+=2,h.caretOffset=u.readShort(e,s),s+=2,s+=8,h.metricDataFormat=u.readShort(e,s),s+=2,h.numberOfHMetrics=u.readUshort(e,s),s+=2,h},r.hmtx={},r.hmtx.parse=function(e,s,l,u){for(var h=r._bin,p={aWidth:[],lsBearing:[]},v=0,m=0,S=0;S<u.maxp.numGlyphs;S++)S<u.hhea.numberOfHMetrics&&(v=h.readUshort(e,s),s+=2,m=h.readShort(e,s),s+=2),p.aWidth.push(v),p.lsBearing.push(m);return p},r.kern={},r.kern.parse=function(e,s,l,u){var h=r._bin,p=h.readUshort(e,s);if(s+=2,1==p)return r.kern.parseV1(e,s-2,l,u);var v=h.readUshort(e,s);s+=2;for(var m={glyph1:[],rval:[]},S=0;S<v;S++){s+=2,l=h.readUshort(e,s),s+=2;var x=h.readUshort(e,s);s+=2;var b=x>>>8;if(0!=(b&=15))throw"unknown kern table format: "+b;s=r.kern.readFormat0(e,s,m)}return m},r.kern.parseV1=function(e,s,l,u){var h=r._bin;h.readFixed(e,s),s+=4;var p=h.readUint(e,s);s+=4;for(var v={glyph1:[],rval:[]},m=0;m<p;m++){h.readUint(e,s),s+=4;var S=h.readUshort(e,s);s+=2,h.readUshort(e,s),s+=2;var x=S>>>8;if(0!=(x&=15))throw"unknown kern table format: "+x;s=r.kern.readFormat0(e,s,v)}return v},r.kern.readFormat0=function(e,s,l){var u=r._bin,h=-1,p=u.readUshort(e,s);s+=2,u.readUshort(e,s),s+=2,u.readUshort(e,s),s+=2,u.readUshort(e,s),s+=2;for(var v=0;v<p;v++){var m=u.readUshort(e,s);s+=2;var S=u.readUshort(e,s);s+=2;var x=u.readShort(e,s);s+=2,m!=h&&(l.glyph1.push(m),l.rval.push({glyph2:[],vals:[]}));var b=l.rval[l.rval.length-1];b.glyph2.push(S),b.vals.push(x),h=m}return s},r.loca={},r.loca.parse=function(e,s,l,u){var h=r._bin,p=[],v=u.head.indexToLocFormat,m=u.maxp.numGlyphs+1;if(0==v)for(var S=0;S<m;S++)p.push(h.readUshort(e,s+(S<<1))<<1);if(1==v)for(S=0;S<m;S++)p.push(h.readUint(e,s+(S<<2)));return p},r.maxp={},r.maxp.parse=function(e,s,l){var u=r._bin,h={},p=u.readUint(e,s);return s+=4,h.numGlyphs=u.readUshort(e,s),s+=2,65536==p&&(h.maxPoints=u.readUshort(e,s),s+=2,h.maxContours=u.readUshort(e,s),s+=2,h.maxCompositePoints=u.readUshort(e,s),s+=2,h.maxCompositeContours=u.readUshort(e,s),s+=2,h.maxZones=u.readUshort(e,s),s+=2,h.maxTwilightPoints=u.readUshort(e,s),s+=2,h.maxStorage=u.readUshort(e,s),s+=2,h.maxFunctionDefs=u.readUshort(e,s),s+=2,h.maxInstructionDefs=u.readUshort(e,s),s+=2,h.maxStackElements=u.readUshort(e,s),s+=2,h.maxSizeOfInstructions=u.readUshort(e,s),s+=2,h.maxComponentElements=u.readUshort(e,s),s+=2,h.maxComponentDepth=u.readUshort(e,s),s+=2),h},r.name={},r.name.parse=function(e,s,l){var u=r._bin,h={};u.readUshort(e,s),s+=2;var p=u.readUshort(e,s);s+=2,u.readUshort(e,s);for(var v,m=["copyright","fontFamily","fontSubfamily","ID","fullName","version","postScriptName","trademark","manufacturer","designer","description","urlVendor","urlDesigner","licence","licenceURL","---","typoFamilyName","typoSubfamilyName","compatibleFull","sampleText","postScriptCID","wwsFamilyName","wwsSubfamilyName","lightPalette","darkPalette"],S=s+=2,x=0;x<p;x++){var b=u.readUshort(e,s);s+=2;var F=u.readUshort(e,s);s+=2;var C=u.readUshort(e,s);s+=2;var _=u.readUshort(e,s);s+=2;var D=u.readUshort(e,s);s+=2;var G=u.readUshort(e,s);s+=2;var A,I=m[_],B=S+12*p+G;if(0==b)A=u.readUnicode(e,B,D/2);else if(3==b&&0==F)A=u.readUnicode(e,B,D/2);else if(0==F)A=u.readASCII(e,B,D);else if(1==F)A=u.readUnicode(e,B,D/2);else if(3==F)A=u.readUnicode(e,B,D/2);else{if(1!=b)throw"unknown encoding "+F+", platformID: "+b;A=u.readASCII(e,B,D),console.debug("reading unknown MAC encoding "+F+" as ASCII")}var R="p"+b+","+C.toString(16);null==h[R]&&(h[R]={}),h[R][void 0!==I?I:_]=A,h[R]._lang=C}for(var E in h)if(null!=h[E].postScriptName&&1033==h[E]._lang)return h[E];for(var E in h)if(null!=h[E].postScriptName&&0==h[E]._lang)return h[E];for(var E in h)if(null!=h[E].postScriptName&&3084==h[E]._lang)return h[E];for(var E in h)if(null!=h[E].postScriptName)return h[E];for(var E in h){v=E;break}return console.debug("returning name table with languageID "+h[v]._lang),h[v]},r["OS/2"]={},r["OS/2"].parse=function(e,s,l){var u=r._bin.readUshort(e,s);s+=2;var h={};if(0==u)r["OS/2"].version0(e,s,h);else if(1==u)r["OS/2"].version1(e,s,h);else if(2==u||3==u||4==u)r["OS/2"].version2(e,s,h);else{if(5!=u)throw"unknown OS/2 table version: "+u;r["OS/2"].version5(e,s,h)}return h},r["OS/2"].version0=function(e,s,l){var u=r._bin;return l.xAvgCharWidth=u.readShort(e,s),s+=2,l.usWeightClass=u.readUshort(e,s),s+=2,l.usWidthClass=u.readUshort(e,s),s+=2,l.fsType=u.readUshort(e,s),s+=2,l.ySubscriptXSize=u.readShort(e,s),s+=2,l.ySubscriptYSize=u.readShort(e,s),s+=2,l.ySubscriptXOffset=u.readShort(e,s),s+=2,l.ySubscriptYOffset=u.readShort(e,s),s+=2,l.ySuperscriptXSize=u.readShort(e,s),s+=2,l.ySuperscriptYSize=u.readShort(e,s),s+=2,l.ySuperscriptXOffset=u.readShort(e,s),s+=2,l.ySuperscriptYOffset=u.readShort(e,s),s+=2,l.yStrikeoutSize=u.readShort(e,s),s+=2,l.yStrikeoutPosition=u.readShort(e,s),s+=2,l.sFamilyClass=u.readShort(e,s),s+=2,l.panose=u.readBytes(e,s,10),s+=10,l.ulUnicodeRange1=u.readUint(e,s),s+=4,l.ulUnicodeRange2=u.readUint(e,s),s+=4,l.ulUnicodeRange3=u.readUint(e,s),s+=4,l.ulUnicodeRange4=u.readUint(e,s),s+=4,l.achVendID=[u.readInt8(e,s),u.readInt8(e,s+1),u.readInt8(e,s+2),u.readInt8(e,s+3)],s+=4,l.fsSelection=u.readUshort(e,s),s+=2,l.usFirstCharIndex=u.readUshort(e,s),s+=2,l.usLastCharIndex=u.readUshort(e,s),s+=2,l.sTypoAscender=u.readShort(e,s),s+=2,l.sTypoDescender=u.readShort(e,s),s+=2,l.sTypoLineGap=u.readShort(e,s),s+=2,l.usWinAscent=u.readUshort(e,s),s+=2,l.usWinDescent=u.readUshort(e,s),s+2},r["OS/2"].version1=function(e,s,l){var u=r._bin;return s=r["OS/2"].version0(e,s,l),l.ulCodePageRange1=u.readUint(e,s),s+=4,l.ulCodePageRange2=u.readUint(e,s),s+4},r["OS/2"].version2=function(e,s,l){var u=r._bin;return s=r["OS/2"].version1(e,s,l),l.sxHeight=u.readShort(e,s),s+=2,l.sCapHeight=u.readShort(e,s),s+=2,l.usDefault=u.readUshort(e,s),s+=2,l.usBreak=u.readUshort(e,s),s+=2,l.usMaxContext=u.readUshort(e,s),s+2},r["OS/2"].version5=function(e,s,l){var u=r._bin;return s=r["OS/2"].version2(e,s,l),l.usLowerOpticalPointSize=u.readUshort(e,s),s+=2,l.usUpperOpticalPointSize=u.readUshort(e,s),s+2},r.post={},r.post.parse=function(e,s,l){var u=r._bin,h={};return h.version=u.readFixed(e,s),s+=4,h.italicAngle=u.readFixed(e,s),s+=4,h.underlinePosition=u.readShort(e,s),s+=2,h.underlineThickness=u.readShort(e,s),s+=2,h},null==r&&(r={}),null==r.U&&(r.U={}),r.U.codeToGlyph=function(e,r){var s=e.cmap,l=-1;if(null!=s.p0e4?l=s.p0e4:null!=s.p3e1?l=s.p3e1:null!=s.p1e0?l=s.p1e0:null!=s.p0e3&&(l=s.p0e3),-1==l)throw"no familiar platform and encoding!";var u=s.tables[l];if(0==u.format)return r>=u.map.length?0:u.map[r];if(4==u.format){for(var h=-1,p=0;p<u.endCount.length;p++)if(r<=u.endCount[p]){h=p;break}return-1==h||u.startCount[h]>r?0:65535&(0!=u.idRangeOffset[h]?u.glyphIdArray[r-u.startCount[h]+(u.idRangeOffset[h]>>1)-(u.idRangeOffset.length-h)]:r+u.idDelta[h])}if(12==u.format){if(r>u.groups[u.groups.length-1][1])return 0;for(p=0;p<u.groups.length;p++){var v=u.groups[p];if(v[0]<=r&&r<=v[1])return v[2]+(r-v[0])}return 0}throw"unknown cmap table format "+u.format},r.U.glyphToPath=function(e,s){var l={cmds:[],crds:[]};if(e.SVG&&e.SVG.entries[s]){var u=e.SVG.entries[s];return null==u?l:("string"==typeof u&&(u=r.SVG.toPath(u),e.SVG.entries[s]=u),u)}if(e.CFF){var h={x:0,y:0,stack:[],nStems:0,haveWidth:!1,width:e.CFF.Private?e.CFF.Private.defaultWidthX:0,open:!1},p=e.CFF,v=e.CFF.Private;if(p.ROS){for(var m=0;p.FDSelect[m+2]<=s;)m+=2;v=p.FDArray[p.FDSelect[m+1]].Private}r.U._drawCFF(e.CFF.CharStrings[s],h,p,v,l)}else e.glyf&&r.U._drawGlyf(s,e,l);return l},r.U._drawGlyf=function(e,s,l){var u=s.glyf[e];null==u&&(u=s.glyf[e]=r.glyf._parseGlyf(s,e)),null!=u&&(u.noc>-1?r.U._simpleGlyph(u,l):r.U._compoGlyph(u,s,l))},r.U._simpleGlyph=function(e,s){for(var l=0;l<e.noc;l++){for(var u=0==l?0:e.endPts[l-1]+1,h=e.endPts[l],p=u;p<=h;p++){var v=p==u?h:p-1,m=p==h?u:p+1,S=1&e.flags[p],x=1&e.flags[v],b=1&e.flags[m],F=e.xs[p],C=e.ys[p];if(p==u)if(S){if(!x){r.U.P.moveTo(s,F,C);continue}r.U.P.moveTo(s,e.xs[v],e.ys[v])}else x?r.U.P.moveTo(s,e.xs[v],e.ys[v]):r.U.P.moveTo(s,(e.xs[v]+F)/2,(e.ys[v]+C)/2);S?x&&r.U.P.lineTo(s,F,C):b?r.U.P.qcurveTo(s,F,C,e.xs[m],e.ys[m]):r.U.P.qcurveTo(s,F,C,(F+e.xs[m])/2,(C+e.ys[m])/2)}r.U.P.closePath(s)}},r.U._compoGlyph=function(e,s,l){for(var u=0;u<e.parts.length;u++){var h={cmds:[],crds:[]},p=e.parts[u];r.U._drawGlyf(p.glyphIndex,s,h);for(var v=p.m,m=0;m<h.crds.length;m+=2){var S=h.crds[m],x=h.crds[m+1];l.crds.push(S*v.a+x*v.b+v.tx),l.crds.push(S*v.c+x*v.d+v.ty)}for(m=0;m<h.cmds.length;m++)l.cmds.push(h.cmds[m])}},r.U._getGlyphClass=function(e,s){var l=r._lctf.getInterval(s,e);return-1==l?0:s[l+2]},r.U._applySubs=function(e,s,l,u){for(var h=e.length-s-1,p=0;p<l.tabs.length;p++)if(null!=l.tabs[p]){var v,m=l.tabs[p];if(!m.coverage||-1!=(v=r._lctf.coverageIndex(m.coverage,e[s])))if(1==l.ltype)e[s],1==m.fmt?e[s]=e[s]+m.delta:e[s]=m.newg[v];else if(4==l.ltype)for(var S=m.vals[v],x=0;x<S.length;x++){var b=S[x],F=b.chain.length;if(!(F>h)){for(var C=!0,_=0,D=0;D<F;D++){for(;-1==e[s+_+(1+D)];)_++;b.chain[D]!=e[s+_+(1+D)]&&(C=!1)}if(C){for(e[s]=b.nglyph,D=0;D<F+_;D++)e[s+D+1]=-1;break}}}else if(5==l.ltype&&2==m.fmt)for(var G=r._lctf.getInterval(m.cDef,e[s]),A=m.cDef[G+2],I=m.scset[A],B=0;B<I.length;B++){var R=I[B],E=R.input;if(!(E.length>h)){for(C=!0,D=0;D<E.length;D++){var W=r._lctf.getInterval(m.cDef,e[s+1+D]);if(-1==G&&m.cDef[W+2]!=E[D]){C=!1;break}}if(C){var z=R.substLookupRecords;for(x=0;x<z.length;x+=2)z[x],z[x+1]}}}else if(6==l.ltype&&3==m.fmt){if(!r.U._glsCovered(e,m.backCvg,s-m.backCvg.length))continue;if(!r.U._glsCovered(e,m.inptCvg,s))continue;if(!r.U._glsCovered(e,m.ahedCvg,s+m.inptCvg.length))continue;var V=m.lookupRec;for(B=0;B<V.length;B+=2){G=V[B];var j=u[V[B+1]];r.U._applySubs(e,s+G,j,u)}}}},r.U._glsCovered=function(e,s,l){for(var u=0;u<s.length;u++)if(-1==r._lctf.coverageIndex(s[u],e[l+u]))return!1;return!0},r.U.glyphsToPath=function(e,s,l){for(var u={cmds:[],crds:[]},h=0,p=0;p<s.length;p++){var v=s[p];if(-1!=v){for(var m=p<s.length-1&&-1!=s[p+1]?s[p+1]:0,S=r.U.glyphToPath(e,v),x=0;x<S.crds.length;x+=2)u.crds.push(S.crds[x]+h),u.crds.push(S.crds[x+1]);for(l&&u.cmds.push(l),x=0;x<S.cmds.length;x++)u.cmds.push(S.cmds[x]);l&&u.cmds.push("X"),h+=e.hmtx.aWidth[v],p<s.length-1&&(h+=r.U.getPairAdjustment(e,v,m))}}return u},r.U.P={},r.U.P.moveTo=function(e,r,s){e.cmds.push("M"),e.crds.push(r,s)},r.U.P.lineTo=function(e,r,s){e.cmds.push("L"),e.crds.push(r,s)},r.U.P.curveTo=function(e,r,s,l,u,h,p){e.cmds.push("C"),e.crds.push(r,s,l,u,h,p)},r.U.P.qcurveTo=function(e,r,s,l,u){e.cmds.push("Q"),e.crds.push(r,s,l,u)},r.U.P.closePath=function(e){e.cmds.push("Z")},r.U._drawCFF=function(e,s,l,u,h){for(var p=s.stack,v=s.nStems,m=s.haveWidth,S=s.width,x=s.open,b=0,F=s.x,C=s.y,_=0,D=0,G=0,A=0,I=0,B=0,R=0,E=0,W=0,z=0,V={val:0,size:0};b<e.length;){r.CFF.getCharString(e,b,V);var j=V.val;if(b+=V.size,"o1"==j||"o18"==j)p.length%2!=0&&!m&&(S=p.shift()+u.nominalWidthX),v+=p.length>>1,p.length=0,m=!0;else if("o3"==j||"o23"==j)p.length%2!=0&&!m&&(S=p.shift()+u.nominalWidthX),v+=p.length>>1,p.length=0,m=!0;else if("o4"==j)p.length>1&&!m&&(S=p.shift()+u.nominalWidthX,m=!0),x&&r.U.P.closePath(h),C+=p.pop(),r.U.P.moveTo(h,F,C),x=!0;else if("o5"==j)for(;p.length>0;)F+=p.shift(),C+=p.shift(),r.U.P.lineTo(h,F,C);else if("o6"==j||"o7"==j)for(var H=p.length,N="o6"==j,q=0;q<H;q++){var X=p.shift();N?F+=X:C+=X,N=!N,r.U.P.lineTo(h,F,C)}else if("o8"==j||"o24"==j){H=p.length;for(var $=0;$+6<=H;)_=F+p.shift(),D=C+p.shift(),G=_+p.shift(),A=D+p.shift(),F=G+p.shift(),C=A+p.shift(),r.U.P.curveTo(h,_,D,G,A,F,C),$+=6;"o24"==j&&(F+=p.shift(),C+=p.shift(),r.U.P.lineTo(h,F,C))}else{if("o11"==j)break;if("o1234"==j||"o1235"==j||"o1236"==j||"o1237"==j)"o1234"==j&&(D=C,G=(_=F+p.shift())+p.shift(),z=A=D+p.shift(),B=A,E=C,F=(R=(I=(W=G+p.shift())+p.shift())+p.shift())+p.shift(),r.U.P.curveTo(h,_,D,G,A,W,z),r.U.P.curveTo(h,I,B,R,E,F,C)),"o1235"==j&&(_=F+p.shift(),D=C+p.shift(),G=_+p.shift(),A=D+p.shift(),W=G+p.shift(),z=A+p.shift(),I=W+p.shift(),B=z+p.shift(),R=I+p.shift(),E=B+p.shift(),F=R+p.shift(),C=E+p.shift(),p.shift(),r.U.P.curveTo(h,_,D,G,A,W,z),r.U.P.curveTo(h,I,B,R,E,F,C)),"o1236"==j&&(_=F+p.shift(),D=C+p.shift(),G=_+p.shift(),z=A=D+p.shift(),B=A,R=(I=(W=G+p.shift())+p.shift())+p.shift(),E=B+p.shift(),F=R+p.shift(),r.U.P.curveTo(h,_,D,G,A,W,z),r.U.P.curveTo(h,I,B,R,E,F,C)),"o1237"==j&&(_=F+p.shift(),D=C+p.shift(),G=_+p.shift(),A=D+p.shift(),W=G+p.shift(),z=A+p.shift(),I=W+p.shift(),B=z+p.shift(),R=I+p.shift(),E=B+p.shift(),Math.abs(R-F)>Math.abs(E-C)?F=R+p.shift():C=E+p.shift(),r.U.P.curveTo(h,_,D,G,A,W,z),r.U.P.curveTo(h,I,B,R,E,F,C));else if("o14"==j){if(p.length>0&&!m&&(S=p.shift()+l.nominalWidthX,m=!0),4==p.length){var Y=p.shift(),J=p.shift(),Z=p.shift(),Q=p.shift(),K=r.CFF.glyphBySE(l,Z),ee=r.CFF.glyphBySE(l,Q);r.U._drawCFF(l.CharStrings[K],s,l,u,h),s.x=Y,s.y=J,r.U._drawCFF(l.CharStrings[ee],s,l,u,h)}x&&(r.U.P.closePath(h),x=!1)}else if("o19"==j||"o20"==j)p.length%2!=0&&!m&&(S=p.shift()+u.nominalWidthX),v+=p.length>>1,p.length=0,m=!0,b+=v+7>>3;else if("o21"==j)p.length>2&&!m&&(S=p.shift()+u.nominalWidthX,m=!0),C+=p.pop(),F+=p.pop(),x&&r.U.P.closePath(h),r.U.P.moveTo(h,F,C),x=!0;else if("o22"==j)p.length>1&&!m&&(S=p.shift()+u.nominalWidthX,m=!0),F+=p.pop(),x&&r.U.P.closePath(h),r.U.P.moveTo(h,F,C),x=!0;else if("o25"==j){for(;p.length>6;)F+=p.shift(),C+=p.shift(),r.U.P.lineTo(h,F,C);_=F+p.shift(),D=C+p.shift(),G=_+p.shift(),A=D+p.shift(),F=G+p.shift(),C=A+p.shift(),r.U.P.curveTo(h,_,D,G,A,F,C)}else if("o26"==j)for(p.length%2&&(F+=p.shift());p.length>0;)_=F,D=C+p.shift(),F=G=_+p.shift(),C=(A=D+p.shift())+p.shift(),r.U.P.curveTo(h,_,D,G,A,F,C);else if("o27"==j)for(p.length%2&&(C+=p.shift());p.length>0;)D=C,G=(_=F+p.shift())+p.shift(),A=D+p.shift(),F=G+p.shift(),C=A,r.U.P.curveTo(h,_,D,G,A,F,C);else if("o10"==j||"o29"==j){var te="o10"==j?u:l;if(0==p.length)console.debug("error: empty stack");else{var re=p.pop(),ne=te.Subrs[re+te.Bias];s.x=F,s.y=C,s.nStems=v,s.haveWidth=m,s.width=S,s.open=x,r.U._drawCFF(ne,s,l,u,h),F=s.x,C=s.y,v=s.nStems,m=s.haveWidth,S=s.width,x=s.open}}else if("o30"==j||"o31"==j){var ae=p.length,oe=($=0,"o31"==j);for($+=ae-(H=-3&ae);$<H;)oe?(D=C,G=(_=F+p.shift())+p.shift(),C=(A=D+p.shift())+p.shift(),H-$==5?(F=G+p.shift(),$++):F=G,oe=!1):(_=F,D=C+p.shift(),G=_+p.shift(),A=D+p.shift(),F=G+p.shift(),H-$==5?(C=A+p.shift(),$++):C=A,oe=!0),r.U.P.curveTo(h,_,D,G,A,F,C),$+=4}else{if("o"==(j+"").charAt(0))throw console.debug("Unknown operation: "+j,e),j;p.push(j)}}}s.x=F,s.y=C,s.nStems=v,s.haveWidth=m,s.width=S,s.open=x};var s=r,l={Typr:s};return e.Typr=s,e.default=l,Object.defineProperty(e,"__esModule",{value:!0}),e}({}).Typr}
/*!
  Custom bundle of woff2otf (https://github.com/arty-name/woff2otf) with fflate
  (https://github.com/101arrowz/fflate) for use in Troika text rendering. 
  Original licenses apply: 
  - fflate: https://github.com/101arrowz/fflate/blob/master/LICENSE (MIT)
  - woff2otf.js: https://github.com/arty-name/woff2otf/blob/master/woff2otf.js (Apache2)
  */,function(){return function(e){var r=Uint8Array,s=Uint16Array,l=Uint32Array,u=new r([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),h=new r([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),p=new r([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),f=function(e,r){for(var u=new s(31),h=0;h<31;++h)u[h]=r+=1<<e[h-1];var p=new l(u[30]);for(h=1;h<30;++h)for(var v=u[h];v<u[h+1];++v)p[v]=v-u[h]<<5|h;return[u,p]},v=f(u,2),m=v[0],S=v[1];m[28]=258,S[258]=28;for(var x=f(h,0)[0],b=new s(32768),F=0;F<32768;++F){var C=(43690&F)>>>1|(21845&F)<<1;C=(61680&(C=(52428&C)>>>2|(13107&C)<<2))>>>4|(3855&C)<<4,b[F]=((65280&C)>>>8|(255&C)<<8)>>>1}var w=function(e,r,l){for(var u=e.length,h=0,p=new s(r);h<u;++h)++p[e[h]-1];var v,m=new s(r);for(h=0;h<r;++h)m[h]=m[h-1]+p[h-1]<<1;if(l){v=new s(1<<r);var S=15-r;for(h=0;h<u;++h)if(e[h])for(var x=h<<4|e[h],F=r-e[h],C=m[e[h]-1]++<<F,_=C|(1<<F)-1;C<=_;++C)v[b[C]>>>S]=x}else for(v=new s(u),h=0;h<u;++h)e[h]&&(v[h]=b[m[e[h]-1]++]>>>15-e[h]);return v},_=new r(288);for(F=0;F<144;++F)_[F]=8;for(F=144;F<256;++F)_[F]=9;for(F=256;F<280;++F)_[F]=7;for(F=280;F<288;++F)_[F]=8;var D=new r(32);for(F=0;F<32;++F)D[F]=5;var G=w(_,9,1),A=w(D,5,1),y=function(e){for(var r=e[0],s=1;s<e.length;++s)e[s]>r&&(r=e[s]);return r},L=function(e,r,s){var l=r/8|0;return(e[l]|e[l+1]<<8)>>(7&r)&s},U=function(e,r){var s=r/8|0;return(e[s]|e[s+1]<<8|e[s+2]<<16)>>(7&r)},I=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],T=function(e,r,s){var l=new Error(r||I[e]);if(l.code=e,Error.captureStackTrace&&Error.captureStackTrace(l,T),!s)throw l;return l},O=function(e,v,S){var b=e.length;if(!b||S&&!S.l&&b<5)return v||new r(0);var F=!v||S,C=!S||S.i;S||(S={}),v||(v=new r(3*b));var _,d=function(e){var s=v.length;if(e>s){var l=new r(Math.max(2*s,e));l.set(v),v=l}},D=S.f||0,I=S.p||0,B=S.b||0,R=S.l,E=S.d,W=S.m,z=S.n,V=8*b;do{if(!R){S.f=D=L(e,I,1);var j=L(e,I+1,3);if(I+=3,!j){var H=e[(te=((_=I)/8|0)+(7&_&&1)+4)-4]|e[te-3]<<8,N=te+H;if(N>b){C&&T(0);break}F&&d(B+H),v.set(e.subarray(te,N),B),S.b=B+=H,S.p=I=8*N;continue}if(1==j)R=G,E=A,W=9,z=5;else if(2==j){var q=L(e,I,31)+257,X=L(e,I+10,15)+4,$=q+L(e,I+5,31)+1;I+=14;for(var Y=new r($),J=new r(19),Z=0;Z<X;++Z)J[p[Z]]=L(e,I+3*Z,7);I+=3*X;var Q=y(J),K=(1<<Q)-1,ee=w(J,Q,1);for(Z=0;Z<$;){var te,re=ee[L(e,I,K)];if(I+=15&re,(te=re>>>4)<16)Y[Z++]=te;else{var ne=0,ae=0;for(16==te?(ae=3+L(e,I,3),I+=2,ne=Y[Z-1]):17==te?(ae=3+L(e,I,7),I+=3):18==te&&(ae=11+L(e,I,127),I+=7);ae--;)Y[Z++]=ne}}var oe=Y.subarray(0,q),ie=Y.subarray(q);W=y(oe),z=y(ie),R=w(oe,W,1),E=w(ie,z,1)}else T(1);if(I>V){C&&T(0);break}}F&&d(B+131072);for(var se=(1<<W)-1,le=(1<<z)-1,ue=I;;ue=I){var fe=(ne=R[U(e,I)&se])>>>4;if((I+=15&ne)>V){C&&T(0);break}if(ne||T(2),fe<256)v[B++]=fe;else{if(256==fe){ue=I,R=null;break}var he=fe-254;if(fe>264){var de=u[Z=fe-257];he=L(e,I,(1<<de)-1)+m[Z],I+=de}var ce=E[U(e,I)&le],pe=ce>>>4;if(ce||T(3),I+=15&ce,ie=x[pe],pe>3&&(de=h[pe],ie+=U(e,I)&(1<<de)-1,I+=de),I>V){C&&T(0);break}F&&d(B+131072);for(var ge=B+he;B<ge;B+=4)v[B]=v[B-ie],v[B+1]=v[B+1-ie],v[B+2]=v[B+2-ie],v[B+3]=v[B+3-ie];B=ge}}S.l=R,S.p=ue,S.b=B,R&&(D=1,S.m=W,S.d=E,S.n=z)}while(!D);return B==v.length?v:function(e,u,h){(null==u||u<0)&&(u=0),(null==h||h>e.length)&&(h=e.length);var p=new(e instanceof s?s:e instanceof l?l:r)(h-u);return p.set(e.subarray(u,h)),p}(v,0,B)},B=new r(0),R="undefined"!=typeof TextDecoder&&new TextDecoder;try{R.decode(B,{stream:!0})}catch(e){}return e.convert_streams=function(e){var r=new DataView(e),s=0;function t(){var e=r.getUint16(s);return s+=2,e}function a(){var e=r.getUint32(s);return s+=4,e}function i(e){C.setUint16(_,e),_+=2}function o(e){C.setUint32(_,e),_+=4}for(var l={signature:a(),flavor:a(),length:a(),numTables:t(),reserved:t(),totalSfntSize:a(),majorVersion:t(),minorVersion:t(),metaOffset:a(),metaLength:a(),metaOrigLength:a(),privOffset:a(),privLength:a()},u=0;Math.pow(2,u)<=l.numTables;)u++;u--;for(var h=16*Math.pow(2,u),p=16*l.numTables-h,v=12,m=[],S=0;S<l.numTables;S++)m.push({tag:a(),offset:a(),compLength:a(),origLength:a(),origChecksum:a()}),v+=16;var x,b=new Uint8Array(12+16*m.length+m.reduce((function(e,r){return e+r.origLength+4}),0)),F=b.buffer,C=new DataView(F),_=0;return o(l.flavor),i(l.numTables),i(h),i(u),i(p),m.forEach((function(e){o(e.tag),o(e.origChecksum),o(v),o(e.origLength),e.outOffset=v,(v+=e.origLength)%4!=0&&(v+=4-v%4)})),m.forEach((function(r){var s,l=e.slice(r.offset,r.offset+r.compLength);if(r.compLength!=r.origLength){var u=new Uint8Array(r.origLength);s=new Uint8Array(l,2),O(s,u)}else u=new Uint8Array(l);b.set(u,r.outOffset);var h=0;(v=r.outOffset+r.origLength)%4!=0&&(h=4-v%4),b.set(new Uint8Array(h).buffer,r.outOffset+r.origLength),x=v+h})),F.slice(0,x)},Object.defineProperty(e,"__esModule",{value:!0}),e}({}).convert_streams},function(e,r){const s={M:2,L:2,Q:4,C:6,Z:0},l={C:"18g,ca,368,1kz",D:"17k,6,2,2+4,5+c,2+6,2+1,10+1,9+f,j+11,2+1,a,2,2+1,15+2,3,j+2,6+3,2+8,2,2,2+1,w+a,4+e,3+3,2,3+2,3+5,23+w,2f+4,3,2+9,2,b,2+3,3,1k+9,6+1,3+1,2+2,2+d,30g,p+y,1,1+1g,f+x,2,sd2+1d,jf3+4,f+3,2+4,2+2,b+3,42,2,4+2,2+1,2,3,t+1,9f+w,2,el+2,2+g,d+2,2l,2+1,5,3+1,2+1,2,3,6,16wm+1v",R:"17m+3,2,2,6+3,m,15+2,2+2,h+h,13,3+8,2,2,3+1,2,p+1,x,5+4,5,a,2,2,3,u,c+2,g+1,5,2+1,4+1,5j,6+1,2,b,2+2,f,2+1,1s+2,2,3+1,7,1ez0,2,2+1,4+4,b,4,3,b,42,2+2,4,3,2+1,2,o+3,ae,ep,x,2o+2,3+1,3,5+1,6",L:"x9u,jff,a,fd,jv",T:"4t,gj+33,7o+4,1+1,7c+18,2,2+1,2+1,2,21+a,2,1b+k,h,2u+6,3+5,3+1,2+3,y,2,v+q,2k+a,1n+8,a,p+3,2+8,2+2,2+4,18+2,3c+e,2+v,1k,2,5+7,5,4+6,b+1,u,1n,5+3,9,l+1,r,3+1,1m,5+1,5+1,3+2,4,v+1,4,c+1,1m,5+4,2+1,5,l+1,n+5,2,1n,3,2+3,9,8+1,c+1,v,1q,d,1f,4,1m+2,6+2,2+3,8+1,c+1,u,1n,3,7,6+1,l+1,t+1,1m+1,5+3,9,l+1,u,21,8+2,2,2j,3+6,d+7,2r,3+8,c+5,23+1,s,2,2,1k+d,2+4,2+1,6+a,2+z,a,2v+3,2+5,2+1,3+1,q+1,5+2,h+3,e,3+1,7,g,jk+2,qb+2,u+2,u+1,v+1,1t+1,2+6,9,3+a,a,1a+2,3c+1,z,3b+2,5+1,a,7+2,64+1,3,1n,2+6,2,2,3+7,7+9,3,1d+d,1,1+1,1s+3,1d,2+4,2,6,15+8,d+1,x+3,3+1,2+2,1l,2+1,4,2+2,1n+7,3+1,49+2,2+c,2+6,5,7,4+1,5j+1l,2+4,ek,3+1,r+4,1e+4,6+5,2p+c,1+3,1,1+2,1+b,2db+2,3y,2p+v,ff+3,30+1,n9x,1+2,2+9,x+1,29+1,7l,4,5,q+1,6,48+1,r+h,e,13+7,q+a,1b+2,1d,3+3,3+1,14,1w+5,3+1,3+1,d,9,1c,1g,2+2,3+1,6+1,2,17+1,9,6n,3,5,fn5,ki+f,h+f,5s,6y+2,ea,6b,46+4,1af+2,2+1,6+3,15+2,5,4m+1,fy+3,as+1,4a+a,4x,1j+e,1l+2,1e+3,3+1,1y+2,11+4,2+7,1r,d+1,1h+8,b+3,3,2o+2,3,2+1,7,4h,4+7,m+1,1m+1,4,12+6,4+4,5g+7,3+2,2,o,2d+5,2,5+1,2+1,6n+3,7+1,2+1,s+1,2e+7,3,2+1,2z,2,3+5,2,2u+2,3+3,2+4,78+8,2+1,75+1,2,5,41+3,3+1,5,x+9,15+5,3+3,9,a+5,3+2,1b+c,2+1,bb+6,2+5,2,2b+l,3+6,2+1,2+1,3f+5,4,2+1,2+6,2,21+1,4,2,9o+1,470+8,at4+4,1o+6,t5,1s+3,2a,f5l+1,2+3,43o+2,a+7,1+7,3+6,v+3,45+2,1j0+1i,5+1d,9,f,n+4,2+e,11t+6,2+g,3+6,2+1,2+4,7a+6,c6+3,15t+6,32+6,1,gzau,v+2n,3l+6n"},u=1,h=2,p=4,v=8,m=16,S=32;let x;function getCharJoiningType(e){if(!x){const e={R:h,L:u,D:p,C:m,U:S,T:v};x=new Map;for(let r in l){let s=0;l[r].split(",").forEach((l=>{let[u,h]=l.split("+");u=parseInt(u,36),h=h?parseInt(h,36):0,x.set(s+=u,e[r]);for(let l=h;l--;)x.set(++s,e[r])}))}}return x.get(e)||S}const b=1,F=2,C=3,_=4,D=[null,"isol","init","fina","medi"];function detectJoiningForms(e){const r=new Uint8Array(e.length);let s=S,l=b,x=-1;for(let D=0;D<e.length;D++){const G=e.codePointAt(D);let A=0|getCharJoiningType(G),I=b;A&v||(s&(u|p|m)?A&(h|p|m)?(I=C,l!==b&&l!==C||r[x]++):A&(u|S)&&(l!==F&&l!==_||r[x]--):s&(h|S)&&(l!==F&&l!==_||r[x]--),l=r[D]=I,s=A,x=D,G>65535&&D++)}return r}function getGlyphClass(r,s){const l=r.GDEF&&r.GDEF.glyphClassDef;return l?e.U._getGlyphClass(s,l):0}function firstNum(...e){for(let r=0;r<e.length;r++)if("number"==typeof e[r])return e[r]}function wrapFontObj(r){const l=Object.create(null),u=r["OS/2"],h=r.hhea,p=r.head.unitsPerEm,v=firstNum(u&&u.sTypoAscender,h&&h.ascender,p),m={unitsPerEm:p,ascender:v,descender:firstNum(u&&u.sTypoDescender,h&&h.descender,0),capHeight:firstNum(u&&u.sCapHeight,v),xHeight:firstNum(u&&u.sxHeight,v),lineGap:firstNum(u&&u.sTypoLineGap,h&&h.lineGap),supportsCodePoint:s=>e.U.codeToGlyph(r,s)>0,forEachGlyph(u,h,p,v){let S=0;const x=1/m.unitsPerEm*h,b=function(r,s){const l=[];for(let u=0;u<s.length;u++){const h=s.codePointAt(u);h>65535&&u++,l.push(e.U.codeToGlyph(r,h))}const u=r.GSUB;if(u){const{lookupList:r,featureList:h}=u;let p;const v=/^(rlig|liga|mset|isol|init|fina|medi|half|pres|blws|ccmp)$/,m=[];h.forEach((u=>{if(v.test(u.tag))for(let h=0;h<u.tab.length;h++){if(m[u.tab[h]])continue;m[u.tab[h]]=!0;const v=r[u.tab[h]],S=/^(isol|init|fina|medi)$/.test(u.tag);S&&!p&&(p=detectJoiningForms(s));for(let s=0;s<l.length;s++)p&&S&&D[p[s]]!==u.tag||e.U._applySubs(l,s,v,r)}}))}return l}(r,u);let F=0;const C=function(r,s){const l=new Int16Array(3*s.length);let u=0;for(;u<s.length;u++){const h=s[u];if(-1===h)continue;l[3*u+2]=r.hmtx.aWidth[h];const p=r.GPOS;if(p){const v=p.lookupList;for(let p=0;p<v.length;p++){const m=v[p];for(let p=0;p<m.tabs.length;p++){const v=m.tabs[p];if(1===m.ltype){if(-1!==e._lctf.coverageIndex(v.coverage,h)&&v.pos){applyValueRecord(v.pos,u);break}}else if(2===m.ltype){let r=null,l=getPrevGlyphIndex();if(-1!==l){const p=e._lctf.coverageIndex(v.coverage,s[l]);if(-1!==p){if(1===v.fmt){const e=v.pairsets[p];for(let s=0;s<e.length;s++)e[s].gid2===h&&(r=e[s])}else if(2===v.fmt){const u=e.U._getGlyphClass(s[l],v.classDef1),p=e.U._getGlyphClass(h,v.classDef2);r=v.matrix[u][p]}if(r){r.val1&&applyValueRecord(r.val1,l),r.val2&&applyValueRecord(r.val2,u);break}}}}else if(4===m.ltype){const r=e._lctf.coverageIndex(v.markCoverage,h);if(-1!==r){const h=getPrevGlyphIndex(isBaseGlyph),p=-1===h?-1:e._lctf.coverageIndex(v.baseCoverage,s[h]);if(-1!==p){const e=v.markArray[r],s=v.baseArray[p][e.markClass];l[3*u]=s.x-e.x+l[3*h]-l[3*h+2],l[3*u+1]=s.y-e.y+l[3*h+1];break}}}else if(6===m.ltype){const p=e._lctf.coverageIndex(v.mark1Coverage,h);if(-1!==p){const h=getPrevGlyphIndex();if(-1!==h){const m=s[h];if(3===getGlyphClass(r,m)){const r=e._lctf.coverageIndex(v.mark2Coverage,m);if(-1!==r){const e=v.mark1Array[p],s=v.mark2Array[r][e.markClass];l[3*u]=s.x-e.x+l[3*h]-l[3*h+2],l[3*u+1]=s.y-e.y+l[3*h+1];break}}}}}}}}else if(r.kern&&!r.cff){const e=getPrevGlyphIndex();if(-1!==e){const u=r.kern.glyph1.indexOf(s[e]);if(-1!==u){const s=r.kern.rval[u].glyph2.indexOf(h);-1!==s&&(l[3*e+2]+=r.kern.rval[u].vals[s])}}}}return l;function getPrevGlyphIndex(e){for(let r=u-1;r>=0;r--)if(-1!==s[r]&&(!e||e(s[r])))return r;return-1}function isBaseGlyph(e){return 1===getGlyphClass(r,e)}function applyValueRecord(e,r){for(let s=0;s<3;s++)l[3*r+s]+=e[s]||0}}(r,b);return b.forEach(((m,b)=>{if(-1!==m){let u=l[m];if(!u){const{cmds:h,crds:p}=e.U.glyphToPath(r,m);let v,S,x,b,F="",C=0;for(let e=0,r=h.length;e<r;e++){const r=s[h[e]];F+=h[e];for(let e=1;e<=r;e++)F+=(e>1?",":"")+p[C++]}if(p.length){v=S=1/0,x=b=-1/0;for(let e=0,r=p.length;e<r;e+=2){let r=p[e],s=p[e+1];r<v&&(v=r),s<S&&(S=s),r>x&&(x=r),s>b&&(b=s)}}else v=x=S=b=0;u=l[m]={index:m,advanceWidth:r.hmtx.aWidth[m],xMin:v,yMin:S,xMax:x,yMax:b,path:F}}v.call(null,u,S+C[3*b]*x,C[3*b+1]*x,F),S+=C[3*b+2]*x,p&&(S+=p*h)}F+=u.codePointAt(F)>65535?2:1})),S}};return m}return function(s){const l=new Uint8Array(s,0,4),u=e._bin.readASCII(l,0,4);if("wOFF"===u)s=r(s);else if("wOF2"===u)throw new Error("woff2 fonts not supported");return wrapFontObj(e.parse(s)[0])}}],init:(e,r,s)=>s(e(),r())}),S=s.defineWorkerModule({name:"FontResolver",dependencies:[function(e,r){const s=Object.create(null),l=Object.create(null);function loadFont(r,u){let h=s[r];h?u(h):l[r]?l[r].push(u):(l[r]=[u],function(r,s){const onError=e=>{console.error(`Failure loading font ${r}`,e)};try{const l=new XMLHttpRequest;l.open("get",r,!0),l.responseType="arraybuffer",l.onload=function(){if(l.status>=400)onError(new Error(l.statusText));else if(l.status>0)try{const u=e(l.response);u.src=r,s(u)}catch(e){onError(e)}},l.onerror=onError,l.send()}catch(e){onError(e)}}(r,(e=>{e.src=r,s[r]=e,l[r].forEach((r=>r(e))),delete l[r]})))}return function(e,l,{lang:u,fonts:h=[],style:p="normal",weight:v="normal",unicodeFontsURL:m}={}){const S=new Uint8Array(e.length),x=[];e.length||allDone();const b=new Map,F=[];if("italic"!==p&&(p="normal"),"number"!=typeof v&&(v="bold"===v?700:400),h&&!Array.isArray(h)&&(h=[h]),(h=h.slice().filter((e=>!e.lang||e.lang.test(u))).reverse()).length){const r=1,l=2;let u=0;!function resolveUserFonts(p=0){for(let v=p,m=e.length;v<m;v++){const p=e.codePointAt(v);if(u===r&&x[S[v-1]].supportsCodePoint(p)||/\s/.test(e[v]))S[v]=S[v-1],u===l&&(F[F.length-1][1]=v);else for(let e=S[v],m=h.length;e<=m;e++)if(e===m)(u===l?F[F.length-1]:F[F.length]=[v,v])[1]=v,u=l;else{S[v]=e;const{src:l,unicodeRange:m}=h[e];if(!m||isCodeInRanges(p,m)){const e=s[l];if(!e)return void loadFont(l,(()=>{resolveUserFonts(v)}));if(e.supportsCodePoint(p)){let s=b.get(e);"number"!=typeof s&&(s=x.length,x.push(e),b.set(e,s)),S[v]=s,u=r;break}}}p>65535&&v+1<m&&(S[v+1]=S[v],v++,u===l&&(F[F.length-1][1]=v))}resolveFallbacks()}()}else F.push([0,e.length-1]),resolveFallbacks();function resolveFallbacks(){if(F.length){const s=F.map((r=>e.substring(r[0],r[1]+1))).join("\n");r.getFontsForString(s,{lang:u||void 0,style:p,weight:v,dataUrl:m}).then((({fontUrls:e,chars:r})=>{const s=x.length;let l=0;F.forEach((e=>{for(let u=0,h=e[1]-e[0];u<=h;u++)S[e[0]+u]=r[l++]+s;l++}));let u=0;e.forEach(((r,l)=>{loadFont(r,(r=>{x[l+s]=r,++u===e.length&&allDone()}))}))}))}else allDone()}function allDone(){l({chars:S,fonts:x})}function isCodeInRanges(e,r){for(let s=0;s<r.length;s++){const[l,u=l]=r[s];if(l<=e&&e<=u)return!0}return!1}}},m,
/*!
  Custom bundle of @unicode-font-resolver/client v1.0.2 (https://github.com/lojjic/unicode-font-resolver)
  for use in Troika text rendering. 
  Original MIT license applies
  */
function(){return function(e){var n=function(){this.buckets=new Map};n.prototype.add=function(e){var r=e>>5;this.buckets.set(r,(this.buckets.get(r)||0)|1<<(31&e))},n.prototype.has=function(e){var r=this.buckets.get(e>>5);return void 0!==r&&0!=(r&1<<(31&e))},n.prototype.serialize=function(){var e=[];return this.buckets.forEach((function(r,s){e.push((+s).toString(36)+":"+r.toString(36))})),e.join(",")},n.prototype.deserialize=function(e){var r=this;this.buckets.clear(),e.split(",").forEach((function(e){var s=e.split(":");r.buckets.set(parseInt(s[0],36),parseInt(s[1],36))}))};var r=Math.pow(2,8),s=r-1,l=~s;function a(e){var s=function(e){return e&l}(e).toString(16),u=function(e){return(e&l)+r-1}(e).toString(16);return"codepoint-index/plane"+(e>>16)+"/"+s+"-"+u+".json"}function i(e,r){var l=e&s,u=r.codePointAt(l/6|0);return 0!=((u=(u||48)-48)&1<<l%6)}function c(e,r){!function(e,r){var s;(s=e,s.replace(/U\+/gi,"").replace(/^,+|,+$/g,"").split(/,+/).map((function(e){return e.split("-").map((function(e){return parseInt(e.trim(),16)}))}))).forEach((function(e){var s=e[0],l=e[1];void 0===l&&(l=s),r(s,l)}))}(e,(function(e,s){for(var l=e;l<=s;l++)r(l)}))}var u={},h={},p=new WeakMap,v="https://cdn.jsdelivr.net/gh/lojjic/unicode-font-resolver@v1.0.1/packages/data";function d(e){var r=p.get(e);return r||(r=new n,c(e.ranges,(function(e){return r.add(e)})),p.set(e,r)),r}var m,S=new Map;function g(e,r,s){return e[r]?r:e[s]?s:function(e){for(var r in e)return r}(e)}function w(e,r){var s=r;if(!e.includes(s)){s=1/0;for(var l=0;l<e.length;l++)Math.abs(e[l]-r)<Math.abs(s-r)&&(s=e[l])}return s}function k(e){return m||(m=new Set,c("9-D,20,85,A0,1680,2000-200A,2028-202F,205F,3000",(function(e){m.add(e)}))),m.has(e)}return e.CodePointSet=n,e.clearCache=function(){u={},h={}},e.getFontsForString=function(e,r){void 0===r&&(r={});var s,l=r.lang;void 0===l&&(l=/\p{Script=Hangul}/u.test(s=e)?"ko":/\p{Script=Hiragana}|\p{Script=Katakana}/u.test(s)?"ja":"en");var p=r.category;void 0===p&&(p="sans-serif");var m=r.style;void 0===m&&(m="normal");var x=r.weight;void 0===x&&(x=400);var b=(r.dataUrl||v).replace(/\/$/g,""),F=new Map,C=new Uint8Array(e.length),_={},D={},G=new Array(e.length),A=new Map,I=!1;function M(e){var r=S.get(e);return r||(r=fetch(b+"/"+e).then((function(e){if(!e.ok)throw new Error(e.statusText);return e.json().then((function(e){if(!Array.isArray(e)||1!==e[0])throw new Error("Incorrect schema version; need 1, got "+e[0]);return e[1]}))})).catch((function(r){if(b!==v)return I||(console.error('unicode-font-resolver: Failed loading from dataUrl "'+b+'", trying default CDN. '+r.message),I=!0),b=v,S.delete(e),M(e);throw r})),S.set(e,r)),r}for(var P=function(r){var s=e.codePointAt(r),l=a(s);G[r]=l,u[l]||A.has(l)||A.set(l,M(l).then((function(e){u[l]=e}))),s>65535&&(r++,B=r)},B=0;B<e.length;B++)P(B);return Promise.all(A.values()).then((function(){A.clear();for(var n=function(s){var p=e.codePointAt(s),v=null,m=u[G[s]],S=void 0;for(var x in m){var b=D[x];if(void 0===b&&(b=D[x]=new RegExp(x).test(l||"en")),b){for(var F in S=x,m[x])if(i(p,m[x][F])){v=F;break}break}}if(!v)e:for(var C in m)if(C!==S)for(var _ in m[C])if(i(p,m[C][_])){v=_;break e}v||(console.debug("No font coverage for U+"+p.toString(16)),v="latin"),G[s]=v,h[v]||A.has(v)||A.set(v,M("font-meta/"+v+".json").then((function(e){h[v]=e}))),p>65535&&(s++,r=s)},r=0;r<e.length;r++)n(r);return Promise.all(A.values())})).then((function(){for(var r,s=null,l=0;l<e.length;l++){var u=e.codePointAt(l);if(s&&(k(u)||d(s).has(u)))C[l]=C[l-1];else{s=h[G[l]];var v=_[s.id];if(!v){var S=s.typeforms,D=g(S,p,"sans-serif"),A=g(S[D],m,"normal"),I=w(null===(r=S[D])||void 0===r?void 0:r[A],x);v=_[s.id]=b+"/font-files/"+s.id+"/"+D+"."+A+"."+I+".woff"}var B=F.get(v);null==B&&(B=F.size,F.set(v,B)),C[l]=B}u>65535&&(l++,C[l]=C[l-1])}return{fontUrls:Array.from(F.keys()),chars:C}}))},Object.defineProperty(e,"__esModule",{value:!0}),e}({})}],init:(e,r,s)=>e(r,s())}),now=()=>(self.performance||Date).now(),x=p.default();let b;const F=[];let C=0;function nextChunk(){const e=now();for(;F.length&&now()-e<5;)F.shift()();C=F.length?setTimeout(nextChunk,0):0}const generateSDF_GL=(...e)=>new Promise(((r,s)=>{F.push((()=>{const l=now();try{x.webgl.generateIntoCanvas(...e),r({timing:now()-l})}catch(e){s(e)}})),C||(C=setTimeout(nextChunk,0))})),_=4,D=2e3,G={};let A=0;function generateSDF_JS_Worker(e,r,l,u,h,v,m,S,b,F){const C="TroikaTextSDFGenerator_JS_"+A++%_;let I=G[C];return I||(I=G[C]={workerModule:s.defineWorkerModule({name:C,workerId:C,dependencies:[p.default,now],init(e,r){const s=e().javascript.generate;return function(...e){const l=r();return{textureData:s(...e),timing:r()-l}}},getTransferables:e=>[e.textureData.buffer]}),requests:0,idleTimer:null}),I.requests++,clearTimeout(I.idleTimer),I.workerModule(e,r,l,u,h,v).then((({textureData:l,timing:u})=>{const h=now(),p=new Uint8Array(4*l.length);for(let e=0;e<l.length;e++)p[4*e+F]=l[e];return x.webglUtils.renderImageData(m,p,S,b,e,r,1<<3-F),u+=now()-h,0==--I.requests&&(I.idleTimer=setTimeout((()=>{s.terminateWorker(C)}),D)),{timing:u}}))}const I=x.webglUtils.resizeWebGLCanvasWithoutClearing,B={defaultFontURL:null,unicodeFontsURL:null,sdfGlyphSize:64,sdfMargin:1/16,sdfExponent:9,textureWidth:2048},R=new r.Color;let E=!1;function now$1(){return(self.performance||Date).now()}const W=Object.create(null);function getTextRenderInfo(e,s){E=!0,e=assign({},e);const l=now$1(),{defaultFontURL:u}=B,h=[];if(u&&h.push({label:"default",src:toAbsoluteURL(u)}),e.font&&h.push({label:"user",src:toAbsoluteURL(e.font)}),e.font=h,e.text=""+e.text,e.sdfGlyphSize=e.sdfGlyphSize||B.sdfGlyphSize,e.unicodeFontsURL=e.unicodeFontsURL||B.unicodeFontsURL,null!=e.colorRanges){let r={};for(let s in e.colorRanges)if(e.colorRanges.hasOwnProperty(s)){let l=e.colorRanges[s];"number"!=typeof l&&(l=R.set(l).getHex()),r[s]=l}e.colorRanges=r}Object.freeze(e);const{textureWidth:p,sdfExponent:v}=B,{sdfGlyphSize:m}=e,S=p/m*4;let b=W[m];if(!b){const e=document.createElement("canvas");e.width=p,e.height=256*m/S,b=W[m]={glyphCount:0,sdfGlyphSize:m,sdfCanvas:e,sdfTexture:new r.Texture(e,void 0,void 0,void 0,r.LinearFilter,r.LinearFilter),contextLost:!1,glyphsByFont:new Map},b.sdfTexture.generateMipmaps=!1,function(e){const r=e.sdfCanvas;r.addEventListener("webglcontextlost",(r=>{console.log("Context Lost",r),r.preventDefault(),e.contextLost=!0})),r.addEventListener("webglcontextrestored",(r=>{console.log("Context Restored",r),e.contextLost=!1;const s=[];e.glyphsByFont.forEach((r=>{r.forEach((r=>{s.push(generateGlyphSDF(r,e,!0))}))})),Promise.all(s).then((()=>{safariPre15Workaround(e),e.sdfTexture.needsUpdate=!0}))}))}(b)}const{sdfTexture:F,sdfCanvas:C}=b;j(e).then((r=>{const{glyphIds:u,glyphFontIndices:h,fontData:x,glyphPositions:_,fontSize:D,timings:G}=r,A=[],R=new Float32Array(4*u.length);let E=0,W=0;const z=now$1(),V=x.map((e=>{let r=b.glyphsByFont.get(e.src);return r||b.glyphsByFont.set(e.src,r=new Map),r}));u.forEach(((e,s)=>{const l=h[s],{src:p,unitsPerEm:v}=x[l];let S=V[l].get(e);if(!S){const{path:s,pathBounds:u}=r.glyphData[p][e],h=Math.max(u[2]-u[0],u[3]-u[1])/m*(B.sdfMargin*m+.5),v=b.glyphCount++,x=[u[0]-h,u[1]-h,u[2]+h,u[3]+h];V[l].set(e,S={path:s,atlasIndex:v,sdfViewBox:x}),A.push(S)}const{sdfViewBox:F}=S,C=_[W++],G=_[W++],I=D/v;R[E++]=C+F[0]*I,R[E++]=G+F[1]*I,R[E++]=C+F[2]*I,R[E++]=G+F[3]*I,u[s]=S.atlasIndex})),G.quads=(G.quads||0)+(now$1()-z);const j=now$1();G.sdf={};const H=C.height,N=Math.ceil(b.glyphCount/S),q=Math.pow(2,Math.ceil(Math.log2(N*m)));q>H&&(console.info(`Increasing SDF texture size ${H}->${q}`),I(C,p,q),F.dispose()),Promise.all(A.map((r=>generateGlyphSDF(r,b,e.gpuAccelerateSDF).then((({timing:e})=>{G.sdf[r.atlasIndex]=e}))))).then((()=>{A.length&&!b.contextLost&&(safariPre15Workaround(b),F.needsUpdate=!0),G.sdfTotal=now$1()-j,G.total=now$1()-l,s(Object.freeze({parameters:e,sdfTexture:F,sdfGlyphSize:m,sdfExponent:v,glyphBounds:R,glyphAtlasIndices:u,glyphColors:r.glyphColors,caretPositions:r.caretPositions,chunkedBounds:r.chunkedBounds,ascender:r.ascender,descender:r.descender,lineHeight:r.lineHeight,capHeight:r.capHeight,xHeight:r.xHeight,topBaseline:r.topBaseline,blockBounds:r.blockBounds,visibleBounds:r.visibleBounds,timings:r.timings}))}))})),Promise.resolve().then((()=>{var e;b.contextLost||(e=C)._warm||(x.webgl.isSupported(e),e._warm=!0)}))}function generateGlyphSDF({path:e,atlasIndex:r,sdfViewBox:s},{sdfGlyphSize:l,sdfCanvas:u,contextLost:h},p){if(h)return Promise.resolve({timing:-1});const{textureWidth:v,sdfExponent:m}=B,S=Math.max(s[2]-s[0],s[3]-s[1]),x=Math.floor(r/4);return function(e,r,s,l,u,h,p,v,m,S,x=!0){return x?generateSDF_GL(e,r,s,l,u,h,p,v,m,S).then(null,(x=>(b||(console.warn("WebGL SDF generation failed, falling back to JS",x),b=!0),generateSDF_JS_Worker(e,r,s,l,u,h,p,v,m,S)))):generateSDF_JS_Worker(e,r,s,l,u,h,p,v,m,S)}(l,l,e,s,S,m,u,x%(v/l)*l,Math.floor(x/(v/l))*l,r%4,p)}function assign(e,r){for(let s in r)r.hasOwnProperty(s)&&(e[s]=r[s]);return e}let z;function toAbsoluteURL(e){return z||(z="undefined"==typeof document?{}:document.createElement("a")),z.href=e,z.href}function safariPre15Workaround(e){if("function"!=typeof createImageBitmap){console.info("Safari<15: applying SDF canvas workaround");const{sdfCanvas:r,sdfTexture:s}=e,{width:l,height:u}=r,h=e.sdfCanvas.getContext("webgl");let p=s.image.data;p&&p.length===l*u*4||(p=new Uint8Array(l*u*4),s.image={width:l,height:u,data:p},s.flipY=!1,s.isDataTexture=!0),h.readPixels(0,0,l,u,h.RGBA,h.UNSIGNED_BYTE,p)}}const V=s.defineWorkerModule({name:"Typesetter",dependencies:[function(e,r){const s=1/0,l=/[\u00AD\u034F\u061C\u115F-\u1160\u17B4-\u17B5\u180B-\u180E\u200B-\u200F\u202A-\u202E\u2060-\u206F\u3164\uFE00-\uFE0F\uFEFF\uFFA0\uFFF0-\uFFF8]/,u="[^\\S\\u00A0]",h=new RegExp(`${u}|[\\-\\u007C\\u00AD\\u2010\\u2012-\\u2014\\u2027\\u2056\\u2E17\\u2E40]`);function typeset({text:p="",font:v,lang:m,sdfGlyphSize:S=64,fontSize:x=400,fontWeight:b=1,fontStyle:F="normal",letterSpacing:C=0,lineHeight:_="normal",maxWidth:D=s,direction:G,textAlign:A="left",textIndent:I=0,whiteSpace:B="normal",overflowWrap:R="normal",anchorX:E=0,anchorY:W=0,metricsOnly:z=!1,unicodeFontsURL:V,preResolvedFonts:j=null,includeCaretPositions:H=!1,chunkedBoundsSize:N=8192,colorRanges:q=null},X){const $=now(),Y={fontLoad:0,typesetting:0};p.indexOf("\r")>-1&&(console.info("Typesetter: got text with \\r chars; normalizing to \\n"),p=p.replace(/\r\n/g,"\n").replace(/\r/g,"\n")),x=+x,C=+C,D=+D,_=_||"normal",I=+I,function({text:r,lang:s,fonts:l,style:u,weight:h,preResolvedFonts:p,unicodeFontsURL:v},m){const onResolved=({chars:e,fonts:r})=>{let s,l;const u=[];for(let h=0;h<e.length;h++)e[h]!==l?(l=e[h],u.push(s={start:h,end:h,fontObj:r[e[h]]})):s.end=h;m(u)};p?onResolved(p):e(r,onResolved,{lang:s,fonts:l,style:u,weight:h,unicodeFontsURL:v})}({text:p,lang:m,style:F,weight:b,fonts:"string"==typeof v?[{src:v}]:v,unicodeFontsURL:V,preResolvedFonts:j},(e=>{Y.fontLoad=now()-$;const v=isFinite(D);let m=null,S=null,b=null,F=null,V=null,j=null,J=null,Z=null,Q=0,K=0,ee="nowrap"!==B;const te=new Map,re=now();let ne=I,ae=0,oe=new TextLine;const ie=[oe];e.forEach((e=>{const{fontObj:r}=e,{ascender:s,descender:m,unitsPerEm:S,lineGap:b,capHeight:F,xHeight:G}=r;let A=te.get(r);if(!A){const e=x/S,l="normal"===_?(s-m+b)*e:_*x,u=(l-(s-m)*e)/2,h=Math.min(l,(s-m)*e),p=(s+m)/2*e+h/2;A={index:te.size,src:r.src,fontObj:r,fontSizeMult:e,unitsPerEm:S,ascender:s*e,descender:m*e,capHeight:F*e,xHeight:G*e,lineHeight:l,baseline:-u-s*e,caretTop:(s+m)/2*e+h/2,caretBottom:p-h},te.set(r,A)}const{fontSizeMult:B}=A,E=p.slice(e.start,e.end+1);let W,z;r.forEachGlyph(E,x,C,((r,s,m,S)=>{s+=ae,S+=e.start,W=s,z=r;const b=p.charAt(S),F=r.advanceWidth*B,_=oe.count;let G;if("isEmpty"in r||(r.isWhitespace=!!b&&new RegExp(u).test(b),r.canBreakAfter=!!b&&h.test(b),r.isEmpty=r.xMin===r.xMax||r.yMin===r.yMax||l.test(b)),r.isWhitespace||r.isEmpty||K++,ee&&v&&!r.isWhitespace&&s+F+ne>D&&_){if(oe.glyphAt(_-1).glyphObj.canBreakAfter)G=new TextLine,ne=-s;else for(let e=_;e--;){if(0===e&&"break-word"===R){G=new TextLine,ne=-s;break}if(oe.glyphAt(e).glyphObj.canBreakAfter){G=oe.splitAt(e+1);const r=G.glyphAt(0).x;ne-=r;for(let e=G.count;e--;)G.glyphAt(e).x-=r;break}}G&&(oe.isSoftWrapped=!0,oe=G,ie.push(oe),Q=D)}let E=oe.glyphAt(oe.count);E.glyphObj=r,E.x=s+ne,E.y=m,E.width=F,E.charIndex=S,E.fontData=A,"\n"===b&&(oe=new TextLine,ie.push(oe),ne=-(s+F+C*x)+I)})),ae=W+z.advanceWidth*B+C*x}));let se=0;ie.forEach((e=>{let r=!0;for(let s=e.count;s--;){const l=e.glyphAt(s);r&&!l.glyphObj.isWhitespace&&(e.width=l.x+l.width,e.width>Q&&(Q=e.width),r=!1);let{lineHeight:u,capHeight:h,xHeight:p,baseline:v}=l.fontData;u>e.lineHeight&&(e.lineHeight=u);const m=v-e.baseline;m<0&&(e.baseline+=m,e.cap+=m,e.ex+=m),e.cap=Math.max(e.cap,e.baseline+h),e.ex=Math.max(e.ex,e.baseline+p)}e.baseline-=se,e.cap-=se,e.ex-=se,se+=e.lineHeight}));let le=0,ue=0;if(E&&("number"==typeof E?le=-E:"string"==typeof E&&(le=-Q*("left"===E?0:"center"===E?.5:"right"===E?1:parsePercent(E)))),W&&("number"==typeof W?ue=-W:"string"==typeof W&&(ue="top"===W?0:"top-baseline"===W?-ie[0].baseline:"top-cap"===W?-ie[0].cap:"top-ex"===W?-ie[0].ex:"middle"===W?se/2:"bottom"===W?se:"bottom-baseline"===W?ie[ie.length-1].baseline:parsePercent(W)*se)),!z){const e=r.getEmbeddingLevels(p,G);m=new Uint16Array(K),S=new Uint8Array(K),b=new Float32Array(2*K),F={},J=[s,s,-s,-s],Z=[],H&&(j=new Float32Array(4*p.length)),q&&(V=new Uint8Array(3*K));let l,u,h=0,v=-1,x=-1;if(ie.forEach(((C,_)=>{let{count:D,width:G}=C;if(D>0){let _=0;for(let e=D;e--&&C.glyphAt(e).glyphObj.isWhitespace;)_++;let I=0,B=0;if("center"===A)I=(Q-G)/2;else if("right"===A)I=Q-G;else if("justify"===A&&C.isSoftWrapped){let e=0;for(let r=D-_;r--;)C.glyphAt(r).glyphObj.isWhitespace&&e++;B=(Q-G)/e}if(B||I){let e=0;for(let r=0;r<D;r++){let s=C.glyphAt(r);const l=s.glyphObj;s.x+=I+e,0!==B&&l.isWhitespace&&r<D-_&&(e+=B,s.width+=B)}}const R=r.getReorderSegments(p,e,C.glyphAt(0).charIndex,C.glyphAt(C.count-1).charIndex);for(let e=0;e<R.length;e++){const[r,s]=R[e];let l=1/0,u=-1/0;for(let e=0;e<D;e++)if(C.glyphAt(e).charIndex>=r){let r=e,h=e;for(;h<D;h++){let e=C.glyphAt(h);if(e.charIndex>s)break;h<D-_&&(l=Math.min(l,e.x),u=Math.max(u,e.x+e.width))}for(let e=r;e<h;e++){const r=C.glyphAt(e);r.x=u-(r.x+r.width-l)}break}}let E;const setGlyphObj=e=>E=e;for(let _=0;_<D;_++){const D=C.glyphAt(_);E=D.glyphObj;const G=E.index,A=1&e.levels[D.charIndex];if(A){const e=r.getMirroredCharacter(p[D.charIndex]);e&&D.fontData.fontObj.forEachGlyph(e,0,0,setGlyphObj)}if(H){const{charIndex:e,fontData:r}=D,s=D.x+le,l=D.x+D.width+le;j[4*e]=A?l:s,j[4*e+1]=A?s:l,j[4*e+2]=C.baseline+r.caretBottom+ue,j[4*e+3]=C.baseline+r.caretTop+ue;const u=e-v;u>1&&fillLigatureCaretPositions(j,v,u),v=e}if(q){const{charIndex:e}=D;for(;e>x;)x++,q.hasOwnProperty(x)&&(u=q[x])}if(!E.isWhitespace&&!E.isEmpty){const e=h++,{fontSizeMult:r,src:p,index:v}=D.fontData,x=F[p]||(F[p]={});x[G]||(x[G]={path:E.path,pathBounds:[E.xMin,E.yMin,E.xMax,E.yMax]});const _=D.x+le,A=D.y+C.baseline+ue;b[2*e]=_,b[2*e+1]=A;const I=_+E.xMin*r,B=A+E.yMin*r,R=_+E.xMax*r,W=A+E.yMax*r;I<J[0]&&(J[0]=I),B<J[1]&&(J[1]=B),R>J[2]&&(J[2]=R),W>J[3]&&(J[3]=W),e%N==0&&(l={start:e,end:e,rect:[s,s,-s,-s]},Z.push(l)),l.end++;const z=l.rect;if(I<z[0]&&(z[0]=I),B<z[1]&&(z[1]=B),R>z[2]&&(z[2]=R),W>z[3]&&(z[3]=W),m[e]=G,S[e]=v,q){const r=3*e;V[r]=u>>16&255,V[r+1]=u>>8&255,V[r+2]=255&u}}}}})),j){const e=p.length-v;e>1&&fillLigatureCaretPositions(j,v,e)}}const fe=[];te.forEach((({index:e,src:r,unitsPerEm:s,ascender:l,descender:u,lineHeight:h,capHeight:p,xHeight:v})=>{fe[e]={src:r,unitsPerEm:s,ascender:l,descender:u,lineHeight:h,capHeight:p,xHeight:v}})),Y.typesetting=now()-re,X({glyphIds:m,glyphFontIndices:S,glyphPositions:b,glyphData:F,fontData:fe,caretPositions:j,glyphColors:V,chunkedBounds:Z,fontSize:x,topBaseline:ue+ie[0].baseline,blockBounds:[le,ue-se,le+Q,ue],visibleBounds:J,timings:Y})}))}function parsePercent(e){let r=e.match(/^([\d.]+)%$/),s=r?parseFloat(r[1]):NaN;return isNaN(s)?0:s/100}function fillLigatureCaretPositions(e,r,s){const l=e[4*r],u=e[4*r+1],h=e[4*r+2],p=e[4*r+3],v=(u-l)/s;for(let u=0;u<s;u++){const s=4*(r+u);e[s]=l+v*u,e[s+1]=l+v*(u+1),e[s+2]=h,e[s+3]=p}}function now(){return(self.performance||Date).now()}function TextLine(){this.data=[]}const p=["glyphObj","x","y","width","charIndex","fontData"];return TextLine.prototype={width:0,lineHeight:0,baseline:0,cap:0,ex:0,isSoftWrapped:!1,get count(){return Math.ceil(this.data.length/p.length)},glyphAt(e){let r=TextLine.flyweight;return r.data=this.data,r.index=e,r},splitAt(e){let r=new TextLine;return r.data=this.data.splice(e*p.length),r}},TextLine.flyweight=p.reduce(((e,r,s,l)=>(Object.defineProperty(e,r,{get(){return this.data[this.index*p.length+s]},set(e){this.data[this.index*p.length+s]=e}}),e)),{data:null,index:0}),{typeset:typeset,measure:function(e,r){typeset({...e,metricsOnly:!0},(e=>{const[s,l,u,h]=e.blockBounds;r({width:u-s,height:h-l})}))}}},S,v.default],init:(e,r,s)=>e(r,s())}),j=s.defineWorkerModule({name:"Typesetter",dependencies:[V],init:e=>function(r){return new Promise((s=>{e.typeset(r,s)}))},getTransferables(e){const r=[];for(let s in e)e[s]&&e[s].buffer&&r.push(e[s].buffer);return r}}),H={},N="aTroikaGlyphIndex";class GlyphsGeometry extends r.InstancedBufferGeometry{constructor(){super(),this.detail=1,this.curveRadius=0,this.groups=[{start:0,count:1/0,materialIndex:0},{start:0,count:1/0,materialIndex:1}],this.boundingSphere=new r.Sphere,this.boundingBox=new r.Box3}computeBoundingSphere(){}computeBoundingBox(){}setSide(e){const s=this.getIndex().count;this.setDrawRange(e===r.BackSide?s/2:0,e===r.DoubleSide?s:s/2)}set detail(e){if(e!==this._detail){this._detail=e,("number"!=typeof e||e<1)&&(e=1);let s=function(e){let s=H[e];if(!s){const l=new r.PlaneGeometry(1,1,e,e),u=l.clone(),h=l.attributes,p=u.attributes,v=new r.BufferGeometry,m=h.uv.count;for(let e=0;e<m;e++)p.position.array[3*e]*=-1,p.normal.array[3*e+2]*=-1;["position","normal","uv"].forEach((e=>{v.setAttribute(e,new r.Float32BufferAttribute([...h[e].array,...p[e].array],h[e].itemSize))})),v.setIndex([...l.index.array,...u.index.array.map((e=>e+m))]),v.translate(.5,.5,0),s=H[e]=v}return s}(e);["position","normal","uv"].forEach((e=>{this.attributes[e]=s.attributes[e].clone()})),this.setIndex(s.getIndex().clone())}}get detail(){return this._detail}set curveRadius(e){e!==this._curveRadius&&(this._curveRadius=e,this._updateBounds())}get curveRadius(){return this._curveRadius}updateGlyphs(e,r,s,l,u){updateBufferAttr(this,"aTroikaGlyphBounds",e,4),updateBufferAttr(this,N,r,1),updateBufferAttr(this,"aTroikaGlyphColor",u,3),this._blockBounds=s,this._chunkedBounds=l,this.instanceCount=r.length,this._updateBounds()}_updateBounds(){const e=this._blockBounds;if(e){const{curveRadius:r,boundingBox:s}=this;if(r){const{PI:l,floor:u,min:h,max:p,sin:v,cos:m}=Math,S=l/2,x=2*l,b=Math.abs(r),F=e[0]/b,C=e[2]/b,_=u((F+S)/x)!==u((C+S)/x)?-b:h(v(F)*b,v(C)*b),D=u((F-S)/x)!==u((C-S)/x)?b:p(v(F)*b,v(C)*b),G=u((F+l)/x)!==u((C+l)/x)?2*b:p(b-m(F)*b,b-m(C)*b);s.min.set(_,e[1],r<0?-G:0),s.max.set(D,e[3],r<0?0:G)}else s.min.set(e[0],e[1],0),s.max.set(e[2],e[3],0);s.getBoundingSphere(this.boundingSphere)}}applyClipRect(e){let r=this.getAttribute(N).count,s=this._chunkedBounds;if(s)for(let l=s.length;l--;){r=s[l].end;let u=s[l].rect;if(u[1]<e.w&&u[3]>e.y&&u[0]<e.z&&u[2]>e.x)break}this.instanceCount=r}}function updateBufferAttr(e,s,l,u){const h=e.getAttribute(s);l?h&&h.array.length===l.length?(h.array.set(l),h.needsUpdate=!0):(e.setAttribute(s,new r.InstancedBufferAttribute(l,u)),delete e._maxInstanceCount,e.dispose()):h&&e.deleteAttribute(s)}function createTextDerivedMaterial(e){const s=h.createDerivedMaterial(e,{chained:!0,extensions:{derivatives:!0},uniforms:{uTroikaSDFTexture:{value:null},uTroikaSDFTextureSize:{value:new r.Vector2},uTroikaSDFGlyphSize:{value:0},uTroikaSDFExponent:{value:0},uTroikaTotalBounds:{value:new r.Vector4(0,0,0,0)},uTroikaClipRect:{value:new r.Vector4(0,0,0,0)},uTroikaDistanceOffset:{value:0},uTroikaOutlineOpacity:{value:0},uTroikaFillOpacity:{value:1},uTroikaPositionOffset:{value:new r.Vector2},uTroikaCurveRadius:{value:0},uTroikaBlurRadius:{value:0},uTroikaStrokeWidth:{value:0},uTroikaStrokeColor:{value:new r.Color},uTroikaStrokeOpacity:{value:1},uTroikaOrient:{value:new r.Matrix3},uTroikaUseGlyphColors:{value:!0},uTroikaSDFDebug:{value:!1}},vertexDefs:"\nuniform vec2 uTroikaSDFTextureSize;\nuniform float uTroikaSDFGlyphSize;\nuniform vec4 uTroikaTotalBounds;\nuniform vec4 uTroikaClipRect;\nuniform mat3 uTroikaOrient;\nuniform bool uTroikaUseGlyphColors;\nuniform float uTroikaDistanceOffset;\nuniform float uTroikaBlurRadius;\nuniform vec2 uTroikaPositionOffset;\nuniform float uTroikaCurveRadius;\nattribute vec4 aTroikaGlyphBounds;\nattribute float aTroikaGlyphIndex;\nattribute vec3 aTroikaGlyphColor;\nvarying vec2 vTroikaGlyphUV;\nvarying vec4 vTroikaTextureUVBounds;\nvarying float vTroikaTextureChannel;\nvarying vec3 vTroikaGlyphColor;\nvarying vec2 vTroikaGlyphDimensions;\n",vertexTransform:"\nvec4 bounds = aTroikaGlyphBounds;\nbounds.xz += uTroikaPositionOffset.x;\nbounds.yw -= uTroikaPositionOffset.y;\n\nvec4 outlineBounds = vec4(\n  bounds.xy - uTroikaDistanceOffset - uTroikaBlurRadius,\n  bounds.zw + uTroikaDistanceOffset + uTroikaBlurRadius\n);\nvec4 clippedBounds = vec4(\n  clamp(outlineBounds.xy, uTroikaClipRect.xy, uTroikaClipRect.zw),\n  clamp(outlineBounds.zw, uTroikaClipRect.xy, uTroikaClipRect.zw)\n);\n\nvec2 clippedXY = (mix(clippedBounds.xy, clippedBounds.zw, position.xy) - bounds.xy) / (bounds.zw - bounds.xy);\n\nposition.xy = mix(bounds.xy, bounds.zw, clippedXY);\n\nuv = (position.xy - uTroikaTotalBounds.xy) / (uTroikaTotalBounds.zw - uTroikaTotalBounds.xy);\n\nfloat rad = uTroikaCurveRadius;\nif (rad != 0.0) {\n  float angle = position.x / rad;\n  position.xz = vec2(sin(angle) * rad, rad - cos(angle) * rad);\n  normal.xz = vec2(sin(angle), cos(angle));\n}\n  \nposition = uTroikaOrient * position;\nnormal = uTroikaOrient * normal;\n\nvTroikaGlyphUV = clippedXY.xy;\nvTroikaGlyphDimensions = vec2(bounds[2] - bounds[0], bounds[3] - bounds[1]);\n\n\nfloat txCols = uTroikaSDFTextureSize.x / uTroikaSDFGlyphSize;\nvec2 txUvPerSquare = uTroikaSDFGlyphSize / uTroikaSDFTextureSize;\nvec2 txStartUV = txUvPerSquare * vec2(\n  mod(floor(aTroikaGlyphIndex / 4.0), txCols),\n  floor(floor(aTroikaGlyphIndex / 4.0) / txCols)\n);\nvTroikaTextureUVBounds = vec4(txStartUV, vec2(txStartUV) + txUvPerSquare);\nvTroikaTextureChannel = mod(aTroikaGlyphIndex, 4.0);\n",fragmentDefs:"\nuniform sampler2D uTroikaSDFTexture;\nuniform vec2 uTroikaSDFTextureSize;\nuniform float uTroikaSDFGlyphSize;\nuniform float uTroikaSDFExponent;\nuniform float uTroikaDistanceOffset;\nuniform float uTroikaFillOpacity;\nuniform float uTroikaOutlineOpacity;\nuniform float uTroikaBlurRadius;\nuniform vec3 uTroikaStrokeColor;\nuniform float uTroikaStrokeWidth;\nuniform float uTroikaStrokeOpacity;\nuniform bool uTroikaSDFDebug;\nvarying vec2 vTroikaGlyphUV;\nvarying vec4 vTroikaTextureUVBounds;\nvarying float vTroikaTextureChannel;\nvarying vec2 vTroikaGlyphDimensions;\n\nfloat troikaSdfValueToSignedDistance(float alpha) {\n  // Inverse of exponential encoding in webgl-sdf-generator\n  \n  float maxDimension = max(vTroikaGlyphDimensions.x, vTroikaGlyphDimensions.y);\n  float absDist = (1.0 - pow(2.0 * (alpha > 0.5 ? 1.0 - alpha : alpha), 1.0 / uTroikaSDFExponent)) * maxDimension;\n  float signedDist = absDist * (alpha > 0.5 ? -1.0 : 1.0);\n  return signedDist;\n}\n\nfloat troikaGlyphUvToSdfValue(vec2 glyphUV) {\n  vec2 textureUV = mix(vTroikaTextureUVBounds.xy, vTroikaTextureUVBounds.zw, glyphUV);\n  vec4 rgba = texture2D(uTroikaSDFTexture, textureUV);\n  float ch = floor(vTroikaTextureChannel + 0.5); //NOTE: can't use round() in WebGL1\n  return ch == 0.0 ? rgba.r : ch == 1.0 ? rgba.g : ch == 2.0 ? rgba.b : rgba.a;\n}\n\nfloat troikaGlyphUvToDistance(vec2 uv) {\n  return troikaSdfValueToSignedDistance(troikaGlyphUvToSdfValue(uv));\n}\n\nfloat troikaGetAADist() {\n  \n  #if defined(GL_OES_standard_derivatives) || __VERSION__ >= 300\n  return length(fwidth(vTroikaGlyphUV * vTroikaGlyphDimensions)) * 0.5;\n  #else\n  return vTroikaGlyphDimensions.x / 64.0;\n  #endif\n}\n\nfloat troikaGetFragDistValue() {\n  vec2 clampedGlyphUV = clamp(vTroikaGlyphUV, 0.5 / uTroikaSDFGlyphSize, 1.0 - 0.5 / uTroikaSDFGlyphSize);\n  float distance = troikaGlyphUvToDistance(clampedGlyphUV);\n \n  // Extrapolate distance when outside bounds:\n  distance += clampedGlyphUV == vTroikaGlyphUV ? 0.0 : \n    length((vTroikaGlyphUV - clampedGlyphUV) * vTroikaGlyphDimensions);\n\n  \n\n  return distance;\n}\n\nfloat troikaGetEdgeAlpha(float distance, float distanceOffset, float aaDist) {\n  #if defined(IS_DEPTH_MATERIAL) || defined(IS_DISTANCE_MATERIAL)\n  float alpha = step(-distanceOffset, -distance);\n  #else\n\n  float alpha = smoothstep(\n    distanceOffset + aaDist,\n    distanceOffset - aaDist,\n    distance\n  );\n  #endif\n\n  return alpha;\n}\n",fragmentColorTransform:"\nfloat aaDist = troikaGetAADist();\nfloat fragDistance = troikaGetFragDistValue();\nfloat edgeAlpha = uTroikaSDFDebug ?\n  troikaGlyphUvToSdfValue(vTroikaGlyphUV) :\n  troikaGetEdgeAlpha(fragDistance, uTroikaDistanceOffset, max(aaDist, uTroikaBlurRadius));\n\n#if !defined(IS_DEPTH_MATERIAL) && !defined(IS_DISTANCE_MATERIAL)\nvec4 fillRGBA = gl_FragColor;\nfillRGBA.a *= uTroikaFillOpacity;\nvec4 strokeRGBA = uTroikaStrokeWidth == 0.0 ? fillRGBA : vec4(uTroikaStrokeColor, uTroikaStrokeOpacity);\nif (fillRGBA.a == 0.0) fillRGBA.rgb = strokeRGBA.rgb;\ngl_FragColor = mix(fillRGBA, strokeRGBA, smoothstep(\n  -uTroikaStrokeWidth - aaDist,\n  -uTroikaStrokeWidth + aaDist,\n  fragDistance\n));\ngl_FragColor.a *= edgeAlpha;\n#endif\n\nif (edgeAlpha == 0.0) {\n  discard;\n}\n",customRewriter({vertexShader:e,fragmentShader:r}){let s=/\buniform\s+vec3\s+diffuse\b/;return s.test(r)&&(r=r.replace(s,"varying vec3 vTroikaGlyphColor").replace(/\bdiffuse\b/g,"vTroikaGlyphColor"),s.test(e)||(e=e.replace(h.voidMainRegExp,"uniform vec3 diffuse;\n$&\nvTroikaGlyphColor = uTroikaUseGlyphColors ? aTroikaGlyphColor / 255.0 : diffuse;\n"))),{vertexShader:e,fragmentShader:r}}});return s.transparent=!0,Object.defineProperties(s,{isTroikaTextMaterial:{value:!0},shadowSide:{get(){return this.side},set(){}}}),s}const q=new r.MeshBasicMaterial({color:16777215,side:r.DoubleSide,transparent:!0}),X=8421504,$=new r.Matrix4,Y=new r.Vector3,J=new r.Vector3,Z=[],Q=new r.Vector3,K="+x+y";function first(e){return Array.isArray(e)?e[0]:e}let getFlatRaycastMesh=()=>{const e=new r.Mesh(new r.PlaneGeometry(1,1),q);return getFlatRaycastMesh=()=>e,e},getCurvedRaycastMesh=()=>{const e=new r.Mesh(new r.PlaneGeometry(1,1,32,1),q);return getCurvedRaycastMesh=()=>e,e};const ee={type:"syncstart"},te={type:"synccomplete"},re=["font","fontSize","fontStyle","fontWeight","lang","letterSpacing","lineHeight","maxWidth","overflowWrap","text","direction","textAlign","textIndent","whiteSpace","anchorX","anchorY","colorRanges","sdfGlyphSize"],ne=re.concat("material","color","depthOffset","clipRect","curveRadius","orientation","glyphGeometryDetail");class Text extends r.Mesh{constructor(){super(new GlyphsGeometry,null),this.text="",this.anchorX=0,this.anchorY=0,this.curveRadius=0,this.direction="auto",this.font=null,this.unicodeFontsURL=null,this.fontSize=.1,this.fontWeight="normal",this.fontStyle="normal",this.lang=null,this.letterSpacing=0,this.lineHeight="normal",this.maxWidth=1/0,this.overflowWrap="normal",this.textAlign="left",this.textIndent=0,this.whiteSpace="normal",this.material=null,this.color=null,this.colorRanges=null,this.outlineWidth=0,this.outlineColor=0,this.outlineOpacity=1,this.outlineBlur=0,this.outlineOffsetX=0,this.outlineOffsetY=0,this.strokeWidth=0,this.strokeColor=X,this.strokeOpacity=1,this.fillOpacity=1,this.depthOffset=0,this.clipRect=null,this.orientation=K,this.glyphGeometryDetail=1,this.sdfGlyphSize=null,this.gpuAccelerateSDF=!0,this.debugSDF=!1}sync(e){this._needsSync&&(this._needsSync=!1,this._isSyncing?(this._queuedSyncs||(this._queuedSyncs=[])).push(e):(this._isSyncing=!0,this.dispatchEvent(ee),getTextRenderInfo({text:this.text,font:this.font,lang:this.lang,fontSize:this.fontSize||.1,fontWeight:this.fontWeight||"normal",fontStyle:this.fontStyle||"normal",letterSpacing:this.letterSpacing||0,lineHeight:this.lineHeight||"normal",maxWidth:this.maxWidth,direction:this.direction||"auto",textAlign:this.textAlign,textIndent:this.textIndent,whiteSpace:this.whiteSpace,overflowWrap:this.overflowWrap,anchorX:this.anchorX,anchorY:this.anchorY,colorRanges:this.colorRanges,includeCaretPositions:!0,sdfGlyphSize:this.sdfGlyphSize,gpuAccelerateSDF:this.gpuAccelerateSDF,unicodeFontsURL:this.unicodeFontsURL},(r=>{this._isSyncing=!1,this._textRenderInfo=r,this.geometry.updateGlyphs(r.glyphBounds,r.glyphAtlasIndices,r.blockBounds,r.chunkedBounds,r.glyphColors);const s=this._queuedSyncs;s&&(this._queuedSyncs=null,this._needsSync=!0,this.sync((()=>{s.forEach((e=>e&&e()))}))),this.dispatchEvent(te),e&&e()}))))}onBeforeRender(e,s,l,u,h,p){this.sync(),h.isTroikaTextMaterial&&this._prepareForRender(h),h._hadOwnSide=h.hasOwnProperty("side"),this.geometry.setSide(h._actualSide=h.side),h.side=r.FrontSide}onAfterRender(e,r,s,l,u,h){u._hadOwnSide?u.side=u._actualSide:delete u.side}dispose(){this.geometry.dispose()}get textRenderInfo(){return this._textRenderInfo||null}get material(){let e=this._derivedMaterial;const r=this._baseMaterial||this._defaultMaterial||(this._defaultMaterial=q.clone());if(e&&e.baseMaterial===r||(e=this._derivedMaterial=createTextDerivedMaterial(r),r.addEventListener("dispose",(function onDispose(){r.removeEventListener("dispose",onDispose),e.dispose()}))),this.outlineWidth||this.outlineBlur||this.outlineOffsetX||this.outlineOffsetY){let r=e._outlineMtl;return r||(r=e._outlineMtl=Object.create(e,{id:{value:e.id+.1}}),r.isTextOutlineMaterial=!0,r.depthWrite=!1,r.map=null,e.addEventListener("dispose",(function onDispose(){e.removeEventListener("dispose",onDispose),r.dispose()}))),[r,e]}return e}set material(e){e&&e.isTroikaTextMaterial?(this._derivedMaterial=e,this._baseMaterial=e.baseMaterial):this._baseMaterial=e}get glyphGeometryDetail(){return this.geometry.detail}set glyphGeometryDetail(e){this.geometry.detail=e}get curveRadius(){return this.geometry.curveRadius}set curveRadius(e){this.geometry.curveRadius=e}get customDepthMaterial(){return first(this.material).getDepthMaterial()}get customDistanceMaterial(){return first(this.material).getDistanceMaterial()}_prepareForRender(e){const s=e.isTextOutlineMaterial,l=e.uniforms,u=this.textRenderInfo;if(u){const{sdfTexture:e,blockBounds:r}=u;l.uTroikaSDFTexture.value=e,l.uTroikaSDFTextureSize.value.set(e.image.width,e.image.height),l.uTroikaSDFGlyphSize.value=u.sdfGlyphSize,l.uTroikaSDFExponent.value=u.sdfExponent,l.uTroikaTotalBounds.value.fromArray(r),l.uTroikaUseGlyphColors.value=!s&&!!u.glyphColors;let h,p,v,m=0,S=0,x=0,b=0,F=0;if(s){let{outlineWidth:e,outlineOffsetX:r,outlineOffsetY:s,outlineBlur:l,outlineOpacity:u}=this;m=this._parsePercent(e)||0,S=Math.max(0,this._parsePercent(l)||0),h=u,b=this._parsePercent(r)||0,F=this._parsePercent(s)||0}else x=Math.max(0,this._parsePercent(this.strokeWidth)||0),x&&(v=this.strokeColor,l.uTroikaStrokeColor.value.set(null==v?X:v),p=this.strokeOpacity,null==p&&(p=1)),h=this.fillOpacity;l.uTroikaDistanceOffset.value=m,l.uTroikaPositionOffset.value.set(b,F),l.uTroikaBlurRadius.value=S,l.uTroikaStrokeWidth.value=x,l.uTroikaStrokeOpacity.value=p,l.uTroikaFillOpacity.value=null==h?1:h,l.uTroikaCurveRadius.value=this.curveRadius||0;let C=this.clipRect;if(C&&Array.isArray(C)&&4===C.length)l.uTroikaClipRect.value.fromArray(C);else{const e=100*(this.fontSize||.1);l.uTroikaClipRect.value.set(r[0]-e,r[1]-e,r[2]+e,r[3]+e)}this.geometry.applyClipRect(l.uTroikaClipRect.value)}l.uTroikaSDFDebug.value=!!this.debugSDF,e.polygonOffset=!!this.depthOffset,e.polygonOffsetFactor=e.polygonOffsetUnits=this.depthOffset||0;const h=s?this.outlineColor||0:this.color;if(null==h)delete e.color;else{const s=e.hasOwnProperty("color")?e.color:e.color=new r.Color;h===s._input&&"object"!=typeof h||s.set(s._input=h)}let p=this.orientation||K;if(p!==e._orientation){let r=l.uTroikaOrient.value;p=p.replace(/[^-+xyz]/g,"");let s=p!==K&&p.match(/^([-+])([xyz])([-+])([xyz])$/);if(s){let[,e,l,u,h]=s;Y.set(0,0,0)[l]="-"===e?1:-1,J.set(0,0,0)[h]="-"===u?-1:1,$.lookAt(Q,Y.cross(J),J),r.setFromMatrix4($)}else r.identity();e._orientation=p}}_parsePercent(e){if("string"==typeof e){let r=e.match(/^(-?[\d.]+)%$/),s=r?parseFloat(r[1]):NaN;e=(isNaN(s)?0:s/100)*this.fontSize}return e}localPositionToTextCoords(e,s=new r.Vector2){s.copy(e);const l=this.curveRadius;return l&&(s.x=Math.atan2(e.x,Math.abs(l)-Math.abs(e.z))*Math.abs(l)),s}worldPositionToTextCoords(e,s=new r.Vector2){return Y.copy(e),this.localPositionToTextCoords(this.worldToLocal(Y),s)}raycast(e,r){const{textRenderInfo:s,curveRadius:l}=this;if(s){const u=s.blockBounds,h=l?getCurvedRaycastMesh():getFlatRaycastMesh(),p=h.geometry,{position:v,uv:m}=p.attributes;for(let e=0;e<m.count;e++){let r=u[0]+m.getX(e)*(u[2]-u[0]);const s=u[1]+m.getY(e)*(u[3]-u[1]);let h=0;l&&(h=l-Math.cos(r/l)*l,r=Math.sin(r/l)*l),v.setXYZ(e,r,s,h)}p.boundingSphere=this.geometry.boundingSphere,p.boundingBox=this.geometry.boundingBox,h.matrixWorld=this.matrixWorld,h.material.side=this.material.side,Z.length=0,h.raycast(e,Z);for(let e=0;e<Z.length;e++)Z[e].object=this,r.push(Z[e])}}copy(e){const r=this.geometry;return super.copy(e),this.geometry=r,ne.forEach((r=>{this[r]=e[r]})),this}clone(){return(new this.constructor).copy(this)}}re.forEach((e=>{const r="_private_"+e;Object.defineProperty(Text.prototype,e,{get(){return this[r]},set(e){e!==this[r]&&(this[r]=e,this._needsSync=!0)}})}));const ae=new WeakMap,oe=new WeakMap;e.GlyphsGeometry=GlyphsGeometry,e.Text=Text,e.configureTextBuilder=function(e){E?console.warn("configureTextBuilder called after first font request; will be ignored."):assign(B,e)},e.createTextDerivedMaterial=createTextDerivedMaterial,e.dumpSDFTextures=function(){Object.keys(W).forEach((e=>{const r=W[e].sdfCanvas,{width:s,height:l}=r;console.log("%c.",`\n      background: url(${r.toDataURL()});\n      background-size: ${s}px ${l}px;\n      color: transparent;\n      font-size: 0;\n      line-height: ${l}px;\n      padding-left: ${s}px;\n    `)}))},e.fontResolverWorkerModule=S,e.getCaretAtPoint=function(e,r,s){let l=null;const u=function(e){let r=oe.get(e);if(!r){r=[];const{caretPositions:s}=e;let l;const visitCaret=(e,s,u,h)=>{(!l||u<(l.top+l.bottom)/2)&&r.push(l={bottom:s,top:u,carets:[]}),u>l.top&&(l.top=u),s<l.bottom&&(l.bottom=s),l.carets.push({x:e,y:s,height:u-s,charIndex:h})};let u=0;for(;u<s.length;u+=4)visitCaret(s[u],s[u+2],s[u+3],u/4);visitCaret(s[u-3],s[u-2],s[u-1],u/4)}return oe.set(e,r),r}(e);let h=null;return u.forEach((e=>{(!h||Math.abs(s-(e.top+e.bottom)/2)<Math.abs(s-(h.top+h.bottom)/2))&&(h=e)})),h.carets.forEach((e=>{(!l||Math.abs(r-e.x)<Math.abs(r-l.x))&&(l=e)})),l},e.getSelectionRects=function(e,r,s){let l;if(e){let u=ae.get(e);if(u&&u.start===r&&u.end===s)return u.rects;const{caretPositions:h}=e;if(s<r){const e=r;r=s,s=e}r=Math.max(r,0),s=Math.min(s,h.length+1),l=[];let p=null;for(let e=r;e<s;e++){const r=h[4*e],s=h[4*e+1],u=Math.min(r,s),v=Math.max(r,s),m=h[4*e+2],S=h[4*e+3];(!p||m!==p.bottom||S!==p.top||u>p.right||v<p.left)&&(p={left:1/0,right:-1/0,bottom:m,top:S},l.push(p)),p.left=Math.min(u,p.left),p.right=Math.max(v,p.right)}l.sort(((e,r)=>r.bottom-e.bottom||e.left-r.left));for(let e=l.length-1;e-- >0;){const r=l[e],s=l[e+1];r.bottom===s.bottom&&r.top===s.top&&r.left<=s.right&&r.right>=s.left&&(s.left=Math.min(s.left,r.left),s.right=Math.max(s.right,r.right),l.splice(e,1))}ae.set(e,{start:r,end:s,rects:l})}return l},e.getTextRenderInfo=getTextRenderInfo,e.preloadFont=function({font:e,characters:r,sdfGlyphSize:s},l){getTextRenderInfo({font:e,sdfGlyphSize:s,text:Array.isArray(r)?r.join("\n"):""+r},l)},e.typesetterWorkerModule=V,Object.defineProperty(e,"__esModule",{value:!0})},"object"==typeof exports&&"undefined"!=typeof module?r(exports,require("three"),require("troika-worker-utils"),require("webgl-sdf-generator"),require("bidi-js"),require("troika-three-utils")):"function"==typeof define&&define.amd?define(["exports","three","troika-worker-utils","webgl-sdf-generator","bidi-js","troika-three-utils"],r):r((e="undefined"!=typeof globalThis?globalThis:e||self).troika_three_text={},e.THREE,e.troika_worker_utils,e.webgl_sdf_generator,e.bidi_js,e.troika_three_utils);var s=Object.freeze({__proto__:null});const l="0.0.1";export{s as TroikaThreeText,l as version};
