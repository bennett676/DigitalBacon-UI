/*
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at https://mozilla.org/MPL/2.0/.
 */
import*as e from"three";import{Vector3 as r,Vector2 as s,Plane as l,Line3 as h,Box3 as u,Mesh as p,Triangle as m,Sphere as _,Matrix4 as v,BufferAttribute as x,FrontSide as b,Group as S,LineBasicMaterial as C,MeshBasicMaterial as A,DataTexture as I,NearestFilter as E,UnsignedIntType as R,IntType as B,FloatType as F,RGBAFormat as D,RGIntegerFormat as G,BufferGeometry as N,Matrix3 as H,Object3D as W,Ray as V,UnsignedByteType as j,UnsignedShortType as z,ByteType as X,ShortType as q,RGBAIntegerFormat as K,Vector4 as $,RGFormat as Y,RedFormat as Z,RedIntegerFormat as J,BackSide as Q,DoubleSide as ee,TrianglesDrawMode as te,TriangleFanDrawMode as ne,TriangleStripDrawMode as re,Quaternion as ie,Loader as se,LoaderUtils as oe,FileLoader as ae,Color as le,LinearSRGBColorSpace as he,SpotLight as ce,PointLight as de,DirectionalLight as ue,SRGBColorSpace as pe,MeshPhysicalMaterial as fe,InstancedMesh as ge,InstancedBufferAttribute as me,TextureLoader as _e,ImageBitmapLoader as ye,InterleavedBuffer as ve,InterleavedBufferAttribute as xe,LinearFilter as be,LinearMipmapLinearFilter as Te,RepeatWrapping as we,PointsMaterial as Se,Material as Ce,MeshStandardMaterial as Ae,PropertyBinding as Ie,SkinnedMesh as Ee,LineSegments as ke,Line as Re,LineLoop as Me,Points as Be,PerspectiveCamera as Le,MathUtils as Pe,OrthographicCamera as Ue,Skeleton as Fe,AnimationClip as De,Bone as Oe,InterpolateLinear as Ge,ColorManagement as Ne,NearestMipmapNearestFilter as He,LinearMipmapNearestFilter as We,NearestMipmapLinearFilter as Ve,ClampToEdgeWrapping as je,MirroredRepeatWrapping as ze,InterpolateDiscrete as Xe,Texture as qe,VectorKeyframeTrack as Ke,NumberKeyframeTrack as $e,QuaternionKeyframeTrack as Ye,Interpolant as Ze,SphereGeometry as Je,UniformsUtils as Qe,MeshDepthMaterial as et,RGBADepthPacking as tt,MeshDistanceMaterial as nt,ShaderChunk as rt,InstancedBufferGeometry as it,PlaneGeometry as st,Float32BufferAttribute as ot}from"three";class Style{constructor(e={}){this._listeners=new Set;for(let r of Style.PROPERTIES)r in e&&(this["_"+r]=e[r])}addUpdateListener(e){this._listeners.add(e)}removeUpdateListener(e){this._listeners.delete(e)}_genericGet(e){return this["_"+e]}_genericSet(e,r){this["_"+e]=r;for(let r of this._listeners)r(e)}get alignItems(){return this._genericGet("alignItems")}get backgroundVisible(){return this._genericGet("backgroundVisible")}get borderMaterial(){return this._genericGet("borderMaterial")}get borderRadius(){return this._genericGet("borderRadius")}get borderBottomLeftRadius(){return this._genericGet("borderBottomLeftRadius")}get borderBottomRightRadius(){return this._genericGet("borderBottomRightRadius")}get borderTopLeftRadius(){return this._genericGet("borderTopLeftRadius")}get borderTopRightRadius(){return this._genericGet("borderTopRightRadius")}get borderWidth(){return this._genericGet("borderWidth")}get color(){return this._genericGet("color")}get contentDirection(){return this._genericGet("contentDirection")}get font(){return this._genericGet("font")}get fontSize(){return this._genericGet("fontSize")}get glassmorphism(){return this._genericGet("glassmorphism")}get height(){return this._genericGet("height")}get justifyContent(){return this._genericGet("justifyContent")}get margin(){return this._genericGet("margin")}get marginBottom(){return this._genericGet("marginBottom")}get marginLeft(){return this._genericGet("marginLeft")}get marginRight(){return this._genericGet("marginRight")}get marginTop(){return this._genericGet("marginTop")}get material(){return this._genericGet("material")}get materialColor(){return this._genericGet("materialColor")}get maxHeight(){return this._genericGet("maxHeight")}get maxWidth(){return this._genericGet("maxWidth")}get minHeight(){return this._genericGet("minHeight")}get minWidth(){return this._genericGet("minWidth")}get opacity(){return this._genericGet("opacity")}get overflow(){return this._genericGet("overflow")}get padding(){return this._genericGet("padding")}get paddingBottom(){return this._genericGet("paddingBottom")}get paddingLeft(){return this._genericGet("paddingLeft")}get paddingRight(){return this._genericGet("paddingRight")}get paddingTop(){return this._genericGet("paddingTop")}get textAlign(){return this._genericGet("textAlign")}get textureFit(){return this._genericGet("textureFit")}get width(){return this._genericGet("width")}set alignItems(e){this._genericSet("alignItems",e)}set backgroundVisible(e){this._genericSet("backgroundVisible",e)}set borderMaterial(e){this._genericSet("borderMaterial",e)}set borderRadius(e){this._genericSet("borderRadius",e)}set borderBottomLeftRadius(e){this._genericSet("borderBottomLeftRadius",e)}set borderBottomRightRadius(e){this._genericSet("borderBottomRightRadius",e)}set borderTopLeftRadius(e){this._genericSet("borderTopLeftRadius",e)}set borderTopRightRadius(e){this._genericSet("borderTopRightRadius",e)}set borderWidth(e){this._genericSet("borderWidth",e)}set color(e){this._genericSet("color",e)}set contentDirection(e){this._genericSet("contentDirection",e)}set font(e){this._genericSet("font",e)}set fontSize(e){this._genericSet("fontSize",e)}set glassmorphism(e){this._genericSet("glassmorphism",e)}set height(e){this._genericSet("height",e)}set justifyContent(e){this._genericSet("justifyContent",e)}set margin(e){this._genericSet("margin",e)}set marginBottom(e){this._genericSet("marginBottom",e)}set marginLeft(e){this._genericSet("marginLeft",e)}set marginRight(e){this._genericSet("marginRight",e)}set marginTop(e){this._genericSet("marginTop",e)}set material(e){this._genericSet("material",e)}set materialColor(e){this._genericSet("materialColor",e)}set maxHeight(e){this._genericSet("maxHeight",e)}set maxWidth(e){this._genericSet("maxWidth",e)}set minHeight(e){this._genericSet("minHeight",e)}set minWidth(e){this._genericSet("minWidth",e)}set opacity(e){this._genericSet("opacity",e)}set overflow(e){this._genericSet("overflow",e)}set padding(e){this._genericSet("padding",e)}set paddingBottom(e){this._genericSet("paddingBottom",e)}set paddingLeft(e){this._genericSet("paddingLeft",e)}set paddingRight(e){this._genericSet("paddingRight",e)}set paddingTop(e){this._genericSet("paddingTop",e)}set textAlign(e){this._genericSet("textAlign",e)}set textureFit(e){this._genericSet("textureFit",e)}set width(e){this._genericSet("width",e)}static PROPERTIES=["alignItems","backgroundVisible","borderMaterial","borderRadius","borderBottomLeftRadius","borderBottomRightRadius","borderTopLeftRadius","borderTopRightRadius","borderWidth","color","contentDirection","font","fontSize","glassmorphism","height","justifyContent","margin","marginBottom","marginLeft","marginRight","marginTop","material","materialColor","maxHeight","maxWidth","minHeight","minWidth","padding","paddingBottom","paddingLeft","paddingRight","paddingTop","opacity","overflow","textAlign","textureFit","width"]}const at=0,lt=1,ht=2,ct=2,dt=1.25,ut=1,pt=32,ft=65535,gt=Math.pow(2,-24),mt=Symbol("SKIP_GENERATION");function getVertexCount(e){return e.index?e.index.count:e.attributes.position.count}function getTriCount(e){return getVertexCount(e)/3}function getIndexArray(e,r=ArrayBuffer){return e>65535?new Uint32Array(new r(4*e)):new Uint16Array(new r(2*e))}function getFullGeometryRange(e){const r=getTriCount(e),s=e.drawRange,l=s.start/3,h=(s.start+s.count)/3,u=Math.max(0,l),p=Math.min(r,h)-u;return[{offset:Math.floor(u),count:Math.floor(p)}]}function getRootIndexRanges(e){if(!e.groups||!e.groups.length)return getFullGeometryRange(e);const r=[],s=new Set,l=e.drawRange,h=l.start/3,u=(l.start+l.count)/3;for(const r of e.groups){const e=r.start/3,l=(r.start+r.count)/3;s.add(Math.max(h,e)),s.add(Math.min(u,l))}const p=Array.from(s.values()).sort(((e,r)=>e-r));for(let e=0;e<p.length-1;e++){const s=p[e],l=p[e+1];r.push({offset:Math.floor(s),count:Math.floor(l-s)})}return r}function getBounds(e,r,s,l,h){let u=1/0,p=1/0,m=1/0,_=-1/0,v=-1/0,x=-1/0,b=1/0,S=1/0,C=1/0,A=-1/0,I=-1/0,E=-1/0;for(let l=6*r,h=6*(r+s);l<h;l+=6){const r=e[l+0],s=e[l+1],h=r-s,R=r+s;h<u&&(u=h),R>_&&(_=R),r<b&&(b=r),r>A&&(A=r);const B=e[l+2],F=e[l+3],D=B-F,G=B+F;D<p&&(p=D),G>v&&(v=G),B<S&&(S=B),B>I&&(I=B);const N=e[l+4],H=e[l+5],W=N-H,V=N+H;W<m&&(m=W),V>x&&(x=V),N<C&&(C=N),N>E&&(E=N)}l[0]=u,l[1]=p,l[2]=m,l[3]=_,l[4]=v,l[5]=x,h[0]=b,h[1]=S,h[2]=C,h[3]=A,h[4]=I,h[5]=E}function arrayToBox(e,r,s){return s.min.x=r[e],s.min.y=r[e+1],s.min.z=r[e+2],s.max.x=r[e+3],s.max.y=r[e+4],s.max.z=r[e+5],s}function getLongestEdgeIndex(e){let r=-1,s=-1/0;for(let l=0;l<3;l++){const h=e[l+3]-e[l];h>s&&(s=h,r=l)}return r}function copyBounds(e,r){r.set(e)}function unionBounds(e,r,s){let l,h;for(let u=0;u<3;u++){const p=u+3;l=e[u],h=r[u],s[u]=l<h?l:h,l=e[p],h=r[p],s[p]=l>h?l:h}}function expandByTriangleBounds(e,r,s){for(let l=0;l<3;l++){const h=r[e+2*l],u=r[e+2*l+1],p=h-u,m=h+u;p<s[l]&&(s[l]=p),m>s[l+3]&&(s[l+3]=m)}}function computeSurfaceArea(e){const r=e[3]-e[0],s=e[4]-e[1],l=e[5]-e[2];return 2*(r*s+s*l+l*r)}const _t=32,binsSort=(e,r)=>e.candidate-r.candidate,yt=new Array(_t).fill().map((()=>({count:0,bounds:new Float32Array(6),rightCacheBounds:new Float32Array(6),leftCacheBounds:new Float32Array(6),candidate:0}))),vt=new Float32Array(6);class MeshBVHNode{constructor(){this.boundingData=new Float32Array(6)}}function partition(e,r,s,l,h,u){let p=l,m=l+h-1;const _=u.pos,v=2*u.axis;for(;;){for(;p<=m&&s[6*p+v]<_;)p++;for(;p<=m&&s[6*m+v]>=_;)m--;if(!(p<m))return p;for(let e=0;e<3;e++){let s=r[3*p+e];r[3*p+e]=r[3*m+e],r[3*m+e]=s}for(let e=0;e<6;e++){let r=s[6*p+e];s[6*p+e]=s[6*m+e],s[6*m+e]=r}p++,m--}}function partition_indirect(e,r,s,l,h,u){let p=l,m=l+h-1;const _=u.pos,v=2*u.axis;for(;;){for(;p<=m&&s[6*p+v]<_;)p++;for(;p<=m&&s[6*m+v]>=_;)m--;if(!(p<m))return p;{let r=e[p];e[p]=e[m],e[m]=r;for(let e=0;e<6;e++){let r=s[6*p+e];s[6*p+e]=s[6*m+e],s[6*m+e]=r}p++,m--}}}function IS_LEAF(e,r){return 65535===r[e+15]}function OFFSET(e,r){return r[e+6]}function COUNT(e,r){return r[e+14]}function LEFT_NODE(e){return e+8}function RIGHT_NODE(e,r){return r[e+6]}function SPLIT_AXIS(e,r){return r[e+7]}let xt,bt,Tt,wt;const St=Math.pow(2,32);function countNodes(e){return"count"in e?1:1+countNodes(e.left)+countNodes(e.right)}function populateBuffer(e,r,s){return xt=new Float32Array(s),bt=new Uint32Array(s),Tt=new Uint16Array(s),wt=new Uint8Array(s),_populateBuffer(e,r)}function _populateBuffer(e,r){const s=e/4,l=e/2,h="count"in r,u=r.boundingData;for(let e=0;e<6;e++)xt[s+e]=u[e];if(h){if(r.buffer){const l=r.buffer;wt.set(new Uint8Array(l),e);for(let r=e,h=e+l.byteLength;r<h;r+=pt){IS_LEAF(r/2,Tt)||(bt[r/4+6]+=s)}return e+l.byteLength}{const h=r.offset,u=r.count;return bt[s+6]=h,Tt[l+14]=u,Tt[l+15]=ft,e+pt}}{const l=r.left,h=r.right,u=r.splitAxis;let p;if(p=_populateBuffer(e+pt,l),p/4>St)throw new Error("MeshBVH: Cannot store child pointer greater than 32 bits.");return bt[s+6]=p/4,p=_populateBuffer(p,h),bt[s+7]=u,p}}function buildTree(e,r,s,l,h){const{maxDepth:u,verbose:p,maxLeafTris:m,strategy:_,onProgress:v,indirect:x}=h,b=e._indirectBuffer,S=e.geometry,C=S.index?S.index.array:null,A=x?partition_indirect:partition,I=getTriCount(S),E=new Float32Array(6);let R=!1;const B=new MeshBVHNode;return getBounds(r,s,l,B.boundingData,E),function splitNode(e,s,l,h=null,v=0){!R&&v>=u&&(R=!0,p&&(console.warn(`MeshBVH: Max depth of ${u} reached when generating BVH. Consider increasing maxDepth.`),console.warn(S)));if(l<=m||v>=u)return triggerProgress(s+l),e.offset=s,e.count=l,e;const x=function(e,r,s,l,h,u){let p=-1,m=0;if(u===at)p=getLongestEdgeIndex(r),-1!==p&&(m=(r[p]+r[p+3])/2);else if(u===lt)p=getLongestEdgeIndex(e),-1!==p&&(m=function(e,r,s,l){let h=0;for(let u=r,p=r+s;u<p;u++)h+=e[6*u+2*l];return h/s}(s,l,h,p));else if(u===ht){const u=computeSurfaceArea(e);let _=dt*h;const v=6*l,x=6*(l+h);for(let e=0;e<3;e++){const l=r[e],b=(r[e+3]-l)/_t;if(h<_t/4){const r=[...yt];r.length=h;let l=0;for(let h=v;h<x;h+=6,l++){const u=r[l];u.candidate=s[h+2*e],u.count=0;const{bounds:p,leftCacheBounds:m,rightCacheBounds:_}=u;for(let e=0;e<3;e++)_[e]=1/0,_[e+3]=-1/0,m[e]=1/0,m[e+3]=-1/0,p[e]=1/0,p[e+3]=-1/0;expandByTriangleBounds(h,s,p)}r.sort(binsSort);let b=h;for(let e=0;e<b;e++){const s=r[e];for(;e+1<b&&r[e+1].candidate===s.candidate;)r.splice(e+1,1),b--}for(let l=v;l<x;l+=6){const h=s[l+2*e];for(let e=0;e<b;e++){const u=r[e];h>=u.candidate?expandByTriangleBounds(l,s,u.rightCacheBounds):(expandByTriangleBounds(l,s,u.leftCacheBounds),u.count++)}}for(let s=0;s<b;s++){const l=r[s],v=l.count,x=h-l.count,b=l.leftCacheBounds,S=l.rightCacheBounds;let C=0;0!==v&&(C=computeSurfaceArea(b)/u);let A=0;0!==x&&(A=computeSurfaceArea(S)/u);const I=ut+dt*(C*v+A*x);I<_&&(p=e,_=I,m=l.candidate)}}else{for(let e=0;e<_t;e++){const r=yt[e];r.count=0,r.candidate=l+b+e*b;const s=r.bounds;for(let e=0;e<3;e++)s[e]=1/0,s[e+3]=-1/0}for(let r=v;r<x;r+=6){let h=~~((s[r+2*e]-l)/b);h>=_t&&(h=_t-1);const u=yt[h];u.count++,expandByTriangleBounds(r,s,u.bounds)}const r=yt[_t-1];copyBounds(r.bounds,r.rightCacheBounds);for(let e=_t-2;e>=0;e--){const r=yt[e],s=yt[e+1];unionBounds(r.bounds,s.rightCacheBounds,r.rightCacheBounds)}let S=0;for(let r=0;r<_t-1;r++){const s=yt[r],l=s.count,v=s.bounds,x=yt[r+1].rightCacheBounds;0!==l&&(0===S?copyBounds(v,vt):unionBounds(v,vt,vt)),S+=l;let b=0,C=0;0!==S&&(b=computeSurfaceArea(vt)/u);const A=h-S;0!==A&&(C=computeSurfaceArea(x)/u);const I=ut+dt*(b*S+C*A);I<_&&(p=e,_=I,m=s.candidate)}}}}else console.warn(`MeshBVH: Invalid build strategy value ${u} used.`);return{axis:p,pos:m}}(e.boundingData,h,r,s,l,_);if(-1===x.axis)return triggerProgress(s+l),e.offset=s,e.count=l,e;const I=A(b,C,r,s,l,x);if(I===s||I===s+l)triggerProgress(s+l),e.offset=s,e.count=l;else{e.splitAxis=x.axis;const h=new MeshBVHNode,u=s,p=I-s;e.left=h,getBounds(r,u,p,h.boundingData,E),splitNode(h,u,p,E,v+1);const m=new MeshBVHNode,_=I,b=l-p;e.right=m,getBounds(r,_,b,m.boundingData,E),splitNode(m,_,b,E,v+1)}return e}(B,s,l,E),B;function triggerProgress(e){v&&v(e/I)}}function buildPackedTree(e,r){const s=e.geometry;r.indirect&&(e._indirectBuffer=function(e,r){const s=(e.index?e.index.count:e.attributes.position.count)/3,l=s>65536,h=l?4:2,u=r?new SharedArrayBuffer(s*h):new ArrayBuffer(s*h),p=l?new Uint32Array(u):new Uint16Array(u);for(let e=0,r=p.length;e<r;e++)p[e]=e;return p}(s,r.useSharedArrayBuffer),function(e){if(0===e.groups.length)return!1;const r=getTriCount(e),s=getRootIndexRanges(e).sort(((e,r)=>e.offset-r.offset)),l=s[s.length-1];l.count=Math.min(r-l.offset,l.count);let h=0;return s.forEach((({count:e})=>h+=e)),r!==h}(s)&&!r.verbose&&console.warn('MeshBVH: Provided geometry contains groups that do not fully span the vertex contents while using the "indirect" option. BVH may incorrectly report intersections on unrendered portions of the geometry.')),e._indirectBuffer||function(e,r){if(!e.index){const s=e.attributes.position.count,l=getIndexArray(s,r.useSharedArrayBuffer?SharedArrayBuffer:ArrayBuffer);e.setIndex(new x(l,1));for(let e=0;e<s;e++)l[e]=e}}(s,r);const l=r.useSharedArrayBuffer?SharedArrayBuffer:ArrayBuffer,h=function(e,r=null,s=null,l=null){const h=e.attributes.position,u=e.index?e.index.array:null,p=getTriCount(e),m=h.normalized;let _;null===r?(_=new Float32Array(6*p*4),s=0,l=p):(_=r,s=s||0,l=l||p);const v=h.array,x=h.offset||0;let b=3;h.isInterleavedBufferAttribute&&(b=h.data.stride);const S=["getX","getY","getZ"];for(let e=s;e<s+l;e++){const r=3*e,s=6*e;let l=r+0,p=r+1,C=r+2;u&&(l=u[l],p=u[p],C=u[C]),m||(l=l*b+x,p=p*b+x,C=C*b+x);for(let e=0;e<3;e++){let r,u,x;m?(r=h[S[e]](l),u=h[S[e]](p),x=h[S[e]](C)):(r=v[l+e],u=v[p+e],x=v[C+e]);let b=r;u<b&&(b=u),x<b&&(b=x);let A=r;u>A&&(A=u),x>A&&(A=x);const I=(A-b)/2,E=2*e;_[s+E+0]=b+I,_[s+E+1]=I+(Math.abs(b)+I)*gt}}return _}(s),u=r.indirect?getFullGeometryRange(s):getRootIndexRanges(s);e._roots=u.map((s=>{const u=buildTree(e,h,s.offset,s.count,r),p=countNodes(u),m=new l(pt*p);return populateBuffer(0,u,m),m}))}class SeparatingAxisBounds{constructor(){this.min=1/0,this.max=-1/0}setFromPointsField(e,r){let s=1/0,l=-1/0;for(let h=0,u=e.length;h<u;h++){const u=e[h][r];s=u<s?u:s,l=u>l?u:l}this.min=s,this.max=l}setFromPoints(e,r){let s=1/0,l=-1/0;for(let h=0,u=r.length;h<u;h++){const u=r[h],p=e.dot(u);s=p<s?p:s,l=p>l?p:l}this.min=s,this.max=l}isSeparated(e){return this.min>e.max||e.min>this.max}}SeparatingAxisBounds.prototype.setFromBox=function(){const e=new r;return function(r,s){const l=s.min,h=s.max;let u=1/0,p=-1/0;for(let s=0;s<=1;s++)for(let m=0;m<=1;m++)for(let _=0;_<=1;_++){e.x=l.x*s+h.x*(1-s),e.y=l.y*m+h.y*(1-m),e.z=l.z*_+h.z*(1-_);const v=r.dot(e);u=Math.min(v,u),p=Math.max(v,p)}this.min=u,this.max=p}}();const Ct=function(){const e=new r,s=new r,l=new r;return function(r,h,u){const p=r.start,m=e,_=h.start,v=s;l.subVectors(p,_),e.subVectors(r.end,r.start),s.subVectors(h.end,h.start);const x=l.dot(v),b=v.dot(m),S=v.dot(v),C=l.dot(m),A=m.dot(m)*S-b*b;let I,E;I=0!==A?(x*b-C*S)/A:0,E=(x+I*b)/S,u.x=I,u.y=E}}(),At=function(){const e=new s,l=new r,h=new r;return function(r,s,u,p){Ct(r,s,e);let m=e.x,_=e.y;if(m>=0&&m<=1&&_>=0&&_<=1)return r.at(m,u),void s.at(_,p);if(m>=0&&m<=1)return _<0?s.at(0,p):s.at(1,p),void r.closestPointToPoint(p,!0,u);if(_>=0&&_<=1)return m<0?r.at(0,u):r.at(1,u),void s.closestPointToPoint(u,!0,p);{let e,v;e=m<0?r.start:r.end,v=_<0?s.start:s.end;const x=l,b=h;return r.closestPointToPoint(v,!0,l),s.closestPointToPoint(e,!0,h),x.distanceToSquared(v)<=b.distanceToSquared(e)?(u.copy(x),void p.copy(v)):(u.copy(e),void p.copy(b))}}}(),It=function(){const e=new r,s=new r,u=new l,p=new h;return function(r,l){const{radius:h,center:m}=r,{a:_,b:v,c:x}=l;p.start=_,p.end=v;if(p.closestPointToPoint(m,!0,e).distanceTo(m)<=h)return!0;p.start=_,p.end=x;if(p.closestPointToPoint(m,!0,e).distanceTo(m)<=h)return!0;p.start=v,p.end=x;if(p.closestPointToPoint(m,!0,e).distanceTo(m)<=h)return!0;const b=l.getPlane(u);if(Math.abs(b.distanceToPoint(m))<=h){const e=b.projectPoint(m,s);if(l.containsPoint(e))return!0}return!1}}();function isNearZero(e){return Math.abs(e)<1e-15}class ExtendedTriangle extends m{constructor(...e){super(...e),this.isExtendedTriangle=!0,this.satAxes=new Array(4).fill().map((()=>new r)),this.satBounds=new Array(4).fill().map((()=>new SeparatingAxisBounds)),this.points=[this.a,this.b,this.c],this.sphere=new _,this.plane=new l,this.needsUpdate=!0}intersectsSphere(e){return It(e,this)}update(){const e=this.a,r=this.b,s=this.c,l=this.points,h=this.satAxes,u=this.satBounds,p=h[0],m=u[0];this.getNormal(p),m.setFromPoints(p,l);const _=h[1],v=u[1];_.subVectors(e,r),v.setFromPoints(_,l);const x=h[2],b=u[2];x.subVectors(r,s),b.setFromPoints(x,l);const S=h[3],C=u[3];S.subVectors(s,e),C.setFromPoints(S,l),this.sphere.setFromPoints(this.points),this.plane.setFromNormalAndCoplanarPoint(p,e),this.needsUpdate=!1}}ExtendedTriangle.prototype.closestPointToSegment=function(){const e=new r,s=new r,l=new h;return function(r,h=null,u=null){const{start:p,end:m}=r,_=this.points;let v,x=1/0;for(let p=0;p<3;p++){const m=(p+1)%3;l.start.copy(_[p]),l.end.copy(_[m]),At(l,r,e,s),v=e.distanceToSquared(s),v<x&&(x=v,h&&h.copy(e),u&&u.copy(s))}return this.closestPointToPoint(p,e),v=p.distanceToSquared(e),v<x&&(x=v,h&&h.copy(e),u&&u.copy(p)),this.closestPointToPoint(m,e),v=m.distanceToSquared(e),v<x&&(x=v,h&&h.copy(e),u&&u.copy(m)),Math.sqrt(x)}}(),ExtendedTriangle.prototype.intersectsTriangle=function(){const e=new ExtendedTriangle,s=new Array(3),l=new Array(3),u=new SeparatingAxisBounds,p=new SeparatingAxisBounds,m=new r,_=new r,v=new r,x=new r,b=new r,S=new h,C=new h,A=new h,I=new r;function triIntersectPlane(e,r,s){const l=e.points;let h=0,u=-1;for(let e=0;e<3;e++){const{start:p,end:m}=S;p.copy(l[e]),m.copy(l[(e+1)%3]),S.delta(_);const v=isNearZero(r.distanceToPoint(p));if(isNearZero(r.normal.dot(_))&&v){s.copy(S),h=2;break}const x=r.intersectLine(S,I);if(!x&&v&&I.copy(p),(x||v)&&!isNearZero(I.distanceTo(m))){if(h<=1){(1===h?s.start:s.end).copy(I),v&&(u=h)}else if(h>=2){(1===u?s.start:s.end).copy(I),h=2;break}if(h++,2===h&&-1===u)break}}return h}return function(r,h=null,_=!1){this.needsUpdate&&this.update(),r.isExtendedTriangle?r.needsUpdate&&r.update():(e.copy(r),e.update(),r=e);const S=this.plane,I=r.plane;if(Math.abs(S.normal.dot(I.normal))>1-1e-10){const e=this.satBounds,v=this.satAxes;l[0]=r.a,l[1]=r.b,l[2]=r.c;for(let r=0;r<4;r++){const s=e[r],h=v[r];if(u.setFromPoints(h,l),s.isSeparated(u))return!1}const x=r.satBounds,b=r.satAxes;s[0]=this.a,s[1]=this.b,s[2]=this.c;for(let e=0;e<4;e++){const r=x[e],l=b[e];if(u.setFromPoints(l,s),r.isSeparated(u))return!1}for(let e=0;e<4;e++){const r=v[e];for(let e=0;e<4;e++){const h=b[e];if(m.crossVectors(r,h),u.setFromPoints(m,s),p.setFromPoints(m,l),u.isSeparated(p))return!1}}return h&&(_||console.warn("ExtendedTriangle.intersectsTriangle: Triangles are coplanar which does not support an output edge. Setting edge to 0, 0, 0."),h.start.set(0,0,0),h.end.set(0,0,0)),!0}{const e=triIntersectPlane(this,I,C);if(1===e&&r.containsPoint(C.end))return h&&(h.start.copy(C.end),h.end.copy(C.end)),!0;if(2!==e)return!1;const s=triIntersectPlane(r,S,A);if(1===s&&this.containsPoint(A.end))return h&&(h.start.copy(A.end),h.end.copy(A.end)),!0;if(2!==s)return!1;if(C.delta(v),A.delta(x),v.dot(x)<0){let e=A.start;A.start=A.end,A.end=e}const l=C.start.dot(v),u=C.end.dot(v),p=A.start.dot(v),m=A.end.dot(v);return(l===m||p===u||u<p!==l<m)&&(h&&(b.subVectors(C.start,A.start),b.dot(v)>0?h.start.copy(C.start):h.start.copy(A.start),b.subVectors(C.end,A.end),b.dot(v)<0?h.end.copy(C.end):h.end.copy(A.end)),!0)}}}(),ExtendedTriangle.prototype.distanceToPoint=function(){const e=new r;return function(r){return this.closestPointToPoint(r,e),r.distanceTo(e)}}(),ExtendedTriangle.prototype.distanceToTriangle=function(){const e=new r,s=new r,l=["a","b","c"],u=new h,p=new h;return function(r,h=null,m=null){const _=h||m?u:null;if(this.intersectsTriangle(r,_))return(h||m)&&(h&&_.getCenter(h),m&&_.getCenter(m)),0;let v=1/0;for(let s=0;s<3;s++){let u;const p=l[s],_=r[p];this.closestPointToPoint(_,e),u=_.distanceToSquared(e),u<v&&(v=u,h&&h.copy(e),m&&m.copy(_));const x=this[p];r.closestPointToPoint(x,e),u=x.distanceToSquared(e),u<v&&(v=u,h&&h.copy(x),m&&m.copy(e))}for(let _=0;_<3;_++){const x=l[_],b=l[(_+1)%3];u.set(this[x],this[b]);for(let _=0;_<3;_++){const x=l[_],b=l[(_+1)%3];p.set(r[x],r[b]),At(u,p,e,s);const S=e.distanceToSquared(s);S<v&&(v=S,h&&h.copy(e),m&&m.copy(s))}}return Math.sqrt(v)}}();class OrientedBox{constructor(e,s,l){this.isOrientedBox=!0,this.min=new r,this.max=new r,this.matrix=new v,this.invMatrix=new v,this.points=new Array(8).fill().map((()=>new r)),this.satAxes=new Array(3).fill().map((()=>new r)),this.satBounds=new Array(3).fill().map((()=>new SeparatingAxisBounds)),this.alignedSatBounds=new Array(3).fill().map((()=>new SeparatingAxisBounds)),this.needsUpdate=!1,e&&this.min.copy(e),s&&this.max.copy(s),l&&this.matrix.copy(l)}set(e,r,s){this.min.copy(e),this.max.copy(r),this.matrix.copy(s),this.needsUpdate=!0}copy(e){this.min.copy(e.min),this.max.copy(e.max),this.matrix.copy(e.matrix),this.needsUpdate=!0}}OrientedBox.prototype.update=function(){const e=this.matrix,r=this.min,s=this.max,l=this.points;for(let h=0;h<=1;h++)for(let u=0;u<=1;u++)for(let p=0;p<=1;p++){const m=l[1*h|2*u|4*p];m.x=h?s.x:r.x,m.y=u?s.y:r.y,m.z=p?s.z:r.z,m.applyMatrix4(e)}const h=this.satBounds,u=this.satAxes,p=l[0];for(let e=0;e<3;e++){const r=u[e],s=h[e],m=l[1<<e];r.subVectors(p,m),s.setFromPoints(r,l)}const m=this.alignedSatBounds;m[0].setFromPointsField(l,"x"),m[1].setFromPointsField(l,"y"),m[2].setFromPointsField(l,"z"),this.invMatrix.copy(this.matrix).invert(),this.needsUpdate=!1},OrientedBox.prototype.intersectsBox=function(){const e=new SeparatingAxisBounds;return function(r){this.needsUpdate&&this.update();const s=r.min,l=r.max,h=this.satBounds,u=this.satAxes,p=this.alignedSatBounds;if(e.min=s.x,e.max=l.x,p[0].isSeparated(e))return!1;if(e.min=s.y,e.max=l.y,p[1].isSeparated(e))return!1;if(e.min=s.z,e.max=l.z,p[2].isSeparated(e))return!1;for(let s=0;s<3;s++){const l=u[s],p=h[s];if(e.setFromBox(l,r),p.isSeparated(e))return!1}return!0}}(),OrientedBox.prototype.intersectsTriangle=function(){const e=new ExtendedTriangle,s=new Array(3),l=new SeparatingAxisBounds,h=new SeparatingAxisBounds,u=new r;return function(r){this.needsUpdate&&this.update(),r.isExtendedTriangle?r.needsUpdate&&r.update():(e.copy(r),e.update(),r=e);const p=this.satBounds,m=this.satAxes;s[0]=r.a,s[1]=r.b,s[2]=r.c;for(let e=0;e<3;e++){const r=p[e],h=m[e];if(l.setFromPoints(h,s),r.isSeparated(l))return!1}const _=r.satBounds,v=r.satAxes,x=this.points;for(let e=0;e<3;e++){const r=_[e],s=v[e];if(l.setFromPoints(s,x),r.isSeparated(l))return!1}for(let e=0;e<3;e++){const r=m[e];for(let e=0;e<4;e++){const p=v[e];if(u.crossVectors(r,p),l.setFromPoints(u,s),h.setFromPoints(u,x),l.isSeparated(h))return!1}}return!0}}(),OrientedBox.prototype.closestPointToPoint=function(e,r){return this.needsUpdate&&this.update(),r.copy(e).applyMatrix4(this.invMatrix).clamp(this.min,this.max).applyMatrix4(this.matrix),r},OrientedBox.prototype.distanceToPoint=function(){const e=new r;return function(r){return this.closestPointToPoint(r,e),r.distanceTo(e)}}(),OrientedBox.prototype.distanceToBox=function(){const e=["x","y","z"],s=new Array(12).fill().map((()=>new h)),l=new Array(12).fill().map((()=>new h)),u=new r,p=new r;return function(r,h=0,m=null,_=null){if(this.needsUpdate&&this.update(),this.intersectsBox(r))return(m||_)&&(r.getCenter(p),this.closestPointToPoint(p,u),r.closestPointToPoint(u,p),m&&m.copy(u),_&&_.copy(p)),0;const v=h*h,x=r.min,b=r.max,S=this.points;let C=1/0;for(let e=0;e<8;e++){const r=S[e];p.copy(r).clamp(x,b);const s=r.distanceToSquared(p);if(s<C&&(C=s,m&&m.copy(r),_&&_.copy(p),s<v))return Math.sqrt(s)}let A=0;for(let r=0;r<3;r++)for(let h=0;h<=1;h++)for(let u=0;u<=1;u++){const p=(r+1)%3,m=(r+2)%3,_=1<<r|h<<p|u<<m,v=S[h<<p|u<<m],C=S[_];s[A].set(v,C);const I=e[r],E=e[p],R=e[m],B=l[A],F=B.start,D=B.end;F[I]=x[I],F[E]=h?x[E]:b[E],F[R]=u?x[R]:b[E],D[I]=b[I],D[E]=h?x[E]:b[E],D[R]=u?x[R]:b[E],A++}for(let e=0;e<=1;e++)for(let r=0;r<=1;r++)for(let s=0;s<=1;s++){p.x=e?b.x:x.x,p.y=r?b.y:x.y,p.z=s?b.z:x.z,this.closestPointToPoint(p,u);const l=p.distanceToSquared(u);if(l<C&&(C=l,m&&m.copy(u),_&&_.copy(p),l<v))return Math.sqrt(l)}for(let e=0;e<12;e++){const r=s[e];for(let e=0;e<12;e++){const s=l[e];At(r,s,u,p);const h=u.distanceToSquared(p);if(h<C&&(C=h,m&&m.copy(u),_&&_.copy(p),h<v))return Math.sqrt(h)}}return Math.sqrt(C)}}();class PrimitivePool{constructor(e){this._getNewPrimitive=e,this._primitives=[]}getPrimitive(){const e=this._primitives;return 0===e.length?this._getNewPrimitive():e.pop()}releasePrimitive(e){this._primitives.push(e)}}class ExtendedTrianglePoolBase extends PrimitivePool{constructor(){super((()=>new ExtendedTriangle))}}const Et=new ExtendedTrianglePoolBase;const kt=new class{constructor(){this.float32Array=null,this.uint16Array=null,this.uint32Array=null;const e=[];let r=null;this.setBuffer=s=>{r&&e.push(r),r=s,this.float32Array=new Float32Array(s),this.uint16Array=new Uint16Array(s),this.uint32Array=new Uint32Array(s)},this.clearBuffer=()=>{r=null,this.float32Array=null,this.uint16Array=null,this.uint32Array=null,0!==e.length&&this.setBuffer(e.pop())}}};let Rt,Mt;const Bt=[],Lt=new PrimitivePool((()=>new u));function shapecast(e,r,s,l,h,u){Rt=Lt.getPrimitive(),Mt=Lt.getPrimitive(),Bt.push(Rt,Mt),kt.setBuffer(e._roots[r]);const p=shapecastTraverse(0,e.geometry,s,l,h,u);kt.clearBuffer(),Lt.releasePrimitive(Rt),Lt.releasePrimitive(Mt),Bt.pop(),Bt.pop();const m=Bt.length;return m>0&&(Mt=Bt[m-1],Rt=Bt[m-2]),p}function shapecastTraverse(e,r,s,l,h=null,u=0,p=0){const{float32Array:m,uint16Array:_,uint32Array:v}=kt;let x=2*e;if(IS_LEAF(x,_)){const b=OFFSET(e,v),S=COUNT(x,_);return arrayToBox(e,m,Rt),l(b,S,!1,p,u+e,Rt)}{const C=LEFT_NODE(e),A=RIGHT_NODE(e,v);let I,E,R,B,F=C,D=A;if(h&&(R=Rt,B=Mt,arrayToBox(F,m,R),arrayToBox(D,m,B),I=h(R),E=h(B),E<I)){F=A,D=C;const V=I;I=E,E=V,R=B}R||(R=Rt,arrayToBox(F,m,R));const G=s(R,IS_LEAF(2*F,_),I,p+1,u+F);let N;if(G===ct){const j=getLeftOffset(F);N=l(j,getRightEndOffset(F)-j,!0,p+1,u+F,R)}else N=G&&shapecastTraverse(F,r,s,l,h,u,p+1);if(N)return!0;B=Mt,arrayToBox(D,m,B);const H=s(B,IS_LEAF(2*D,_),E,p+1,u+D);let W;if(H===ct){const z=getLeftOffset(D);W=l(z,getRightEndOffset(D)-z,!0,p+1,u+D,B)}else W=H&&shapecastTraverse(D,r,s,l,h,u,p+1);return!!W;function getLeftOffset(e){const{uint16Array:r,uint32Array:s}=kt;let l=2*e;for(;!IS_LEAF(l,r);)l=2*(e=LEFT_NODE(e));return OFFSET(e,s)}function getRightEndOffset(e){const{uint16Array:r,uint32Array:s}=kt;let l=2*e;for(;!IS_LEAF(l,r);)l=2*(e=RIGHT_NODE(e,s));return OFFSET(e,s)+COUNT(l,r)}}}const Pt=new r,Ut=new r;const Ft=new r,Dt=new r,Ot=new r,Gt=new s,Nt=new s,Ht=new s,Wt=new r,Vt=new r,jt=new r,zt=new r;function checkBufferGeometryIntersection(e,l,h,u,p,_,v,x,b){Ft.fromBufferAttribute(l,_),Dt.fromBufferAttribute(l,v),Ot.fromBufferAttribute(l,x);const S=function(e,r,s,l,h,u){let p;return p=u===Q?e.intersectTriangle(l,s,r,!0,h):e.intersectTriangle(r,s,l,u!==ee,h),null===p?null:{distance:e.origin.distanceTo(h),point:h.clone()}}(e,Ft,Dt,Ot,zt,b);if(S){u&&(Gt.fromBufferAttribute(u,_),Nt.fromBufferAttribute(u,v),Ht.fromBufferAttribute(u,x),S.uv=m.getInterpolation(zt,Ft,Dt,Ot,Gt,Nt,Ht,new s)),p&&(Gt.fromBufferAttribute(p,_),Nt.fromBufferAttribute(p,v),Ht.fromBufferAttribute(p,x),S.uv1=m.getInterpolation(zt,Ft,Dt,Ot,Gt,Nt,Ht,new s)),h&&(Wt.fromBufferAttribute(h,_),Vt.fromBufferAttribute(h,v),jt.fromBufferAttribute(h,x),S.normal=m.getInterpolation(zt,Ft,Dt,Ot,Wt,Vt,jt,new r),S.normal.dot(e.direction)>0&&S.normal.multiplyScalar(-1));const l={a:_,b:v,c:x,normal:new r,materialIndex:0};m.getNormal(Ft,Dt,Ot,l.normal),S.face=l,S.faceIndex=_}return S}function intersectTri(e,r,s,l,h){const u=3*l;let p=u+0,m=u+1,_=u+2;const v=e.index;e.index&&(p=v.getX(p),m=v.getX(m),_=v.getX(_));const{position:x,normal:b,uv:S,uv1:C}=e.attributes,A=checkBufferGeometryIntersection(s,x,b,S,C,p,m,_,r);return A?(A.faceIndex=l,h&&h.push(A),A):null}function setTriangle(e,r,s,l){const h=e.a,u=e.b,p=e.c;let m=r,_=r+1,v=r+2;s&&(m=s.getX(m),_=s.getX(_),v=s.getX(v)),h.x=l.getX(m),h.y=l.getY(m),h.z=l.getZ(m),u.x=l.getX(_),u.y=l.getY(_),u.z=l.getZ(_),p.x=l.getX(v),p.y=l.getY(v),p.z=l.getZ(v)}const Xt=new r,qt=new r,Kt=new r,$t=new s,Yt=new s,Zt=new s;function iterateOverTriangles(e,r,s,l,h,u,p){const{geometry:m}=s,{index:_}=m,v=m.attributes.position;for(let s=e,m=r+e;s<m;s++){let e;if(e=s,setTriangle(p,3*e,_,v),p.needsUpdate=!0,l(p,e,h,u))return!0}return!1}function refit(e,r=null){r&&Array.isArray(r)&&(r=new Set(r));const s=e.geometry,l=s.index?s.index.array:null,h=s.attributes.position;let u,p,m,_,v=0;const x=e._roots;for(let e=0,r=x.length;e<r;e++)u=x[e],p=new Uint32Array(u),m=new Uint16Array(u),_=new Float32Array(u),_traverse(0,v),v+=u.byteLength;function _traverse(e,s,u=!1){const v=2*e;if(m[v+15]===ft){const r=p[e+6];let s=1/0,u=1/0,x=1/0,b=-1/0,S=-1/0,C=-1/0;for(let e=3*r,p=3*(r+m[v+14]);e<p;e++){let r=l[e];const p=h.getX(r),m=h.getY(r),_=h.getZ(r);p<s&&(s=p),p>b&&(b=p),m<u&&(u=m),m>S&&(S=m),_<x&&(x=_),_>C&&(C=_)}return(_[e+0]!==s||_[e+1]!==u||_[e+2]!==x||_[e+3]!==b||_[e+4]!==S||_[e+5]!==C)&&(_[e+0]=s,_[e+1]=u,_[e+2]=x,_[e+3]=b,_[e+4]=S,_[e+5]=C,!0)}{const l=e+8,h=p[e+6],m=l+s,v=h+s;let x=u,b=!1,S=!1;r?x||(b=r.has(m),S=r.has(v),x=!b&&!S):(b=!0,S=!0);const C=x||S;let A=!1;(x||b)&&(A=_traverse(l,s,x));let I=!1;C&&(I=_traverse(h,s,x));const E=A||I;if(E)for(let r=0;r<3;r++){const s=l+r,u=h+r,p=_[s],m=_[s+3],v=_[u],x=_[u+3];_[e+r]=p<v?p:v,_[e+r+3]=m>x?m:x}return E}}}function intersectRay(e,r,s){let l,h,u,p,m,_;const v=1/s.direction.x,x=1/s.direction.y,b=1/s.direction.z,S=s.origin.x,C=s.origin.y,A=s.origin.z;let I=r[e],E=r[e+3],R=r[e+1],B=r[e+3+1],F=r[e+2],D=r[e+3+2];return v>=0?(l=(I-S)*v,h=(E-S)*v):(l=(E-S)*v,h=(I-S)*v),x>=0?(u=(R-C)*x,p=(B-C)*x):(u=(B-C)*x,p=(R-C)*x),!(l>p||u>h)&&((u>l||isNaN(l))&&(l=u),(p<h||isNaN(h))&&(h=p),b>=0?(m=(F-A)*b,_=(D-A)*b):(m=(D-A)*b,_=(F-A)*b),!(l>_||m>h)&&((_<h||h!=h)&&(h=_),!(h<0)))}function iterateOverTriangles_indirect(e,r,s,l,h,u,p){const{geometry:m}=s,{index:_}=m,v=m.attributes.position;for(let m=e,x=r+e;m<x;m++){let e;if(e=s.resolveTriangleIndex(m),setTriangle(p,3*e,_,v),p.needsUpdate=!0,l(p,e,h,u))return!0}return!1}function raycast(e,r,s,l,h){kt.setBuffer(e._roots[r]),_raycast$1(0,e,s,l,h),kt.clearBuffer()}function _raycast$1(e,r,s,l,h){const{float32Array:u,uint16Array:p,uint32Array:m}=kt,_=2*e;if(IS_LEAF(_,p)){!function(e,r,s,l,h,u){const{geometry:p,_indirectBuffer:m}=e;for(let e=l,m=l+h;e<m;e++)intersectTri(p,r,s,e,u)}(r,s,l,OFFSET(e,m),COUNT(_,p),h)}else{const p=LEFT_NODE(e);intersectRay(p,u,l)&&_raycast$1(p,r,s,l,h);const _=RIGHT_NODE(e,m);intersectRay(_,u,l)&&_raycast$1(_,r,s,l,h)}}const Jt=["x","y","z"];function raycastFirst(e,r,s,l){kt.setBuffer(e._roots[r]);const h=_raycastFirst$1(0,e,s,l);return kt.clearBuffer(),h}function _raycastFirst$1(e,r,s,l){const{float32Array:h,uint16Array:u,uint32Array:p}=kt;let m=2*e;if(IS_LEAF(m,u)){return function(e,r,s,l,h){const{geometry:u,_indirectBuffer:p}=e;let m=1/0,_=null;for(let e=l,p=l+h;e<p;e++){let l;l=intersectTri(u,r,s,e),l&&l.distance<m&&(_=l,m=l.distance)}return _}(r,s,l,OFFSET(e,p),COUNT(m,u))}{const u=SPLIT_AXIS(e,p),m=Jt[u],_=l.direction[m]>=0;let v,x;_?(v=LEFT_NODE(e),x=RIGHT_NODE(e,p)):(v=RIGHT_NODE(e,p),x=LEFT_NODE(e));const b=intersectRay(v,h,l)?_raycastFirst$1(v,r,s,l):null;if(b){const e=b.point[m];if(_?e<=h[x+u]:e>=h[x+u+3])return b}const S=intersectRay(x,h,l)?_raycastFirst$1(x,r,s,l):null;return b&&S?b.distance<=S.distance?b:S:b||S||null}}const Qt=new u,en=new ExtendedTriangle,tn=new ExtendedTriangle,nn=new v,rn=new OrientedBox,sn=new OrientedBox;function intersectsGeometry(e,r,s,l){kt.setBuffer(e._roots[r]);const h=_intersectsGeometry$1(0,e,s,l);return kt.clearBuffer(),h}function _intersectsGeometry$1(e,r,s,l,h=null){const{float32Array:u,uint16Array:p,uint32Array:m}=kt;let _=2*e;null===h&&(s.boundingBox||s.computeBoundingBox(),rn.set(s.boundingBox.min,s.boundingBox.max,l),h=rn);if(!IS_LEAF(_,p)){const p=e+8,_=m[e+6];arrayToBox(p,u,Qt);if(h.intersectsBox(Qt)&&_intersectsGeometry$1(p,r,s,l,h))return!0;arrayToBox(_,u,Qt);return!!(h.intersectsBox(Qt)&&_intersectsGeometry$1(_,r,s,l,h))}{const h=r.geometry,v=h.index,x=h.attributes.position,b=s.index,S=s.attributes.position,C=OFFSET(e,m),A=COUNT(_,p);if(nn.copy(l).invert(),s.boundsTree){arrayToBox(e,u,sn),sn.matrix.copy(nn),sn.needsUpdate=!0;const r=s.boundsTree.shapecast({intersectsBounds:e=>sn.intersectsBox(e),intersectsTriangle:e=>{e.a.applyMatrix4(l),e.b.applyMatrix4(l),e.c.applyMatrix4(l),e.needsUpdate=!0;for(let r=3*C,s=3*(A+C);r<s;r+=3)if(setTriangle(tn,r,v,x),tn.needsUpdate=!0,e.intersectsTriangle(tn))return!0;return!1}});return r}for(let e=3*C,r=3*(A+C);e<r;e+=3){setTriangle(en,e,v,x),en.a.applyMatrix4(nn),en.b.applyMatrix4(nn),en.c.applyMatrix4(nn),en.needsUpdate=!0;for(let e=0,r=b.count;e<r;e+=3)if(setTriangle(tn,e,b,S),tn.needsUpdate=!0,en.intersectsTriangle(tn))return!0}}}const on=new v,an=new OrientedBox,ln=new OrientedBox,hn=new r,cn=new r,dn=new r,un=new r;function closestPointToGeometry(e,r,s,l={},h={},u=0,p=1/0){r.boundingBox||r.computeBoundingBox(),an.set(r.boundingBox.min,r.boundingBox.max,s),an.needsUpdate=!0;const m=e.geometry,_=m.attributes.position,v=m.index,x=r.attributes.position,b=r.index,S=Et.getPrimitive(),C=Et.getPrimitive();let A=hn,I=cn,E=null,R=null;h&&(E=dn,R=un);let B=1/0,F=null,D=null;return on.copy(s).invert(),ln.matrix.copy(on),e.shapecast({boundsTraverseOrder:e=>an.distanceToBox(e),intersectsBounds:(e,r,s)=>s<B&&s<p&&(r&&(ln.min.copy(e.min),ln.max.copy(e.max),ln.needsUpdate=!0),!0),intersectsRange:(e,l)=>{if(r.boundsTree){return r.boundsTree.shapecast({boundsTraverseOrder:e=>ln.distanceToBox(e),intersectsBounds:(e,r,s)=>s<B&&s<p,intersectsRange:(r,h)=>{for(let p=r,m=r+h;p<m;p++){setTriangle(C,3*p,b,x),C.a.applyMatrix4(s),C.b.applyMatrix4(s),C.c.applyMatrix4(s),C.needsUpdate=!0;for(let r=e,s=e+l;r<s;r++){setTriangle(S,3*r,v,_),S.needsUpdate=!0;const e=S.distanceToTriangle(C,A,E);if(e<B&&(I.copy(A),R&&R.copy(E),B=e,F=r,D=p),e<u)return!0}}}})}for(let h=0,p=getTriCount(r);h<p;h++){setTriangle(C,3*h,b,x),C.a.applyMatrix4(s),C.b.applyMatrix4(s),C.c.applyMatrix4(s),C.needsUpdate=!0;for(let r=e,s=e+l;r<s;r++){setTriangle(S,3*r,v,_),S.needsUpdate=!0;const e=S.distanceToTriangle(C,A,E);if(e<B&&(I.copy(A),R&&R.copy(E),B=e,F=r,D=h),e<u)return!0}}}}),Et.releasePrimitive(S),Et.releasePrimitive(C),B===1/0?null:(l.point?l.point.copy(I):l.point=I.clone(),l.distance=B,l.faceIndex=F,h&&(h.point?h.point.copy(R):h.point=R.clone(),h.point.applyMatrix4(on),I.applyMatrix4(on),h.distance=I.sub(h.point).length(),h.faceIndex=D),l)}function refit_indirect(e,r=null){r&&Array.isArray(r)&&(r=new Set(r));const s=e.geometry,l=s.index?s.index.array:null,h=s.attributes.position;let u,p,m,_,v=0;const x=e._roots;for(let e=0,r=x.length;e<r;e++)u=x[e],p=new Uint32Array(u),m=new Uint16Array(u),_=new Float32Array(u),_traverse(0,v),v+=u.byteLength;function _traverse(s,u,v=!1){const x=2*s;if(m[x+15]===ft){const r=p[s+6];let u=1/0,v=1/0,b=1/0,S=-1/0,C=-1/0,A=-1/0;for(let s=r,p=r+m[x+14];s<p;s++){const r=3*e.resolveTriangleIndex(s);for(let e=0;e<3;e++){let s=r+e;s=l?l[s]:s;const p=h.getX(s),m=h.getY(s),_=h.getZ(s);p<u&&(u=p),p>S&&(S=p),m<v&&(v=m),m>C&&(C=m),_<b&&(b=_),_>A&&(A=_)}}return(_[s+0]!==u||_[s+1]!==v||_[s+2]!==b||_[s+3]!==S||_[s+4]!==C||_[s+5]!==A)&&(_[s+0]=u,_[s+1]=v,_[s+2]=b,_[s+3]=S,_[s+4]=C,_[s+5]=A,!0)}{const e=s+8,l=p[s+6],h=e+u,m=l+u;let x=v,b=!1,S=!1;r?x||(b=r.has(h),S=r.has(m),x=!b&&!S):(b=!0,S=!0);const C=x||S;let A=!1;(x||b)&&(A=_traverse(e,u,x));let I=!1;C&&(I=_traverse(l,u,x));const E=A||I;if(E)for(let r=0;r<3;r++){const h=e+r,u=l+r,p=_[h],m=_[h+3],v=_[u],x=_[u+3];_[s+r]=p<v?p:v,_[s+r+3]=m>x?m:x}return E}}}function raycast_indirect(e,r,s,l,h){kt.setBuffer(e._roots[r]),_raycast(0,e,s,l,h),kt.clearBuffer()}function _raycast(e,r,s,l,h){const{float32Array:u,uint16Array:p,uint32Array:m}=kt,_=2*e;if(IS_LEAF(_,p)){!function(e,r,s,l,h,u){const{geometry:p,_indirectBuffer:m}=e;for(let e=l,_=l+h;e<_;e++)intersectTri(p,r,s,m?m[e]:e,u)}(r,s,l,OFFSET(e,m),COUNT(_,p),h)}else{const p=LEFT_NODE(e);intersectRay(p,u,l)&&_raycast(p,r,s,l,h);const _=RIGHT_NODE(e,m);intersectRay(_,u,l)&&_raycast(_,r,s,l,h)}}const pn=["x","y","z"];function raycastFirst_indirect(e,r,s,l){kt.setBuffer(e._roots[r]);const h=_raycastFirst(0,e,s,l);return kt.clearBuffer(),h}function _raycastFirst(e,r,s,l){const{float32Array:h,uint16Array:u,uint32Array:p}=kt;let m=2*e;if(IS_LEAF(m,u)){return function(e,r,s,l,h){const{geometry:u,_indirectBuffer:p}=e;let m=1/0,_=null;for(let e=l,v=l+h;e<v;e++){let l;l=intersectTri(u,r,s,p?p[e]:e),l&&l.distance<m&&(_=l,m=l.distance)}return _}(r,s,l,OFFSET(e,p),COUNT(m,u))}{const u=SPLIT_AXIS(e,p),m=pn[u],_=l.direction[m]>=0;let v,x;_?(v=LEFT_NODE(e),x=RIGHT_NODE(e,p)):(v=RIGHT_NODE(e,p),x=LEFT_NODE(e));const b=intersectRay(v,h,l)?_raycastFirst(v,r,s,l):null;if(b){const e=b.point[m];if(_?e<=h[x+u]:e>=h[x+u+3])return b}const S=intersectRay(x,h,l)?_raycastFirst(x,r,s,l):null;return b&&S?b.distance<=S.distance?b:S:b||S||null}}const fn=new u,gn=new ExtendedTriangle,mn=new ExtendedTriangle,_n=new v,yn=new OrientedBox,vn=new OrientedBox;function intersectsGeometry_indirect(e,r,s,l){kt.setBuffer(e._roots[r]);const h=_intersectsGeometry(0,e,s,l);return kt.clearBuffer(),h}function _intersectsGeometry(e,r,s,l,h=null){const{float32Array:u,uint16Array:p,uint32Array:m}=kt;let _=2*e;null===h&&(s.boundingBox||s.computeBoundingBox(),yn.set(s.boundingBox.min,s.boundingBox.max,l),h=yn);if(!IS_LEAF(_,p)){const p=e+8,_=m[e+6];arrayToBox(p,u,fn);if(h.intersectsBox(fn)&&_intersectsGeometry(p,r,s,l,h))return!0;arrayToBox(_,u,fn);return!!(h.intersectsBox(fn)&&_intersectsGeometry(_,r,s,l,h))}{const h=r.geometry,v=h.index,x=h.attributes.position,b=s.index,S=s.attributes.position,C=OFFSET(e,m),A=COUNT(_,p);if(_n.copy(l).invert(),s.boundsTree){arrayToBox(e,u,vn),vn.matrix.copy(_n),vn.needsUpdate=!0;const h=s.boundsTree.shapecast({intersectsBounds:e=>vn.intersectsBox(e),intersectsTriangle:e=>{e.a.applyMatrix4(l),e.b.applyMatrix4(l),e.c.applyMatrix4(l),e.needsUpdate=!0;for(let s=C,l=A+C;s<l;s++)if(setTriangle(mn,3*r.resolveTriangleIndex(s),v,x),mn.needsUpdate=!0,e.intersectsTriangle(mn))return!0;return!1}});return h}for(let e=C,s=A+C;e<s;e++){const s=r.resolveTriangleIndex(e);setTriangle(gn,3*s,v,x),gn.a.applyMatrix4(_n),gn.b.applyMatrix4(_n),gn.c.applyMatrix4(_n),gn.needsUpdate=!0;for(let e=0,r=b.count;e<r;e+=3)if(setTriangle(mn,e,b,S),mn.needsUpdate=!0,gn.intersectsTriangle(mn))return!0}}}const xn=new v,bn=new OrientedBox,Tn=new OrientedBox,wn=new r,Sn=new r,Cn=new r,An=new r;function closestPointToGeometry_indirect(e,r,s,l={},h={},u=0,p=1/0){r.boundingBox||r.computeBoundingBox(),bn.set(r.boundingBox.min,r.boundingBox.max,s),bn.needsUpdate=!0;const m=e.geometry,_=m.attributes.position,v=m.index,x=r.attributes.position,b=r.index,S=Et.getPrimitive(),C=Et.getPrimitive();let A=wn,I=Sn,E=null,R=null;h&&(E=Cn,R=An);let B=1/0,F=null,D=null;return xn.copy(s).invert(),Tn.matrix.copy(xn),e.shapecast({boundsTraverseOrder:e=>bn.distanceToBox(e),intersectsBounds:(e,r,s)=>s<B&&s<p&&(r&&(Tn.min.copy(e.min),Tn.max.copy(e.max),Tn.needsUpdate=!0),!0),intersectsRange:(l,h)=>{if(r.boundsTree){const m=r.boundsTree;return m.shapecast({boundsTraverseOrder:e=>Tn.distanceToBox(e),intersectsBounds:(e,r,s)=>s<B&&s<p,intersectsRange:(r,p)=>{for(let G=r,N=r+p;G<N;G++){const r=m.resolveTriangleIndex(G);setTriangle(C,3*r,b,x),C.a.applyMatrix4(s),C.b.applyMatrix4(s),C.c.applyMatrix4(s),C.needsUpdate=!0;for(let r=l,s=l+h;r<s;r++){const s=e.resolveTriangleIndex(r);setTriangle(S,3*s,v,_),S.needsUpdate=!0;const l=S.distanceToTriangle(C,A,E);if(l<B&&(I.copy(A),R&&R.copy(E),B=l,F=r,D=G),l<u)return!0}}}})}for(let p=0,m=getTriCount(r);p<m;p++){setTriangle(C,3*p,b,x),C.a.applyMatrix4(s),C.b.applyMatrix4(s),C.c.applyMatrix4(s),C.needsUpdate=!0;for(let r=l,s=l+h;r<s;r++){const s=e.resolveTriangleIndex(r);setTriangle(S,3*s,v,_),S.needsUpdate=!0;const l=S.distanceToTriangle(C,A,E);if(l<B&&(I.copy(A),R&&R.copy(E),B=l,F=r,D=p),l<u)return!0}}}}),Et.releasePrimitive(S),Et.releasePrimitive(C),B===1/0?null:(l.point?l.point.copy(I):l.point=I.clone(),l.distance=B,l.faceIndex=F,h&&(h.point?h.point.copy(R):h.point=R.clone(),h.point.applyMatrix4(xn),I.applyMatrix4(xn),h.distance=I.sub(h.point).length(),h.faceIndex=D),l)}function isSharedArrayBufferSupported(){return"undefined"!=typeof SharedArrayBuffer}const In=new kt.constructor,En=new kt.constructor,kn=new PrimitivePool((()=>new u)),Rn=new u,Mn=new u,Bn=new u,Ln=new u;let Pn=!1;function _traverse(e,r,s,l,h,u=0,p=0,m=0,_=0,v=null,x=!1){let b,S;x?(b=En,S=In):(b=In,S=En);const C=b.float32Array,A=b.uint32Array,I=b.uint16Array,E=S.float32Array,R=S.uint32Array,B=S.uint16Array,F=2*r,D=IS_LEAF(2*e,I),G=IS_LEAF(F,B);let N=!1;if(G&&D)N=x?h(OFFSET(r,R),COUNT(2*r,B),OFFSET(e,A),COUNT(2*e,I),_,p+r,m,u+e):h(OFFSET(e,A),COUNT(2*e,I),OFFSET(r,R),COUNT(2*r,B),m,u+e,_,p+r);else if(G){const v=kn.getPrimitive();arrayToBox(r,E,v),v.applyMatrix4(s);const b=LEFT_NODE(e),S=RIGHT_NODE(e,A);arrayToBox(b,C,Rn),arrayToBox(S,C,Mn);const I=v.intersectsBox(Rn),R=v.intersectsBox(Mn);N=I&&_traverse(r,b,l,s,h,p,u,_,m+1,v,!x)||R&&_traverse(r,S,l,s,h,p,u,_,m+1,v,!x),kn.releasePrimitive(v)}else{const b=LEFT_NODE(r),S=RIGHT_NODE(r,R);arrayToBox(b,E,Bn),arrayToBox(S,E,Ln);const I=v.intersectsBox(Bn),B=v.intersectsBox(Ln);if(I&&B)N=_traverse(e,b,s,l,h,u,p,m,_+1,v,x)||_traverse(e,S,s,l,h,u,p,m,_+1,v,x);else if(I)if(D)N=_traverse(e,b,s,l,h,u,p,m,_+1,v,x);else{const r=kn.getPrimitive();r.copy(Bn).applyMatrix4(s);const v=LEFT_NODE(e),S=RIGHT_NODE(e,A);arrayToBox(v,C,Rn),arrayToBox(S,C,Mn);const I=r.intersectsBox(Rn),E=r.intersectsBox(Mn);N=I&&_traverse(b,v,l,s,h,p,u,_,m+1,r,!x)||E&&_traverse(b,S,l,s,h,p,u,_,m+1,r,!x),kn.releasePrimitive(r)}else if(B)if(D)N=_traverse(e,S,s,l,h,u,p,m,_+1,v,x);else{const r=kn.getPrimitive();r.copy(Ln).applyMatrix4(s);const v=LEFT_NODE(e),b=RIGHT_NODE(e,A);arrayToBox(v,C,Rn),arrayToBox(b,C,Mn);const I=r.intersectsBox(Rn),E=r.intersectsBox(Mn);N=I&&_traverse(S,v,l,s,h,p,u,_,m+1,r,!x)||E&&_traverse(S,b,l,s,h,p,u,_,m+1,r,!x),kn.releasePrimitive(r)}}return N}const Un=new OrientedBox,Fn=new u,Dn={strategy:at,maxDepth:40,maxLeafTris:10,useSharedArrayBuffer:!1,setBoundingBox:!0,onProgress:null,indirect:!1,verbose:!0};class MeshBVH{static serialize(e,r={}){r={cloneBuffers:!0,...r};const s=e.geometry,l=e._roots,h=e._indirectBuffer,u=s.getIndex();let p;return p=r.cloneBuffers?{roots:l.map((e=>e.slice())),index:u?u.array.slice():null,indirectBuffer:h?h.slice():null}:{roots:l,index:u?u.array:null,indirectBuffer:h},p}static deserialize(e,r,s={}){s={setIndex:!0,indirect:Boolean(e.indirectBuffer),...s};const{index:l,roots:h,indirectBuffer:u}=e,p=new MeshBVH(r,{...s,[mt]:!0});if(p._roots=h,p._indirectBuffer=u||null,s.setIndex){const s=r.getIndex();if(null===s){const s=new x(e.index,1,!1);r.setIndex(s)}else s.array!==l&&(s.array.set(l),s.needsUpdate=!0)}return p}get indirect(){return!!this._indirectBuffer}constructor(e,r={}){if(!e.isBufferGeometry)throw new Error("MeshBVH: Only BufferGeometries are supported.");if(e.index&&e.index.isInterleavedBufferAttribute)throw new Error("MeshBVH: InterleavedBufferAttribute is not supported for the index attribute.");if((r=Object.assign({...Dn,[mt]:!1},r)).useSharedArrayBuffer&&!isSharedArrayBufferSupported())throw new Error("MeshBVH: SharedArrayBuffer is not available.");this.geometry=e,this._roots=null,this._indirectBuffer=null,r[mt]||(buildPackedTree(this,r),!e.boundingBox&&r.setBoundingBox&&(e.boundingBox=this.getBoundingBox(new u)));const{_indirectBuffer:s}=this;this.resolveTriangleIndex=r.indirect?e=>s[e]:e=>e}refit(e=null){return(this.indirect?refit_indirect:refit)(this,e)}traverse(e,r=0){const s=this._roots[r],l=new Uint32Array(s),h=new Uint16Array(s);!function _traverse(r,u=0){const p=2*r,m=h[p+15]===ft;if(m){const _=l[r+6],v=h[p+14];e(u,m,new Float32Array(s,4*r,6),_,v)}else{const h=r+pt/4,p=l[r+6],_=l[r+7];e(u,m,new Float32Array(s,4*r,6),_)||(_traverse(h,u+1),_traverse(p,u+1))}}(0)}raycast(e,r=b){const s=this._roots,l=this.geometry,h=[],u=r.isMaterial,p=Array.isArray(r),m=l.groups,_=u?r.side:r,v=this.indirect?raycast_indirect:raycast;for(let l=0,u=s.length;l<u;l++){const s=p?r[m[l].materialIndex].side:_,u=h.length;if(v(this,l,s,e,h),p){const e=m[l].materialIndex;for(let r=u,s=h.length;r<s;r++)h[r].face.materialIndex=e}}return h}raycastFirst(e,r=b){const s=this._roots,l=this.geometry,h=r.isMaterial,u=Array.isArray(r);let p=null;const m=l.groups,_=h?r.side:r,v=this.indirect?raycastFirst_indirect:raycastFirst;for(let l=0,h=s.length;l<h;l++){const s=v(this,l,u?r[m[l].materialIndex].side:_,e);null!=s&&(null==p||s.distance<p.distance)&&(p=s,u&&(s.face.materialIndex=m[l].materialIndex))}return p}intersectsGeometry(e,r){let s=!1;const l=this._roots,h=this.indirect?intersectsGeometry_indirect:intersectsGeometry;for(let u=0,p=l.length;u<p&&(s=h(this,u,e,r),!s);u++);return s}shapecast(e){const r=Et.getPrimitive(),s=this.indirect?iterateOverTriangles_indirect:iterateOverTriangles;let{boundsTraverseOrder:l,intersectsBounds:h,intersectsRange:u,intersectsTriangle:p}=e;if(u&&p){const e=u;u=(l,h,u,m,_)=>!!e(l,h,u,m,_)||s(l,h,this,p,u,m,r)}else u||(u=p?(e,l,h,u)=>s(e,l,this,p,h,u,r):(e,r,s)=>s);let m=!1,_=0;const v=this._roots;for(let e=0,r=v.length;e<r;e++){const r=v[e];if(m=shapecast(this,e,h,u,l,_),m)break;_+=r.byteLength}return Et.releasePrimitive(r),m}bvhcast(e,r,s){let{intersectsRanges:l,intersectsTriangles:h}=s;const u=Et.getPrimitive(),p=this.geometry.index,m=this.geometry.attributes.position,_=this.indirect?e=>{const r=this.resolveTriangleIndex(e);setTriangle(u,3*r,p,m)}:e=>{setTriangle(u,3*e,p,m)},x=Et.getPrimitive(),b=e.geometry.index,S=e.geometry.attributes.position,C=e.indirect?r=>{const s=e.resolveTriangleIndex(r);setTriangle(x,3*s,b,S)}:e=>{setTriangle(x,3*e,b,S)};if(h){const iterateOverDoubleTriangles=(e,s,l,p,m,v,b,S)=>{for(let A=l,I=l+p;A<I;A++){C(A),x.a.applyMatrix4(r),x.b.applyMatrix4(r),x.c.applyMatrix4(r),x.needsUpdate=!0;for(let r=e,l=e+s;r<l;r++)if(_(r),u.needsUpdate=!0,h(u,x,r,A,m,v,b,S))return!0}return!1};if(l){const e=l;l=function(r,s,l,h,u,p,m,_){return!!e(r,s,l,h,u,p,m,_)||iterateOverDoubleTriangles(r,s,l,h,u,p,m,_)}}else l=iterateOverDoubleTriangles}return function(e,r,s,l){if(Pn)throw new Error("MeshBVH: Recursive calls to bvhcast not supported.");Pn=!0;const h=e._roots,u=r._roots;let p,m=0,_=0;const x=(new v).copy(s).invert();for(let e=0,r=h.length;e<r;e++){In.setBuffer(h[e]),_=0;const r=kn.getPrimitive();arrayToBox(0,In.float32Array,r),r.applyMatrix4(x);for(let h=0,v=u.length;h<v&&(En.setBuffer(u[e]),p=_traverse(0,0,s,x,l,m,_,0,0,r),En.clearBuffer(),_+=u[h].length,!p);h++);if(kn.releasePrimitive(r),In.clearBuffer(),m+=h[e].length,p)break}return Pn=!1,p}(this,e,r,l)}intersectsBox(e,r){return Un.set(e.min,e.max,r),Un.needsUpdate=!0,this.shapecast({intersectsBounds:e=>Un.intersectsBox(e),intersectsTriangle:e=>Un.intersectsTriangle(e)})}intersectsSphere(e){return this.shapecast({intersectsBounds:r=>e.intersectsBox(r),intersectsTriangle:r=>r.intersectsSphere(e)})}closestPointToGeometry(e,r,s={},l={},h=0,u=1/0){return(this.indirect?closestPointToGeometry_indirect:closestPointToGeometry)(this,e,r,s,l,h,u)}closestPointToPoint(e,r={},s=0,l=1/0){return function(e,r,s={},l=0,h=1/0){const u=l*l,p=h*h;let m=1/0,_=null;if(e.shapecast({boundsTraverseOrder:e=>(Pt.copy(r).clamp(e.min,e.max),Pt.distanceToSquared(r)),intersectsBounds:(e,r,s)=>s<m&&s<p,intersectsTriangle:(e,s)=>{e.closestPointToPoint(r,Pt);const l=r.distanceToSquared(Pt);return l<m&&(Ut.copy(Pt),m=l,_=s),l<u}}),m===1/0)return null;const v=Math.sqrt(m);return s.point?s.point.copy(Ut):s.point=Ut.clone(),s.distance=v,s.faceIndex=_,s}(this,e,r,s,l)}getBoundingBox(e){e.makeEmpty();return this._roots.forEach((r=>{arrayToBox(0,new Float32Array(r),Fn),e.union(Fn)})),e}}const On=new u;class MeshBVHRootHelper extends W{get isMesh(){return!this.displayEdges}get isLineSegments(){return this.displayEdges}get isLine(){return this.displayEdges}constructor(e,r,s=10,l=0){super(),this.material=r,this.geometry=new N,this.name="MeshBVHRootHelper",this.depth=s,this.displayParents=!1,this.bvh=e,this.displayEdges=!0,this._group=l}raycast(){}update(){const e=this.geometry,r=this.bvh,s=this._group;if(e.dispose(),this.visible=!1,r){const l=this.depth-1,h=this.displayParents;let u=0;r.traverse(((e,r)=>{if(e>=l||r)return u++,!0;h&&u++}),s);let p=0;const m=new Float32Array(24*u);let _,v;r.traverse(((e,r,s)=>{const u=e>=l||r;if(u||h){arrayToBox(0,s,On);const{min:e,max:r}=On;for(let s=-1;s<=1;s+=2){const l=s<0?e.x:r.x;for(let s=-1;s<=1;s+=2){const h=s<0?e.y:r.y;for(let s=-1;s<=1;s+=2){const u=s<0?e.z:r.z;m[p+0]=l,m[p+1]=h,m[p+2]=u,p+=3}}}return u}}),s),v=this.displayEdges?new Uint8Array([0,4,1,5,2,6,3,7,0,2,1,3,4,6,5,7,0,1,2,3,4,5,6,7]):new Uint8Array([0,1,2,2,1,3,4,6,5,6,7,5,1,4,5,0,4,1,2,3,6,3,7,6,0,2,4,2,6,4,1,5,3,3,5,7]),_=m.length>65535?new Uint32Array(v.length*u):new Uint16Array(v.length*u);const b=v.length;for(let e=0;e<u;e++){const r=8*e,s=e*b;for(let e=0;e<b;e++)_[s+e]=r+v[e]}e.setIndex(new x(_,1,!1)),e.setAttribute("position",new x(m,3,!1)),this.visible=!0}}}class MeshBVHHelper extends S{get color(){return this.edgeMaterial.color}get opacity(){return this.edgeMaterial.opacity}set opacity(e){this.edgeMaterial.opacity=e,this.meshMaterial.opacity=e}constructor(e=null,r=null,s=10){e instanceof MeshBVH&&(s=r||10,r=e,e=null),"number"==typeof r&&(s=r,r=null),super(),this.name="MeshBVHHelper",this.depth=s,this.mesh=e,this.bvh=r,this.displayParents=!1,this.displayEdges=!0,this._roots=[];const l=new C({color:65416,transparent:!0,opacity:.3,depthWrite:!1}),h=new A({color:65416,transparent:!0,opacity:.3,depthWrite:!1});h.color=l.color,this.edgeMaterial=l,this.meshMaterial=h,this.update()}update(){const e=this.bvh||this.mesh.geometry.boundsTree,r=e?e._roots.length:0;for(;this._roots.length>r;){const e=this._roots.pop();e.geometry.dispose(),this.remove(e)}for(let s=0;s<r;s++){const{depth:r,edgeMaterial:l,meshMaterial:h,displayParents:u,displayEdges:p}=this;if(s>=this._roots.length){const h=new MeshBVHRootHelper(e,l,r,s);this.add(h),this._roots.push(h)}const m=this._roots[s];m.bvh=e,m.depth=r,m.displayParents=u,m.displayEdges=p,m.material=p?l:h,m.update()}}updateMatrixWorld(...e){const r=this.mesh,s=this.parent;null!==r&&(r.updateWorldMatrix(!0,!1),s?this.matrix.copy(s.matrixWorld).invert().multiply(r.matrixWorld):this.matrix.copy(r.matrixWorld),this.matrix.decompose(this.position,this.quaternion,this.scale)),super.updateMatrixWorld(...e)}copy(e){this.depth=e.depth,this.mesh=e.mesh,this.bvh=e.bvh,this.opacity=e.opacity,this.color.copy(e.color)}clone(){return new MeshBVHHelper(this.mesh,this.bvh,this.depth)}dispose(){this.edgeMaterial.dispose(),this.meshMaterial.dispose();const e=this.children;for(let r=0,s=e.length;r<s;r++)e[r].geometry.dispose()}}const Gn=new u,Nn=new u,Hn=new r;function getPrimitiveSize(e){switch(typeof e){case"number":return 8;case"string":return 2*e.length;case"boolean":return 4;default:return 0}}function convertRaycastIntersect(e,r,s){return null===e?null:(e.point.applyMatrix4(r.matrixWorld),e.distance=e.point.distanceTo(s.ray.origin),e.object=r,e.distance<s.near||e.distance>s.far?null:e)}const Wn=new V,Vn=new v,jn=p.prototype.raycast;function countToIntFormat(e){switch(e){case 1:return J;case 2:return G;case 3:case 4:return K}}class VertexAttributeTexture extends I{constructor(){super(),this.minFilter=E,this.magFilter=E,this.generateMipmaps=!1,this.overrideItemSize=null,this._forcedType=null}updateFrom(e){const r=this.overrideItemSize,s=e.itemSize,l=e.count;if(null!==r){if(s*l%r!=0)throw new Error("VertexAttributeTexture: overrideItemSize must divide evenly into buffer length.");e.itemSize=r,e.count=l*s/r}const h=e.itemSize,u=e.count,p=e.normalized,m=e.array.constructor,_=m.BYTES_PER_ELEMENT;let v,x,b,S,C=this._forcedType,A=h;if(null===C)switch(m){case Float32Array:C=F;break;case Uint8Array:case Uint16Array:case Uint32Array:C=R;break;case Int8Array:case Int16Array:case Int32Array:C=B}let I=function(e){switch(e){case 1:return"R";case 2:return"RG";case 3:case 4:return"RGBA"}throw new Error}(h);switch(C){case F:b=1,x=function(e){switch(e){case 1:return Z;case 2:return Y;case 3:case 4:return D}}(h),p&&1===_?(S=m,I+="8",m===Uint8Array?v=j:(v=X,I+="_SNORM")):(S=Float32Array,I+="32F",v=F);break;case B:I+=8*_+"I",b=p?Math.pow(2,8*m.BYTES_PER_ELEMENT-1):1,x=countToIntFormat(h),1===_?(S=Int8Array,v=X):2===_?(S=Int16Array,v=q):(S=Int32Array,v=B);break;case R:I+=8*_+"UI",b=p?Math.pow(2,8*m.BYTES_PER_ELEMENT-1):1,x=countToIntFormat(h),1===_?(S=Uint8Array,v=j):2===_?(S=Uint16Array,v=z):(S=Uint32Array,v=R)}3!==A||x!==D&&x!==K||(A=4);const E=Math.ceil(Math.sqrt(u))||1,G=new S(A*E*E),N=e.normalized;e.normalized=!1;for(let r=0;r<u;r++){const s=A*r;G[s]=e.getX(r)/b,h>=2&&(G[s+1]=e.getY(r)/b),h>=3&&(G[s+2]=e.getZ(r)/b,4===A&&(G[s+3]=1)),h>=4&&(G[s+3]=e.getW(r)/b)}e.normalized=N,this.internalFormat=I,this.format=x,this.type=v,this.image.width=E,this.image.height=E,this.image.data=G,this.needsUpdate=!0,this.dispose(),e.itemSize=s,e.count=l}}class UIntVertexAttributeTexture extends VertexAttributeTexture{constructor(){super(),this._forcedType=R}}class FloatVertexAttributeTexture extends VertexAttributeTexture{constructor(){super(),this._forcedType=F}}const zn=new r,Xn=new r,qn=new r,Kn=new $,$n=new r,Yn=new r,Zn=new $,Jn=new $,Qn=new v,er=new v;function validateAttributes(e,r){if(!e&&!r)return;const s=e.count===r.count,l=e.normalized===r.normalized,h=e.array.constructor===r.array.constructor,u=e.itemSize===r.itemSize;if(!(s&&l&&h&&u))throw new Error}function createAttributeClone(e,r=null){const s=e.array.constructor,l=e.normalized,h=e.itemSize,u=null===r?e.count:r;return new x(new s(h*u),h,l)}function copyAttributeContents(e,r,s=0){if(e.isInterleavedBufferAttribute){const l=e.itemSize;for(let h=0,u=e.count;h<u;h++){const u=h+s;r.setX(u,e.getX(h)),l>=2&&r.setY(u,e.getY(h)),l>=3&&r.setZ(u,e.getZ(h)),l>=4&&r.setW(u,e.getW(h))}}else{const l=r.array,h=l.constructor,u=l.BYTES_PER_ELEMENT*e.itemSize*s;new h(l.buffer,u,e.array.length).set(e.array)}}function addScaledMatrix(e,r,s){const l=e.elements,h=r.elements;for(let e=0,r=h.length;e<r;e++)l[e]+=h[e]*s}function boneNormalTransform(e,r,s){const l=e.skeleton,h=e.geometry,u=l.bones,p=l.boneInverses;Zn.fromBufferAttribute(h.attributes.skinIndex,r),Jn.fromBufferAttribute(h.attributes.skinWeight,r),Qn.elements.fill(0);for(let e=0;e<4;e++){const r=Jn.getComponent(e);if(0!==r){const s=Zn.getComponent(e);er.multiplyMatrices(u[s].matrixWorld,p[s]),addScaledMatrix(Qn,er,r)}}return Qn.multiply(e.bindMatrix).premultiply(e.bindMatrixInverse),s.transformDirection(Qn),s}function applyMorphTarget(e,r,s,l,h){$n.set(0,0,0);for(let u=0,p=e.length;u<p;u++){const p=r[u],m=e[u];0!==p&&(Yn.fromBufferAttribute(m,l),s?$n.addScaledVector(Yn,p):$n.addScaledVector(Yn.sub(h),p))}h.add($n)}class GeometryDiff{constructor(e){this.matrixWorld=new v,this.geometryHash=null,this.boneMatrices=null,this.primitiveCount=-1,this.mesh=e,this.update()}update(){const e=this.mesh,r=e.geometry,s=e.skeleton,l=(r.index?r.index.count:r.attributes.position.count)/3;if(this.matrixWorld.copy(e.matrixWorld),this.geometryHash=r.attributes.position.version,this.primitiveCount=l,s){s.boneTexture||s.computeBoneTexture(),s.update();const e=s.boneMatrices;this.boneMatrices&&this.boneMatrices.length===e.length?this.boneMatrices.set(e):this.boneMatrices=e.slice()}else this.boneMatrices=null}didChange(){const e=this.mesh,r=e.geometry,s=(r.index?r.index.count:r.attributes.position.count)/3,l=this.matrixWorld.equals(e.matrixWorld)&&this.geometryHash===r.attributes.position.version&&function(e,r){if(null===e||null===r)return e===r;if(e.length!==r.length)return!1;for(let s=0,l=e.length;s<l;s++)if(e[s]!==r[s])return!1;return!0}(e.skeleton&&e.skeleton.boneMatrices||null,this.boneMatrices)&&this.primitiveCount===s;return!l}}class StaticGeometryGenerator{constructor(e){Array.isArray(e)||(e=[e]);const r=[];e.forEach((e=>{e.traverseVisible((e=>{e.isMesh&&r.push(e)}))})),this.meshes=r,this.useGroups=!0,this.applyWorldTransforms=!0,this.attributes=["position","normal","color","tangent","uv","uv2"],this._intermediateGeometry=new Array(r.length).fill().map((()=>new N)),this._diffMap=new WeakMap}getMaterials(){const e=[];return this.meshes.forEach((r=>{Array.isArray(r.material)?e.push(...r.material):e.push(r.material)})),e}generate(e=new N){let r=[];const{meshes:s,useGroups:l,_intermediateGeometry:h,_diffMap:u}=this;for(let e=0,l=s.length;e<l;e++){const l=s[e],p=h[e],m=u.get(l);!m||m.didChange(l)?(this._convertToStaticGeometry(l,p),r.push(!1),m?m.update():u.set(l,new GeometryDiff(l))):r.push(!0)}if(0===h.length){e.setIndex(null);const r=e.attributes;for(const s in r)e.deleteAttribute(s);for(const r in this.attributes)e.setAttribute(this.attributes[r],new x(new Float32Array(0),4,!1))}else!function(e,r={useGroups:!1,updateIndex:!1,skipAttributes:[]},s=new N){const l=null!==e[0].index,{useGroups:h=!1,updateIndex:u=!1,skipAttributes:p=[]}=r,m=new Set(Object.keys(e[0].attributes)),_={};let v=0;s.clearGroups();for(let r=0;r<e.length;++r){const u=e[r];let p=0;if(l!==(null!==u.index))throw new Error("StaticGeometryGenerator: All geometries must have compatible attributes; make sure index attribute exists among all geometries, or in none of them.");for(const e in u.attributes){if(!m.has(e))throw new Error('StaticGeometryGenerator: All geometries must have compatible attributes; make sure "'+e+'" attribute exists among all geometries, or in none of them.');void 0===_[e]&&(_[e]=[]),_[e].push(u.attributes[e]),p++}if(p!==m.size)throw new Error("StaticGeometryGenerator: Make sure all geometries have the same number of attributes.");if(h){let e;if(l)e=u.index.count;else{if(void 0===u.attributes.position)throw new Error("StaticGeometryGenerator: The geometry must have either an index or a position attribute");e=u.attributes.position.count}s.addGroup(v,e,r),v+=e}}if(l){let r=!1;if(!s.index){let l=0;for(let r=0;r<e.length;++r)l+=e[r].index.count;s.setIndex(new x(new Uint32Array(l),1,!1)),r=!0}if(u||r){const r=s.index;let l=0,h=0;for(let s=0;s<e.length;++s){const u=e[s],m=u.index;if(!0!==p[s])for(let e=0;e<m.count;++e)r.setX(l,m.getX(e)+h),l++;h+=u.attributes.position.count}}}for(const e in _){const r=_[e];if(!(e in s.attributes)){let l=0;for(const e in r)l+=r[e].count;s.setAttribute(e,createAttributeClone(_[e][0],l))}const l=s.attributes[e];let h=0;for(let e=0,s=r.length;e<s;e++){const s=r[e];!0!==p[e]&&copyAttributeContents(s,l,h),h+=s.count}}}(h,{useGroups:l,skipAttributes:r},e);for(const r in e.attributes)e.attributes[r].needsUpdate=!0;return e}_convertToStaticGeometry(e,r=new N){const s=e.geometry,l=this.applyWorldTransforms,h=this.attributes.includes("normal"),u=this.attributes.includes("tangent"),p=s.attributes,m=r.attributes;!r.index&&s.index&&(r.index=s.index.clone()),m.position||r.setAttribute("position",createAttributeClone(p.position)),h&&!m.normal&&p.normal&&r.setAttribute("normal",createAttributeClone(p.normal)),u&&!m.tangent&&p.tangent&&r.setAttribute("tangent",createAttributeClone(p.tangent)),validateAttributes(s.index,r.index),validateAttributes(p.position,m.position),h&&validateAttributes(p.normal,m.normal),u&&validateAttributes(p.tangent,m.tangent);const _=p.position,v=h?p.normal:null,x=u?p.tangent:null,b=s.morphAttributes.position,S=s.morphAttributes.normal,C=s.morphAttributes.tangent,A=s.morphTargetsRelative,I=e.morphTargetInfluences,E=new H;E.getNormalMatrix(e.matrixWorld),s.index&&r.index.array.set(s.index.array);for(let r=0,s=p.position.count;r<s;r++)zn.fromBufferAttribute(_,r),v&&Xn.fromBufferAttribute(v,r),x&&(Kn.fromBufferAttribute(x,r),qn.fromBufferAttribute(x,r)),I&&(b&&applyMorphTarget(b,I,A,r,zn),S&&applyMorphTarget(S,I,A,r,Xn),C&&applyMorphTarget(C,I,A,r,qn)),e.isSkinnedMesh&&(e.applyBoneTransform(r,zn),v&&boneNormalTransform(e,r,Xn),x&&boneNormalTransform(e,r,qn)),l&&zn.applyMatrix4(e.matrixWorld),m.position.setXYZ(r,zn.x,zn.y,zn.z),v&&(l&&Xn.applyNormalMatrix(E),m.normal.setXYZ(r,Xn.x,Xn.y,Xn.z)),x&&(l&&qn.transformDirection(e.matrixWorld),m.tangent.setXYZW(r,qn.x,qn.y,qn.z,Kn.w));for(const e in this.attributes){const s=this.attributes[e];"position"!==s&&"tangent"!==s&&"normal"!==s&&s in p&&(m[s]||r.setAttribute(s,createAttributeClone(p[s])),validateAttributes(p[s],m[s]),copyAttributeContents(p[s],m[s]))}return e.matrixWorld.determinant()<0&&function(e){const{index:r,attributes:s}=e;if(r)for(let e=0,s=r.count;e<s;e+=3){const s=r.getX(e),l=r.getX(e+2);r.setX(e,l),r.setX(e+2,s)}else for(const e in s){const r=s[e],l=r.itemSize;for(let e=0,s=r.count;e<s;e+=3)for(let s=0;s<l;s++){const l=r.getComponent(e,s),h=r.getComponent(e+2,s);r.setComponent(e,s,h),r.setComponent(e+2,s,l)}}}(r),r}}const tr="\n\n// A stack of uint32 indices can can store the indices for\n// a perfectly balanced tree with a depth up to 31. Lower stack\n// depth gets higher performance.\n//\n// However not all trees are balanced. Best value to set this to\n// is the trees max depth.\n#ifndef BVH_STACK_DEPTH\n#define BVH_STACK_DEPTH 60\n#endif\n\n#ifndef INFINITY\n#define INFINITY 1e20\n#endif\n\n// Utilities\nuvec4 uTexelFetch1D( usampler2D tex, uint index ) {\n\n\tuint width = uint( textureSize( tex, 0 ).x );\n\tuvec2 uv;\n\tuv.x = index % width;\n\tuv.y = index / width;\n\n\treturn texelFetch( tex, ivec2( uv ), 0 );\n\n}\n\nivec4 iTexelFetch1D( isampler2D tex, uint index ) {\n\n\tuint width = uint( textureSize( tex, 0 ).x );\n\tuvec2 uv;\n\tuv.x = index % width;\n\tuv.y = index / width;\n\n\treturn texelFetch( tex, ivec2( uv ), 0 );\n\n}\n\nvec4 texelFetch1D( sampler2D tex, uint index ) {\n\n\tuint width = uint( textureSize( tex, 0 ).x );\n\tuvec2 uv;\n\tuv.x = index % width;\n\tuv.y = index / width;\n\n\treturn texelFetch( tex, ivec2( uv ), 0 );\n\n}\n\nvec4 textureSampleBarycoord( sampler2D tex, vec3 barycoord, uvec3 faceIndices ) {\n\n\treturn\n\t\tbarycoord.x * texelFetch1D( tex, faceIndices.x ) +\n\t\tbarycoord.y * texelFetch1D( tex, faceIndices.y ) +\n\t\tbarycoord.z * texelFetch1D( tex, faceIndices.z );\n\n}\n\nvoid ndcToCameraRay(\n\tvec2 coord, mat4 cameraWorld, mat4 invProjectionMatrix,\n\tout vec3 rayOrigin, out vec3 rayDirection\n) {\n\n\t// get camera look direction and near plane for camera clipping\n\tvec4 lookDirection = cameraWorld * vec4( 0.0, 0.0, - 1.0, 0.0 );\n\tvec4 nearVector = invProjectionMatrix * vec4( 0.0, 0.0, - 1.0, 1.0 );\n\tfloat near = abs( nearVector.z / nearVector.w );\n\n\t// get the camera direction and position from camera matrices\n\tvec4 origin = cameraWorld * vec4( 0.0, 0.0, 0.0, 1.0 );\n\tvec4 direction = invProjectionMatrix * vec4( coord, 0.5, 1.0 );\n\tdirection /= direction.w;\n\tdirection = cameraWorld * direction - origin;\n\n\t// slide the origin along the ray until it sits at the near clip plane position\n\torigin.xyz += direction.xyz * near / dot( direction, lookDirection );\n\n\trayOrigin = origin.xyz;\n\trayDirection = direction.xyz;\n\n}\n",nr="\n\nfloat dot2( vec3 v ) {\n\n\treturn dot( v, v );\n\n}\n\n// https://www.shadertoy.com/view/ttfGWl\nvec3 closestPointToTriangle( vec3 p, vec3 v0, vec3 v1, vec3 v2, out vec3 barycoord ) {\n\n    vec3 v10 = v1 - v0;\n    vec3 v21 = v2 - v1;\n    vec3 v02 = v0 - v2;\n\n\tvec3 p0 = p - v0;\n\tvec3 p1 = p - v1;\n\tvec3 p2 = p - v2;\n\n    vec3 nor = cross( v10, v02 );\n\n    // method 2, in barycentric space\n    vec3  q = cross( nor, p0 );\n    float d = 1.0 / dot2( nor );\n    float u = d * dot( q, v02 );\n    float v = d * dot( q, v10 );\n    float w = 1.0 - u - v;\n\n\tif( u < 0.0 ) {\n\n\t\tw = clamp( dot( p2, v02 ) / dot2( v02 ), 0.0, 1.0 );\n\t\tu = 0.0;\n\t\tv = 1.0 - w;\n\n\t} else if( v < 0.0 ) {\n\n\t\tu = clamp( dot( p0, v10 ) / dot2( v10 ), 0.0, 1.0 );\n\t\tv = 0.0;\n\t\tw = 1.0 - u;\n\n\t} else if( w < 0.0 ) {\n\n\t\tv = clamp( dot( p1, v21 ) / dot2( v21 ), 0.0, 1.0 );\n\t\tw = 0.0;\n\t\tu = 1.0-v;\n\n\t}\n\n\tbarycoord = vec3( u, v, w );\n    return u * v1 + v * v2 + w * v0;\n\n}\n\nfloat distanceToTriangles(\n\t// geometry info and triangle range\n\tsampler2D positionAttr, usampler2D indexAttr, uint offset, uint count,\n\n\t// point and cut off range\n\tvec3 point, float closestDistanceSquared,\n\n\t// outputs\n\tinout uvec4 faceIndices, inout vec3 faceNormal, inout vec3 barycoord, inout float side, inout vec3 outPoint\n) {\n\n\tbool found = false;\n\tvec3 localBarycoord;\n\tfor ( uint i = offset, l = offset + count; i < l; i ++ ) {\n\n\t\tuvec3 indices = uTexelFetch1D( indexAttr, i ).xyz;\n\t\tvec3 a = texelFetch1D( positionAttr, indices.x ).rgb;\n\t\tvec3 b = texelFetch1D( positionAttr, indices.y ).rgb;\n\t\tvec3 c = texelFetch1D( positionAttr, indices.z ).rgb;\n\n\t\t// get the closest point and barycoord\n\t\tvec3 closestPoint = closestPointToTriangle( point, a, b, c, localBarycoord );\n\t\tvec3 delta = point - closestPoint;\n\t\tfloat sqDist = dot2( delta );\n\t\tif ( sqDist < closestDistanceSquared ) {\n\n\t\t\t// set the output results\n\t\t\tclosestDistanceSquared = sqDist;\n\t\t\tfaceIndices = uvec4( indices.xyz, i );\n\t\t\tfaceNormal = normalize( cross( a - b, b - c ) );\n\t\t\tbarycoord = localBarycoord;\n\t\t\toutPoint = closestPoint;\n\t\t\tside = sign( dot( faceNormal, delta ) );\n\n\t\t}\n\n\t}\n\n\treturn closestDistanceSquared;\n\n}\n\nfloat distanceSqToBounds( vec3 point, vec3 boundsMin, vec3 boundsMax ) {\n\n\tvec3 clampedPoint = clamp( point, boundsMin, boundsMax );\n\tvec3 delta = point - clampedPoint;\n\treturn dot( delta, delta );\n\n}\n\nfloat distanceSqToBVHNodeBoundsPoint( vec3 point, sampler2D bvhBounds, uint currNodeIndex ) {\n\n\tuint cni2 = currNodeIndex * 2u;\n\tvec3 boundsMin = texelFetch1D( bvhBounds, cni2 ).xyz;\n\tvec3 boundsMax = texelFetch1D( bvhBounds, cni2 + 1u ).xyz;\n\treturn distanceSqToBounds( point, boundsMin, boundsMax );\n\n}\n\n// use a macro to hide the fact that we need to expand the struct into separate fields\n#define\tbvhClosestPointToPoint(\t\tbvh,\t\tpoint, faceIndices, faceNormal, barycoord, side, outPoint\t)\t_bvhClosestPointToPoint(\t\tbvh.position, bvh.index, bvh.bvhBounds, bvh.bvhContents,\t\tpoint, faceIndices, faceNormal, barycoord, side, outPoint\t)\n\nfloat _bvhClosestPointToPoint(\n\t// bvh info\n\tsampler2D bvh_position, usampler2D bvh_index, sampler2D bvh_bvhBounds, usampler2D bvh_bvhContents,\n\n\t// point to check\n\tvec3 point,\n\n\t// output variables\n\tinout uvec4 faceIndices, inout vec3 faceNormal, inout vec3 barycoord,\n\tinout float side, inout vec3 outPoint\n ) {\n\n\t// stack needs to be twice as long as the deepest tree we expect because\n\t// we push both the left and right child onto the stack every traversal\n\tint ptr = 0;\n\tuint stack[ BVH_STACK_DEPTH ];\n\tstack[ 0 ] = 0u;\n\n\tfloat closestDistanceSquared = pow( 100000.0, 2.0 );\n\tbool found = false;\n\twhile ( ptr > - 1 && ptr < BVH_STACK_DEPTH ) {\n\n\t\tuint currNodeIndex = stack[ ptr ];\n\t\tptr --;\n\n\t\t// check if we intersect the current bounds\n\t\tfloat boundsHitDistance = distanceSqToBVHNodeBoundsPoint( point, bvh_bvhBounds, currNodeIndex );\n\t\tif ( boundsHitDistance > closestDistanceSquared ) {\n\n\t\t\tcontinue;\n\n\t\t}\n\n\t\tuvec2 boundsInfo = uTexelFetch1D( bvh_bvhContents, currNodeIndex ).xy;\n\t\tbool isLeaf = bool( boundsInfo.x & 0xffff0000u );\n\t\tif ( isLeaf ) {\n\n\t\t\tuint count = boundsInfo.x & 0x0000ffffu;\n\t\t\tuint offset = boundsInfo.y;\n\t\t\tclosestDistanceSquared = distanceToTriangles(\n\t\t\t\tbvh_position, bvh_index, offset, count, point, closestDistanceSquared,\n\n\t\t\t\t// outputs\n\t\t\t\tfaceIndices, faceNormal, barycoord, side, outPoint\n\t\t\t);\n\n\t\t} else {\n\n\t\t\tuint leftIndex = currNodeIndex + 1u;\n\t\t\tuint splitAxis = boundsInfo.x & 0x0000ffffu;\n\t\t\tuint rightIndex = boundsInfo.y;\n\t\t\tbool leftToRight = distanceSqToBVHNodeBoundsPoint( point, bvh_bvhBounds, leftIndex ) < distanceSqToBVHNodeBoundsPoint( point, bvh_bvhBounds, rightIndex );//rayDirection[ splitAxis ] >= 0.0;\n\t\t\tuint c1 = leftToRight ? leftIndex : rightIndex;\n\t\t\tuint c2 = leftToRight ? rightIndex : leftIndex;\n\n\t\t\t// set c2 in the stack so we traverse it later. We need to keep track of a pointer in\n\t\t\t// the stack while we traverse. The second pointer added is the one that will be\n\t\t\t// traversed first\n\t\t\tptr ++;\n\t\t\tstack[ ptr ] = c2;\n\t\t\tptr ++;\n\t\t\tstack[ ptr ] = c1;\n\n\t\t}\n\n\t}\n\n\treturn sqrt( closestDistanceSquared );\n\n}\n",rr="\n\n#ifndef TRI_INTERSECT_EPSILON\n#define TRI_INTERSECT_EPSILON 1e-5\n#endif\n\n// Raycasting\nbool intersectsBounds( vec3 rayOrigin, vec3 rayDirection, vec3 boundsMin, vec3 boundsMax, out float dist ) {\n\n\t// https://www.reddit.com/r/opengl/comments/8ntzz5/fast_glsl_ray_box_intersection/\n\t// https://tavianator.com/2011/ray_box.html\n\tvec3 invDir = 1.0 / rayDirection;\n\n\t// find intersection distances for each plane\n\tvec3 tMinPlane = invDir * ( boundsMin - rayOrigin );\n\tvec3 tMaxPlane = invDir * ( boundsMax - rayOrigin );\n\n\t// get the min and max distances from each intersection\n\tvec3 tMinHit = min( tMaxPlane, tMinPlane );\n\tvec3 tMaxHit = max( tMaxPlane, tMinPlane );\n\n\t// get the furthest hit distance\n\tvec2 t = max( tMinHit.xx, tMinHit.yz );\n\tfloat t0 = max( t.x, t.y );\n\n\t// get the minimum hit distance\n\tt = min( tMaxHit.xx, tMaxHit.yz );\n\tfloat t1 = min( t.x, t.y );\n\n\t// set distance to 0.0 if the ray starts inside the box\n\tdist = max( t0, 0.0 );\n\n\treturn t1 >= dist;\n\n}\n\nbool intersectsTriangle(\n\tvec3 rayOrigin, vec3 rayDirection, vec3 a, vec3 b, vec3 c,\n\tout vec3 barycoord, out vec3 norm, out float dist, out float side\n) {\n\n\t// https://stackoverflow.com/questions/42740765/intersection-between-line-and-triangle-in-3d\n\tvec3 edge1 = b - a;\n\tvec3 edge2 = c - a;\n\tnorm = cross( edge1, edge2 );\n\n\tfloat det = - dot( rayDirection, norm );\n\tfloat invdet = 1.0 / det;\n\n\tvec3 AO = rayOrigin - a;\n\tvec3 DAO = cross( AO, rayDirection );\n\n\tvec4 uvt;\n\tuvt.x = dot( edge2, DAO ) * invdet;\n\tuvt.y = - dot( edge1, DAO ) * invdet;\n\tuvt.z = dot( AO, norm ) * invdet;\n\tuvt.w = 1.0 - uvt.x - uvt.y;\n\n\t// set the hit information\n\tbarycoord = uvt.wxy; // arranged in A, B, C order\n\tdist = uvt.z;\n\tside = sign( det );\n\tnorm = side * normalize( norm );\n\n\t// add an epsilon to avoid misses between triangles\n\tuvt += vec4( TRI_INTERSECT_EPSILON );\n\n\treturn all( greaterThanEqual( uvt, vec4( 0.0 ) ) );\n\n}\n\nbool intersectTriangles(\n\t// geometry info and triangle range\n\tsampler2D positionAttr, usampler2D indexAttr, uint offset, uint count,\n\n\t// ray\n\tvec3 rayOrigin, vec3 rayDirection,\n\n\t// outputs\n\tinout float minDistance, inout uvec4 faceIndices, inout vec3 faceNormal, inout vec3 barycoord,\n\tinout float side, inout float dist\n) {\n\n\tbool found = false;\n\tvec3 localBarycoord, localNormal;\n\tfloat localDist, localSide;\n\tfor ( uint i = offset, l = offset + count; i < l; i ++ ) {\n\n\t\tuvec3 indices = uTexelFetch1D( indexAttr, i ).xyz;\n\t\tvec3 a = texelFetch1D( positionAttr, indices.x ).rgb;\n\t\tvec3 b = texelFetch1D( positionAttr, indices.y ).rgb;\n\t\tvec3 c = texelFetch1D( positionAttr, indices.z ).rgb;\n\n\t\tif (\n\t\t\tintersectsTriangle( rayOrigin, rayDirection, a, b, c, localBarycoord, localNormal, localDist, localSide )\n\t\t\t&& localDist < minDistance\n\t\t) {\n\n\t\t\tfound = true;\n\t\t\tminDistance = localDist;\n\n\t\t\tfaceIndices = uvec4( indices.xyz, i );\n\t\t\tfaceNormal = localNormal;\n\n\t\t\tside = localSide;\n\t\t\tbarycoord = localBarycoord;\n\t\t\tdist = localDist;\n\n\t\t}\n\n\t}\n\n\treturn found;\n\n}\n\nbool intersectsBVHNodeBounds( vec3 rayOrigin, vec3 rayDirection, sampler2D bvhBounds, uint currNodeIndex, out float dist ) {\n\n\tuint cni2 = currNodeIndex * 2u;\n\tvec3 boundsMin = texelFetch1D( bvhBounds, cni2 ).xyz;\n\tvec3 boundsMax = texelFetch1D( bvhBounds, cni2 + 1u ).xyz;\n\treturn intersectsBounds( rayOrigin, rayDirection, boundsMin, boundsMax, dist );\n\n}\n\n// use a macro to hide the fact that we need to expand the struct into separate fields\n#define\tbvhIntersectFirstHit(\t\tbvh,\t\trayOrigin, rayDirection, faceIndices, faceNormal, barycoord, side, dist\t)\t_bvhIntersectFirstHit(\t\tbvh.position, bvh.index, bvh.bvhBounds, bvh.bvhContents,\t\trayOrigin, rayDirection, faceIndices, faceNormal, barycoord, side, dist\t)\n\nbool _bvhIntersectFirstHit(\n\t// bvh info\n\tsampler2D bvh_position, usampler2D bvh_index, sampler2D bvh_bvhBounds, usampler2D bvh_bvhContents,\n\n\t// ray\n\tvec3 rayOrigin, vec3 rayDirection,\n\n\t// output variables split into separate variables due to output precision\n\tinout uvec4 faceIndices, inout vec3 faceNormal, inout vec3 barycoord,\n\tinout float side, inout float dist\n) {\n\n\t// stack needs to be twice as long as the deepest tree we expect because\n\t// we push both the left and right child onto the stack every traversal\n\tint ptr = 0;\n\tuint stack[ BVH_STACK_DEPTH ];\n\tstack[ 0 ] = 0u;\n\n\tfloat triangleDistance = INFINITY;\n\tbool found = false;\n\twhile ( ptr > - 1 && ptr < BVH_STACK_DEPTH ) {\n\n\t\tuint currNodeIndex = stack[ ptr ];\n\t\tptr --;\n\n\t\t// check if we intersect the current bounds\n\t\tfloat boundsHitDistance;\n\t\tif (\n\t\t\t! intersectsBVHNodeBounds( rayOrigin, rayDirection, bvh_bvhBounds, currNodeIndex, boundsHitDistance )\n\t\t\t|| boundsHitDistance > triangleDistance\n\t\t) {\n\n\t\t\tcontinue;\n\n\t\t}\n\n\t\tuvec2 boundsInfo = uTexelFetch1D( bvh_bvhContents, currNodeIndex ).xy;\n\t\tbool isLeaf = bool( boundsInfo.x & 0xffff0000u );\n\n\t\tif ( isLeaf ) {\n\n\t\t\tuint count = boundsInfo.x & 0x0000ffffu;\n\t\t\tuint offset = boundsInfo.y;\n\n\t\t\tfound = intersectTriangles(\n\t\t\t\tbvh_position, bvh_index, offset, count,\n\t\t\t\trayOrigin, rayDirection, triangleDistance,\n\t\t\t\tfaceIndices, faceNormal, barycoord, side, dist\n\t\t\t) || found;\n\n\t\t} else {\n\n\t\t\tuint leftIndex = currNodeIndex + 1u;\n\t\t\tuint splitAxis = boundsInfo.x & 0x0000ffffu;\n\t\t\tuint rightIndex = boundsInfo.y;\n\n\t\t\tbool leftToRight = rayDirection[ splitAxis ] >= 0.0;\n\t\t\tuint c1 = leftToRight ? leftIndex : rightIndex;\n\t\t\tuint c2 = leftToRight ? rightIndex : leftIndex;\n\n\t\t\t// set c2 in the stack so we traverse it later. We need to keep track of a pointer in\n\t\t\t// the stack while we traverse. The second pointer added is the one that will be\n\t\t\t// traversed first\n\t\t\tptr ++;\n\t\t\tstack[ ptr ] = c2;\n\n\t\t\tptr ++;\n\t\t\tstack[ ptr ] = c1;\n\n\t\t}\n\n\t}\n\n\treturn found;\n\n}\n",ir="\nstruct BVH {\n\n\tusampler2D index;\n\tsampler2D position;\n\n\tsampler2D bvhBounds;\n\tusampler2D bvhContents;\n\n};\n";var sr=Object.freeze({__proto__:null,bvh_distance_functions:nr,bvh_ray_functions:rr,bvh_struct_definitions:ir,common_functions:tr});const or=ir,ar=nr,lr=`\n\t${tr}\n\t${rr}\n`;var hr=Object.freeze({__proto__:null,AVERAGE:lt,BVHShaderGLSL:sr,CENTER:at,CONTAINED:ct,ExtendedTriangle:ExtendedTriangle,FloatVertexAttributeTexture:FloatVertexAttributeTexture,INTERSECTED:1,IntVertexAttributeTexture:class extends VertexAttributeTexture{constructor(){super(),this._forcedType=B}},MeshBVH:MeshBVH,MeshBVHHelper:MeshBVHHelper,MeshBVHUniformStruct:class{constructor(){this.index=new UIntVertexAttributeTexture,this.position=new FloatVertexAttributeTexture,this.bvhBounds=new I,this.bvhContents=new I,this._cachedIndexAttr=null,this.index.overrideItemSize=3}updateFrom(e){const{geometry:r}=e;if(function(e,r,s){const l=e._roots;if(1!==l.length)throw new Error("MeshBVHUniformStruct: Multi-root BVHs not supported.");const h=l[0],u=new Uint16Array(h),p=new Uint32Array(h),m=new Float32Array(h),_=h.byteLength/pt,v=2*Math.ceil(Math.sqrt(_/2)),x=new Float32Array(4*v*v),b=Math.ceil(Math.sqrt(_)),S=new Uint32Array(2*b*b);for(let e=0;e<_;e++){const r=e*pt/4,s=2*r,l=r;for(let r=0;r<3;r++)x[8*e+0+r]=m[l+0+r],x[8*e+4+r]=m[l+3+r];if(IS_LEAF(s,u)){const l=COUNT(s,u),h=OFFSET(r,p),m=4294901760|l;S[2*e+0]=m,S[2*e+1]=h}else{const s=4*RIGHT_NODE(r,p)/pt,l=SPLIT_AXIS(r,p);S[2*e+0]=l,S[2*e+1]=s}}r.image.data=x,r.image.width=v,r.image.height=v,r.format=D,r.type=F,r.internalFormat="RGBA32F",r.minFilter=E,r.magFilter=E,r.generateMipmaps=!1,r.needsUpdate=!0,r.dispose(),s.image.data=S,s.image.width=b,s.image.height=b,s.format=G,s.type=R,s.internalFormat="RG32UI",s.minFilter=E,s.magFilter=E,s.generateMipmaps=!1,s.needsUpdate=!0,s.dispose()}(e,this.bvhBounds,this.bvhContents),this.position.updateFrom(r.attributes.position),e.indirect){const s=e._indirectBuffer;if(null===this._cachedIndexAttr||this._cachedIndexAttr.count!==s.length)if(r.index)this._cachedIndexAttr=r.index.clone();else{const e=getIndexArray(getVertexCount(r));this._cachedIndexAttr=new x(e,1,!1)}!function(e,r,s){const l=s.array,h=e.index?e.index.array:null;for(let e=0,s=r.length;e<s;e++){const s=3*e,u=3*r[e];for(let e=0;e<3;e++)l[s+e]=h?h[u+e]:u+e}}(r,s,this._cachedIndexAttr),this.index.updateFrom(this._cachedIndexAttr)}else this.index.updateFrom(r.index)}dispose(){const{index:e,position:r,bvhBounds:s,bvhContents:l}=this;e&&e.dispose(),r&&r.dispose(),s&&s.dispose(),l&&l.dispose()}},NOT_INTERSECTED:0,OrientedBox:OrientedBox,SAH:ht,StaticGeometryGenerator:StaticGeometryGenerator,UIntVertexAttributeTexture:UIntVertexAttributeTexture,VertexAttributeTexture:VertexAttributeTexture,acceleratedRaycast:function(e,r){if(this.geometry.boundsTree){if(void 0===this.material)return;Vn.copy(this.matrixWorld).invert(),Wn.copy(e.ray).applyMatrix4(Vn);const s=this.geometry.boundsTree;if(!0===e.firstHitOnly){const l=convertRaycastIntersect(s.raycastFirst(Wn,this.material),this,e);l&&r.push(l)}else{const l=s.raycast(Wn,this.material);for(let s=0,h=l.length;s<h;s++){const h=convertRaycastIntersect(l[s],this,e);h&&r.push(h)}}}else jn.call(this,e,r)},computeBoundsTree:function(e){return this.boundsTree=new MeshBVH(this,e),this.boundsTree},disposeBoundsTree:function(){this.boundsTree=null},estimateMemoryInBytes:function(e){const r=new Set,s=[e];let l=0;for(;s.length;){const e=s.pop();if(!r.has(e)){r.add(e);for(let r in e){if(!e.hasOwnProperty(r))continue;l+=getPrimitiveSize(r);const h=e[r];!h||"object"!=typeof h&&"function"!=typeof h?l+=getPrimitiveSize(h):/(Uint|Int|Float)(8|16|32)Array/.test(h.constructor.name)||isSharedArrayBufferSupported()&&h instanceof SharedArrayBuffer||h instanceof ArrayBuffer?l+=h.byteLength:s.push(h)}}}return l},getBVHExtremes:function(e){return e._roots.map(((r,s)=>function(e,r){const s={nodeCount:0,leafNodeCount:0,depth:{min:1/0,max:-1/0},tris:{min:1/0,max:-1/0},splits:[0,0,0],surfaceAreaScore:0};return e.traverse(((e,r,l,h,u)=>{const p=l[3]-l[0],m=l[4]-l[1],_=l[5]-l[2],v=2*(p*m+m*_+_*p);s.nodeCount++,r?(s.leafNodeCount++,s.depth.min=Math.min(e,s.depth.min),s.depth.max=Math.max(e,s.depth.max),s.tris.min=Math.min(u,s.tris.min),s.tris.max=Math.max(u,s.tris.max),s.surfaceAreaScore+=v*dt*u):(s.splits[h]++,s.surfaceAreaScore+=v*ut)}),r),s.tris.min===1/0&&(s.tris.min=0,s.tris.max=0),s.depth.min===1/0&&(s.depth.min=0,s.depth.max=0),s}(e,s)))},getJSONStructure:function(e){const r=[];return e.traverse(((e,s,l,h,p)=>{const m={bounds:arrayToBox(0,l,new u)};s?(m.count=p,m.offset=h):(m.left=null,m.right=null),r[e]=m;const _=r[e-1];_&&(null===_.left?_.left=m:_.right=m)})),r[0]},getTriangleHitPointInfo:function(e,l,h,u){const p=l.getIndex().array,_=l.getAttribute("position"),v=l.getAttribute("uv"),x=p[3*h],b=p[3*h+1],S=p[3*h+2];Xt.fromBufferAttribute(_,x),qt.fromBufferAttribute(_,b),Kt.fromBufferAttribute(_,S);let C=0;const A=l.groups,I=3*h;for(let e=0,r=A.length;e<r;e++){const r=A[e],{start:s,count:l}=r;if(I>=s&&I<s+l){C=r.materialIndex;break}}let E=null;return v&&($t.fromBufferAttribute(v,x),Yt.fromBufferAttribute(v,b),Zt.fromBufferAttribute(v,S),E=u&&u.uv?u.uv:new s,m.getInterpolation(e,Xt,qt,Kt,$t,Yt,Zt,E)),u?(u.face||(u.face={}),u.face.a=x,u.face.b=b,u.face.c=S,u.face.materialIndex=C,u.face.normal||(u.face.normal=new r),m.getNormal(Xt,qt,Kt,u.face.normal),E&&(u.uv=E),u):{face:{a:x,b:b,c:S,materialIndex:C,normal:m.getNormal(Xt,qt,Kt,new r)},uv:E}},shaderDistanceFunction:ar,shaderIntersectFunction:lr,shaderStructs:or,validateBounds:function(e){const r=e.geometry,s=[],l=r.index,h=r.getAttribute("position");let u=!0;return e.traverse(((r,p,m,_,v)=>{const x={depth:r,isLeaf:p,boundingData:m,offset:_,count:v};s[r]=x,arrayToBox(0,m,Gn);const b=s[r-1];if(p)for(let r=_,s=_+v;r<s;r++){const s=e.resolveTriangleIndex(r);let p,m=3*s,_=3*s+1,v=3*s+2;l&&(m=l.getX(m),_=l.getX(_),v=l.getX(v)),Hn.fromBufferAttribute(h,m),p=Gn.containsPoint(Hn),Hn.fromBufferAttribute(h,_),p=p&&Gn.containsPoint(Hn),Hn.fromBufferAttribute(h,v),p=p&&Gn.containsPoint(Hn),console.assert(p,"Leaf bounds does not fully contain triangle."),u=u&&p}if(b){arrayToBox(0,m,Nn);const e=Nn.containsBox(Gn);console.assert(e,"Parent bounds does not fully contain child."),u=u&&e}})),u}});const numberOr=(e,r)=>"number"==typeof e?e:r,capitalizeFirstLetter=e=>e.charAt(0).toUpperCase()+e.slice(1),isDescendant=(e,r)=>{for(;r?.parent;){if(r.parent==e)return!0;r=r.parent}return!1},cartesianToPolar=(e,r)=>[Math.sqrt(e*e+r*r),Math.atan2(r,e)],polarToCartesian=(e,r)=>[e*Math.cos(r),e*Math.sin(r)],radiansToDegrees=e=>(e+Math.PI)/(2*Math.PI)*360;function hueToRGB(e,r,s){return s<0&&(s+=1),s>1&&(s-=1),s<1/6?e+6*(r-e)*s:s<.5?r:s<2/3?e+(r-e)*(2/3-s)*6:e}const hslToRGB=(e,r,s)=>{let l,h,u;if(e/=360,0==r)l=h=u=s;else{let p=s<.5?s*(1+r):s+r-s*r,m=2*s-p;l=hueToRGB(m,p,e+1/3),h=hueToRGB(m,p,e),u=hueToRGB(m,p,e-1/3)}return[Math.round(255*l),Math.round(255*h),Math.round(255*u)]},rgbToHex=(e,r,s)=>e<<16^r<<8^s<<0;function containsGeometry(e){if(e.geometry)return!0;for(let r of e.children)if(containsGeometry(r))return!0;return!1}const setupBVHForComplexObject=e=>{if(!containsGeometry(e))return!1;if(e.parent){let r=e.parent;r.remove(e),e.updateMatrixWorld(!0),r.add(e)}if(e.children?.length){e.staticGeometryGenerator=new StaticGeometryGenerator([e]);try{e.bvhGeometry=e.staticGeometryGenerator.generate()}catch(e){return console.error(e),!1}}else e.bvhGeometry=e.geometry;return e.bvhGeometry.computeBoundsTree(),e.parent&&e.updateMatrixWorld(!0),!0},updateBVHForComplexObject=e=>{if(!e.staticGeometryGenerator)return setupBVHForComplexObject(e);if(e.parent){let r=e.parent;r.remove(e),e.updateMatrixWorld(!0),r.add(e)}e.staticGeometryGenerator.generate(e.bvhGeometry),e.bvhGeometry.boundsTree.refit(),e.parent&&e.updateMatrixWorld(!0)};var cr=Object.freeze({__proto__:null,addBVHHelper:r=>{if(r.bvhGeometry&&r.geomtry==r.bvhGeometry)return void r.parent.add(new MeshBVHHelper(r));let s=new e.MeshBasicMaterial({wireframe:!0,transparent:!0,opacity:.05,depthWrite:!1}),l=new e.Mesh(r.bvhGeometry,s);r.parent.add(l);let h=new MeshBVHHelper(l,10);r.parent.add(h),r.bvhHelper=h},capitalizeFirstLetter:capitalizeFirstLetter,cartesianToPolar:cartesianToPolar,hslToRGB:hslToRGB,isDescendant:isDescendant,numberOr:numberOr,polarToCartesian:polarToCartesian,radiansToDegrees:radiansToDegrees,rgbToHex:rgbToHex,setupBVHForComplexObject:setupBVHForComplexObject,updateBVHForComplexObject:updateBVHForComplexObject});class UIComponent extends e.Object3D{constructor(...e){super(),e=Array.from(new Set(e)),this._styles=[],this._needsUpdate={},this._overrideStyle={},this._latestValue={},this._defaults={},this._styleListener=e=>this._onStyleChange(e);for(let r of e)r&&(r instanceof Style||(r=new Style(r)),this._styles.push(r),r.addUpdateListener(this._styleListener))}addStyle(e){let r=!1;for(let s=this._styles.length-1;s>=0;s--)e==this._styles[s]&&(this._styles.splice(s,1),r=!0);this._styles.push(e);for(let r of Style.PROPERTIES)null!=e[r]&&this._onStyleChange(r);r||e.addUpdateListener(this._styleListener)}_onStyleChange(e){this._needsUpdate[e]=!0;let r="_handleStyleUpdateFor"+capitalizeFirstLetter(e);r in this&&this[r]()}removeStyle(e){let r=!1;for(let s=this._styles.length-1;s>=0;s--)e==this._styles[s]&&(this._styles.splice(s,1),r=!0);if(r){for(let r of Style.PROPERTIES)null!=e[r]&&this._onStyleChange(r);e.removeUpdateListener(this._styleListener)}}_genericGet(e){if(e in this._overrideStyle)return this._overrideStyle[e];if(!this._needsUpdate[e]&&null!=this._latestValue[e])return this._latestValue[e];for(let r=this._styles.length-1;r>=0;r--){let s=this._styles[r][e];if(null!=s)return this._needsUpdate[e]=!1,this._latestValue[e]=s,s}return this._needsUpdate[e]=!1,this._latestValue[e]=this._defaults[e],this._defaults[e]}_genericSet(e,r){null==r?delete this._overrideStyle[e]:this._overrideStyle[e]=r;let s="_handleStyleUpdateFor"+capitalizeFirstLetter(e);s in this&&this[s]()}get alignItems(){return this._genericGet("alignItems")}get backgroundVisible(){return this._genericGet("backgroundVisible")}get borderMaterial(){return this._genericGet("borderMaterial")}get borderRadius(){return this._genericGet("borderRadius")}get borderBottomLeftRadius(){return this._genericGet("borderBottomLeftRadius")}get borderBottomRightRadius(){return this._genericGet("borderBottomRightRadius")}get borderTopLeftRadius(){return this._genericGet("borderTopLeftRadius")}get borderTopRightRadius(){return this._genericGet("borderTopRightRadius")}get borderWidth(){return this._genericGet("borderWidth")}get color(){return this._genericGet("color")}get contentDirection(){return this._genericGet("contentDirection")}get font(){return this._genericGet("font")}get fontSize(){return this._genericGet("fontSize")}get glassmorphism(){return this._genericGet("glassmorphism")}get height(){return this._genericGet("height")}get justifyContent(){return this._genericGet("justifyContent")}get margin(){return this._genericGet("margin")}get marginBottom(){return this._genericGet("marginBottom")}get marginLeft(){return this._genericGet("marginLeft")}get marginRight(){return this._genericGet("marginRight")}get marginTop(){return this._genericGet("marginTop")}get material(){return this._genericGet("material")}get materialColor(){return this._genericGet("materialColor")}get maxHeight(){return this._genericGet("maxHeight")}get maxWidth(){return this._genericGet("maxWidth")}get minHeight(){return this._genericGet("minHeight")}get minWidth(){return this._genericGet("minWidth")}get opacity(){return this._genericGet("opacity")}get overflow(){return this._genericGet("overflow")}get padding(){return this._genericGet("padding")}get paddingBottom(){return this._genericGet("paddingBottom")}get paddingLeft(){return this._genericGet("paddingLeft")}get paddingRight(){return this._genericGet("paddingRight")}get paddingTop(){return this._genericGet("paddingTop")}get textAlign(){return this._genericGet("textAlign")}get textureFit(){return this._genericGet("textureFit")}get width(){return this._genericGet("width")}set alignItems(e){this._genericSet("alignItems",e)}set backgroundVisible(e){this._genericSet("backgroundVisible",e)}set borderMaterial(e){this._genericSet("borderMaterial",e)}set borderRadius(e){this._genericSet("borderRadius",e)}set borderBottomLeftRadius(e){this._genericSet("borderBottomLeftRadius",e)}set borderBottomRightRadius(e){this._genericSet("borderBottomRightRadius",e)}set borderTopLeftRadius(e){this._genericSet("borderTopLeftRadius",e)}set borderTopRightRadius(e){this._genericSet("borderTopRightRadius",e)}set borderWidth(e){this._genericSet("borderWidth",e)}set color(e){this._genericSet("color",e)}set contentDirection(e){this._genericSet("contentDirection",e)}set font(e){this._genericSet("font",e)}set fontSize(e){this._genericSet("fontSize",e)}set glassmorphism(e){this._genericSet("glassmorphism",e)}set height(e){this._genericSet("height",e)}set justifyContent(e){this._genericSet("justifyContent",e)}set margin(e){this._genericSet("margin",e)}set marginBottom(e){this._genericSet("marginBottom",e)}set marginLeft(e){this._genericSet("marginLeft",e)}set marginRight(e){this._genericSet("marginRight",e)}set marginTop(e){this._genericSet("marginTop",e)}set material(e){this._genericSet("material",e)}set materialColor(e){this._genericSet("materialColor",e)}set maxHeight(e){this._genericSet("maxHeight",e)}set maxWidth(e){this._genericSet("maxWidth",e)}set minHeight(e){this._genericSet("minHeight",e)}set minWidth(e){this._genericSet("minWidth",e)}set opacity(e){this._genericSet("opacity",e)}set overflow(e){this._genericSet("overflow",e)}set padding(e){this._genericSet("padding",e)}set paddingBottom(e){this._genericSet("paddingBottom",e)}set paddingLeft(e){this._genericSet("paddingLeft",e)}set paddingRight(e){this._genericSet("paddingRight",e)}set paddingTop(e){this._genericSet("paddingTop",e)}set textAlign(e){this._genericSet("textAlign",e)}set textureFit(e){this._genericSet("textureFit",e)}set width(e){this._genericSet("width",e)}}let dr=new class{constructor(){this._listeners=new Set}add(e){this._listeners.add(e)}remove(e){this._listeners.delete(e)}update(){for(let e of this._listeners)e()}};const ur=new e.MeshBasicMaterial({color:16777215,side:e.DoubleSide,transparent:!0,polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:1}),pr=new e.MeshPhysicalMaterial({color:16777215,roughness:.45,side:e.DoubleSide,specularIntensity:0,transmission:.99,polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:1}),fr=new e.MeshBasicMaterial({color:16777215,transparent:!0,side:e.DoubleSide,polygonOffset:!0});class LayoutComponent extends UIComponent{constructor(...r){super(...r),this._defaults.alignItems="center",this._defaults.backgroundVisible=!1,this._defaults.borderMaterial=fr.clone(),this._defaults.borderRadius=0,this._defaults.borderWidth=0,this._defaults.contentDirection="column",this._defaults.justifyContent="start",this._defaults.margin=0,this._defaults.material=this.glassmorphism?pr.clone():ur.clone(),this._defaults.height="auto",this._defaults.overflow="visible",this._defaults.padding=0,this._defaults.width="auto",this._updateListener=()=>this._updateClippingPlanes(),this.computedHeight=0,this.marginedHeight=0,this.unpaddedHeight=0,this.computedWidth=0,this.marginedWidth=0,this.unpaddedWidth=0,this._materialOffset=0,this._content=new e.Object3D,this._content.position.z=1e-8,this.addEventListener("added",(()=>this._onAdded())),this.addEventListener("removed",(()=>this._onRemoved())),this.add(this._content),"visible"!=this.overflow&&this._createClippingPlanes()}_handleStyleUpdateForAlignItems(){this.updateLayout()}_handleStyleUpdateForBackgroundVisible(){this._background&&(this._background.visible=this.backgroundVisible||!1)}_handleStyleUpdateForBorderRadius(){this._createBackground()}_handleStyleUpdateForBorderBottomLeftRadius(){this._createBackground()}_handleStyleUpdateForBorderBottomRightRadius(){this._createBackground()}_handleStyleUpdateForBorderTopLeftRadius(){this._createBackground()}_handleStyleUpdateForBorderTopRightRadius(){this._createBackground()}_handleStyleUpdateForJustifyContent(){this.updateLayout()}_handleStyleUpdateForMargin(){this.updateLayout()}_handleStyleUpdateForMarginBottom(){this.updateLayout()}_handleStyleUpdateForMarginLeft(){this.updateLayout()}_handleStyleUpdateForMarginRight(){this.updateLayout()}_handleStyleUpdateForMarginTop(){this.updateLayout()}_handleStyleUpdateForMaxHeight(){this.updateLayout()}_handleStyleUpdateForMaxWidth(){this.updateLayout()}_handleStyleUpdateForMinHeight(){this.updateLayout()}_handleStyleUpdateForMinWidth(){this.updateLayout()}_handleStyleUpdateForPadding(){this.updateLayout()}_handleStyleUpdateForPaddingBottom(){this.updateLayout()}_handleStyleUpdateForPaddingLeft(){this.updateLayout()}_handleStyleUpdateForPaddingRight(){this.updateLayout()}_handleStyleUpdateForPaddingTop(){this.updateLayout()}_handleStyleUpdateForHeight(){this.updateLayout()}_handleStyleUpdateForWidth(){this.updateLayout()}_handleStyleUpdateForMaterial(){let e=this.material;e.polygonOffset=!0,e.polygonOffsetFactor=e.polygonOffsetUnits=-1*this._materialOffset,this._background.material=e}_handleStyleUpdateForMaterialColor(){let e=this.materialColor;null==e&&(e="#ffffff"),this.material.color.set(e)}_handleStyleUpdateForOpacity(){let e=this.opacity;null==e&&(e=1),this.material.opacity=e}_handleStyleUpdateForOverflow(){"visible"!=this.overflow?this.clippingPlanes||this._createClippingPlanes():this.clippingPlanes&&this._clearClippingPlanes()}_createBackground(){this._background&&this.remove(this._background),this._border&&this.remove(this._border),this._background=null,this._border=null;let r=this.material,s=this.materialColor,l=this.opacity;null!=s&&r.color.set(s),l&&(r.opacity=l);let h=this.borderWidth||0,u=this.borderRadius||0,p=numberOr(this.borderTopLeftRadius,u),m=numberOr(this.borderTopRightRadius,u),_=numberOr(this.borderBottomLeftRadius,u),v=numberOr(this.borderBottomRightRadius,u),x=this.computedHeight,b=this.computedWidth,S=100+this._materialOffset;if(h){let r=LayoutComponent.createShape(b,x,p,m,_,v);p=Math.max(p-h,0),m=Math.max(m-h,0),_=Math.max(_-h,0),v=Math.max(v-h,0),x-=2*h,b-=2*h;let s=LayoutComponent.createShape(b,x,p,m,_,v),l=new e.ShapeGeometry(s);this._background=new e.Mesh(l,this.material),this.add(this._background),r.holes.push(s),l=new e.ShapeGeometry(r),this._border=new e.Mesh(l,this.borderMaterial),this.add(this._border),this._border.renderOrder=S}else{let r=LayoutComponent.createShape(b,x,p,m,_,v),s=new e.ShapeGeometry(r);this._background=new e.Mesh(s,this.material),this.add(this._background)}this._background.renderOrder=S,this.backgroundVisible||(this._background.visible=!1)}_addClippingPlanesUpdateListener(){this.clippingPlanes&&dr.add(this._updateListener);for(let e of this._content.children)e instanceof LayoutComponent&&e._addClippingPlanesUpdateListener()}_removeClippingPlanesUpdateListener(){dr.remove(this._updateListener);for(let e of this._content.children)e instanceof LayoutComponent&&e._removeClippingPlanesUpdateListener()}_createClippingPlanes(){this.clippingPlanes=[new e.Plane(new e.Vector3(0,1,0)),new e.Plane(new e.Vector3(0,-1,0)),new e.Plane(new e.Vector3(1,0,0)),new e.Plane(new e.Vector3(-1,0,0))],this._updateClippingPlanes(),this.updateClippingPlanes(!0),dr.add(this._updateListener)}_getClippingPlanes(){let e=[],r=this;for(;r instanceof LayoutComponent;)r.clippingPlanes&&e.push(...r.clippingPlanes),r=r.parentComponent;return e.length?e:null}_clearClippingPlanes(){this.clippingPlanes=null,dr.remove(this._updateListener),this.updateClippingPlanes(!0)}_updateClippingPlanes(){let e=this.computedWidth/2,r=this.computedHeight/2;this.clippingPlanes[0].constant=r,this.clippingPlanes[1].constant=r,this.clippingPlanes[2].constant=e,this.clippingPlanes[3].constant=e,this.clippingPlanes[0].normal.set(0,1,0),this.clippingPlanes[1].normal.set(0,-1,0),this.clippingPlanes[2].normal.set(1,0,0),this.clippingPlanes[3].normal.set(-1,0,0),this.updateWorldMatrix(!0);for(let e of this.clippingPlanes)e.applyMatrix4(this.matrixWorld)}updateClippingPlanes(e){let r=this._getClippingPlanes();if(this.material.clippingPlanes=r,this._text&&(this._text.material.clippingPlanes=r),e)for(let e of this._content.children)e instanceof LayoutComponent&&e.updateClippingPlanes(!0)}updateLayout(){let e,r,s,l,h,u,p,m,_,v,x,b,S,C,A,I,E,R=this.computedHeight,B=this.computedWidth,F=this.marginedHeight,D=this.marginedWidth,G=this._computeDimension("height"),N=this._computeDimension("width"),H=this._getContentHeight(),W=this._getContentWidth(),V=this._content.children.reduce(((e,r)=>e+(r instanceof LayoutComponent?1:0)),0),j=this.alignItems,z=this.justifyContent,X=0;"row"==this.contentDirection?(r=-N,m=G,_=-W,s=-this.unpaddedWidth,v="computedWidth",x="computedHeight",h=this.paddingLeft||this.padding,u=this.paddingTop||this.padding,p=this.paddingBottom||this.padding,b="marginLeft",S="marginRight",C="marginTop",A="marginBottom",I="x",E="y",l=1):(r=G,m=-N,_=H,s=this.unpaddedHeight,v="computedHeight",x="computedWidth",h=this.paddingTop||this.padding,u=this.paddingLeft||this.padding,p=this.paddingRight||this.padding,b="marginTop",S="marginBottom",C="marginLeft",A="marginRight",I="y",E="x",l=-1),"start"==z?(e=r/2,e+=h*l):"end"==z?(e=r/-2+_,e-=h*l):"center"==z||Math.abs(s)-Math.abs(_)<0?e=_/2:("spaceBetween"==z?(X=Math.abs(s-_)/(V-1)*l,e=r/2):"spaceAround"==z?(X=Math.abs(s-_)/V*l,e=r/2+X/2):"spaceEvenly"==z&&(X=Math.abs(s-_)/(V+1)*l,e=r/2+X),e+=h*l);for(let r of this._content.children)if(r instanceof LayoutComponent){let s=r.margin||0,h=numberOr(r[b],s),_=numberOr(r[S],s),R=numberOr(r[C],s),B=numberOr(r[A],s);if(e+=h*l,r.position[I]=e+r[v]/2*l,e+=r[v]*l,e+=_*l,e+=X,"start"==j)r.position[E]=m/2-r[x]/2*l-u*l-R*l;else if("end"==j)r.position[E]=-m/2+r[x]/2*l+p*l+B*l;else{let e=(p-u+B-R)*l/2;r.position[E]=e}}B!=N||R!=G?(this._createBackground(),this.clippingPlanes&&this._updateClippingPlanes(),this.parentComponent instanceof LayoutComponent&&this.parent.parent.updateLayout(),this._updateChildrensLayout(B!=N,R!=G)):F==this.marginedHeight&&D==this.marginedWidth||(this.clippingPlanes&&this._updateClippingPlanes(),this.parentComponent instanceof LayoutComponent&&this.parent.parent.updateLayout())}_updateChildrensLayout(e,r){for(let s of this._content.children)if(s instanceof LayoutComponent){let l=!1;if(e){let e=s.width;"string"==typeof e&&e.endsWith("%")&&(l=!0)}if(!l&&r){let e=s.height;"string"==typeof e&&e.endsWith("%")&&(l=!0)}l&&s.updateLayout()}}_computeDimension(e,r){let s=capitalizeFirstLetter(e),l="computed"+s,h="margined"+s,u="unpadded"+s,p="max"+s,m="min"+s,_=this[r||e];if("number"==typeof _)this[l]=_;else if("auto"==_)if("column"==this.contentDirection==("height"==e)){let r=0;for(let e of this._content.children)e instanceof LayoutComponent&&(r+=e[h]);let s="height"==e?this.paddingVertical:this.paddingHorizontal;this[l]=r+s}else{let r=0;for(let e of this._content.children)e instanceof LayoutComponent&&(r=Math.max(r,e[h]));let s="height"==e?this.paddingVertical:this.paddingHorizontal;this[l]=r+s}else{let e=this.parentComponent;if(e instanceof LayoutComponent){let r=Number(_.replace("%",""))/100;this[l]=e[u]*r}}if(r)return this[l];{let r=!1;if(null!=this[p]){let s=this[l];this._computeDimension(e,p),s<this[l]?this[l]=s:r=!0}if(null!=this[m]&&!r){let r=this[l];this._computeDimension(e,m),r>this[l]&&(this[l]=r)}}return this._computeUnpaddedAndMarginedDimensions(e,this[l]),this[l]}_computeUnpaddedAndMarginedDimensions(e,r){let s="margined"+capitalizeFirstLetter(e),l="height"==e?"Vertical":"Horizontal";this["unpadded"+capitalizeFirstLetter(e)]=r-this["padding"+l],this[s]=r+this["margin"+l],"height"==e?(this.unpaddedHeight=Math.max(r-this.paddingVertical,0),this.marginedHeight=r+this.marginVertical):(this.unpaddedWidth=Math.max(r-this.paddingHorizontal,0),this.marginedWidth=r+this.marginHorizontal)}_getContentHeight(){if("column"==this.contentDirection){let e=0;for(let r of this._content.children)r instanceof LayoutComponent&&(e+=r.marginedHeight);return e}{let e=0;for(let r of this._content.children)r instanceof LayoutComponent&&(e=Math.max(e,r.marginedHeight));return e}}_getContentWidth(){if("row"==this.contentDirection){let e=0;for(let r of this._content.children)r instanceof LayoutComponent&&(e+=r.marginedWidth);return e}{let e=0;for(let r of this._content.children)r instanceof LayoutComponent&&(e=Math.max(e,r.marginedWidth));return e}}_updateMaterialOffset(e){this._materialOffset=e+1;let r=this.material,s=this.borderMaterial;s.polygonOffset=r.polygonOffset=!0,s.polygonOffsetFactor=s.polygonOffsetUnits=r.polygonOffsetFactor=r.polygonOffsetUnits=-1*this._materialOffset;for(let e of this._content.children)e instanceof LayoutComponent&&e._updateMaterialOffset(this._materialOffset);let l=100+this._materialOffset;this._background&&(this._background.renderOrder=l),this._border&&(this._border.renderOrder=l)}_onAdded(){this._addClippingPlanesUpdateListener()}_onRemoved(){this._removeClippingPlanesUpdateListener()}add(e){if(arguments.length>1)for(let e of arguments)this.add(e);else e instanceof UIComponent&&!e.bypassContentPositioning?(this._content.add(e),e.updateLayout(),e._updateMaterialOffset(this._materialOffset),e.updateClippingPlanes(!0),this.updateLayout()):super.add(e)}remove(e){if(arguments.length>1)for(let e of arguments)this.add(e);else e instanceof UIComponent&&!e.bypassContentPositioning?this._content.remove(e):super.remove(e)}get marginHorizontal(){let e=this.margin||0;return numberOr(this.marginLeft,e)+numberOr(this.marginRight,e)}get marginVertical(){let e=this.margin||0;return numberOr(this.marginTop,e)+numberOr(this.marginBottom,e)}get paddingHorizontal(){let e=this.padding||0;return numberOr(this.paddingLeft,e)+numberOr(this.paddingRight,e)}get paddingVertical(){let e=this.padding||0;return numberOr(this.paddingTop,e)+numberOr(this.paddingBottom,e)}get parentComponent(){return this.parent?.parent}static createShape(r,s,l,h,u,p){let m=new e.Shape,_=r/2,v=s/2,x=-1*_,b=-1*v;return m.moveTo(x,b+u),m.lineTo(x,v-l),l&&m.absarc(x+l,v-l,l,Math.PI,Math.PI/2,!0),m.lineTo(_-h,v),h&&m.absarc(_-h,v-h,h,Math.PI/2,0,!0),m.lineTo(_,b+p),p&&m.absarc(_-p,b+p,p,0,Math.PI/-2,!0),m.lineTo(x+u,b),u&&m.absarc(x+u,b+u,u,Math.PI/-2,-Math.PI,!0),m}}let gr=new class{constructor(){this._tool=null,this._listeners=new Set}getTool(){return this._tool}setTool(e){this._tool=e;for(let r of this._listeners)r(e)}addUpdateListener(e){this._listeners.add(e)}removeUpdateListener(e){this._listeners.delete(e)}};const mr={IDLE:"IDLE",DISABLED:"DISABLED",HOVERED:"HOVERED",SELECTED:"SELECTED"};class Interactable{constructor(e){this._object=e,this._state=mr.IDLE,this.children=new Set,this._hoveredOwners=new Set,this._selectedOwners=new Set,this._capturedOwners=new Set,this._stateCallbacks=new Set,this._hoveredCallbacks=new Set,this._callbacks={},this._callbacksLength=0,this._toolCounts={},this._hoveredCallbackState=!1,this._disabled=!1}addEventListener(e,r,s){s&&(s={...s});let l=s?.tool||"none";e in this._callbacks||(this._callbacks[e]=new Map),this._callbacks[e].has(r)&&this.removeEventListener(e,r),this._callbacks[e].set(r,s),this._callbacksLength++,this._toolCounts[l]||(this._toolCounts[l]=0),this._toolCounts[l]++}copyEventListenersTo(e){for(let r in this._callbacks)for(let[s,l]of this._callbacks[r])e.addEventListener(r,s,l)}removeEventListener(e,r){if(e in this._callbacks&&this._callbacks[e].has(r)){let s=this._callbacks[e].get(r);this._callbacks[e].delete(r),this._callbacksLength--;let l=s?.tool||"none";this._toolCounts[l]--}}dispatchEvent(e,r){if(this._disabled||!(e in this._callbacks))return;let s=gr.getTool();for(let[l,h]of this._callbacks[e]){let e=h?.tool;e&&e!=s||l(r)}}over(e){this.dispatchEvent("over",e)}out(e){this.dispatchEvent("out",e)}down(e){this.dispatchEvent("down",e)}up(e){this.dispatchEvent("up",e)}click(e){this.dispatchEvent("click",e),this._capturedOwners.has(e.owner)&&this._capturedOwners.delete(e.owner)}move(e){this.dispatchEvent("move",e)}drag(e){this.dispatchEvent("drag",e)}capture(e){this._capturedOwners.add(e)}isCapturedBy(e){return this._capturedOwners.has(e)}getCallbacksLength(e){return e?this._toolCounts[e]:this._callbacksLength}supportsTool(){let e=gr.getTool();return this._toolCounts.none||this._toolCounts[e]}isOnlyGroup(){return!this.supportsTool()}addStateCallback(e){this._stateCallbacks.add(e)}addHoveredCallback(e){this._hoveredCallbacks.add(e)}removeStateCallback(e){this._stateCallbacks.delete(e)}removeHoveredCallback(e){this._hoveredCallbacks.delete(e)}_determineAndSetState(){this._selectedOwners.size>0?this.state=mr.SELECTED:this._hoveredOwners.size>0?this.state=mr.HOVERED:this.state=mr.IDLE}_determineHoveredCallbackState(){if(this._disabled||0==this._hoveredCallbacks.size)return;let e=!1;for(let r of this._hoveredOwners)if(!this._selectedOwners.has(r)){e=!0;break}if(e!=this._hoveredCallbackState){this._hoveredCallbackState=e;for(let r of this._hoveredCallbacks)r(e)}}addHoveredBy(e){this._hoveredOwners.has(e)||(this._hoveredOwners.add(e),this._determineHoveredCallbackState(),0==this._selectedOwners.size&&(this.state=mr.HOVERED))}removeHoveredBy(e){this._hoveredOwners.delete(e),this._determineAndSetState(),this._determineHoveredCallbackState()}addSelectedBy(e){this._selectedOwners.add(e),this.state=mr.SELECTED,this._determineHoveredCallbackState()}removeSelectedBy(e){this._selectedOwners.delete(e),this._determineAndSetState(),this._determineHoveredCallbackState()}reset(){this._hoveredOwners.clear(),this._selectedOwners.clear(),this.state=mr.IDLE,this.children.forEach((e=>{e.reset()}))}addChild(e){e.parent!=this&&(e.parent&&e.parent.removeChild(e),this.children.add(e),e.parent=this)}addChildren(e){e.forEach((e=>{this.addChild(e)}))}removeChild(e){this.children.delete(e),e.parent=null}removeChildren(e){e.forEach((e=>{this.removeChild(e)}))}get disabled(){return this._disabled}get object(){return this._object}get state(){return this._state}set disabled(e){e?(this._hoveredCallbackState&&(this._hoveredCallbacks.forEach((e=>e(!1))),this._hoveredCallbackState=!1),this.state=mr.DISABLED,this._disabled=e):(this._disabled=e,this._determineAndSetState(),this._determineHoveredCallbackState())}set object(e){this._object=e}set state(e){if(!this._disabled&&this._state!=e){this._state=e;for(let r of this._stateCallbacks)r(e)}}}class PointerInteractable extends Interactable{constructor(e){super(e),e&&(e.pointerInteractable=this),this._maxDistance=-1/0,this._hoveredCursor="pointer"}addEventListener(e,r,s={}){null==(s={...s}).maxDistance&&(s.maxDistance=1/0),s.maxDistance>this._maxDistance&&(this._maxDistance=s.maxDistance),super.addEventListener(e,r,s)}removeEventListener(e,r){let s=!1;if(e in this._callbacks&&this._callbacks[e].has(r)){this._callbacks[e].get(r).maxDistance==this._maxDistance&&(s=!0)}if(super.removeEventListener(e,r),s){this._maxDistance=-1/0;for(let e in this._callbacks)for(let[r,s]of this._callbacks[e])s.maxDistance>this._maxDistance&&(this._maxDistance=s.maxDistance)}}dispatchEvent(e,r){if(this._disabled||!(e in this._callbacks))return;let s=gr.getTool();for(let[l,h]of this._callbacks[e]){let e=h.tool;e&&e!=s||(null==r?.userDistance||h.maxDistance>=r.userDistance)&&l(r)}}isWithinReach(e){return e<this._maxDistance}get hoveredCursor(){return this._disabled?"not-allowed":this._hoveredCursor}set hoveredCursor(e){this._hoveredCursor=e}}const _r=new e.Matrix4;class TouchInteractable extends Interactable{constructor(e){super(e),this._target1={},this._target2={},this._targets=[this._target1,this._target2],e&&(e.touchInteractable=this,e.bvhGeometry||setupBVHForComplexObject(e)),this._createBoundingObject()}_createBoundingObject(){this._boundingBox=new e.Box3}_getBoundingObject(){return this._boundingBox.setFromObject(this._object),this._boundingBox}intersectsSphere(e){let r,s=this._getBoundingObject();return r=!!s&&e.intersectsBox(s),r}intersectsObject(e){if(e?.bvhGeometry?.boundsTree&&(this._object?.bvhGeometry?.boundsTree||setupBVHForComplexObject(this._object)))return _r.copy(this._object.matrixWorld).invert().multiply(e.matrixWorld),this._object.bvhGeometry.boundsTree.intersectsGeometry(e.bvhGeometry,_r)}getClosestPointTo(e){if(e.model&&(e=e.model),!e?.bvhGeometry?.boundsTree)return;if(!this._object?.bvhGeometry?.boundsTree)return;return _r.copy(this._object.matrixWorld).invert().multiply(e.matrixWorld),this._object.bvhGeometry.boundsTree.closestPointToGeometry(e.bvhGeometry,_r,this._target1,this._target2)?(this._target2.object=e,this._targets):void 0}}const yr={POINTER:"POINTER",TOUCH_SCREEN:"TOUCH_SCREEN",XR:"XR"},vr={LEFT:"LEFT",RIGHT:"RIGHT",otherHand:e=>e==vr.LEFT?vr.RIGHT:e==vr.RIGHT?vr.LEFT:void console.error("ERROR: Unexpected hand provided to Handedness.otherHand")},xr={CONTROLLER:"CONTROLLER",HAND:"HAND",OTHER:"OTHER"};function toTrianglesDrawMode(e,r){if(r===te)return console.warn("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Geometry already defined as triangles."),e;if(r===ne||r===re){let s=e.getIndex();if(null===s){const r=[],l=e.getAttribute("position");if(void 0===l)return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),e;for(let e=0;e<l.count;e++)r.push(e);e.setIndex(r),s=e.getIndex()}const l=s.count-2,h=[];if(r===ne)for(let e=1;e<=l;e++)h.push(s.getX(0)),h.push(s.getX(e)),h.push(s.getX(e+1));else for(let e=0;e<l;e++)e%2==0?(h.push(s.getX(e)),h.push(s.getX(e+1)),h.push(s.getX(e+2))):(h.push(s.getX(e+2)),h.push(s.getX(e+1)),h.push(s.getX(e)));h.length/3!==l&&console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");const u=e.clone();return u.setIndex(h),u.clearGroups(),u}return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unknown draw mode:",r),e}class GLTFLoader extends se{constructor(e){super(e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register((function(e){return new GLTFMaterialsClearcoatExtension(e)})),this.register((function(e){return new GLTFMaterialsDispersionExtension(e)})),this.register((function(e){return new GLTFTextureBasisUExtension(e)})),this.register((function(e){return new GLTFTextureWebPExtension(e)})),this.register((function(e){return new GLTFTextureAVIFExtension(e)})),this.register((function(e){return new GLTFMaterialsSheenExtension(e)})),this.register((function(e){return new GLTFMaterialsTransmissionExtension(e)})),this.register((function(e){return new GLTFMaterialsVolumeExtension(e)})),this.register((function(e){return new GLTFMaterialsIorExtension(e)})),this.register((function(e){return new GLTFMaterialsEmissiveStrengthExtension(e)})),this.register((function(e){return new GLTFMaterialsSpecularExtension(e)})),this.register((function(e){return new GLTFMaterialsIridescenceExtension(e)})),this.register((function(e){return new GLTFMaterialsAnisotropyExtension(e)})),this.register((function(e){return new GLTFMaterialsBumpExtension(e)})),this.register((function(e){return new GLTFLightsExtension(e)})),this.register((function(e){return new GLTFMeshoptCompression(e)})),this.register((function(e){return new GLTFMeshGpuInstancing(e)}))}load(e,r,s,l){const h=this;let u;if(""!==this.resourcePath)u=this.resourcePath;else if(""!==this.path){const r=oe.extractUrlBase(e);u=oe.resolveURL(r,this.path)}else u=oe.extractUrlBase(e);this.manager.itemStart(e);const _onError=function(r){l?l(r):console.error(r),h.manager.itemError(e),h.manager.itemEnd(e)},p=new ae(this.manager);p.setPath(this.path),p.setResponseType("arraybuffer"),p.setRequestHeader(this.requestHeader),p.setWithCredentials(this.withCredentials),p.load(e,(function(s){try{h.parse(s,u,(function(s){r(s),h.manager.itemEnd(e)}),_onError)}catch(e){_onError(e)}}),s,_onError)}setDRACOLoader(e){return this.dracoLoader=e,this}setDDSLoader(){throw new Error('THREE.GLTFLoader: "MSFT_texture_dds" no longer supported. Please update to "KHR_texture_basisu".')}setKTX2Loader(e){return this.ktx2Loader=e,this}setMeshoptDecoder(e){return this.meshoptDecoder=e,this}register(e){return-1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this}unregister(e){return-1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,r,s,l){let h;const u={},p={},m=new TextDecoder;if("string"==typeof e)h=JSON.parse(e);else if(e instanceof ArrayBuffer){if(m.decode(new Uint8Array(e,0,4))===Tr){try{u[br.KHR_BINARY_GLTF]=new GLTFBinaryExtension(e)}catch(e){return void(l&&l(e))}h=JSON.parse(u[br.KHR_BINARY_GLTF].content)}else h=JSON.parse(m.decode(e))}else h=e;if(void 0===h.asset||h.asset.version[0]<2)return void(l&&l(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported.")));const _=new GLTFParser(h,{path:r||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});_.fileLoader.setRequestHeader(this.requestHeader);for(let e=0;e<this.pluginCallbacks.length;e++){const r=this.pluginCallbacks[e](_);r.name||console.error("THREE.GLTFLoader: Invalid plugin found: missing name"),p[r.name]=r,u[r.name]=!0}if(h.extensionsUsed)for(let e=0;e<h.extensionsUsed.length;++e){const r=h.extensionsUsed[e],s=h.extensionsRequired||[];switch(r){case br.KHR_MATERIALS_UNLIT:u[r]=new GLTFMaterialsUnlitExtension;break;case br.KHR_DRACO_MESH_COMPRESSION:u[r]=new GLTFDracoMeshCompressionExtension(h,this.dracoLoader);break;case br.KHR_TEXTURE_TRANSFORM:u[r]=new GLTFTextureTransformExtension;break;case br.KHR_MESH_QUANTIZATION:u[r]=new GLTFMeshQuantizationExtension;break;default:s.indexOf(r)>=0&&void 0===p[r]&&console.warn('THREE.GLTFLoader: Unknown extension "'+r+'".')}}_.setExtensions(u),_.setPlugins(p),_.parse(s,l)}parseAsync(e,r){const s=this;return new Promise((function(l,h){s.parse(e,r,l,h)}))}}function GLTFRegistry(){let e={};return{get:function(r){return e[r]},add:function(r,s){e[r]=s},remove:function(r){delete e[r]},removeAll:function(){e={}}}}const br={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_DISPERSION:"KHR_materials_dispersion",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_ANISOTROPY:"KHR_materials_anisotropy",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_MATERIALS_BUMP:"EXT_materials_bump",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_TEXTURE_AVIF:"EXT_texture_avif",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression",EXT_MESH_GPU_INSTANCING:"EXT_mesh_gpu_instancing"};class GLTFLightsExtension{constructor(e){this.parser=e,this.name=br.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){const e=this.parser,r=this.parser.json.nodes||[];for(let s=0,l=r.length;s<l;s++){const l=r[s];l.extensions&&l.extensions[this.name]&&void 0!==l.extensions[this.name].light&&e._addNodeRef(this.cache,l.extensions[this.name].light)}}_loadLight(e){const r=this.parser,s="light:"+e;let l=r.cache.get(s);if(l)return l;const h=r.json,u=((h.extensions&&h.extensions[this.name]||{}).lights||[])[e];let p;const m=new le(16777215);void 0!==u.color&&m.setRGB(u.color[0],u.color[1],u.color[2],he);const _=void 0!==u.range?u.range:0;switch(u.type){case"directional":p=new ue(m),p.target.position.set(0,0,-1),p.add(p.target);break;case"point":p=new de(m),p.distance=_;break;case"spot":p=new ce(m),p.distance=_,u.spot=u.spot||{},u.spot.innerConeAngle=void 0!==u.spot.innerConeAngle?u.spot.innerConeAngle:0,u.spot.outerConeAngle=void 0!==u.spot.outerConeAngle?u.spot.outerConeAngle:Math.PI/4,p.angle=u.spot.outerConeAngle,p.penumbra=1-u.spot.innerConeAngle/u.spot.outerConeAngle,p.target.position.set(0,0,-1),p.add(p.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+u.type)}return p.position.set(0,0,0),p.decay=2,assignExtrasToUserData(p,u),void 0!==u.intensity&&(p.intensity=u.intensity),p.name=r.createUniqueName(u.name||"light_"+e),l=Promise.resolve(p),r.cache.add(s,l),l}getDependency(e,r){if("light"===e)return this._loadLight(r)}createNodeAttachment(e){const r=this,s=this.parser,l=s.json.nodes[e],h=(l.extensions&&l.extensions[this.name]||{}).light;return void 0===h?null:this._loadLight(h).then((function(e){return s._getNodeRef(r.cache,h,e)}))}}class GLTFMaterialsUnlitExtension{constructor(){this.name=br.KHR_MATERIALS_UNLIT}getMaterialType(){return A}extendParams(e,r,s){const l=[];e.color=new le(1,1,1),e.opacity=1;const h=r.pbrMetallicRoughness;if(h){if(Array.isArray(h.baseColorFactor)){const r=h.baseColorFactor;e.color.setRGB(r[0],r[1],r[2],he),e.opacity=r[3]}void 0!==h.baseColorTexture&&l.push(s.assignTexture(e,"map",h.baseColorTexture,pe))}return Promise.all(l)}}class GLTFMaterialsEmissiveStrengthExtension{constructor(e){this.parser=e,this.name=br.KHR_MATERIALS_EMISSIVE_STRENGTH}extendMaterialParams(e,r){const s=this.parser.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const l=s.extensions[this.name].emissiveStrength;return void 0!==l&&(r.emissiveIntensity=l),Promise.resolve()}}class GLTFMaterialsClearcoatExtension{constructor(e){this.parser=e,this.name=br.KHR_MATERIALS_CLEARCOAT}getMaterialType(e){const r=this.parser.json.materials[e];return r.extensions&&r.extensions[this.name]?fe:null}extendMaterialParams(e,r){const l=this.parser,h=l.json.materials[e];if(!h.extensions||!h.extensions[this.name])return Promise.resolve();const u=[],p=h.extensions[this.name];if(void 0!==p.clearcoatFactor&&(r.clearcoat=p.clearcoatFactor),void 0!==p.clearcoatTexture&&u.push(l.assignTexture(r,"clearcoatMap",p.clearcoatTexture)),void 0!==p.clearcoatRoughnessFactor&&(r.clearcoatRoughness=p.clearcoatRoughnessFactor),void 0!==p.clearcoatRoughnessTexture&&u.push(l.assignTexture(r,"clearcoatRoughnessMap",p.clearcoatRoughnessTexture)),void 0!==p.clearcoatNormalTexture&&(u.push(l.assignTexture(r,"clearcoatNormalMap",p.clearcoatNormalTexture)),void 0!==p.clearcoatNormalTexture.scale)){const e=p.clearcoatNormalTexture.scale;r.clearcoatNormalScale=new s(e,e)}return Promise.all(u)}}class GLTFMaterialsDispersionExtension{constructor(e){this.parser=e,this.name=br.KHR_MATERIALS_DISPERSION}getMaterialType(e){const r=this.parser.json.materials[e];return r.extensions&&r.extensions[this.name]?fe:null}extendMaterialParams(e,r){const s=this.parser.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const l=s.extensions[this.name];return r.dispersion=void 0!==l.dispersion?l.dispersion:0,Promise.resolve()}}class GLTFMaterialsIridescenceExtension{constructor(e){this.parser=e,this.name=br.KHR_MATERIALS_IRIDESCENCE}getMaterialType(e){const r=this.parser.json.materials[e];return r.extensions&&r.extensions[this.name]?fe:null}extendMaterialParams(e,r){const s=this.parser,l=s.json.materials[e];if(!l.extensions||!l.extensions[this.name])return Promise.resolve();const h=[],u=l.extensions[this.name];return void 0!==u.iridescenceFactor&&(r.iridescence=u.iridescenceFactor),void 0!==u.iridescenceTexture&&h.push(s.assignTexture(r,"iridescenceMap",u.iridescenceTexture)),void 0!==u.iridescenceIor&&(r.iridescenceIOR=u.iridescenceIor),void 0===r.iridescenceThicknessRange&&(r.iridescenceThicknessRange=[100,400]),void 0!==u.iridescenceThicknessMinimum&&(r.iridescenceThicknessRange[0]=u.iridescenceThicknessMinimum),void 0!==u.iridescenceThicknessMaximum&&(r.iridescenceThicknessRange[1]=u.iridescenceThicknessMaximum),void 0!==u.iridescenceThicknessTexture&&h.push(s.assignTexture(r,"iridescenceThicknessMap",u.iridescenceThicknessTexture)),Promise.all(h)}}class GLTFMaterialsSheenExtension{constructor(e){this.parser=e,this.name=br.KHR_MATERIALS_SHEEN}getMaterialType(e){const r=this.parser.json.materials[e];return r.extensions&&r.extensions[this.name]?fe:null}extendMaterialParams(e,r){const s=this.parser,l=s.json.materials[e];if(!l.extensions||!l.extensions[this.name])return Promise.resolve();const h=[];r.sheenColor=new le(0,0,0),r.sheenRoughness=0,r.sheen=1;const u=l.extensions[this.name];if(void 0!==u.sheenColorFactor){const e=u.sheenColorFactor;r.sheenColor.setRGB(e[0],e[1],e[2],he)}return void 0!==u.sheenRoughnessFactor&&(r.sheenRoughness=u.sheenRoughnessFactor),void 0!==u.sheenColorTexture&&h.push(s.assignTexture(r,"sheenColorMap",u.sheenColorTexture,pe)),void 0!==u.sheenRoughnessTexture&&h.push(s.assignTexture(r,"sheenRoughnessMap",u.sheenRoughnessTexture)),Promise.all(h)}}class GLTFMaterialsTransmissionExtension{constructor(e){this.parser=e,this.name=br.KHR_MATERIALS_TRANSMISSION}getMaterialType(e){const r=this.parser.json.materials[e];return r.extensions&&r.extensions[this.name]?fe:null}extendMaterialParams(e,r){const s=this.parser,l=s.json.materials[e];if(!l.extensions||!l.extensions[this.name])return Promise.resolve();const h=[],u=l.extensions[this.name];return void 0!==u.transmissionFactor&&(r.transmission=u.transmissionFactor),void 0!==u.transmissionTexture&&h.push(s.assignTexture(r,"transmissionMap",u.transmissionTexture)),Promise.all(h)}}class GLTFMaterialsVolumeExtension{constructor(e){this.parser=e,this.name=br.KHR_MATERIALS_VOLUME}getMaterialType(e){const r=this.parser.json.materials[e];return r.extensions&&r.extensions[this.name]?fe:null}extendMaterialParams(e,r){const s=this.parser,l=s.json.materials[e];if(!l.extensions||!l.extensions[this.name])return Promise.resolve();const h=[],u=l.extensions[this.name];r.thickness=void 0!==u.thicknessFactor?u.thicknessFactor:0,void 0!==u.thicknessTexture&&h.push(s.assignTexture(r,"thicknessMap",u.thicknessTexture)),r.attenuationDistance=u.attenuationDistance||1/0;const p=u.attenuationColor||[1,1,1];return r.attenuationColor=(new le).setRGB(p[0],p[1],p[2],he),Promise.all(h)}}class GLTFMaterialsIorExtension{constructor(e){this.parser=e,this.name=br.KHR_MATERIALS_IOR}getMaterialType(e){const r=this.parser.json.materials[e];return r.extensions&&r.extensions[this.name]?fe:null}extendMaterialParams(e,r){const s=this.parser.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const l=s.extensions[this.name];return r.ior=void 0!==l.ior?l.ior:1.5,Promise.resolve()}}class GLTFMaterialsSpecularExtension{constructor(e){this.parser=e,this.name=br.KHR_MATERIALS_SPECULAR}getMaterialType(e){const r=this.parser.json.materials[e];return r.extensions&&r.extensions[this.name]?fe:null}extendMaterialParams(e,r){const s=this.parser,l=s.json.materials[e];if(!l.extensions||!l.extensions[this.name])return Promise.resolve();const h=[],u=l.extensions[this.name];r.specularIntensity=void 0!==u.specularFactor?u.specularFactor:1,void 0!==u.specularTexture&&h.push(s.assignTexture(r,"specularIntensityMap",u.specularTexture));const p=u.specularColorFactor||[1,1,1];return r.specularColor=(new le).setRGB(p[0],p[1],p[2],he),void 0!==u.specularColorTexture&&h.push(s.assignTexture(r,"specularColorMap",u.specularColorTexture,pe)),Promise.all(h)}}class GLTFMaterialsBumpExtension{constructor(e){this.parser=e,this.name=br.EXT_MATERIALS_BUMP}getMaterialType(e){const r=this.parser.json.materials[e];return r.extensions&&r.extensions[this.name]?fe:null}extendMaterialParams(e,r){const s=this.parser,l=s.json.materials[e];if(!l.extensions||!l.extensions[this.name])return Promise.resolve();const h=[],u=l.extensions[this.name];return r.bumpScale=void 0!==u.bumpFactor?u.bumpFactor:1,void 0!==u.bumpTexture&&h.push(s.assignTexture(r,"bumpMap",u.bumpTexture)),Promise.all(h)}}class GLTFMaterialsAnisotropyExtension{constructor(e){this.parser=e,this.name=br.KHR_MATERIALS_ANISOTROPY}getMaterialType(e){const r=this.parser.json.materials[e];return r.extensions&&r.extensions[this.name]?fe:null}extendMaterialParams(e,r){const s=this.parser,l=s.json.materials[e];if(!l.extensions||!l.extensions[this.name])return Promise.resolve();const h=[],u=l.extensions[this.name];return void 0!==u.anisotropyStrength&&(r.anisotropy=u.anisotropyStrength),void 0!==u.anisotropyRotation&&(r.anisotropyRotation=u.anisotropyRotation),void 0!==u.anisotropyTexture&&h.push(s.assignTexture(r,"anisotropyMap",u.anisotropyTexture)),Promise.all(h)}}class GLTFTextureBasisUExtension{constructor(e){this.parser=e,this.name=br.KHR_TEXTURE_BASISU}loadTexture(e){const r=this.parser,s=r.json,l=s.textures[e];if(!l.extensions||!l.extensions[this.name])return null;const h=l.extensions[this.name],u=r.options.ktx2Loader;if(!u){if(s.extensionsRequired&&s.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return r.loadTextureImage(e,h.source,u)}}class GLTFTextureWebPExtension{constructor(e){this.parser=e,this.name=br.EXT_TEXTURE_WEBP,this.isSupported=null}loadTexture(e){const r=this.name,s=this.parser,l=s.json,h=l.textures[e];if(!h.extensions||!h.extensions[r])return null;const u=h.extensions[r],p=l.images[u.source];let m=s.textureLoader;if(p.uri){const e=s.options.manager.getHandler(p.uri);null!==e&&(m=e)}return this.detectSupport().then((function(h){if(h)return s.loadTextureImage(e,u.source,m);if(l.extensionsRequired&&l.extensionsRequired.indexOf(r)>=0)throw new Error("THREE.GLTFLoader: WebP required by asset but unsupported.");return s.loadTexture(e)}))}detectSupport(){return this.isSupported||(this.isSupported=new Promise((function(e){const r=new Image;r.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",r.onload=r.onerror=function(){e(1===r.height)}}))),this.isSupported}}class GLTFTextureAVIFExtension{constructor(e){this.parser=e,this.name=br.EXT_TEXTURE_AVIF,this.isSupported=null}loadTexture(e){const r=this.name,s=this.parser,l=s.json,h=l.textures[e];if(!h.extensions||!h.extensions[r])return null;const u=h.extensions[r],p=l.images[u.source];let m=s.textureLoader;if(p.uri){const e=s.options.manager.getHandler(p.uri);null!==e&&(m=e)}return this.detectSupport().then((function(h){if(h)return s.loadTextureImage(e,u.source,m);if(l.extensionsRequired&&l.extensionsRequired.indexOf(r)>=0)throw new Error("THREE.GLTFLoader: AVIF required by asset but unsupported.");return s.loadTexture(e)}))}detectSupport(){return this.isSupported||(this.isSupported=new Promise((function(e){const r=new Image;r.src="data:image/avif;base64,AAAAIGZ0eXBhdmlmAAAAAGF2aWZtaWYxbWlhZk1BMUIAAADybWV0YQAAAAAAAAAoaGRscgAAAAAAAAAAcGljdAAAAAAAAAAAAAAAAGxpYmF2aWYAAAAADnBpdG0AAAAAAAEAAAAeaWxvYwAAAABEAAABAAEAAAABAAABGgAAABcAAAAoaWluZgAAAAAAAQAAABppbmZlAgAAAAABAABhdjAxQ29sb3IAAAAAamlwcnAAAABLaXBjbwAAABRpc3BlAAAAAAAAAAEAAAABAAAAEHBpeGkAAAAAAwgICAAAAAxhdjFDgQAMAAAAABNjb2xybmNseAACAAIABoAAAAAXaXBtYQAAAAAAAAABAAEEAQKDBAAAAB9tZGF0EgAKCBgABogQEDQgMgkQAAAAB8dSLfI=",r.onload=r.onerror=function(){e(1===r.height)}}))),this.isSupported}}class GLTFMeshoptCompression{constructor(e){this.name=br.EXT_MESHOPT_COMPRESSION,this.parser=e}loadBufferView(e){const r=this.parser.json,s=r.bufferViews[e];if(s.extensions&&s.extensions[this.name]){const e=s.extensions[this.name],l=this.parser.getDependency("buffer",e.buffer),h=this.parser.options.meshoptDecoder;if(!h||!h.supported){if(r.extensionsRequired&&r.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return l.then((function(r){const s=e.byteOffset||0,l=e.byteLength||0,u=e.count,p=e.byteStride,m=new Uint8Array(r,s,l);return h.decodeGltfBufferAsync?h.decodeGltfBufferAsync(u,p,m,e.mode,e.filter).then((function(e){return e.buffer})):h.ready.then((function(){const r=new ArrayBuffer(u*p);return h.decodeGltfBuffer(new Uint8Array(r),u,p,m,e.mode,e.filter),r}))}))}return null}}class GLTFMeshGpuInstancing{constructor(e){this.name=br.EXT_MESH_GPU_INSTANCING,this.parser=e}createNodeMesh(e){const s=this.parser.json,l=s.nodes[e];if(!l.extensions||!l.extensions[this.name]||void 0===l.mesh)return null;const h=s.meshes[l.mesh];for(const e of h.primitives)if(e.mode!==Ar.TRIANGLES&&e.mode!==Ar.TRIANGLE_STRIP&&e.mode!==Ar.TRIANGLE_FAN&&void 0!==e.mode)return null;const u=l.extensions[this.name].attributes,p=[],m={};for(const e in u)p.push(this.parser.getDependency("accessor",u[e]).then((r=>(m[e]=r,m[e]))));return p.length<1?null:(p.push(this.parser.createNodeMesh(e)),Promise.all(p).then((e=>{const s=e.pop(),l=s.isGroup?s.children:[s],h=e[0].count,u=[];for(const e of l){const s=new v,l=new r,p=new ie,_=new r(1,1,1),x=new ge(e.geometry,e.material,h);for(let e=0;e<h;e++)m.TRANSLATION&&l.fromBufferAttribute(m.TRANSLATION,e),m.ROTATION&&p.fromBufferAttribute(m.ROTATION,e),m.SCALE&&_.fromBufferAttribute(m.SCALE,e),x.setMatrixAt(e,s.compose(l,p,_));for(const r in m)if("_COLOR_0"===r){const e=m[r];x.instanceColor=new me(e.array,e.itemSize,e.normalized)}else"TRANSLATION"!==r&&"ROTATION"!==r&&"SCALE"!==r&&e.geometry.setAttribute(r,m[r]);W.prototype.copy.call(x,e),this.parser.assignFinalMaterial(x),u.push(x)}return s.isGroup?(s.clear(),s.add(...u),s):u[0]})))}}const Tr="glTF",wr=1313821514,Sr=5130562;class GLTFBinaryExtension{constructor(e){this.name=br.KHR_BINARY_GLTF,this.content=null,this.body=null;const r=new DataView(e,0,12),s=new TextDecoder;if(this.header={magic:s.decode(new Uint8Array(e.slice(0,4))),version:r.getUint32(4,!0),length:r.getUint32(8,!0)},this.header.magic!==Tr)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const l=this.header.length-12,h=new DataView(e,12);let u=0;for(;u<l;){const r=h.getUint32(u,!0);u+=4;const l=h.getUint32(u,!0);if(u+=4,l===wr){const l=new Uint8Array(e,12+u,r);this.content=s.decode(l)}else if(l===Sr){const s=12+u;this.body=e.slice(s,s+r)}u+=r}if(null===this.content)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class GLTFDracoMeshCompressionExtension{constructor(e,r){if(!r)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=br.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=r,this.dracoLoader.preload()}decodePrimitive(e,r){const s=this.json,l=this.dracoLoader,h=e.extensions[this.name].bufferView,u=e.extensions[this.name].attributes,p={},m={},_={};for(const e in u){const r=Mr[e]||e.toLowerCase();p[r]=u[e]}for(const r in e.attributes){const l=Mr[r]||r.toLowerCase();if(void 0!==u[r]){const h=s.accessors[e.attributes[r]],u=Ir[h.componentType];_[l]=u.name,m[l]=!0===h.normalized}}return r.getDependency("bufferView",h).then((function(e){return new Promise((function(r,s){l.decodeDracoFile(e,(function(e){for(const r in e.attributes){const s=e.attributes[r],l=m[r];void 0!==l&&(s.normalized=l)}r(e)}),p,_,he,s)}))}))}}class GLTFTextureTransformExtension{constructor(){this.name=br.KHR_TEXTURE_TRANSFORM}extendTexture(e,r){return void 0!==r.texCoord&&r.texCoord!==e.channel||void 0!==r.offset||void 0!==r.rotation||void 0!==r.scale?(e=e.clone(),void 0!==r.texCoord&&(e.channel=r.texCoord),void 0!==r.offset&&e.offset.fromArray(r.offset),void 0!==r.rotation&&(e.rotation=r.rotation),void 0!==r.scale&&e.repeat.fromArray(r.scale),e.needsUpdate=!0,e):e}}class GLTFMeshQuantizationExtension{constructor(){this.name=br.KHR_MESH_QUANTIZATION}}class GLTFCubicSplineInterpolant extends Ze{constructor(e,r,s,l){super(e,r,s,l)}copySampleValue_(e){const r=this.resultBuffer,s=this.sampleValues,l=this.valueSize,h=e*l*3+l;for(let e=0;e!==l;e++)r[e]=s[h+e];return r}interpolate_(e,r,s,l){const h=this.resultBuffer,u=this.sampleValues,p=this.valueSize,m=2*p,_=3*p,v=l-r,x=(s-r)/v,b=x*x,S=b*x,C=e*_,A=C-_,I=-2*S+3*b,E=S-b,R=1-I,B=E-b+x;for(let e=0;e!==p;e++){const r=u[A+e+p],s=u[A+e+m]*v,l=u[C+e+p],_=u[C+e]*v;h[e]=R*r+B*s+I*l+E*_}return h}}const Cr=new ie;class GLTFCubicSplineQuaternionInterpolant extends GLTFCubicSplineInterpolant{interpolate_(e,r,s,l){const h=super.interpolate_(e,r,s,l);return Cr.fromArray(h).normalize().toArray(h),h}}const Ar={FLOAT:5126,FLOAT_MAT3:35675,FLOAT_MAT4:35676,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,LINEAR:9729,REPEAT:10497,SAMPLER_2D:35678,POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,UNSIGNED_BYTE:5121,UNSIGNED_SHORT:5123},Ir={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},Er={9728:E,9729:be,9984:He,9985:We,9986:Ve,9987:Te},kr={33071:je,33648:ze,10497:we},Rr={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},Mr={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv1",TEXCOORD_2:"uv2",TEXCOORD_3:"uv3",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},Br={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},Lr={CUBICSPLINE:void 0,LINEAR:Ge,STEP:Xe},Pr="OPAQUE",Ur="MASK",Fr="BLEND";function addUnknownExtensionsToUserData(e,r,s){for(const l in s.extensions)void 0===e[l]&&(r.userData.gltfExtensions=r.userData.gltfExtensions||{},r.userData.gltfExtensions[l]=s.extensions[l])}function assignExtrasToUserData(e,r){void 0!==r.extras&&("object"==typeof r.extras?Object.assign(e.userData,r.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+r.extras))}function updateMorphTargets(e,r){if(e.updateMorphTargets(),void 0!==r.weights)for(let s=0,l=r.weights.length;s<l;s++)e.morphTargetInfluences[s]=r.weights[s];if(r.extras&&Array.isArray(r.extras.targetNames)){const s=r.extras.targetNames;if(e.morphTargetInfluences.length===s.length){e.morphTargetDictionary={};for(let r=0,l=s.length;r<l;r++)e.morphTargetDictionary[s[r]]=r}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function createPrimitiveKey(e){let r;const s=e.extensions&&e.extensions[br.KHR_DRACO_MESH_COMPRESSION];if(r=s?"draco:"+s.bufferView+":"+s.indices+":"+createAttributesKey(s.attributes):e.indices+":"+createAttributesKey(e.attributes)+":"+e.mode,void 0!==e.targets)for(let s=0,l=e.targets.length;s<l;s++)r+=":"+createAttributesKey(e.targets[s]);return r}function createAttributesKey(e){let r="";const s=Object.keys(e).sort();for(let l=0,h=s.length;l<h;l++)r+=s[l]+":"+e[s[l]]+";";return r}function getNormalizedComponentScale(e){switch(e){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}const Dr=new v;class GLTFParser{constructor(e={},r={}){this.json=e,this.extensions={},this.plugins={},this.options=r,this.cache=new GLTFRegistry,this.associations=new Map,this.primitiveCache={},this.nodeCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={};let s=!1,l=!1,h=-1;"undefined"!=typeof navigator&&(s=!0===/^((?!chrome|android).)*safari/i.test(navigator.userAgent),l=navigator.userAgent.indexOf("Firefox")>-1,h=l?navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1]:-1),"undefined"==typeof createImageBitmap||s||l&&h<98?this.textureLoader=new _e(this.options.manager):this.textureLoader=new ye(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new ae(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),"use-credentials"===this.options.crossOrigin&&this.fileLoader.setWithCredentials(!0)}setExtensions(e){this.extensions=e}setPlugins(e){this.plugins=e}parse(e,r){const s=this,l=this.json,h=this.extensions;this.cache.removeAll(),this.nodeCache={},this._invokeAll((function(e){return e._markDefs&&e._markDefs()})),Promise.all(this._invokeAll((function(e){return e.beforeRoot&&e.beforeRoot()}))).then((function(){return Promise.all([s.getDependencies("scene"),s.getDependencies("animation"),s.getDependencies("camera")])})).then((function(r){const u={scene:r[0][l.scene||0],scenes:r[0],animations:r[1],cameras:r[2],asset:l.asset,parser:s,userData:{}};return addUnknownExtensionsToUserData(h,u,l),assignExtrasToUserData(u,l),Promise.all(s._invokeAll((function(e){return e.afterRoot&&e.afterRoot(u)}))).then((function(){for(const e of u.scenes)e.updateMatrixWorld();e(u)}))})).catch(r)}_markDefs(){const e=this.json.nodes||[],r=this.json.skins||[],s=this.json.meshes||[];for(let s=0,l=r.length;s<l;s++){const l=r[s].joints;for(let r=0,s=l.length;r<s;r++)e[l[r]].isBone=!0}for(let r=0,l=e.length;r<l;r++){const l=e[r];void 0!==l.mesh&&(this._addNodeRef(this.meshCache,l.mesh),void 0!==l.skin&&(s[l.mesh].isSkinnedMesh=!0)),void 0!==l.camera&&this._addNodeRef(this.cameraCache,l.camera)}}_addNodeRef(e,r){void 0!==r&&(void 0===e.refs[r]&&(e.refs[r]=e.uses[r]=0),e.refs[r]++)}_getNodeRef(e,r,s){if(e.refs[r]<=1)return s;const l=s.clone(),updateMappings=(e,r)=>{const s=this.associations.get(e);null!=s&&this.associations.set(r,s);for(const[s,l]of e.children.entries())updateMappings(l,r.children[s])};return updateMappings(s,l),l.name+="_instance_"+e.uses[r]++,l}_invokeOne(e){const r=Object.values(this.plugins);r.push(this);for(let s=0;s<r.length;s++){const l=e(r[s]);if(l)return l}return null}_invokeAll(e){const r=Object.values(this.plugins);r.unshift(this);const s=[];for(let l=0;l<r.length;l++){const h=e(r[l]);h&&s.push(h)}return s}getDependency(e,r){const s=e+":"+r;let l=this.cache.get(s);if(!l){switch(e){case"scene":l=this.loadScene(r);break;case"node":l=this._invokeOne((function(e){return e.loadNode&&e.loadNode(r)}));break;case"mesh":l=this._invokeOne((function(e){return e.loadMesh&&e.loadMesh(r)}));break;case"accessor":l=this.loadAccessor(r);break;case"bufferView":l=this._invokeOne((function(e){return e.loadBufferView&&e.loadBufferView(r)}));break;case"buffer":l=this.loadBuffer(r);break;case"material":l=this._invokeOne((function(e){return e.loadMaterial&&e.loadMaterial(r)}));break;case"texture":l=this._invokeOne((function(e){return e.loadTexture&&e.loadTexture(r)}));break;case"skin":l=this.loadSkin(r);break;case"animation":l=this._invokeOne((function(e){return e.loadAnimation&&e.loadAnimation(r)}));break;case"camera":l=this.loadCamera(r);break;default:if(l=this._invokeOne((function(s){return s!=this&&s.getDependency&&s.getDependency(e,r)})),!l)throw new Error("Unknown type: "+e)}this.cache.add(s,l)}return l}getDependencies(e){let r=this.cache.get(e);if(!r){const s=this,l=this.json[e+("mesh"===e?"es":"s")]||[];r=Promise.all(l.map((function(r,l){return s.getDependency(e,l)}))),this.cache.add(e,r)}return r}loadBuffer(e){const r=this.json.buffers[e],s=this.fileLoader;if(r.type&&"arraybuffer"!==r.type)throw new Error("THREE.GLTFLoader: "+r.type+" buffer type is not supported.");if(void 0===r.uri&&0===e)return Promise.resolve(this.extensions[br.KHR_BINARY_GLTF].body);const l=this.options;return new Promise((function(e,h){s.load(oe.resolveURL(r.uri,l.path),e,void 0,(function(){h(new Error('THREE.GLTFLoader: Failed to load buffer "'+r.uri+'".'))}))}))}loadBufferView(e){const r=this.json.bufferViews[e];return this.getDependency("buffer",r.buffer).then((function(e){const s=r.byteLength||0,l=r.byteOffset||0;return e.slice(l,l+s)}))}loadAccessor(e){const r=this,s=this.json,l=this.json.accessors[e];if(void 0===l.bufferView&&void 0===l.sparse){const e=Rr[l.type],r=Ir[l.componentType],s=!0===l.normalized,h=new r(l.count*e);return Promise.resolve(new x(h,e,s))}const h=[];return void 0!==l.bufferView?h.push(this.getDependency("bufferView",l.bufferView)):h.push(null),void 0!==l.sparse&&(h.push(this.getDependency("bufferView",l.sparse.indices.bufferView)),h.push(this.getDependency("bufferView",l.sparse.values.bufferView))),Promise.all(h).then((function(e){const h=e[0],u=Rr[l.type],p=Ir[l.componentType],m=p.BYTES_PER_ELEMENT,_=m*u,v=l.byteOffset||0,b=void 0!==l.bufferView?s.bufferViews[l.bufferView].byteStride:void 0,S=!0===l.normalized;let C,A;if(b&&b!==_){const e=Math.floor(v/b),s="InterleavedBuffer:"+l.bufferView+":"+l.componentType+":"+e+":"+l.count;let _=r.cache.get(s);_||(C=new p(h,e*b,l.count*b/m),_=new ve(C,b/m),r.cache.add(s,_)),A=new xe(_,u,v%b/m,S)}else C=null===h?new p(l.count*u):new p(h,v,l.count*u),A=new x(C,u,S);if(void 0!==l.sparse){const r=Rr.SCALAR,s=Ir[l.sparse.indices.componentType],m=l.sparse.indices.byteOffset||0,_=l.sparse.values.byteOffset||0,v=new s(e[1],m,l.sparse.count*r),b=new p(e[2],_,l.sparse.count*u);null!==h&&(A=new x(A.array.slice(),A.itemSize,A.normalized));for(let e=0,r=v.length;e<r;e++){const r=v[e];if(A.setX(r,b[e*u]),u>=2&&A.setY(r,b[e*u+1]),u>=3&&A.setZ(r,b[e*u+2]),u>=4&&A.setW(r,b[e*u+3]),u>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return A}))}loadTexture(e){const r=this.json,s=this.options,l=r.textures[e].source,h=r.images[l];let u=this.textureLoader;if(h.uri){const e=s.manager.getHandler(h.uri);null!==e&&(u=e)}return this.loadTextureImage(e,l,u)}loadTextureImage(e,r,s){const l=this,h=this.json,u=h.textures[e],p=h.images[r],m=(p.uri||p.bufferView)+":"+u.sampler;if(this.textureCache[m])return this.textureCache[m];const _=this.loadImageSource(r,s).then((function(r){r.flipY=!1,r.name=u.name||p.name||"",""===r.name&&"string"==typeof p.uri&&!1===p.uri.startsWith("data:image/")&&(r.name=p.uri);const s=(h.samplers||{})[u.sampler]||{};return r.magFilter=Er[s.magFilter]||be,r.minFilter=Er[s.minFilter]||Te,r.wrapS=kr[s.wrapS]||we,r.wrapT=kr[s.wrapT]||we,l.associations.set(r,{textures:e}),r})).catch((function(){return null}));return this.textureCache[m]=_,_}loadImageSource(e,r){const s=this,l=this.json,h=this.options;if(void 0!==this.sourceCache[e])return this.sourceCache[e].then((e=>e.clone()));const u=l.images[e],p=self.URL||self.webkitURL;let m=u.uri||"",_=!1;if(void 0!==u.bufferView)m=s.getDependency("bufferView",u.bufferView).then((function(e){_=!0;const r=new Blob([e],{type:u.mimeType});return m=p.createObjectURL(r),m}));else if(void 0===u.uri)throw new Error("THREE.GLTFLoader: Image "+e+" is missing URI and bufferView");const v=Promise.resolve(m).then((function(e){return new Promise((function(s,l){let u=s;!0===r.isImageBitmapLoader&&(u=function(e){const r=new qe(e);r.needsUpdate=!0,s(r)}),r.load(oe.resolveURL(e,h.path),u,void 0,l)}))})).then((function(e){var r;return!0===_&&p.revokeObjectURL(m),e.userData.mimeType=u.mimeType||((r=u.uri).search(/\.jpe?g($|\?)/i)>0||0===r.search(/^data\:image\/jpeg/)?"image/jpeg":r.search(/\.webp($|\?)/i)>0||0===r.search(/^data\:image\/webp/)?"image/webp":"image/png"),e})).catch((function(e){throw console.error("THREE.GLTFLoader: Couldn't load texture",m),e}));return this.sourceCache[e]=v,v}assignTexture(e,r,s,l){const h=this;return this.getDependency("texture",s.index).then((function(u){if(!u)return null;if(void 0!==s.texCoord&&s.texCoord>0&&((u=u.clone()).channel=s.texCoord),h.extensions[br.KHR_TEXTURE_TRANSFORM]){const e=void 0!==s.extensions?s.extensions[br.KHR_TEXTURE_TRANSFORM]:void 0;if(e){const r=h.associations.get(u);u=h.extensions[br.KHR_TEXTURE_TRANSFORM].extendTexture(u,e),h.associations.set(u,r)}}return void 0!==l&&(u.colorSpace=l),e[r]=u,u}))}assignFinalMaterial(e){const r=e.geometry;let s=e.material;const l=void 0===r.attributes.tangent,h=void 0!==r.attributes.color,u=void 0===r.attributes.normal;if(e.isPoints){const e="PointsMaterial:"+s.uuid;let r=this.cache.get(e);r||(r=new Se,Ce.prototype.copy.call(r,s),r.color.copy(s.color),r.map=s.map,r.sizeAttenuation=!1,this.cache.add(e,r)),s=r}else if(e.isLine){const e="LineBasicMaterial:"+s.uuid;let r=this.cache.get(e);r||(r=new C,Ce.prototype.copy.call(r,s),r.color.copy(s.color),r.map=s.map,this.cache.add(e,r)),s=r}if(l||h||u){let e="ClonedMaterial:"+s.uuid+":";l&&(e+="derivative-tangents:"),h&&(e+="vertex-colors:"),u&&(e+="flat-shading:");let r=this.cache.get(e);r||(r=s.clone(),h&&(r.vertexColors=!0),u&&(r.flatShading=!0),l&&(r.normalScale&&(r.normalScale.y*=-1),r.clearcoatNormalScale&&(r.clearcoatNormalScale.y*=-1)),this.cache.add(e,r),this.associations.set(r,this.associations.get(s))),s=r}e.material=s}getMaterialType(){return Ae}loadMaterial(e){const r=this,l=this.json,h=this.extensions,u=l.materials[e];let p;const m={},_=[];if((u.extensions||{})[br.KHR_MATERIALS_UNLIT]){const e=h[br.KHR_MATERIALS_UNLIT];p=e.getMaterialType(),_.push(e.extendParams(m,u,r))}else{const s=u.pbrMetallicRoughness||{};if(m.color=new le(1,1,1),m.opacity=1,Array.isArray(s.baseColorFactor)){const e=s.baseColorFactor;m.color.setRGB(e[0],e[1],e[2],he),m.opacity=e[3]}void 0!==s.baseColorTexture&&_.push(r.assignTexture(m,"map",s.baseColorTexture,pe)),m.metalness=void 0!==s.metallicFactor?s.metallicFactor:1,m.roughness=void 0!==s.roughnessFactor?s.roughnessFactor:1,void 0!==s.metallicRoughnessTexture&&(_.push(r.assignTexture(m,"metalnessMap",s.metallicRoughnessTexture)),_.push(r.assignTexture(m,"roughnessMap",s.metallicRoughnessTexture))),p=this._invokeOne((function(r){return r.getMaterialType&&r.getMaterialType(e)})),_.push(Promise.all(this._invokeAll((function(r){return r.extendMaterialParams&&r.extendMaterialParams(e,m)}))))}!0===u.doubleSided&&(m.side=ee);const v=u.alphaMode||Pr;if(v===Fr?(m.transparent=!0,m.depthWrite=!1):(m.transparent=!1,v===Ur&&(m.alphaTest=void 0!==u.alphaCutoff?u.alphaCutoff:.5)),void 0!==u.normalTexture&&p!==A&&(_.push(r.assignTexture(m,"normalMap",u.normalTexture)),m.normalScale=new s(1,1),void 0!==u.normalTexture.scale)){const e=u.normalTexture.scale;m.normalScale.set(e,e)}if(void 0!==u.occlusionTexture&&p!==A&&(_.push(r.assignTexture(m,"aoMap",u.occlusionTexture)),void 0!==u.occlusionTexture.strength&&(m.aoMapIntensity=u.occlusionTexture.strength)),void 0!==u.emissiveFactor&&p!==A){const e=u.emissiveFactor;m.emissive=(new le).setRGB(e[0],e[1],e[2],he)}return void 0!==u.emissiveTexture&&p!==A&&_.push(r.assignTexture(m,"emissiveMap",u.emissiveTexture,pe)),Promise.all(_).then((function(){const s=new p(m);return u.name&&(s.name=u.name),assignExtrasToUserData(s,u),r.associations.set(s,{materials:e}),u.extensions&&addUnknownExtensionsToUserData(h,s,u),s}))}createUniqueName(e){const r=Ie.sanitizeNodeName(e||"");return r in this.nodeNamesUsed?r+"_"+ ++this.nodeNamesUsed[r]:(this.nodeNamesUsed[r]=0,r)}loadGeometries(e){const r=this,s=this.extensions,l=this.primitiveCache;function createDracoPrimitive(e){return s[br.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(e,r).then((function(s){return addPrimitiveAttributes(s,e,r)}))}const h=[];for(let s=0,u=e.length;s<u;s++){const u=e[s],p=createPrimitiveKey(u),m=l[p];if(m)h.push(m.promise);else{let e;e=u.extensions&&u.extensions[br.KHR_DRACO_MESH_COMPRESSION]?createDracoPrimitive(u):addPrimitiveAttributes(new N,u,r),l[p]={primitive:u,promise:e},h.push(e)}}return Promise.all(h)}loadMesh(e){const r=this,s=this.json,l=this.extensions,h=s.meshes[e],u=h.primitives,m=[];for(let e=0,r=u.length;e<r;e++){const r=void 0===u[e].material?(void 0===(_=this.cache).DefaultMaterial&&(_.DefaultMaterial=new Ae({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:b})),_.DefaultMaterial):this.getDependency("material",u[e].material);m.push(r)}var _;return m.push(r.loadGeometries(u)),Promise.all(m).then((function(s){const m=s.slice(0,s.length-1),_=s[s.length-1],v=[];for(let s=0,x=_.length;s<x;s++){const x=_[s],b=u[s];let S;const C=m[s];if(b.mode===Ar.TRIANGLES||b.mode===Ar.TRIANGLE_STRIP||b.mode===Ar.TRIANGLE_FAN||void 0===b.mode)S=!0===h.isSkinnedMesh?new Ee(x,C):new p(x,C),!0===S.isSkinnedMesh&&S.normalizeSkinWeights(),b.mode===Ar.TRIANGLE_STRIP?S.geometry=toTrianglesDrawMode(S.geometry,re):b.mode===Ar.TRIANGLE_FAN&&(S.geometry=toTrianglesDrawMode(S.geometry,ne));else if(b.mode===Ar.LINES)S=new ke(x,C);else if(b.mode===Ar.LINE_STRIP)S=new Re(x,C);else if(b.mode===Ar.LINE_LOOP)S=new Me(x,C);else{if(b.mode!==Ar.POINTS)throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+b.mode);S=new Be(x,C)}Object.keys(S.geometry.morphAttributes).length>0&&updateMorphTargets(S,h),S.name=r.createUniqueName(h.name||"mesh_"+e),assignExtrasToUserData(S,h),b.extensions&&addUnknownExtensionsToUserData(l,S,b),r.assignFinalMaterial(S),v.push(S)}for(let s=0,l=v.length;s<l;s++)r.associations.set(v[s],{meshes:e,primitives:s});if(1===v.length)return h.extensions&&addUnknownExtensionsToUserData(l,v[0],h),v[0];const x=new S;h.extensions&&addUnknownExtensionsToUserData(l,x,h),r.associations.set(x,{meshes:e});for(let e=0,r=v.length;e<r;e++)x.add(v[e]);return x}))}loadCamera(e){let r;const s=this.json.cameras[e],l=s[s.type];if(l)return"perspective"===s.type?r=new Le(Pe.radToDeg(l.yfov),l.aspectRatio||1,l.znear||1,l.zfar||2e6):"orthographic"===s.type&&(r=new Ue(-l.xmag,l.xmag,l.ymag,-l.ymag,l.znear,l.zfar)),s.name&&(r.name=this.createUniqueName(s.name)),assignExtrasToUserData(r,s),Promise.resolve(r);console.warn("THREE.GLTFLoader: Missing camera parameters.")}loadSkin(e){const r=this.json.skins[e],s=[];for(let e=0,l=r.joints.length;e<l;e++)s.push(this._loadNodeShallow(r.joints[e]));return void 0!==r.inverseBindMatrices?s.push(this.getDependency("accessor",r.inverseBindMatrices)):s.push(null),Promise.all(s).then((function(e){const s=e.pop(),l=e,h=[],u=[];for(let e=0,p=l.length;e<p;e++){const p=l[e];if(p){h.push(p);const r=new v;null!==s&&r.fromArray(s.array,16*e),u.push(r)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',r.joints[e])}return new Fe(h,u)}))}loadAnimation(e){const r=this.json,s=this,l=r.animations[e],h=l.name?l.name:"animation_"+e,u=[],p=[],m=[],_=[],v=[];for(let e=0,r=l.channels.length;e<r;e++){const r=l.channels[e],s=l.samplers[r.sampler],h=r.target,x=h.node,b=void 0!==l.parameters?l.parameters[s.input]:s.input,S=void 0!==l.parameters?l.parameters[s.output]:s.output;void 0!==h.node&&(u.push(this.getDependency("node",x)),p.push(this.getDependency("accessor",b)),m.push(this.getDependency("accessor",S)),_.push(s),v.push(h))}return Promise.all([Promise.all(u),Promise.all(p),Promise.all(m),Promise.all(_),Promise.all(v)]).then((function(e){const r=e[0],l=e[1],u=e[2],p=e[3],m=e[4],_=[];for(let e=0,h=r.length;e<h;e++){const h=r[e],v=l[e],x=u[e],b=p[e],S=m[e];if(void 0===h)continue;h.updateMatrix&&h.updateMatrix();const C=s._createAnimationTracks(h,v,x,b,S);if(C)for(let e=0;e<C.length;e++)_.push(C[e])}return new De(h,void 0,_)}))}createNodeMesh(e){const r=this.json,s=this,l=r.nodes[e];return void 0===l.mesh?null:s.getDependency("mesh",l.mesh).then((function(e){const r=s._getNodeRef(s.meshCache,l.mesh,e);return void 0!==l.weights&&r.traverse((function(e){if(e.isMesh)for(let r=0,s=l.weights.length;r<s;r++)e.morphTargetInfluences[r]=l.weights[r]})),r}))}loadNode(e){const r=this,s=this.json.nodes[e],l=r._loadNodeShallow(e),h=[],u=s.children||[];for(let e=0,s=u.length;e<s;e++)h.push(r.getDependency("node",u[e]));const p=void 0===s.skin?Promise.resolve(null):r.getDependency("skin",s.skin);return Promise.all([l,Promise.all(h),p]).then((function(e){const r=e[0],s=e[1],l=e[2];null!==l&&r.traverse((function(e){e.isSkinnedMesh&&e.bind(l,Dr)}));for(let e=0,l=s.length;e<l;e++)r.add(s[e]);return r}))}_loadNodeShallow(e){const r=this.json,s=this.extensions,l=this;if(void 0!==this.nodeCache[e])return this.nodeCache[e];const h=r.nodes[e],u=h.name?l.createUniqueName(h.name):"",p=[],m=l._invokeOne((function(r){return r.createNodeMesh&&r.createNodeMesh(e)}));return m&&p.push(m),void 0!==h.camera&&p.push(l.getDependency("camera",h.camera).then((function(e){return l._getNodeRef(l.cameraCache,h.camera,e)}))),l._invokeAll((function(r){return r.createNodeAttachment&&r.createNodeAttachment(e)})).forEach((function(e){p.push(e)})),this.nodeCache[e]=Promise.all(p).then((function(r){let p;if(p=!0===h.isBone?new Oe:r.length>1?new S:1===r.length?r[0]:new W,p!==r[0])for(let e=0,s=r.length;e<s;e++)p.add(r[e]);if(h.name&&(p.userData.name=h.name,p.name=u),assignExtrasToUserData(p,h),h.extensions&&addUnknownExtensionsToUserData(s,p,h),void 0!==h.matrix){const e=new v;e.fromArray(h.matrix),p.applyMatrix4(e)}else void 0!==h.translation&&p.position.fromArray(h.translation),void 0!==h.rotation&&p.quaternion.fromArray(h.rotation),void 0!==h.scale&&p.scale.fromArray(h.scale);return l.associations.has(p)||l.associations.set(p,{}),l.associations.get(p).nodes=e,p})),this.nodeCache[e]}loadScene(e){const r=this.extensions,s=this.json.scenes[e],l=this,h=new S;s.name&&(h.name=l.createUniqueName(s.name)),assignExtrasToUserData(h,s),s.extensions&&addUnknownExtensionsToUserData(r,h,s);const u=s.nodes||[],p=[];for(let e=0,r=u.length;e<r;e++)p.push(l.getDependency("node",u[e]));return Promise.all(p).then((function(e){for(let r=0,s=e.length;r<s;r++)h.add(e[r]);return l.associations=(e=>{const r=new Map;for(const[e,s]of l.associations)(e instanceof Ce||e instanceof qe)&&r.set(e,s);return e.traverse((e=>{const s=l.associations.get(e);null!=s&&r.set(e,s)})),r})(h),h}))}_createAnimationTracks(e,r,s,l,h){const u=[],p=e.name?e.name:e.uuid,m=[];let _;switch(Br[h.path]===Br.weights?e.traverse((function(e){e.morphTargetInfluences&&m.push(e.name?e.name:e.uuid)})):m.push(p),Br[h.path]){case Br.weights:_=$e;break;case Br.rotation:_=Ye;break;case Br.position:case Br.scale:_=Ke;break;default:if(1===s.itemSize)_=$e;else _=Ke}const v=void 0!==l.interpolation?Lr[l.interpolation]:Ge,x=this._getArrayFromAccessor(s);for(let e=0,s=m.length;e<s;e++){const s=new _(m[e]+"."+Br[h.path],r.array,x,v);"CUBICSPLINE"===l.interpolation&&this._createCubicSplineTrackInterpolant(s),u.push(s)}return u}_getArrayFromAccessor(e){let r=e.array;if(e.normalized){const e=getNormalizedComponentScale(r.constructor),s=new Float32Array(r.length);for(let l=0,h=r.length;l<h;l++)s[l]=r[l]*e;r=s}return r}_createCubicSplineTrackInterpolant(e){e.createInterpolant=function(e){return new(this instanceof Ye?GLTFCubicSplineQuaternionInterpolant:GLTFCubicSplineInterpolant)(this.times,this.values,this.getValueSize()/3,e)},e.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0}}function addPrimitiveAttributes(e,s,l){const h=s.attributes,p=[];function assignAttributeAccessor(r,s){return l.getDependency("accessor",r).then((function(r){e.setAttribute(s,r)}))}for(const r in h){const s=Mr[r]||r.toLowerCase();s in e.attributes||p.push(assignAttributeAccessor(h[r],s))}if(void 0!==s.indices&&!e.index){const r=l.getDependency("accessor",s.indices).then((function(r){e.setIndex(r)}));p.push(r)}return Ne.workingColorSpace!==he&&"COLOR_0"in h&&console.warn(`THREE.GLTFLoader: Converting vertex colors from "srgb-linear" to "${Ne.workingColorSpace}" not supported.`),assignExtrasToUserData(e,s),function(e,s,l){const h=s.attributes,p=new u;if(void 0===h.POSITION)return;{const e=l.json.accessors[h.POSITION],s=e.min,u=e.max;if(void 0===s||void 0===u)return void console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");if(p.set(new r(s[0],s[1],s[2]),new r(u[0],u[1],u[2])),e.normalized){const r=getNormalizedComponentScale(Ir[e.componentType]);p.min.multiplyScalar(r),p.max.multiplyScalar(r)}}const m=s.targets;if(void 0!==m){const e=new r,s=new r;for(let r=0,h=m.length;r<h;r++){const h=m[r];if(void 0!==h.POSITION){const r=l.json.accessors[h.POSITION],u=r.min,p=r.max;if(void 0!==u&&void 0!==p){if(s.setX(Math.max(Math.abs(u[0]),Math.abs(p[0]))),s.setY(Math.max(Math.abs(u[1]),Math.abs(p[1]))),s.setZ(Math.max(Math.abs(u[2]),Math.abs(p[2]))),r.normalized){const e=getNormalizedComponentScale(Ir[r.componentType]);s.multiplyScalar(e)}e.max(s)}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}p.expandByVector(e)}e.boundingBox=p;const v=new _;p.getCenter(v.center),v.radius=p.min.distanceTo(p.max)/2,e.boundingSphere=v}(e,s,l),Promise.all(p).then((function(){return void 0!==s.targets?function(e,r,s){let l=!1,h=!1,u=!1;for(let e=0,s=r.length;e<s;e++){const s=r[e];if(void 0!==s.POSITION&&(l=!0),void 0!==s.NORMAL&&(h=!0),void 0!==s.COLOR_0&&(u=!0),l&&h&&u)break}if(!l&&!h&&!u)return Promise.resolve(e);const p=[],m=[],_=[];for(let v=0,x=r.length;v<x;v++){const x=r[v];if(l){const r=void 0!==x.POSITION?s.getDependency("accessor",x.POSITION):e.attributes.position;p.push(r)}if(h){const r=void 0!==x.NORMAL?s.getDependency("accessor",x.NORMAL):e.attributes.normal;m.push(r)}if(u){const r=void 0!==x.COLOR_0?s.getDependency("accessor",x.COLOR_0):e.attributes.color;_.push(r)}}return Promise.all([Promise.all(p),Promise.all(m),Promise.all(_)]).then((function(r){const s=r[0],p=r[1],m=r[2];return l&&(e.morphAttributes.position=s),h&&(e.morphAttributes.normal=p),u&&(e.morphAttributes.color=m),e.morphTargetsRelative=!0,e}))}(e,s.targets,l):e}))}const Or={Handedness:Object.freeze({NONE:"none",LEFT:"left",RIGHT:"right"}),ComponentState:Object.freeze({DEFAULT:"default",TOUCHED:"touched",PRESSED:"pressed"}),ComponentProperty:Object.freeze({BUTTON:"button",X_AXIS:"xAxis",Y_AXIS:"yAxis",STATE:"state"}),ComponentType:Object.freeze({TRIGGER:"trigger",SQUEEZE:"squeeze",TOUCHPAD:"touchpad",THUMBSTICK:"thumbstick",BUTTON:"button"}),ButtonTouchThreshold:.05,AxisTouchThreshold:.1,VisualResponseProperty:Object.freeze({TRANSFORM:"transform",VISIBILITY:"visibility"})};async function fetchJsonFile(e){const r=await fetch(e);if(r.ok)return r.json();throw new Error(r.statusText)}async function fetchProfile(e,r,s=null,l=!0){if(!e)throw new Error("No xrInputSource supplied");if(!r)throw new Error("No basePath supplied");const h=await async function(e){if(!e)throw new Error("No basePath supplied");return await fetchJsonFile(`${e}/profilesList.json`)}(r);let u;if(e.profiles.some((e=>{const s=h[e];return s&&(u={profileId:e,profilePath:`${r}/${s.path}`,deprecated:!!s.deprecated}),!!u})),!u){if(!s)throw new Error("No matching profile name found");const e=h[s];if(!e)throw new Error(`No matching profile name found and default profile "${s}" missing.`);u={profileId:s,profilePath:`${r}/${e.path}`,deprecated:!!e.deprecated}}const p=await fetchJsonFile(u.profilePath);let m;if(l){let r;if(r="any"===e.handedness?p.layouts[Object.keys(p.layouts)[0]]:p.layouts[e.handedness],!r)throw new Error(`No matching handedness, ${e.handedness}, in profile ${u.profileId}`);r.assetPath&&(m=u.profilePath.replace("profile.json",r.assetPath))}return{profile:p,assetPath:m}}const Gr={xAxis:0,yAxis:0,button:0,state:Or.ComponentState.DEFAULT};class VisualResponse{constructor(e){this.componentProperty=e.componentProperty,this.states=e.states,this.valueNodeName=e.valueNodeName,this.valueNodeProperty=e.valueNodeProperty,this.valueNodeProperty===Or.VisualResponseProperty.TRANSFORM&&(this.minNodeName=e.minNodeName,this.maxNodeName=e.maxNodeName),this.value=0,this.updateFromComponent(Gr)}updateFromComponent({xAxis:e,yAxis:r,button:s,state:l}){const{normalizedXAxis:h,normalizedYAxis:u}=function(e=0,r=0){let s=e,l=r;if(Math.sqrt(e*e+r*r)>1){const h=Math.atan2(r,e);s=Math.cos(h),l=Math.sin(h)}return{normalizedXAxis:.5*s+.5,normalizedYAxis:.5*l+.5}}(e,r);switch(this.componentProperty){case Or.ComponentProperty.X_AXIS:this.value=this.states.includes(l)?h:.5;break;case Or.ComponentProperty.Y_AXIS:this.value=this.states.includes(l)?u:.5;break;case Or.ComponentProperty.BUTTON:this.value=this.states.includes(l)?s:0;break;case Or.ComponentProperty.STATE:this.valueNodeProperty===Or.VisualResponseProperty.VISIBILITY?this.value=this.states.includes(l):this.value=this.states.includes(l)?1:0;break;default:throw new Error(`Unexpected visualResponse componentProperty ${this.componentProperty}`)}}}class Component{constructor(e,r){if(!(e&&r&&r.visualResponses&&r.gamepadIndices&&0!==Object.keys(r.gamepadIndices).length))throw new Error("Invalid arguments supplied");this.id=e,this.type=r.type,this.rootNodeName=r.rootNodeName,this.touchPointNodeName=r.touchPointNodeName,this.visualResponses={},Object.keys(r.visualResponses).forEach((e=>{const s=new VisualResponse(r.visualResponses[e]);this.visualResponses[e]=s})),this.gamepadIndices=Object.assign({},r.gamepadIndices),this.values={state:Or.ComponentState.DEFAULT,button:void 0!==this.gamepadIndices.button?0:void 0,xAxis:void 0!==this.gamepadIndices.xAxis?0:void 0,yAxis:void 0!==this.gamepadIndices.yAxis?0:void 0}}get data(){return{id:this.id,...this.values}}updateFromGamepad(e){if(this.values.state=Or.ComponentState.DEFAULT,void 0!==this.gamepadIndices.button&&e.buttons.length>this.gamepadIndices.button){const r=e.buttons[this.gamepadIndices.button];this.values.button=r.value,this.values.button=this.values.button<0?0:this.values.button,this.values.button=this.values.button>1?1:this.values.button,r.pressed||1===this.values.button?this.values.state=Or.ComponentState.PRESSED:(r.touched||this.values.button>Or.ButtonTouchThreshold)&&(this.values.state=Or.ComponentState.TOUCHED)}void 0!==this.gamepadIndices.xAxis&&e.axes.length>this.gamepadIndices.xAxis&&(this.values.xAxis=e.axes[this.gamepadIndices.xAxis],this.values.xAxis=this.values.xAxis<-1?-1:this.values.xAxis,this.values.xAxis=this.values.xAxis>1?1:this.values.xAxis,this.values.state===Or.ComponentState.DEFAULT&&Math.abs(this.values.xAxis)>Or.AxisTouchThreshold&&(this.values.state=Or.ComponentState.TOUCHED)),void 0!==this.gamepadIndices.yAxis&&e.axes.length>this.gamepadIndices.yAxis&&(this.values.yAxis=e.axes[this.gamepadIndices.yAxis],this.values.yAxis=this.values.yAxis<-1?-1:this.values.yAxis,this.values.yAxis=this.values.yAxis>1?1:this.values.yAxis,this.values.state===Or.ComponentState.DEFAULT&&Math.abs(this.values.yAxis)>Or.AxisTouchThreshold&&(this.values.state=Or.ComponentState.TOUCHED)),Object.values(this.visualResponses).forEach((e=>{e.updateFromComponent(this.values)}))}}class MotionController{constructor(e,r,s){if(!e)throw new Error("No xrInputSource supplied");if(!r)throw new Error("No profile supplied");this.xrInputSource=e,this.assetUrl=s,this.id=r.profileId,this.layoutDescription=r.layouts[e.handedness],this.components={},Object.keys(this.layoutDescription.components).forEach((e=>{const r=this.layoutDescription.components[e];this.components[e]=new Component(e,r)})),this.updateFromGamepad()}get gripSpace(){return this.xrInputSource.gripSpace}get targetRaySpace(){return this.xrInputSource.targetRaySpace}get data(){const e=[];return Object.values(this.components).forEach((r=>{e.push(r.data)})),e}updateFromGamepad(){Object.values(this.components).forEach((e=>{e.updateFromGamepad(this.xrInputSource.gamepad)}))}}class XRControllerModel extends W{constructor(){super(),this.motionController=null,this.envMap=null}setEnvironmentMap(e){return this.envMap==e||(this.envMap=e,this.traverse((e=>{e.isMesh&&(e.material.envMap=this.envMap,e.material.needsUpdate=!0)}))),this}updateMatrixWorld(e){if(super.updateMatrixWorld(e),!this.motionController)return;let r=this.motionController.xrInputSource?.gamepad;r&&this.motionController.updateFromGamepad(),Object.values(this.motionController.components).forEach((e=>{Object.values(e.visualResponses).forEach((e=>{const{valueNode:r,minNode:s,maxNode:l,value:h,valueNodeProperty:u}=e;r&&(u===Or.VisualResponseProperty.VISIBILITY?r.visible=h:u===Or.VisualResponseProperty.TRANSFORM&&(r.quaternion.slerpQuaternions(s.quaternion,l.quaternion,h),r.position.lerpVectors(s.position,l.position,h)))}))}))}}function addAssetSceneToControllerModel(e,r){!function(e,r){Object.values(e.components).forEach((e=>{const{type:s,touchPointNodeName:l,visualResponses:h}=e;if(s===Or.ComponentType.TOUCHPAD)if(e.touchPointNode=r.getObjectByName(l),e.touchPointNode){const r=new Je(.001),s=new A({color:255}),l=new p(r,s);e.touchPointNode.add(l)}else console.warn("Could not find touch dot, "+e.touchPointNodeName+", in touchpad component "+e.id);Object.values(h).forEach((e=>{const{valueNodeName:s,minNodeName:l,maxNodeName:h,valueNodeProperty:u}=e;if(u===Or.VisualResponseProperty.TRANSFORM){if(e.minNode=r.getObjectByName(l),e.maxNode=r.getObjectByName(h),!e.minNode)return void console.warn(`Could not find ${l} in the model`);if(!e.maxNode)return void console.warn(`Could not find ${h} in the model`)}e.valueNode=r.getObjectByName(s),e.valueNode||console.warn(`Could not find ${s} in the model`)}))}))}(e.motionController,r),e.envMap&&r.traverse((r=>{r.isMesh&&(r.material.envMap=e.envMap,r.material.needsUpdate=!0)})),e.add(r)}const Nr="https://cdn.jsdelivr.net/npm/@webxr-input-profiles/assets@1.0/dist/profiles/generic-hand/";class XRHandMeshModel{constructor(e,s,l,h,u=null){this.xrInputSource=s,this.handModel=e,this.bones=[],this._fingertips=[],this._phalanxProximals=[],this._palmTriangleVectors=[new r,new r,new r],this._palmTriangleBones=[],this._palmTriangle=new m,this.isPinching=!1,this.isGrabbing=!1,this.palmDirection=new r,null===u&&(u=new GLTFLoader).setPath(l||Nr),u.load(`${h}.glb`,(r=>{const s=r.scene.children[0];this.handModel.add(s),this.assetUrl=Nr+`${h}.glb`;const l=s.getObjectByProperty("type","SkinnedMesh");l.frustumCulled=!1,l.castShadow=!0,l.receiveShadow=!0;["wrist","thumb-metacarpal","thumb-phalanx-proximal","thumb-phalanx-distal","thumb-tip","index-finger-metacarpal","index-finger-phalanx-proximal","index-finger-phalanx-intermediate","index-finger-phalanx-distal","index-finger-tip","middle-finger-metacarpal","middle-finger-phalanx-proximal","middle-finger-phalanx-intermediate","middle-finger-phalanx-distal","middle-finger-tip","ring-finger-metacarpal","ring-finger-phalanx-proximal","ring-finger-phalanx-intermediate","ring-finger-phalanx-distal","ring-finger-tip","pinky-finger-metacarpal","pinky-finger-phalanx-proximal","pinky-finger-phalanx-intermediate","pinky-finger-phalanx-distal","pinky-finger-tip"].forEach((e=>{const r=s.getObjectByName(e);void 0!==r?r.jointName=e:console.warn(`Couldn't find ${e} in ${h} hand mesh`),this.bones.push(r)}));for(let e of[4,9,14,19,24])this._fingertips.push(this.bones[e]);for(let e of[2,6,11,16,21])this._phalanxProximals.push(this.bones[e]);this._palmTriangleBones.push(this.bones[5]),this._palmTriangleBones.push(this.bones[6]),this._palmTriangleBones.push(this.bones[10]),"left"==h&&this._palmTriangleBones.reverse(),setupBVHForComplexObject(e)}))}_updateGestures(){let e=this.bones[0];if(!e)return;let r=!0,s=e.position;for(let e=2;e<5;e++){let l=this._fingertips[e].position,h=this._phalanxProximals[e].position;if(l.distanceTo(s)>h.distanceTo(s)){r=!1;break}}this.isGrabbing=r;let l=this.bones[4],h=this.bones[9],u=l.position.distanceTo(h.position);this.isPinching?u>.025&&(this.isPinching=!1):u<.015&&(this.isPinching=!0);for(let e=0;e<3;e++)this._palmTriangleBones[e].getWorldPosition(this._palmTriangleVectors[e]);this._palmTriangle.setFromPointsAndIndices(this._palmTriangleVectors,0,1,2),this._palmTriangle.getNormal(this.palmDirection)}updateMesh(e,r,s){if(!s)return;s=s.clone().invert();let l=0;for(let h of this.xrInputSource.hand.values()){let u=this.bones[l],p=e.getJointPose(h,r);u&&p&&(u.matrix.fromArray(p.transform.matrix).premultiply(s),u.matrix.decompose(u.position,u.rotation,u.scale)),l++}this._updateGestures()}}class XRHandModel extends W{constructor(e){super(),this.controller=e,this.motionController=null,this.envMap=null,this.mesh=null}}const Hr=new class{constructor(e=null){this.gltfLoader=e,this.path="https://cdn.jsdelivr.net/npm/@webxr-input-profiles/assets@1.0/dist/profiles",this._assetCache={},this.gltfLoader||(this.gltfLoader=new GLTFLoader)}createControllerModel(e){const r=new XRControllerModel;let s=null;if("tracked-pointer"===e.targetRayMode&&e.gamepad)return fetchProfile(e,this.path,"generic-trigger").then((({profile:l,assetPath:h})=>{r.motionController=new MotionController(e,l,h);const u=this._assetCache[r.motionController.assetUrl];if(u)s=u.scene.clone(),addAssetSceneToControllerModel(r,s);else{if(!this.gltfLoader)throw new Error("GLTFLoader not set.");this.gltfLoader.setPath(""),this.gltfLoader.load(r.motionController.assetUrl,(e=>{this._assetCache[r.motionController.assetUrl]=e,s=e.scene.clone(),addAssetSceneToControllerModel(r,s),setupBVHForComplexObject(r)}),null,(e=>{throw console.error(e),new Error("Asset "+r.motionController.assetUrl+" missing or malformed.")}))}})).catch((e=>{console.warn(e)})),r}},Wr=new class{constructor(){this.path=null}setPath(e){return this.path=e,this}createHandModel(e){let r=e;const s=new XRHandModel;return r.hand&&!s.motionController&&(s.xrInputSource=r,s.motionController=new XRHandMeshModel(s,r,this.path,r.handedness)),s}};let Vr=new class{init(e,r){this._container=e,this._renderer=r,this._renderer.domElement.tabIndex="1",this._xrInputDevices={};for(let e in xr)this._xrInputDevices[e]={};this._pointerPosition=new s,this._pointerPressed=!1,this._keysPressed=new Set,this._keyCodesPressed=new Set,this._screenTouched=!1,this._joystickAngle=0,this._joystickDistance=0,this._container.style.position="relative",this._createExtraControls(),this._addEventListeners()}_addEventListeners(){if("XR"==yr.active)this._renderer.xr.addEventListener("sessionstart",(()=>{this._onXRSessionStart()})),this._renderer.xr.addEventListener("sessionend",(()=>{this._onXRSessionEnd()}));else if("POINTER"==yr.active)this._container.addEventListener("keydown",(e=>{this._keysPressed.add(e.key),this._keyCodesPressed.add(e.code)})),this._container.addEventListener("keyup",(e=>{this._keysPressed.delete(e.key),this._keyCodesPressed.delete(e.code)})),window.addEventListener("blur",(()=>{this._keysPressed.clear(),this._keyCodesPressed.clear()})),this._renderer.domElement.addEventListener("mousedown",(()=>{this._pointerPressed=!0})),this._renderer.domElement.addEventListener("mouseup",(()=>{this._pointerPressed=!1})),this._renderer.domElement.addEventListener("mousemove",(e=>{let r=e.target.getBoundingClientRect();this._pointerPosition.x=(e.clientX-r.left)/this._renderer.domElement.clientWidth*2-1,this._pointerPosition.y=-(e.clientY-r.top)/this._renderer.domElement.clientHeight*2+1})),this._container.addEventListener("mouseup",(()=>{this._renderer.domElement.focus()}));else if("TOUCH_SCREEN"==yr.active){this._renderer.domElement.addEventListener("touchstart",(()=>{this._screenTouched=!0;let e=event.target.getBoundingClientRect();this._pointerPosition.x=(event.touches[0].clientX-e.left)/this._renderer.domElement.clientWidth*2-1,this._pointerPosition.y=-(event.touches[0].clientY-e.top)/this._renderer.domElement.clientHeight*2+1})),this._renderer.domElement.addEventListener("touchend",(()=>{this._screenTouched=!1})),this._renderer.domElement.addEventListener("touchmove",(e=>{let r=e.target.getBoundingClientRect();this._pointerPosition.x=(e.touches[0].clientX-r.left)/this._renderer.domElement.clientWidth*2-1,this._pointerPosition.y=-(e.touches[0].clientY-r.top)/this._renderer.domElement.clientHeight*2+1}));let e=0;document.addEventListener("touchend",(function(r){let s=(new Date).getTime();s-e<=300&&r.preventDefault(),e=s}),!1)}}_onXRSessionStart(){this._session=this._renderer.xr.getSession(),this._session.oninputsourceschange=e=>{this._onXRInputSourceChange(e)};let e=this._session.inputSources;for(let r=0;r<e.length;r++)this._addXRInputSource(e[r])}_onXRSessionEnd(){this._session.oninputsourcechange=null,this._session=null;for(let e in this._xrInputDevices)for(let r in this._xrInputDevices[e])delete this._xrInputDevices[e][r].inputSource}_onXRInputSourceChange(e){for(let r=0;r<e.removed.length;r++)this._deleteXRInputSource(e.removed[r]);for(let r=0;r<e.added.length;r++)this._addXRInputSource(e.added[r])}_addXRInputSource(e){if("tracked-pointer"!=e.targetRayMode)return;let r=null!=e.hand?xr.HAND:xr.CONTROLLER,s=e.handedness.toUpperCase();if(s in vr){let l=this._xrInputDevices[r][s];if(l||(l={controllers:{}},this._xrInputDevices[r][s]=l,e.targetRaySpace&&(l.controllers.targetRay=new W,l.controllers.targetRay.xrInputDeviceType=r,l.controllers.targetRay.handedness=s),e.gripSpace&&(l.controllers.grip=new W,l.controllers.grip.xrInputDeviceType=r,l.controllers.grip.handedness=s)),l.inputSource=e,l.model){let r=l.model.motionController;r&&(r.xrInputSource=e)}else r==xr.HAND?l.model=Wr.createHandModel(e):r==xr.CONTROLLER&&(l.model=Hr.createControllerModel(e,"mesh"));this._xrControllerParent&&(this._xrControllerParent.add(l.controllers.targetRay),this._xrControllerParent.add(l.controllers.grip),l.controllers.grip.add(l.model),l.controllers.grip.model=l.model)}}_deleteXRInputSource(e){if("tracked-pointer"!=e.targetRayMode)return;let r=null!=e.hand?xr.HAND:xr.CONTROLLER,s=e.handedness.toUpperCase(),l=this._getXRInputDevice(r,s);l?.inputSource&&delete this._xrInputDevices[r][s].inputSource,l?.controllers&&this._xrControllerParent&&(this._xrControllerParent.remove(l.controllers.targetRay),this._xrControllerParent.remove(l.controllers.grip))}_getXRInputDevice(e,r){return this._xrInputDevices[e]?this._xrInputDevices[e][r]:null}getXRInputSource(e,r){let s=this._getXRInputDevice(e,r);return s?s.inputSource:null}getXRGamepad(e){let r=xr.CONTROLLER,s=this.getXRInputSource(r,e);return s?s.gamepad:null}getXRController(e,r,s){let l=this._getXRInputDevice(e,r);return l?l.controllers[s]:null}getXRControllerModel(e,r){let s=this._getXRInputDevice(e,r);return s?s.model:null}setXRControllerModel(e,r,s){let l=this._getXRInputDevice(e,r);return!!l&&(l.model&&l.controllers.grip.remove(l.model),l.model=s,l.controllers.grip.add(s),!0)}enableXRControllerManagement(e){this._xrControllerParent=e}disableXRControllerManagement(){this._xrControllerParent=null}getPointerPosition(){return this._pointerPosition}isPointerPressed(){return this._pointerPressed}isKeyPressed(e){return this._keysPressed.has(e)}isKeyCodePressed(e){return this._keyCodesPressed.has(e)}isScreenTouched(){return this._screenTouched}getJoystickAngle(){return this._joystickAngle}getJoystickDistance(){return this._joystickDistance}_createExtraControls(){this._extraControls={},this._extraControlsDiv=document.createElement("div"),this._extraControlsDiv.style.position="absolute",this._extraControlsDiv.style.bottom="10px",this._extraControlsDiv.style.right="10px",this._container.appendChild(this._extraControlsDiv)}createJoystick(){let e=document.createElement("div");e.style.position="absolute",e.style.width="100px",e.style.height="100px",e.style.left="10px",e.style.bottom="10px",this._container.appendChild(e);let r={zone:e,mode:"static",position:{left:"50%",top:"50%"}},s=nipplejs.create(r).get(0);s.on("move",((e,r)=>{this._joystickAngle=r.angle.radian,this._joystickDistance=Math.min(r.force,1)})),s.on("end",(()=>{this._joystickDistance=0}))}addExtraControlsButton(e,r){let s=document.createElement("button");return s.id=e,s.innerText=r,s.style.borderWidth="1px",s.style.borderStyle="solid",s.style.borderColor="#fff",s.style.borderRadius="4px",s.style.background="rgba(0,0,0,0.5)",s.style.padding="12px",s.style.color="#fff",s.style.font="normal 13px sans-serif",s.style.marginLeft="5px",s.style.opacity="0.75",s.style.width="70px",this._extraControlsDiv.appendChild(s),this._extraControls[e]=s,s}getExtraControlsButton(e){return this._extraControls[e]}hideExtraControls(){this._extraControlsDiv.style.display="none"}hideExtraControlsButton(e){let r=this._extraControls[e];r&&(r.style.display="none")}showExtraControls(){this._extraControlsDiv.style.display="block"}showExtraControlsButton(e){let r=this._extraControls[e];r&&(r.style.display="inline-block")}_updateXRController(e,r,s){let l=s.inputSource,h=s.controllers;if(l){let u=e.getPose(l.targetRaySpace,r);null!=u&&(h.targetRay.matrix.fromArray(u.transform.matrix),h.targetRay.matrix.decompose(h.targetRay.position,h.targetRay.rotation,h.targetRay.scale));let p=e.getPose(l.gripSpace,r);if(null!=p&&(h.grip.matrix.fromArray(p.transform.matrix),h.grip.matrix.decompose(h.grip.position,h.grip.rotation,h.grip.scale)),l.hand&&s.model){let l=s.model.motionController;l&&(l.updateMesh(e,r,h.grip.matrix),s.model.children.length&&updateBVHForComplexObject(s.model))}}}update(e){if(null==e)return;let r=this._renderer.xr.getReferenceSpace();for(let s in this._xrInputDevices)for(let l in this._xrInputDevices[s])this._updateXRController(e,r,this._xrInputDevices[s][l])}};class InteractableHandler{constructor(){this._interactables=new Set,this._hoveredInteractables=new Map,this._selectedInteractables=new Map,this._capturedInteractables=new Map,this._overInteractables=new Map,this._owners=new Map,this._owners.set("POINTER",{id:"POINTER"}),this._owners.set("TOUCH_SCREEN",{id:"TOUCH_SCREEN"}),this._wasPressed=new Map,this._listeners={},this._tool=null,this._toolHandlers={}}_setupXRSubscription(){gr.addUpdateListener((e=>{for(let[e,r]of this._hoveredInteractables)r&&r.removeHoveredBy(e),this._hoveredInteractables.delete(e);for(let[r,s]of this._selectedInteractables){if(!s)continue;let l=0;e&&(l+=s.getCallbacksLength(e)),this._tool&&(l+=s.getCallbacksLength(this._tool)),l&&(s.removeSelectedBy(r),this._selectedInteractables.delete(r))}this._tool=e}))}_getOwner(e){return this._owners.has(e)||this._owners.set(e,{id:e.uuid,object:e}),this._owners.get(e)}init(){"XR"==yr.active?(this.update=this._updateForXR,this._setupXRSubscription()):"POINTER"==yr.active?this.update=this._updateForPointer:"TOUCH_SCREEN"==yr.active&&(this.update=this._updateForTouchScreen)}addEventListener(e,r){e in this._listeners||(this._listeners[e]=new Set),this._listeners[e].add(r)}removeEventListener(e,r){e in this._listeners&&(this._listeners[e].delete(r),0==this._listeners[e].size&&delete this._listeners[e])}_trigger(e,r,s){if(this._listeners[e]){let l={...r};if(s&&(l.target=s.object,s[e](r)),!this._listeners[e])return;let h=[];this._listeners[e].forEach((e=>h.push(e)));for(let e of h)e(l)}else s&&s[e](r)}registerToolHandler(e,r){this._toolHandlers[e]=r}addInteractable(e){this._interactables.add(e)}addInteractables(e){e.forEach((e=>{this._interactables.add(e)}))}removeInteractable(e){this._interactables.delete(e),e.reset()}removeInteractables(e){e.forEach((e=>{this._interactables.delete(e),e.reset()}))}reset(){this._interactables.forEach((e=>{e.reset()})),this._interactables=new Set,this._hoveredInteractables=new Map,this._selectedInteractables=new Map}update(){}_updateForXR(){}_updateForPointer(){}_updateForTouchScreen(){}}const jr=new e.Vector3;let zr=new class extends InteractableHandler{constructor(){super(),this._cursors={},this._ignoredInteractables=new Set}init(e,r,s,l){super.init(),this._renderer=e,this._scene=r,this._camera=s,this._cameraFocus=l||s}_getXRCursor(r){if(this._cursors[r])return this._cursors[r];let s=document.createElement("canvas");s.width=64,s.height=64;let l=s.getContext("2d");l.beginPath(),l.arc(32,32,29,0,2*Math.PI),l.lineWidth=5,l.stroke(),l.fillStyle="white",l.fill();let h=new e.SpriteMaterial({map:new e.CanvasTexture(s),depthTest:!1,sizeAttenuation:!1});for(let r in vr){let s=new e.Sprite(h);s.scale.set(.015,.015,.015),s.visible=!1,s.renderOrder=1/0,this._cursors[r]=s,this._scene.add(s)}return this._cursors[r]}_getRaycaster(r){r.raycaster||(r.raycaster=new e.Raycaster);let s=Vr.getPointerPosition();return r.raycaster.setFromCamera(s,this._camera),r.raycaster}_getXRRaycaster(r){return r.raycaster||(r.raycaster=new e.Raycaster),r.getWorldPosition(r.raycaster.ray.origin),r.getWorldDirection(r.raycaster.ray.direction).negate().normalize(),r.raycaster}_isXRControllerPressed(e,r){if(e==xr.HAND){let s=Vr.getXRControllerModel(e,r);return 1==s?.motionController?.isPinching}{let e=Vr.getXRGamepad(r);return null!=e?.buttons&&e.buttons[0].pressed}}_squashInteractables(e,r,s){for(let l of r){let r=l.object;r&&!l.isOnlyGroup()&&s.push(r),0!=l.children.size&&this._squashInteractables(e,l.children,s)}}_getObjectInteractable(e){for(;null!=e;){let r=e.pointerInteractable;if(r&&!r.isOnlyGroup())return r;e=e.parent}}_raycastInteractables(e,r){this._ignoredInteractables.clear();let s=e.raycaster;if(!s||s.disabled)return;s.firstHitOnly=!0,s.params.Line.threshold=.01;let l=[];this._squashInteractables(e.owner,r,l);let h=s.intersectObjects(l);for(let r of h){let s=this._getObjectInteractable(r.object);if(!s||this._ignoredInteractables.has(s))continue;if(this._checkClipped(r.object,r.point)){this._ignoredInteractables.add(s);continue}let l=r.distance,h=l;if("XR"!=yr.active&&(this._cameraFocus.getWorldPosition(jr),h=r.point.distanceTo(jr)),s.isWithinReach(h))return e.closestPointDistance=l,e.closestPoint=r.point,e.closestInteractable=s,void(e.userDistance=h)}}_checkClipped(e,r){let s=e?.material?.clippingPlanes;if(s&&s.length>0)for(let e of s)if(e.distanceToPoint(r)<0)return!0;return!1}_updateInteractables(e){let r=e.owner,s=e.isPressed,l=this._hoveredInteractables.get(r),h=this._selectedInteractables.get(r),u=this._overInteractables.get(r),p=e.closestInteractable,m=e.closestPoint,_=e.userDistance;p!=l&&(l&&(l.removeHoveredBy(r),this._hoveredInteractables.delete(r)),!p||(h||s)&&p!=h||(p.addHoveredBy(r),this._hoveredInteractables.set(r,p),l=p));let v={owner:r},x={owner:r,point:m,userDistance:_};h?(s||(h.removeSelectedBy(r),this._selectedInteractables.delete(r)),h==p?(u!=p&&(u&&u.out(v),p.over(x),this._overInteractables.set(r,p)),p.move(x),p.drag(x),s||(this._trigger("up",x,p),p.click(x))):h.isCapturedBy(r)?(h!=u&&(u&&u.out(v),h.over(v),this._overInteractables.set(r,h),u=h),h.move(v),h.drag(v),s||(this._trigger("up",v,h),h.click(v),u&&u.out(v),p?(p.over(x),this._overInteractables.set(r,p)):this._overInteractables.delete(r))):p?(u!=p&&(u&&u.out(v),p.over(x),this._overInteractables.set(r,p)),p.move(x),s||this._trigger("up",x,p)):u&&(u.out(v),this._overInteractables.delete(r))):p?(u!=p&&(u&&u.out(v),p.over(x),this._overInteractables.set(r,p)),p.move(x),s&&!this._wasPressed.get(r)?(this._trigger("down",x,p),p.addSelectedBy(r),this._selectedInteractables.set(r,p)):!s&&this._wasPressed.get(r)&&this._trigger("up",x,p)):(u&&(u.out(v),this._overInteractables.delete(r)),s?this._wasPressed.get(r)||this._trigger("down",v):this._wasPressed.get(r)&&this._trigger("up",v)),this._wasPressed.set(r,s)}_updateCursor(e){let r=e.cursor;r&&(null!=e.closestPoint?(r.position.copy(e.closestPoint),r.visible||(r.visible=!0)):r.visible&&(r.visible=!1))}_updateForXR(){for(let e in vr){let r=!1;for(let s of[xr.HAND,xr.CONTROLLER]){let l=Vr.getXRController(s,e,"grip");if(!l)continue;let h,u,p=this._getOwner(l),m=isDescendant(this._scene,l);if(m&&(s==xr.CONTROLLER?r=!0:r&&(m=!1)),m){let r=Vr.getXRController(s,e,"targetRay");h=this._getXRRaycaster(r),p.raycaster||(p.raycaster=h),u=this._isXRControllerPressed(s,e)}let _={owner:p,raycaster:h,isPressed:u,closestPoint:null,closestPointDistance:Number.MAX_SAFE_INTEGER,cursor:m?this._getXRCursor(e):null,userDistance:Number.MAX_SAFE_INTEGER},v=!1;this._toolHandlers[this._tool]&&(v=this._toolHandlers[this._tool](_)),v||(this._raycastInteractables(_,this._interactables),this._updateInteractables(_)),this._updateCursor(_)}}}_updateForPointer(){let e=this._getOwner(yr.POINTER),r={owner:e,raycaster:this._getRaycaster(e),isPressed:Vr.isPointerPressed(),closestPoint:null,closestPointDistance:Number.MAX_SAFE_INTEGER,userDistance:Number.MAX_SAFE_INTEGER},s=!1;this._toolHandlers[this._tool]&&(s=this._toolHandlers[this._tool](r)),s||(this._raycastInteractables(r,this._interactables),this._updateInteractables(r));let l=this._renderer.domElement.style,h=this._hoveredInteractables.get(e);h&&!this._selectedInteractables.get(e)?l.cursor=h.hoveredCursor:""!=l.cursor&&(l.cursor="")}_updateForTouchScreen(){let e=this._getOwner(yr.TOUCH_SCREEN),r={owner:e,raycaster:this._getRaycaster(e),isPressed:Vr.isScreenTouched(),closestPoint:null,closestPointDistance:Number.MAX_SAFE_INTEGER,userDistance:Number.MAX_SAFE_INTEGER};r.raycaster.disabled=!r.isPressed&&!this._wasPressed.get(e);let s=!1;this._toolHandlers[this._tool]&&(s=this._toolHandlers[this._tool](r)),s?this._wasPressed.set(e,r.isPressed):(this._raycastInteractables(r,this._interactables),this._updateInteractables(r))}};const Xr=new e.Vector3;let qr=new class extends InteractableHandler{constructor(){super(),this._skipIntersectsCheck=new Map,this._sphere=new e.Sphere,this._box3=new e.Box3}init(e){super.init(),this._scene=e}_setupXRSubscription(){gr.addUpdateListener((e=>{for(let[r,s]of this._selectedInteractables)for(let l of s){if(!l)continue;let s=0;e&&(s+=l.getCallbacksLength(e)),this._tool&&(s+=l.getCallbacksLength(this._tool)),s&&(l.removeSelectedBy(r),this._selectedInteractables.delete(r))}this._tool=e}))}_getBoundingSphere(e){return e?(this._skipIntersectsCheck.get(e)||this._skipIntersectsCheck.set(e,new Map),this._box3.setFromObject(e).getBoundingSphere(this._sphere),this._sphere):null}_isXRControllerPressed(e,r){if(e==xr.HAND){let s=Vr.getXRControllerModel(e,r);return null!=s?.motionController?.isGrabbing}{let e=Vr.getXRGamepad(r);return null!=e?.buttons&&e.buttons[1].pressed}}_scopeInteractables(e,r){let s=e.boundingSphere,l=e.skipIntersectsCheck;if(null!=s)for(let h of r){0!=h.children.size&&this._scopeInteractables(e,h.children);let r=h.object;if(null!=r&&!h.isOnlyGroup()&&(e.activeInteractables.add(h),h.intersectsSphere(s)&&!this._checkClipped(r))){let r=e.model||e.owner.object,s=l.get(h);s?(this._selectedInteractables.get(e.owner).has(h)&&e.touchedInteractables.add(h),l.set(h,s-1)):(h.intersectsObject(r)&&e.touchedInteractables.add(h),l.set(h,5))}}}_checkClipped(e){let r=e?.material?.clippingPlanes;if(r&&r.length>0){e.getWorldPosition(Xr);for(let e of r)if(e.distanceToPoint(Xr)<0)return!0}return!1}_updateInteractables(e){let r=e.owner;this._scopeInteractables(e,this._interactables),this._selectedInteractables.get(r)||this._selectedInteractables.set(r,new Set);let s=this._selectedInteractables.get(r),l=e.touchedInteractables,h=e.activeInteractables,u={owner:r};for(let e of s)l.has(e)||(e.removeSelectedBy(r),s.delete(e),h.has(e)&&(e.drag(u),this._trigger("up",u,e),e.click(u)));for(let e of l)s.has(e)?e.drag(u):(e.addSelectedBy(r),s.add(e),this._trigger("down",u,e))}_updateForXR(){for(let e in vr){let r=!1;for(let s of[xr.HAND,xr.CONTROLLER]){let l=Vr.getXRController(s,e,"grip"),h=Vr.getXRControllerModel(s,e);if(!l)continue;let u,p,m=this._getOwner(l),_=isDescendant(this._scene,l);if(_&&(s==xr.CONTROLLER?r=!0:r&&(_=!1)),_){let e=isDescendant(l,h)?h:l;u=this._getBoundingSphere(e),p=this._skipIntersectsCheck.get(e)}let v={owner:m,model:h,boundingSphere:u,activeInteractables:new Set,touchedInteractables:new Set,skipIntersectsCheck:p},x=!1;this._toolHandlers[this._tool]&&(x=this._toolHandlers[this._tool](v)),x||this._updateInteractables(v)}}}};class InteractableComponent extends LayoutComponent{constructor(...e){super(...e),this.pointerInteractable=new PointerInteractable(this),this.touchInteractable=new TouchInteractable(this),this._clickAction=e=>this._pointerClick(e),this._dragAction=e=>this._pointerDrag(e),this._touchAction=e=>this._touch(e),this._touchDragAction=e=>this._touchDrag(e)}_createBackground(){super._createBackground(),this.pointerInteractable.object=this._background,this.touchInteractable.object=this._background}_pointerClick(e){this._onClick&&this._onClick(e)}_pointerDrag(e){this._onDrag&&this._onDrag(e)}_touch(e){this._onTouch&&this._onTouch(e)}_touchDrag(e){this._onTouchDrag&&this._onTouchDrag(e)}_onAdded(){super._onAdded();let r=this.parentComponent;if(this.parent?.pointerInteractable&&this.parent?.touchInteractable)this.parent.pointerInteractable.addChild(this.pointerInteractable),this.parent.touchInteractable.addChild(this.touchInteractable);else if(r instanceof InteractableComponent)r.pointerInteractable.addChild(this.pointerInteractable),r.touchInteractable.addChild(this.touchInteractable);else{for(r=this.parent;r;){if(r instanceof e.Scene)return zr.addInteractable(this.pointerInteractable),void qr.addInteractable(this.touchInteractable);r=r.parent}zr.removeInteractable(this.pointerInteractable),qr.removeInteractable(this.touchInteractable)}}_onRemoved(){super._onRemoved(),this.pointerInteractable.parent?this.pointerInteractable.parent.removeChild(this.pointerInteractable):zr.removeInteractable(this.pointerInteractable),this.touchInteractable.parent?this.touchInteractable.parent.removeChild(this.touchInteractable):qr.removeInteractable(this.touchInteractable)}_setCallback(e,r,s,l){let h="_on"+capitalizeFirstLetter(s),u="_"+s+"Action";l&&!this[h]?e.addEventListener(r,this[u]):!l&&this[h]&&e.removeEventListener(r,this[u]),this[h]=l}get onClick(){return this._onClick}get onDrag(){return this._onDrag}get onTouch(){return this._onTouch}get onTouchDrag(){return this._onTouchDrag}set onClick(e){this._setCallback(this.pointerInteractable,"click","click",e)}set onClickAndTouch(e){this._setCallback(this.pointerInteractable,"click","click",e),this._setCallback(this.touchInteractable,"click","touch",e)}set onDrag(e){this._setCallback(this.pointerInteractable,"drag","drag",e)}set onTouch(e){this._setCallback(this.touchInteractable,"click","touch",e)}set onTouchDrag(e){this._setCallback(this.touchInteractable,"drag","touchDrag",e)}}const Kr=new e.Vector3,$r=new e.Plane;class ScrollableComponent extends InteractableComponent{constructor(...r){super(...r),this.scrollAmount=0,this._scrollBoundsMin=new e.Vector2,this._scrollBoundsMax=new e.Vector2,this._scrollOwner,this._scrollable=!1,this._scrollableByAncestor=!1,this._downAction=e=>this.pointerInteractable.capture(e.owner),this._touchDownAction=e=>this.touchInteractable.capture(e.owner)}updateLayout(){super.updateLayout(),this._updateScrollInteractables()}_updateScrollInteractables(){let e=this._scrollable||this._scrollableByAncestor;if(this._updateScrollable(),e==(this._scrollable||this._scrollableByAncestor))return;for(let e of this._content.children)e instanceof ScrollableComponent&&e._updateScrollInteractables();let r=e?"removeEventListener":"addEventListener";this.pointerInteractable[r]("down",this._downAction),this.touchInteractable[r]("down",this._touchDownAction),this._onClick||this.pointerInteractable[r]("click",this._clickAction),this._onDrag||this.pointerInteractable[r]("drag",this._dragAction),this._onTouch||this.touchInteractable[r]("click",this._touchAction),this._onTouchDrag||this.touchInteractable[r]("drag",this._touchDragAction)}_updateScrollable(){let e=this.computedHeight,r=this.computedWidth,s=this._getContentHeight(),l=this._getContentWidth(),h="scroll"==this.overflow;if(this._verticallyScrollable=s>e&&h,this._horizontallyScrollable=l>r&&h,this._scrollable=this._verticallyScrollable||this._horizontallyScrollable,this._scrollableByAncestor=null!=this._onClick&&null!=this._getScrollableAncestor(),!this._scrollable)return this._content.position.x=0,void(this._content.position.y=0);let u,p,m,_,v,x,b,S,C=this.justifyContent,A=this.alignItems;"row"==this.contentDirection?(u=-this.unpaddedWidth,p=this.unpaddedHeight,m=-l,_=s,v="x",x="y",b=this._scrollBoundsMin,S=this._scrollBoundsMax):(u=this.unpaddedHeight,p=-this.unpaddedWidth,m=s,_=-l,v="y",x="x",b=this._scrollBoundsMax,S=this._scrollBoundsMin),"start"==C?(b[v]=m-u,S[v]=0):"end"==C?(b[v]=0,S[v]=-m+u):"center"==C||Math.abs(u)-Math.abs(m)<0?(b[v]=(m-u)/2,S[v]=-1*b[v]):b[v]=S[v]=0,"start"==A?(S[x]=_-p,b[x]=0):"end"==A?(S[x]=0,b[x]=-_+p):(S[x]=(_-p)/2,b[x]=-1*S[x]),this._verticallyScrollable&&this._boundScrollPosition("y"),this._horizontallyScrollable&&this._boundScrollPosition("x")}_pointerClick(e){let{owner:r,point:s}=e;if(this._scrollAncestor){let l=!this._scrollAncestor.scrollThresholdReached;this._scrollAncestor.clearScroll(r),this._scrollAncestor=null,this._onClick&&l&&s&&this._onClick(e)}else this._onClick&&this._onClick(e);this.clearScroll(r)}_pointerDrag(e){let{owner:r,point:s}=e;this._onDrag?this._onDrag(e):this._scrollable?this.handleScroll(r,s):this._scrollableByAncestor&&(this._scrollAncestor?this._scrollAncestor.handleScroll(r,s):(this._scrollAncestor=this._getScrollableAncestor(),this._scrollAncestor&&this._scrollAncestor.handleScroll(r,s)))}_touch(e){let r=e.owner;if(this._scrollAncestor){let r=!this.scrollThresholdReached;this.scrollThresholdReached=!1,this._scrollAncestor=null,this._onTouch&&r&&this._onTouch(e)}else this._onTouch&&this._onTouch(e);this.clearScroll(r)}_touchDrag(e){let r=e.owner;this._onTouchDrag?this._onTouchDrag(r):this._scrollable?this.handleTouchScroll(r,this.touchInteractable):this._scrollAncestor?this._scrollAncestor.scrollThresholdReached&&!this.scrollThresholdReached&&(this.scrollThresholdReached=!0):this._scrollAncestor=this._getScrollableAncestor()}clearScroll(e){this._scrollStart&&e==this._scrollOwner&&(this._scrollOwner=null,this._scrollStart=null,this._scrollStartPosition=null,this._scrollType=null,this._scrollStartThresholdReached=null,this.scrollThresholdReached=null,this.scrollAmount=0)}handleScroll(e,r){this._scrollStart?e==this._scrollOwner&&"POINTER"==this._scrollType&&(r?r=Kr.copy(r):($r.set(Kr.set(0,0,1),0),$r.applyMatrix4(this.matrixWorld),r=e.raycaster.ray.intersectPlane($r,Kr)),r&&(r=this.worldToLocal(r),this._horizontallyScrollable&&this._scroll("x",r),this._verticallyScrollable&&this._scroll("y",r))):r&&(this._scrollStart=this.worldToLocal(r.clone()),this._scrollStartPosition=this._content.position.clone(),this._scrollOwner=e,this._scrollType="POINTER")}handleTouchScroll(e,r){if(this._scrollStart){if(e==this._scrollOwner&&"TOUCH"==this._scrollType){let e=this._scrollController.bvhGeometry.getAttribute("position");Kr.fromBufferAttribute(e,this._scrollVertex),this._scrollController.localToWorld(Kr),this.worldToLocal(Kr),this._horizontallyScrollable&&this._scroll("x",Kr),this._verticallyScrollable&&this._scroll("y",Kr)}}else{let s=r.getClosestPointTo(e.object);this._scrollController=s[1].object,this._scrollVertex=this._scrollController.bvhGeometry.index.array[3*s[1].faceIndex];let l=this._scrollController.bvhGeometry.getAttribute("position");Kr.fromBufferAttribute(l,this._scrollVertex),this._scrollController.localToWorld(Kr),this._scrollStart=this.worldToLocal(Kr).clone(),this._scrollStartPosition=this._content.position.clone(),this._scrollOwner=e,this._scrollType="TOUCH"}}_getScrollableAncestor(){let e=this.parentComponent;for(;e instanceof LayoutComponent;){if(e._scrollable)return e;e=e.parentComponent}}_scroll(e,r){let s=this._content.position[e];if(this._content.position[e]=this._scrollStartPosition[e]-this._scrollStart[e]+r[e],this._boundScrollPosition(e),!this.scrollThresholdReached){let l=Math.abs(s-this._content.position[e]);this.scrollAmount+=l;let h="x"==e?this.computedWidth:this.computedHeight;this._scrollStartThresholdReached?this.scrollAmount>.1*h&&(this.scrollThresholdReached=!0):(this._content.position[e]=s,this._scrollStart[e]=r[e],this.scrollAmount>=.02*h&&(this._scrollStartThresholdReached=!0,this.scrollAmount=0))}}_boundScrollPosition(e){this._content.position[e]<this._scrollBoundsMin[e]?this._content.position[e]=this._scrollBoundsMin[e]:this._content.position[e]>this._scrollBoundsMax[e]&&(this._content.position[e]=this._scrollBoundsMax[e])}_setCallback(e,r,s,l){let h="_on"+capitalizeFirstLetter(s),u="_"+s+"Action";this._scrollable||this._scrollableByAncestor||(l&&!this[h]?e.addEventListener(r,this[u]):!l&&this[h]&&e.removeEventListener(r,this[u])),this[h]=l}}class Body extends ScrollableComponent{constructor(...e){super(...e),this.bypassContentPositioning=!0,this._defaults.backgroundVisible=!0,this._defaults.height=1,this._defaults.width=1,this.updateLayout()}}function workerBootstrap(){var e=Object.create(null);function registerModule(r,s){var l=r.id,h=r.name,u=r.dependencies;void 0===u&&(u=[]);var p=r.init;void 0===p&&(p=function(){});var m=r.getTransferables;if(void 0===m&&(m=null),!e[l])try{u=u.map((function(r){return r&&r.isWorkerModule&&(registerModule(r,(function(e){if(e instanceof Error)throw e})),r=e[r.id].value),r})),p=rehydrate("<"+h+">.init",p),m&&(m=rehydrate("<"+h+">.getTransferables",m));var _=null;"function"==typeof p?_=p.apply(void 0,u):console.error("worker module init function failed to rehydrate"),e[l]={id:l,value:_,getTransferables:m},s(_)}catch(e){e&&e.noLog||console.error(e),s(e)}}function rehydrate(e,r){var s=void 0;self.troikaDefine=function(e){return s=e};var l=URL.createObjectURL(new Blob(["/** "+e.replace(/\*/g,"")+" **/\n\ntroikaDefine(\n"+r+"\n)"],{type:"application/javascript"}));try{importScripts(l)}catch(e){console.error(e)}return URL.revokeObjectURL(l),delete self.troikaDefine,s}self.addEventListener("message",(function(r){var s=r.data,l=s.messageId,h=s.action,u=s.data;try{"registerModule"===h&&registerModule(u,(function(e){e instanceof Error?postMessage({messageId:l,success:!1,error:e.message}):postMessage({messageId:l,success:!0,result:{isCallable:"function"==typeof e}})})),"callModule"===h&&function(r,s){var l,h=r.id,u=r.args;e[h]&&"function"==typeof e[h].value||s(new Error("Worker module "+h+": not found or its 'init' did not return a function"));try{var p=(l=e[h]).value.apply(l,u);p&&"function"==typeof p.then?p.then(handleResult,(function(e){return s(e instanceof Error?e:new Error(""+e))})):handleResult(p)}catch(e){s(e)}function handleResult(r){try{var l=e[h].getTransferables&&e[h].getTransferables(r);l&&Array.isArray(l)&&l.length||(l=void 0),s(r,l)}catch(e){console.error(e),s(e)}}}(u,(function(e,r){e instanceof Error?postMessage({messageId:l,success:!1,error:e.message}):postMessage({messageId:l,success:!0,result:e},r||void 0)}))}catch(e){postMessage({messageId:l,success:!1,error:e.stack})}}))}var supportsWorkers=function(){var e=!1;if("undefined"!=typeof window&&void 0!==window.document)try{new Worker(URL.createObjectURL(new Blob([""],{type:"application/javascript"}))).terminate(),e=!0}catch(e){"undefined"!=typeof process&&"test"===process.env.NODE_ENV||console.log("Troika createWorkerModule: web workers not allowed; falling back to main thread execution. Cause: ["+e.message+"]")}return supportsWorkers=function(){return e},e},Yr=0,Zr=0,Jr=!1,Qr=Object.create(null),ei=Object.create(null),ti=Object.create(null);function defineWorkerModule(e){if(!(e&&"function"==typeof e.init||Jr))throw new Error("requires `options.init` function");var r=e.dependencies,s=e.init,l=e.getTransferables,h=e.workerId;if(!supportsWorkers())return function(e){var moduleFunc=function(){for(var e=[],r=arguments.length;r--;)e[r]=arguments[r];return moduleFunc._getInitResult().then((function(r){if("function"==typeof r)return r.apply(void 0,e);throw new Error("Worker module function was called but `init` did not return a callable function")}))};return moduleFunc._getInitResult=function(){var r=e.dependencies,s=e.init;r=Array.isArray(r)?r.map((function(e){return e&&e._getInitResult?e._getInitResult():e})):[];var l=Promise.all(r).then((function(e){return s.apply(null,e)}));return moduleFunc._getInitResult=function(){return l},l},moduleFunc}(e);null==h&&(h="#default");var u="workerModule"+ ++Yr,p=e.name||u,m=null;function moduleFunc(){for(var e=[],r=arguments.length;r--;)e[r]=arguments[r];if(!m){m=callWorker(h,"registerModule",moduleFunc.workerModuleData);var unregister=function(){m=null,ei[h].delete(unregister)};(ei[h]||(ei[h]=new Set)).add(unregister)}return m.then((function(r){if(r.isCallable)return callWorker(h,"callModule",{id:u,args:e});throw new Error("Worker module function was called but `init` did not return a callable function")}))}return r=r&&r.map((function(e){return"function"!=typeof e||e.workerModuleData||(Jr=!0,e=defineWorkerModule({workerId:h,name:"<"+p+"> function dependency: "+e.name,init:"function(){return (\n"+stringifyFunction(e)+"\n)}"}),Jr=!1),e&&e.workerModuleData&&(e=e.workerModuleData),e})),moduleFunc.workerModuleData={isWorkerModule:!0,id:u,name:p,dependencies:r,init:stringifyFunction(s),getTransferables:l&&stringifyFunction(l)},moduleFunc}function stringifyFunction(e){var r=e.toString();return!/^function/.test(r)&&/^\w+\s*\(/.test(r)&&(r="function "+r),r}function callWorker(e,r,s){return new Promise((function(l,h){var u=++Zr;ti[u]=function(e){e.success?l(e.result):h(new Error("Error in worker "+r+" call: "+e.error))},function(e){var r=Qr[e];if(!r){var s=stringifyFunction(workerBootstrap);(r=Qr[e]=new Worker(URL.createObjectURL(new Blob(["/** Worker Module Bootstrap: "+e.replace(/\*/g,"")+" **/\n\n;("+s+")()"],{type:"application/javascript"})))).onmessage=function(e){var r=e.data,s=r.messageId,l=ti[s];if(!l)throw new Error("WorkerModule response with empty or unknown messageId");delete ti[s],l(r)}}return r}(e).postMessage({messageId:u,action:r,data:s})}))}function SDFGenerator(){var e=function(e){function pointOnCubicBezier(e,r,s,l,h,u,p,m,_,v){var x=1-_;v.x=x*x*x*e+3*x*x*_*s+3*x*_*_*h+_*_*_*p,v.y=x*x*x*r+3*x*x*_*l+3*x*_*_*u+_*_*_*m}function forEachPathCommand(e,r){for(var s,l,h,u,p,m=/([MLQCZ])([^MLQCZ]*)/g;s=m.exec(e);){var _=s[2].replace(/^\s*|\s*$/g,"").split(/[,\s]+/).map((function(e){return parseFloat(e)}));switch(s[1]){case"M":u=l=_[0],p=h=_[1];break;case"L":_[0]===u&&_[1]===p||r("L",u,p,u=_[0],p=_[1]);break;case"Q":r("Q",u,p,u=_[2],p=_[3],_[0],_[1]);break;case"C":r("C",u,p,u=_[4],p=_[5],_[0],_[1],_[2],_[3]);break;case"Z":u===l&&p===h||r("L",u,p,l,h)}}}function pathToLineSegments(e,r,s){void 0===s&&(s=16);var l={x:0,y:0};forEachPathCommand(e,(function(e,h,u,p,m,_,v,x,b){switch(e){case"L":r(h,u,p,m);break;case"Q":for(var S=h,C=u,A=1;A<s;A++)B=u,F=v,D=m,H=void 0,H=1-(G=A/(s-1)),(N=l).x=H*H*h+2*H*G*_+G*G*p,N.y=H*H*B+2*H*G*F+G*G*D,r(S,C,l.x,l.y),S=l.x,C=l.y;break;case"C":for(var I=h,E=u,R=1;R<s;R++)pointOnCubicBezier(h,u,_,v,x,b,p,m,R/(s-1),l),r(I,E,l.x,l.y),I=l.x,E=l.y}var B,F,D,G,N,H}))}var r="precision highp float;attribute vec2 aUV;varying vec2 vUV;void main(){vUV=aUV;gl_Position=vec4(mix(vec2(-1.0),vec2(1.0),aUV),0.0,1.0);}",s="precision highp float;uniform sampler2D tex;varying vec2 vUV;void main(){gl_FragColor=texture2D(tex,vUV);}",l=new WeakMap,h={premultipliedAlpha:!1,preserveDrawingBuffer:!0,antialias:!1,depth:!1};function withWebGLContext(e,r){var s=e.getContext?e.getContext("webgl",h):e,u=l.get(s);if(!u){var p="undefined"!=typeof WebGL2RenderingContext&&s instanceof WebGL2RenderingContext,m={},_={},v={},x=-1,b=[];function getExtension(e){var r=m[e];if(!r&&!(r=m[e]=s.getExtension(e)))throw new Error(e+" not supported");return r}function compileShader(e,r){var l=s.createShader(r);return s.shaderSource(l,e),s.compileShader(l),l}function withProgram(e,r,l,h){if(!_[e]){var u={},m={},v=s.createProgram();s.attachShader(v,compileShader(r,s.VERTEX_SHADER)),s.attachShader(v,compileShader(l,s.FRAGMENT_SHADER)),s.linkProgram(v),_[e]={program:v,transaction:function(e){s.useProgram(v),e({setUniform:function(e,r){for(var l=[],h=arguments.length-2;h-- >0;)l[h]=arguments[h+2];var u=m[r]||(m[r]=s.getUniformLocation(v,r));s["uniform"+e].apply(s,[u].concat(l))},setAttribute:function(e,r,l,h,m){var _=u[e];_||(_=u[e]={buf:s.createBuffer(),loc:s.getAttribLocation(v,e),data:null}),s.bindBuffer(s.ARRAY_BUFFER,_.buf),s.vertexAttribPointer(_.loc,r,s.FLOAT,!1,0,0),s.enableVertexAttribArray(_.loc),p?s.vertexAttribDivisor(_.loc,h):getExtension("ANGLE_instanced_arrays").vertexAttribDivisorANGLE(_.loc,h),m!==_.data&&(s.bufferData(s.ARRAY_BUFFER,m,l),_.data=m)}})}}}_[e].transaction(h)}function withTexture(e,r){x++;try{s.activeTexture(s.TEXTURE0+x);var l=v[e];l||(l=v[e]=s.createTexture(),s.bindTexture(s.TEXTURE_2D,l),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.NEAREST),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,s.NEAREST)),s.bindTexture(s.TEXTURE_2D,l),r(l,x)}finally{x--}}function withTextureFramebuffer(e,r,l){var h=s.createFramebuffer();b.push(h),s.bindFramebuffer(s.FRAMEBUFFER,h),s.activeTexture(s.TEXTURE0+r),s.bindTexture(s.TEXTURE_2D,e),s.framebufferTexture2D(s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.TEXTURE_2D,e,0);try{l(h)}finally{s.deleteFramebuffer(h),s.bindFramebuffer(s.FRAMEBUFFER,b[--b.length-1]||null)}}function handleContextLoss(){m={},_={},v={},x=-1,b.length=0}s.canvas.addEventListener("webglcontextlost",(function(e){handleContextLoss(),e.preventDefault()}),!1),l.set(s,u={gl:s,isWebGL2:p,getExtension:getExtension,withProgram:withProgram,withTexture:withTexture,withTextureFramebuffer:withTextureFramebuffer,handleContextLoss:handleContextLoss})}r(u)}function renderImageData(e,l,h,u,p,m,_,v){void 0===_&&(_=15),void 0===v&&(v=null),withWebGLContext(e,(function(e){var x=e.gl,b=e.withProgram;(0,e.withTexture)("copy",(function(e,S){x.texImage2D(x.TEXTURE_2D,0,x.RGBA,p,m,0,x.RGBA,x.UNSIGNED_BYTE,l),b("copy",r,s,(function(e){var r=e.setUniform;(0,e.setAttribute)("aUV",2,x.STATIC_DRAW,0,new Float32Array([0,0,2,0,0,2])),r("1i","image",S),x.bindFramebuffer(x.FRAMEBUFFER,v||null),x.disable(x.BLEND),x.colorMask(8&_,4&_,2&_,1&_),x.viewport(h,u,p,m),x.scissor(h,u,p,m),x.drawArrays(x.TRIANGLES,0,3)}))}))}))}var u=Object.freeze({__proto__:null,withWebGLContext:withWebGLContext,renderImageData:renderImageData,resizeWebGLCanvasWithoutClearing:function(e,r,s){var l=e.width,h=e.height;withWebGLContext(e,(function(u){var p=u.gl,m=new Uint8Array(l*h*4);p.readPixels(0,0,l,h,p.RGBA,p.UNSIGNED_BYTE,m),e.width=r,e.height=s,renderImageData(p,m,0,0,l,h)}))}});function generate$2(e,r,s,l,h,u){void 0===u&&(u=1);var p=new Uint8Array(e*r),m=l[2]-l[0],_=l[3]-l[1],v=[];pathToLineSegments(s,(function(e,r,s,l){v.push({x1:e,y1:r,x2:s,y2:l,minX:Math.min(e,s),minY:Math.min(r,l),maxX:Math.max(e,s),maxY:Math.max(r,l)})})),v.sort((function(e,r){return e.maxX-r.maxX}));for(var x=0;x<e;x++)for(var b=0;b<r;b++){var S=findNearestSignedDistance(l[0]+m*(x+.5)/e,l[1]+_*(b+.5)/r),C=Math.pow(1-Math.abs(S)/h,u)/2;S<0&&(C=1-C),C=Math.max(0,Math.min(255,Math.round(255*C))),p[b*e+x]=C}return p;function findNearestSignedDistance(e,r){for(var s=1/0,l=1/0,h=v.length;h--;){var u=v[h];if(u.maxX+l<=e)break;if(e+l>u.minX&&r-l<u.maxY&&r+l>u.minY){var p=absSquareDistanceToLineSegment(e,r,u.x1,u.y1,u.x2,u.y2);p<s&&(s=p,l=Math.sqrt(s))}}return function(e,r){for(var s=0,l=v.length;l--;){var h=v[l];if(h.maxX<=e)break;h.y1>r!=h.y2>r&&e<(h.x2-h.x1)*(r-h.y1)/(h.y2-h.y1)+h.x1&&(s+=h.y1<h.y2?1:-1)}return 0!==s}(e,r)&&(l=-l),l}}function generateIntoCanvas$2(e,r,s,l,h,u,p,m,_,v){void 0===u&&(u=1),void 0===m&&(m=0),void 0===_&&(_=0),void 0===v&&(v=0),generateIntoFramebuffer$1(e,r,s,l,h,u,p,null,m,_,v)}function generateIntoFramebuffer$1(e,r,s,l,h,u,p,m,_,v,x){void 0===u&&(u=1),void 0===_&&(_=0),void 0===v&&(v=0),void 0===x&&(x=0);for(var b=generate$2(e,r,s,l,h,u),S=new Uint8Array(4*b.length),C=0;C<b.length;C++)S[4*C+x]=b[C];renderImageData(p,S,_,v,e,r,1<<3-x,m)}function absSquareDistanceToLineSegment(e,r,s,l,h,u){var p=h-s,m=u-l,_=p*p+m*m,v=_?Math.max(0,Math.min(1,((e-s)*p+(r-l)*m)/_)):0,x=e-(s+v*p),b=r-(l+v*m);return x*x+b*b}var p=Object.freeze({__proto__:null,generate:generate$2,generateIntoCanvas:generateIntoCanvas$2,generateIntoFramebuffer:generateIntoFramebuffer$1}),m="precision highp float;uniform vec4 uGlyphBounds;attribute vec2 aUV;attribute vec4 aLineSegment;varying vec4 vLineSegment;varying vec2 vGlyphXY;void main(){vLineSegment=aLineSegment;vGlyphXY=mix(uGlyphBounds.xy,uGlyphBounds.zw,aUV);gl_Position=vec4(mix(vec2(-1.0),vec2(1.0),aUV),0.0,1.0);}",_="precision highp float;uniform vec4 uGlyphBounds;uniform float uMaxDistance;uniform float uExponent;varying vec4 vLineSegment;varying vec2 vGlyphXY;float absDistToSegment(vec2 point,vec2 lineA,vec2 lineB){vec2 lineDir=lineB-lineA;float lenSq=dot(lineDir,lineDir);float t=lenSq==0.0 ? 0.0 : clamp(dot(point-lineA,lineDir)/lenSq,0.0,1.0);vec2 linePt=lineA+t*lineDir;return distance(point,linePt);}void main(){vec4 seg=vLineSegment;vec2 p=vGlyphXY;float dist=absDistToSegment(p,seg.xy,seg.zw);float val=pow(1.0-clamp(dist/uMaxDistance,0.0,1.0),uExponent)*0.5;bool crossing=(seg.y>p.y!=seg.w>p.y)&&(p.x<(seg.z-seg.x)*(p.y-seg.y)/(seg.w-seg.y)+seg.x);bool crossingUp=crossing&&vLineSegment.y<vLineSegment.w;gl_FragColor=vec4(crossingUp ? 1.0/255.0 : 0.0,crossing&&!crossingUp ? 1.0/255.0 : 0.0,0.0,val);}",v="precision highp float;uniform sampler2D tex;varying vec2 vUV;void main(){vec4 color=texture2D(tex,vUV);bool inside=color.r!=color.g;float val=inside ? 1.0-color.a : color.a;gl_FragColor=vec4(val);}",x=new Float32Array([0,0,2,0,0,2]),b=null,S=!1,C={},A=new WeakMap;function validateSupport(e){if(!S&&!isSupported(e))throw new Error("WebGL generation not supported")}function generate$1(e,r,s,l,h,u,p){if(void 0===u&&(u=1),void 0===p&&(p=null),!p&&!(p=b)){var m="function"==typeof OffscreenCanvas?new OffscreenCanvas(1,1):"undefined"!=typeof document?document.createElement("canvas"):null;if(!m)throw new Error("OffscreenCanvas or DOM canvas not supported");p=b=m.getContext("webgl",{depth:!1})}validateSupport(p);var _=new Uint8Array(e*r*4);withWebGLContext(p,(function(p){var m=p.gl,v=p.withTexture,x=p.withTextureFramebuffer;v("readable",(function(p,v){m.texImage2D(m.TEXTURE_2D,0,m.RGBA,e,r,0,m.RGBA,m.UNSIGNED_BYTE,null),x(p,v,(function(p){generateIntoFramebuffer(e,r,s,l,h,u,m,p,0,0,0),m.readPixels(0,0,e,r,m.RGBA,m.UNSIGNED_BYTE,_)}))}))}));for(var v=new Uint8Array(e*r),x=0,S=0;x<_.length;x+=4)v[S++]=_[x];return v}function generateIntoCanvas$1(e,r,s,l,h,u,p,m,_,v){void 0===u&&(u=1),void 0===m&&(m=0),void 0===_&&(_=0),void 0===v&&(v=0),generateIntoFramebuffer(e,r,s,l,h,u,p,null,m,_,v)}function generateIntoFramebuffer(e,s,l,h,u,p,b,S,C,A,I){void 0===p&&(p=1),void 0===C&&(C=0),void 0===A&&(A=0),void 0===I&&(I=0),validateSupport(b);var E=[];pathToLineSegments(l,(function(e,r,s,l){E.push(e,r,s,l)})),E=new Float32Array(E),withWebGLContext(b,(function(l){var b=l.gl,R=l.isWebGL2,B=l.getExtension,F=l.withProgram,D=l.withTexture,G=l.withTextureFramebuffer,N=l.handleContextLoss;if(D("rawDistances",(function(l,D){e===l._lastWidth&&s===l._lastHeight||b.texImage2D(b.TEXTURE_2D,0,b.RGBA,l._lastWidth=e,l._lastHeight=s,0,b.RGBA,b.UNSIGNED_BYTE,null),F("main",m,_,(function(r){var m=r.setAttribute,_=r.setUniform,v=!R&&B("ANGLE_instanced_arrays"),S=!R&&B("EXT_blend_minmax");m("aUV",2,b.STATIC_DRAW,0,x),m("aLineSegment",4,b.DYNAMIC_DRAW,1,E),_.apply(void 0,["4f","uGlyphBounds"].concat(h)),_("1f","uMaxDistance",u),_("1f","uExponent",p),G(l,D,(function(r){b.enable(b.BLEND),b.colorMask(!0,!0,!0,!0),b.viewport(0,0,e,s),b.scissor(0,0,e,s),b.blendFunc(b.ONE,b.ONE),b.blendEquationSeparate(b.FUNC_ADD,R?b.MAX:S.MAX_EXT),b.clear(b.COLOR_BUFFER_BIT),R?b.drawArraysInstanced(b.TRIANGLES,0,3,E.length/4):v.drawArraysInstancedANGLE(b.TRIANGLES,0,3,E.length/4)}))})),F("post",r,v,(function(r){r.setAttribute("aUV",2,b.STATIC_DRAW,0,x),r.setUniform("1i","tex",D),b.bindFramebuffer(b.FRAMEBUFFER,S),b.disable(b.BLEND),b.colorMask(0===I,1===I,2===I,3===I),b.viewport(C,A,e,s),b.scissor(C,A,e,s),b.drawArrays(b.TRIANGLES,0,3)}))})),b.isContextLost())throw N(),new Error("webgl context lost")}))}function isSupported(e){var r=e&&e!==b?e.canvas||e:C,s=A.get(r);if(void 0===s){S=!0;var l=null;try{var h=[97,106,97,61,99,137,118,80,80,118,137,99,61,97,106,97],u=generate$1(4,4,"M8,8L16,8L24,24L16,24Z",[0,0,32,32],24,1,e);s=u&&h.length===u.length&&u.every((function(e,r){return e===h[r]})),s||(l="bad trial run results",console.info(h,u))}catch(e){s=!1,l=e.message}l&&console.warn("WebGL SDF generation not supported:",l),S=!1,A.set(r,s)}return s}var I=Object.freeze({__proto__:null,generate:generate$1,generateIntoCanvas:generateIntoCanvas$1,generateIntoFramebuffer:generateIntoFramebuffer,isSupported:isSupported});return e.forEachPathCommand=forEachPathCommand,e.generate=function(e,r,s,l,h,u){void 0===h&&(h=Math.max(l[2]-l[0],l[3]-l[1])/2),void 0===u&&(u=1);try{return generate$1.apply(I,arguments)}catch(e){return console.info("WebGL SDF generation failed, falling back to JS",e),generate$2.apply(p,arguments)}},e.generateIntoCanvas=function(e,r,s,l,h,u,m,_,v,x){void 0===h&&(h=Math.max(l[2]-l[0],l[3]-l[1])/2),void 0===u&&(u=1),void 0===_&&(_=0),void 0===v&&(v=0),void 0===x&&(x=0);try{return generateIntoCanvas$1.apply(I,arguments)}catch(e){return console.info("WebGL SDF generation failed, falling back to JS",e),generateIntoCanvas$2.apply(p,arguments)}},e.javascript=p,e.pathToLineSegments=pathToLineSegments,e.webgl=I,e.webglUtils=u,Object.defineProperty(e,"__esModule",{value:!0}),e}({});return e}const ni=/\bvoid\s+main\s*\(\s*\)\s*{/g;function expandShaderIncludes(e){return e.replace(/^[ \t]*#include +<([\w\d./]+)>/gm,(function(e,r){let s=rt[r];return s?expandShaderIncludes(s):e}))}const ri=[];for(let e=0;e<256;e++)ri[e]=(e<16?"0":"")+e.toString(16);const ii=Object.assign||function(){let e=arguments[0];for(let r=1,s=arguments.length;r<s;r++){let s=arguments[r];if(s)for(let r in s)Object.prototype.hasOwnProperty.call(s,r)&&(e[r]=s[r])}return e},si=Date.now(),oi=new WeakMap,ai=new Map;let li=1e10;function createDerivedMaterial(e,r){const s=function(e){const r=JSON.stringify(e,optionsJsonReplacer);let s=ci.get(r);null==s&&ci.set(r,s=++hi);return s}
/*!
Custom build of Typr.ts (https://github.com/fredli74/Typr.ts) for use in Troika text rendering.
Original MIT license applies: https://github.com/fredli74/Typr.ts/blob/master/LICENSE
*/(r);let l=oi.get(e);if(l||oi.set(e,l=Object.create(null)),l[s])return new l[s];const h=`_onBeforeCompile${s}`,onBeforeCompile=function(l,u){e.onBeforeCompile.call(this,l,u);const p=this.customProgramCacheKey()+"|"+l.vertexShader+"|"+l.fragmentShader;let m=ai[p];if(!m){const e=function(e,{vertexShader:r,fragmentShader:s},l,h){let{vertexDefs:u,vertexMainIntro:p,vertexMainOutro:m,vertexTransform:_,fragmentDefs:v,fragmentMainIntro:x,fragmentMainOutro:b,fragmentColorTransform:S,customRewriter:C,timeUniform:A}=l;u=u||"",p=p||"",m=m||"",v=v||"",x=x||"",b=b||"",(_||C)&&(r=expandShaderIncludes(r));(S||C)&&(s=expandShaderIncludes(s=s.replace(/^[ \t]*#include <((?:tonemapping|encodings|fog|premultiplied_alpha|dithering)_fragment)>/gm,"\n//!BEGIN_POST_CHUNK $1\n$&\n//!END_POST_CHUNK\n")));if(C){let e=C({vertexShader:r,fragmentShader:s});r=e.vertexShader,s=e.fragmentShader}if(S){let e=[];s=s.replace(/^\/\/!BEGIN_POST_CHUNK[^]+?^\/\/!END_POST_CHUNK/gm,(r=>(e.push(r),""))),b=`${S}\n${e.join("\n")}\n${b}`}if(A){const e=`\nuniform float ${A};\n`;u=e+u,v=e+v}_&&(u=`${u}\nvoid troikaVertexTransform${h}(inout vec3 position, inout vec3 normal, inout vec2 uv) {\n  ${_}\n}\n`,p=`\ntroika_position_${h} = vec3(position);\ntroika_normal_${h} = vec3(normal);\ntroika_uv_${h} = vec2(uv);\ntroikaVertexTransform${h}(troika_position_${h}, troika_normal_${h}, troika_uv_${h});\n${p}\n`,r=(r=`vec3 troika_position_${h};\nvec3 troika_normal_${h};\nvec2 troika_uv_${h};\n${r}\n`).replace(/\b(position|normal|uv)\b/g,((e,r,s,l)=>/\battribute\s+vec[23]\s+$/.test(l.substr(0,s))?r:`troika_${r}_${h}`)),e.map&&e.map.channel>0||(r=r.replace(/\bMAP_UV\b/g,`troika_uv_${h}`)));return r=injectIntoShaderCode(r,h,u,p,m),s=injectIntoShaderCode(s,h,v,x,b),{vertexShader:r,fragmentShader:s}}(this,l,r,s);m=ai[p]=e}l.vertexShader=m.vertexShader,l.fragmentShader=m.fragmentShader,ii(l.uniforms,this.uniforms),r.timeUniform&&(l.uniforms[r.timeUniform]={get value(){return Date.now()-si}}),this[h]&&this[h](l)},DerivedMaterial=function(){return derive(r.chained?e:e.clone())},derive=function(l){const h=Object.create(l,u);return Object.defineProperty(h,"baseMaterial",{value:e}),Object.defineProperty(h,"id",{value:li++}),h.uuid=function(){const e=4294967295*Math.random()|0,r=4294967295*Math.random()|0,s=4294967295*Math.random()|0,l=4294967295*Math.random()|0;return(ri[255&e]+ri[e>>8&255]+ri[e>>16&255]+ri[e>>24&255]+"-"+ri[255&r]+ri[r>>8&255]+"-"+ri[r>>16&15|64]+ri[r>>24&255]+"-"+ri[63&s|128]+ri[s>>8&255]+"-"+ri[s>>16&255]+ri[s>>24&255]+ri[255&l]+ri[l>>8&255]+ri[l>>16&255]+ri[l>>24&255]).toUpperCase()}(),h.uniforms=ii({},l.uniforms,r.uniforms),h.defines=ii({},l.defines,r.defines),h.defines[`TROIKA_DERIVED_MATERIAL_${s}`]="",h.extensions=ii({},l.extensions,r.extensions),h._listeners=void 0,h},u={constructor:{value:DerivedMaterial},isDerivedMaterial:{value:!0},customProgramCacheKey:{writable:!0,configurable:!0,value:function(){return e.customProgramCacheKey()+"|"+s}},onBeforeCompile:{get:()=>onBeforeCompile,set(e){this[h]=e}},copy:{writable:!0,configurable:!0,value:function(r){return e.copy.call(this,r),e.isShaderMaterial||e.isDerivedMaterial||(ii(this.extensions,r.extensions),ii(this.defines,r.defines),ii(this.uniforms,Qe.clone(r.uniforms))),this}},clone:{writable:!0,configurable:!0,value:function(){const r=new e.constructor;return derive(r).copy(this)}},getDepthMaterial:{writable:!0,configurable:!0,value:function(){let s=this._depthMaterial;return s||(s=this._depthMaterial=createDerivedMaterial(e.isDerivedMaterial?e.getDepthMaterial():new et({depthPacking:tt}),r),s.defines.IS_DEPTH_MATERIAL="",s.uniforms=this.uniforms),s}},getDistanceMaterial:{writable:!0,configurable:!0,value:function(){let s=this._distanceMaterial;return s||(s=this._distanceMaterial=createDerivedMaterial(e.isDerivedMaterial?e.getDistanceMaterial():new nt,r),s.defines.IS_DISTANCE_MATERIAL="",s.uniforms=this.uniforms),s}},dispose:{writable:!0,configurable:!0,value(){const{_depthMaterial:r,_distanceMaterial:s}=this;r&&r.dispose(),s&&s.dispose(),e.dispose.call(this)}}};return l[s]=DerivedMaterial,new DerivedMaterial}function injectIntoShaderCode(e,r,s,l,h){return(l||h||s)&&(e=e.replace(ni,`\n${s}\nvoid troikaOrigMain${r}() {`),e+=`\nvoid main() {\n  ${l}\n  troikaOrigMain${r}();\n  ${h}\n}`),e}function optionsJsonReplacer(e,r){return"uniforms"===e?void 0:"function"==typeof r?r.toString():r}let hi=0;const ci=new Map;const di=defineWorkerModule({name:"Typr Font Parser",dependencies:[function(){return"undefined"==typeof window&&(self.window=self),function(e){var r={parse:function(e){var s=r._bin,l=new Uint8Array(e);if("ttcf"==s.readASCII(l,0,4)){var h=4;s.readUshort(l,h),h+=2,s.readUshort(l,h),h+=2;var u=s.readUint(l,h);h+=4;for(var p=[],m=0;m<u;m++){var _=s.readUint(l,h);h+=4,p.push(r._readFont(l,_))}return p}return[r._readFont(l,0)]},_readFont:function(e,s){var l=r._bin,h=s;l.readFixed(e,s),s+=4;var u=l.readUshort(e,s);s+=2,l.readUshort(e,s),s+=2,l.readUshort(e,s),s+=2,l.readUshort(e,s),s+=2;for(var p=["cmap","head","hhea","maxp","hmtx","name","OS/2","post","loca","glyf","kern","CFF ","GDEF","GPOS","GSUB","SVG "],m={_data:e,_offset:h},_={},v=0;v<u;v++){var x=l.readASCII(e,s,4);s+=4,l.readUint(e,s),s+=4;var b=l.readUint(e,s);s+=4;var S=l.readUint(e,s);s+=4,_[x]={offset:b,length:S}}for(v=0;v<p.length;v++){var C=p[v];_[C]&&(m[C.trim()]=r[C.trim()].parse(e,_[C].offset,_[C].length,m))}return m},_tabOffset:function(e,s,l){for(var h=r._bin,u=h.readUshort(e,l+4),p=l+12,m=0;m<u;m++){var _=h.readASCII(e,p,4);p+=4,h.readUint(e,p),p+=4;var v=h.readUint(e,p);if(p+=4,h.readUint(e,p),p+=4,_==s)return v}return 0}};r._bin={readFixed:function(e,r){return(e[r]<<8|e[r+1])+(e[r+2]<<8|e[r+3])/65540},readF2dot14:function(e,s){return r._bin.readShort(e,s)/16384},readInt:function(e,s){return r._bin._view(e).getInt32(s)},readInt8:function(e,s){return r._bin._view(e).getInt8(s)},readShort:function(e,s){return r._bin._view(e).getInt16(s)},readUshort:function(e,s){return r._bin._view(e).getUint16(s)},readUshorts:function(e,s,l){for(var h=[],u=0;u<l;u++)h.push(r._bin.readUshort(e,s+2*u));return h},readUint:function(e,s){return r._bin._view(e).getUint32(s)},readUint64:function(e,s){return 4294967296*r._bin.readUint(e,s)+r._bin.readUint(e,s+4)},readASCII:function(e,r,s){for(var l="",h=0;h<s;h++)l+=String.fromCharCode(e[r+h]);return l},readUnicode:function(e,r,s){for(var l="",h=0;h<s;h++){var u=e[r++]<<8|e[r++];l+=String.fromCharCode(u)}return l},_tdec:"undefined"!=typeof window&&window.TextDecoder?new window.TextDecoder:null,readUTF8:function(e,s,l){var h=r._bin._tdec;return h&&0==s&&l==e.length?h.decode(e):r._bin.readASCII(e,s,l)},readBytes:function(e,r,s){for(var l=[],h=0;h<s;h++)l.push(e[r+h]);return l},readASCIIArray:function(e,r,s){for(var l=[],h=0;h<s;h++)l.push(String.fromCharCode(e[r+h]));return l},_view:function(e){return e._dataView||(e._dataView=e.buffer?new DataView(e.buffer,e.byteOffset,e.byteLength):new DataView(new Uint8Array(e).buffer))}},r._lctf={},r._lctf.parse=function(e,s,l,h,u){var p=r._bin,m={},_=s;p.readFixed(e,s),s+=4;var v=p.readUshort(e,s);s+=2;var x=p.readUshort(e,s);s+=2;var b=p.readUshort(e,s);return s+=2,m.scriptList=r._lctf.readScriptList(e,_+v),m.featureList=r._lctf.readFeatureList(e,_+x),m.lookupList=r._lctf.readLookupList(e,_+b,u),m},r._lctf.readLookupList=function(e,s,l){var h=r._bin,u=s,p=[],m=h.readUshort(e,s);s+=2;for(var _=0;_<m;_++){var v=h.readUshort(e,s);s+=2;var x=r._lctf.readLookupTable(e,u+v,l);p.push(x)}return p},r._lctf.readLookupTable=function(e,s,l){var h=r._bin,u=s,p={tabs:[]};p.ltype=h.readUshort(e,s),s+=2,p.flag=h.readUshort(e,s),s+=2;var m=h.readUshort(e,s);s+=2;for(var _=p.ltype,v=0;v<m;v++){var x=h.readUshort(e,s);s+=2;var b=l(e,_,u+x,p);p.tabs.push(b)}return p},r._lctf.numOfOnes=function(e){for(var r=0,s=0;s<32;s++)0!=(e>>>s&1)&&r++;return r},r._lctf.readClassDef=function(e,s){var l=r._bin,h=[],u=l.readUshort(e,s);if(s+=2,1==u){var p=l.readUshort(e,s);s+=2;var m=l.readUshort(e,s);s+=2;for(var _=0;_<m;_++)h.push(p+_),h.push(p+_),h.push(l.readUshort(e,s)),s+=2}if(2==u){var v=l.readUshort(e,s);for(s+=2,_=0;_<v;_++)h.push(l.readUshort(e,s)),s+=2,h.push(l.readUshort(e,s)),s+=2,h.push(l.readUshort(e,s)),s+=2}return h},r._lctf.getInterval=function(e,r){for(var s=0;s<e.length;s+=3){var l=e[s],h=e[s+1];if(e[s+2],l<=r&&r<=h)return s}return-1},r._lctf.readCoverage=function(e,s){var l=r._bin,h={};h.fmt=l.readUshort(e,s),s+=2;var u=l.readUshort(e,s);return s+=2,1==h.fmt&&(h.tab=l.readUshorts(e,s,u)),2==h.fmt&&(h.tab=l.readUshorts(e,s,3*u)),h},r._lctf.coverageIndex=function(e,s){var l=e.tab;if(1==e.fmt)return l.indexOf(s);if(2==e.fmt){var h=r._lctf.getInterval(l,s);if(-1!=h)return l[h+2]+(s-l[h])}return-1},r._lctf.readFeatureList=function(e,s){var l=r._bin,h=s,u=[],p=l.readUshort(e,s);s+=2;for(var m=0;m<p;m++){var _=l.readASCII(e,s,4);s+=4;var v=l.readUshort(e,s);s+=2;var x=r._lctf.readFeatureTable(e,h+v);x.tag=_.trim(),u.push(x)}return u},r._lctf.readFeatureTable=function(e,s){var l=r._bin,h=s,u={},p=l.readUshort(e,s);s+=2,p>0&&(u.featureParams=h+p);var m=l.readUshort(e,s);s+=2,u.tab=[];for(var _=0;_<m;_++)u.tab.push(l.readUshort(e,s+2*_));return u},r._lctf.readScriptList=function(e,s){var l=r._bin,h=s,u={},p=l.readUshort(e,s);s+=2;for(var m=0;m<p;m++){var _=l.readASCII(e,s,4);s+=4;var v=l.readUshort(e,s);s+=2,u[_.trim()]=r._lctf.readScriptTable(e,h+v)}return u},r._lctf.readScriptTable=function(e,s){var l=r._bin,h=s,u={},p=l.readUshort(e,s);s+=2,p>0&&(u.default=r._lctf.readLangSysTable(e,h+p));var m=l.readUshort(e,s);s+=2;for(var _=0;_<m;_++){var v=l.readASCII(e,s,4);s+=4;var x=l.readUshort(e,s);s+=2,u[v.trim()]=r._lctf.readLangSysTable(e,h+x)}return u},r._lctf.readLangSysTable=function(e,s){var l=r._bin,h={};l.readUshort(e,s),s+=2,h.reqFeature=l.readUshort(e,s),s+=2;var u=l.readUshort(e,s);return s+=2,h.features=l.readUshorts(e,s,u),h},r.CFF={},r.CFF.parse=function(e,s,l){var h=r._bin;(e=new Uint8Array(e.buffer,s,l))[s=0],e[++s],e[++s],e[++s],s++;var u=[];s=r.CFF.readIndex(e,s,u);for(var p=[],m=0;m<u.length-1;m++)p.push(h.readASCII(e,s+u[m],u[m+1]-u[m]));s+=u[u.length-1];var _=[];s=r.CFF.readIndex(e,s,_);var v=[];for(m=0;m<_.length-1;m++)v.push(r.CFF.readDict(e,s+_[m],s+_[m+1]));s+=_[_.length-1];var x=v[0],b=[];s=r.CFF.readIndex(e,s,b);var S=[];for(m=0;m<b.length-1;m++)S.push(h.readASCII(e,s+b[m],b[m+1]-b[m]));if(s+=b[b.length-1],r.CFF.readSubrs(e,s,x),x.CharStrings){s=x.CharStrings,b=[],s=r.CFF.readIndex(e,s,b);var C=[];for(m=0;m<b.length-1;m++)C.push(h.readBytes(e,s+b[m],b[m+1]-b[m]));x.CharStrings=C}if(x.ROS){s=x.FDArray;var A=[];for(s=r.CFF.readIndex(e,s,A),x.FDArray=[],m=0;m<A.length-1;m++){var I=r.CFF.readDict(e,s+A[m],s+A[m+1]);r.CFF._readFDict(e,I,S),x.FDArray.push(I)}s+=A[A.length-1],s=x.FDSelect,x.FDSelect=[];var E=e[s];if(s++,3!=E)throw E;var R=h.readUshort(e,s);for(s+=2,m=0;m<R+1;m++)x.FDSelect.push(h.readUshort(e,s),e[s+2]),s+=3}return x.Encoding&&(x.Encoding=r.CFF.readEncoding(e,x.Encoding,x.CharStrings.length)),x.charset&&(x.charset=r.CFF.readCharset(e,x.charset,x.CharStrings.length)),r.CFF._readFDict(e,x,S),x},r.CFF._readFDict=function(e,s,l){var h;for(var u in s.Private&&(h=s.Private[1],s.Private=r.CFF.readDict(e,h,h+s.Private[0]),s.Private.Subrs&&r.CFF.readSubrs(e,h+s.Private.Subrs,s.Private)),s)-1!=["FamilyName","FontName","FullName","Notice","version","Copyright"].indexOf(u)&&(s[u]=l[s[u]-426+35])},r.CFF.readSubrs=function(e,s,l){var h=r._bin,u=[];s=r.CFF.readIndex(e,s,u);var p,m=u.length;p=m<1240?107:m<33900?1131:32768,l.Bias=p,l.Subrs=[];for(var _=0;_<u.length-1;_++)l.Subrs.push(h.readBytes(e,s+u[_],u[_+1]-u[_]))},r.CFF.tableSE=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,0,111,112,113,114,0,115,116,117,118,119,120,121,122,0,123,0,124,125,126,127,128,129,130,131,0,132,133,0,134,135,136,137,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,138,0,139,0,0,0,0,140,141,142,143,0,0,0,0,0,144,0,0,0,145,0,0,146,147,148,149,0,0,0,0],r.CFF.glyphByUnicode=function(e,r){for(var s=0;s<e.charset.length;s++)if(e.charset[s]==r)return s;return-1},r.CFF.glyphBySE=function(e,s){return s<0||s>255?-1:r.CFF.glyphByUnicode(e,r.CFF.tableSE[s])},r.CFF.readEncoding=function(e,s,l){r._bin;var h=[".notdef"],u=e[s];if(s++,0!=u)throw"error: unknown encoding format: "+u;var p=e[s];s++;for(var m=0;m<p;m++)h.push(e[s+m]);return h},r.CFF.readCharset=function(e,s,l){var h=r._bin,u=[".notdef"],p=e[s];if(s++,0==p)for(var m=0;m<l;m++){var _=h.readUshort(e,s);s+=2,u.push(_)}else{if(1!=p&&2!=p)throw"error: format: "+p;for(;u.length<l;){_=h.readUshort(e,s),s+=2;var v=0;for(1==p?(v=e[s],s++):(v=h.readUshort(e,s),s+=2),m=0;m<=v;m++)u.push(_),_++}}return u},r.CFF.readIndex=function(e,s,l){var h=r._bin,u=h.readUshort(e,s)+1,p=e[s+=2];if(s++,1==p)for(var m=0;m<u;m++)l.push(e[s+m]);else if(2==p)for(m=0;m<u;m++)l.push(h.readUshort(e,s+2*m));else if(3==p)for(m=0;m<u;m++)l.push(16777215&h.readUint(e,s+3*m-1));else if(1!=u)throw"unsupported offset size: "+p+", count: "+u;return(s+=u*p)-1},r.CFF.getCharString=function(e,s,l){var h=r._bin,u=e[s],p=e[s+1];e[s+2],e[s+3],e[s+4];var m=1,_=null,v=null;u<=20&&(_=u,m=1),12==u&&(_=100*u+p,m=2),21<=u&&u<=27&&(_=u,m=1),28==u&&(v=h.readShort(e,s+1),m=3),29<=u&&u<=31&&(_=u,m=1),32<=u&&u<=246&&(v=u-139,m=1),247<=u&&u<=250&&(v=256*(u-247)+p+108,m=2),251<=u&&u<=254&&(v=256*-(u-251)-p-108,m=2),255==u&&(v=h.readInt(e,s+1)/65535,m=5),l.val=null!=v?v:"o"+_,l.size=m},r.CFF.readCharString=function(e,s,l){for(var h=s+l,u=r._bin,p=[];s<h;){var m=e[s],_=e[s+1];e[s+2],e[s+3],e[s+4];var v=1,x=null,b=null;m<=20&&(x=m,v=1),12==m&&(x=100*m+_,v=2),19!=m&&20!=m||(x=m,v=2),21<=m&&m<=27&&(x=m,v=1),28==m&&(b=u.readShort(e,s+1),v=3),29<=m&&m<=31&&(x=m,v=1),32<=m&&m<=246&&(b=m-139,v=1),247<=m&&m<=250&&(b=256*(m-247)+_+108,v=2),251<=m&&m<=254&&(b=256*-(m-251)-_-108,v=2),255==m&&(b=u.readInt(e,s+1)/65535,v=5),p.push(null!=b?b:"o"+x),s+=v}return p},r.CFF.readDict=function(e,s,l){for(var h=r._bin,u={},p=[];s<l;){var m=e[s],_=e[s+1];e[s+2],e[s+3],e[s+4];var v=1,x=null,b=null;if(28==m&&(b=h.readShort(e,s+1),v=3),29==m&&(b=h.readInt(e,s+1),v=5),32<=m&&m<=246&&(b=m-139,v=1),247<=m&&m<=250&&(b=256*(m-247)+_+108,v=2),251<=m&&m<=254&&(b=256*-(m-251)-_-108,v=2),255==m)throw b=h.readInt(e,s+1)/65535,v=5,"unknown number";if(30==m){var S=[];for(v=1;;){var C=e[s+v];v++;var A=C>>4,I=15&C;if(15!=A&&S.push(A),15!=I&&S.push(I),15==I)break}for(var E="",R=[0,1,2,3,4,5,6,7,8,9,".","e","e-","reserved","-","endOfNumber"],B=0;B<S.length;B++)E+=R[S[B]];b=parseFloat(E)}m<=21&&(x=["version","Notice","FullName","FamilyName","Weight","FontBBox","BlueValues","OtherBlues","FamilyBlues","FamilyOtherBlues","StdHW","StdVW","escape","UniqueID","XUID","charset","Encoding","CharStrings","Private","Subrs","defaultWidthX","nominalWidthX"][m],v=1,12==m&&(x=["Copyright","isFixedPitch","ItalicAngle","UnderlinePosition","UnderlineThickness","PaintType","CharstringType","FontMatrix","StrokeWidth","BlueScale","BlueShift","BlueFuzz","StemSnapH","StemSnapV","ForceBold",0,0,"LanguageGroup","ExpansionFactor","initialRandomSeed","SyntheticBase","PostScript","BaseFontName","BaseFontBlend",0,0,0,0,0,0,"ROS","CIDFontVersion","CIDFontRevision","CIDFontType","CIDCount","UIDBase","FDArray","FDSelect","FontName"][_],v=2)),null!=x?(u[x]=1==p.length?p[0]:p,p=[]):p.push(b),s+=v}return u},r.cmap={},r.cmap.parse=function(e,s,l){e=new Uint8Array(e.buffer,s,l),s=0;var h=r._bin,u={};h.readUshort(e,s),s+=2;var p=h.readUshort(e,s);s+=2;var m=[];u.tables=[];for(var _=0;_<p;_++){var v=h.readUshort(e,s);s+=2;var x=h.readUshort(e,s);s+=2;var b=h.readUint(e,s);s+=4;var S="p"+v+"e"+x,C=m.indexOf(b);if(-1==C){var A;C=u.tables.length,m.push(b);var I=h.readUshort(e,b);0==I?A=r.cmap.parse0(e,b):4==I?A=r.cmap.parse4(e,b):6==I?A=r.cmap.parse6(e,b):12==I?A=r.cmap.parse12(e,b):console.debug("unknown format: "+I,v,x,b),u.tables.push(A)}if(null!=u[S])throw"multiple tables for one platform+encoding";u[S]=C}return u},r.cmap.parse0=function(e,s){var l=r._bin,h={};h.format=l.readUshort(e,s),s+=2;var u=l.readUshort(e,s);s+=2,l.readUshort(e,s),s+=2,h.map=[];for(var p=0;p<u-6;p++)h.map.push(e[s+p]);return h},r.cmap.parse4=function(e,s){var l=r._bin,h=s,u={};u.format=l.readUshort(e,s),s+=2;var p=l.readUshort(e,s);s+=2,l.readUshort(e,s),s+=2;var m=l.readUshort(e,s);s+=2;var _=m/2;u.searchRange=l.readUshort(e,s),s+=2,u.entrySelector=l.readUshort(e,s),s+=2,u.rangeShift=l.readUshort(e,s),s+=2,u.endCount=l.readUshorts(e,s,_),s+=2*_,s+=2,u.startCount=l.readUshorts(e,s,_),s+=2*_,u.idDelta=[];for(var v=0;v<_;v++)u.idDelta.push(l.readShort(e,s)),s+=2;for(u.idRangeOffset=l.readUshorts(e,s,_),s+=2*_,u.glyphIdArray=[];s<h+p;)u.glyphIdArray.push(l.readUshort(e,s)),s+=2;return u},r.cmap.parse6=function(e,s){var l=r._bin,h={};h.format=l.readUshort(e,s),s+=2,l.readUshort(e,s),s+=2,l.readUshort(e,s),s+=2,h.firstCode=l.readUshort(e,s),s+=2;var u=l.readUshort(e,s);s+=2,h.glyphIdArray=[];for(var p=0;p<u;p++)h.glyphIdArray.push(l.readUshort(e,s)),s+=2;return h},r.cmap.parse12=function(e,s){var l=r._bin,h={};h.format=l.readUshort(e,s),s+=2,s+=2,l.readUint(e,s),s+=4,l.readUint(e,s),s+=4;var u=l.readUint(e,s);s+=4,h.groups=[];for(var p=0;p<u;p++){var m=s+12*p,_=l.readUint(e,m+0),v=l.readUint(e,m+4),x=l.readUint(e,m+8);h.groups.push([_,v,x])}return h},r.glyf={},r.glyf.parse=function(e,r,s,l){for(var h=[],u=0;u<l.maxp.numGlyphs;u++)h.push(null);return h},r.glyf._parseGlyf=function(e,s){var l=r._bin,h=e._data,u=r._tabOffset(h,"glyf",e._offset)+e.loca[s];if(e.loca[s]==e.loca[s+1])return null;var p={};if(p.noc=l.readShort(h,u),u+=2,p.xMin=l.readShort(h,u),u+=2,p.yMin=l.readShort(h,u),u+=2,p.xMax=l.readShort(h,u),u+=2,p.yMax=l.readShort(h,u),u+=2,p.xMin>=p.xMax||p.yMin>=p.yMax)return null;if(p.noc>0){p.endPts=[];for(var m=0;m<p.noc;m++)p.endPts.push(l.readUshort(h,u)),u+=2;var _=l.readUshort(h,u);if(u+=2,h.length-u<_)return null;p.instructions=l.readBytes(h,u,_),u+=_;var v=p.endPts[p.noc-1]+1;for(p.flags=[],m=0;m<v;m++){var x=h[u];if(u++,p.flags.push(x),0!=(8&x)){var b=h[u];u++;for(var S=0;S<b;S++)p.flags.push(x),m++}}for(p.xs=[],m=0;m<v;m++){var C=0!=(2&p.flags[m]),A=0!=(16&p.flags[m]);C?(p.xs.push(A?h[u]:-h[u]),u++):A?p.xs.push(0):(p.xs.push(l.readShort(h,u)),u+=2)}for(p.ys=[],m=0;m<v;m++)C=0!=(4&p.flags[m]),A=0!=(32&p.flags[m]),C?(p.ys.push(A?h[u]:-h[u]),u++):A?p.ys.push(0):(p.ys.push(l.readShort(h,u)),u+=2);var I=0,E=0;for(m=0;m<v;m++)I+=p.xs[m],E+=p.ys[m],p.xs[m]=I,p.ys[m]=E}else{var R;p.parts=[];do{R=l.readUshort(h,u),u+=2;var B={m:{a:1,b:0,c:0,d:1,tx:0,ty:0},p1:-1,p2:-1};if(p.parts.push(B),B.glyphIndex=l.readUshort(h,u),u+=2,1&R){var F=l.readShort(h,u);u+=2;var D=l.readShort(h,u);u+=2}else F=l.readInt8(h,u),u++,D=l.readInt8(h,u),u++;2&R?(B.m.tx=F,B.m.ty=D):(B.p1=F,B.p2=D),8&R?(B.m.a=B.m.d=l.readF2dot14(h,u),u+=2):64&R?(B.m.a=l.readF2dot14(h,u),u+=2,B.m.d=l.readF2dot14(h,u),u+=2):128&R&&(B.m.a=l.readF2dot14(h,u),u+=2,B.m.b=l.readF2dot14(h,u),u+=2,B.m.c=l.readF2dot14(h,u),u+=2,B.m.d=l.readF2dot14(h,u),u+=2)}while(32&R);if(256&R){var G=l.readUshort(h,u);for(u+=2,p.instr=[],m=0;m<G;m++)p.instr.push(h[u]),u++}}return p},r.GDEF={},r.GDEF.parse=function(e,s,l,h){var u=s;s+=4;var p=r._bin.readUshort(e,s);return{glyphClassDef:0===p?null:r._lctf.readClassDef(e,u+p)}},r.GPOS={},r.GPOS.parse=function(e,s,l,h){return r._lctf.parse(e,s,l,h,r.GPOS.subt)},r.GPOS.subt=function(e,s,l,h){var u=r._bin,p=l,m={};if(m.fmt=u.readUshort(e,l),l+=2,1==s||2==s||3==s||7==s||8==s&&m.fmt<=2){var _=u.readUshort(e,l);l+=2,m.coverage=r._lctf.readCoverage(e,_+p)}if(1==s&&1==m.fmt){var v=u.readUshort(e,l);l+=2,0!=v&&(m.pos=r.GPOS.readValueRecord(e,l,v))}else if(2==s&&m.fmt>=1&&m.fmt<=2){v=u.readUshort(e,l),l+=2;var x=u.readUshort(e,l);l+=2;var b=r._lctf.numOfOnes(v),S=r._lctf.numOfOnes(x);if(1==m.fmt){m.pairsets=[];var C=u.readUshort(e,l);l+=2;for(var A=0;A<C;A++){var I=p+u.readUshort(e,l);l+=2;var E=u.readUshort(e,I);I+=2;for(var R=[],B=0;B<E;B++){var F=u.readUshort(e,I);I+=2,0!=v&&(V=r.GPOS.readValueRecord(e,I,v),I+=2*b),0!=x&&(j=r.GPOS.readValueRecord(e,I,x),I+=2*S),R.push({gid2:F,val1:V,val2:j})}m.pairsets.push(R)}}if(2==m.fmt){var D=u.readUshort(e,l);l+=2;var G=u.readUshort(e,l);l+=2;var N=u.readUshort(e,l);l+=2;var H=u.readUshort(e,l);for(l+=2,m.classDef1=r._lctf.readClassDef(e,p+D),m.classDef2=r._lctf.readClassDef(e,p+G),m.matrix=[],A=0;A<N;A++){var W=[];for(B=0;B<H;B++){var V=null,j=null;0!=v&&(V=r.GPOS.readValueRecord(e,l,v),l+=2*b),0!=x&&(j=r.GPOS.readValueRecord(e,l,x),l+=2*S),W.push({val1:V,val2:j})}m.matrix.push(W)}}}else if(4==s&&1==m.fmt)m.markCoverage=r._lctf.readCoverage(e,u.readUshort(e,l)+p),m.baseCoverage=r._lctf.readCoverage(e,u.readUshort(e,l+2)+p),m.markClassCount=u.readUshort(e,l+4),m.markArray=r.GPOS.readMarkArray(e,u.readUshort(e,l+6)+p),m.baseArray=r.GPOS.readBaseArray(e,u.readUshort(e,l+8)+p,m.markClassCount);else if(6==s&&1==m.fmt)m.mark1Coverage=r._lctf.readCoverage(e,u.readUshort(e,l)+p),m.mark2Coverage=r._lctf.readCoverage(e,u.readUshort(e,l+2)+p),m.markClassCount=u.readUshort(e,l+4),m.mark1Array=r.GPOS.readMarkArray(e,u.readUshort(e,l+6)+p),m.mark2Array=r.GPOS.readBaseArray(e,u.readUshort(e,l+8)+p,m.markClassCount);else{if(9==s&&1==m.fmt){var z=u.readUshort(e,l);l+=2;var X=u.readUint(e,l);if(l+=4,9==h.ltype)h.ltype=z;else if(h.ltype!=z)throw"invalid extension substitution";return r.GPOS.subt(e,h.ltype,p+X)}console.debug("unsupported GPOS table LookupType",s,"format",m.fmt)}return m},r.GPOS.readValueRecord=function(e,s,l){var h=r._bin,u=[];return u.push(1&l?h.readShort(e,s):0),s+=1&l?2:0,u.push(2&l?h.readShort(e,s):0),s+=2&l?2:0,u.push(4&l?h.readShort(e,s):0),s+=4&l?2:0,u.push(8&l?h.readShort(e,s):0),s+=8&l?2:0,u},r.GPOS.readBaseArray=function(e,s,l){var h=r._bin,u=[],p=s,m=h.readUshort(e,s);s+=2;for(var _=0;_<m;_++){for(var v=[],x=0;x<l;x++)v.push(r.GPOS.readAnchorRecord(e,p+h.readUshort(e,s))),s+=2;u.push(v)}return u},r.GPOS.readMarkArray=function(e,s){var l=r._bin,h=[],u=s,p=l.readUshort(e,s);s+=2;for(var m=0;m<p;m++){var _=r.GPOS.readAnchorRecord(e,l.readUshort(e,s+2)+u);_.markClass=l.readUshort(e,s),h.push(_),s+=4}return h},r.GPOS.readAnchorRecord=function(e,s){var l=r._bin,h={};return h.fmt=l.readUshort(e,s),h.x=l.readShort(e,s+2),h.y=l.readShort(e,s+4),h},r.GSUB={},r.GSUB.parse=function(e,s,l,h){return r._lctf.parse(e,s,l,h,r.GSUB.subt)},r.GSUB.subt=function(e,s,l,h){var u=r._bin,p=l,m={};if(m.fmt=u.readUshort(e,l),l+=2,1!=s&&2!=s&&4!=s&&5!=s&&6!=s)return null;if(1==s||2==s||4==s||5==s&&m.fmt<=2||6==s&&m.fmt<=2){var _=u.readUshort(e,l);l+=2,m.coverage=r._lctf.readCoverage(e,p+_)}if(1==s&&m.fmt>=1&&m.fmt<=2){if(1==m.fmt)m.delta=u.readShort(e,l),l+=2;else if(2==m.fmt){var v=u.readUshort(e,l);l+=2,m.newg=u.readUshorts(e,l,v),l+=2*m.newg.length}}else if(2==s&&1==m.fmt){v=u.readUshort(e,l),l+=2,m.seqs=[];for(var x=0;x<v;x++){var b=u.readUshort(e,l)+p;l+=2;var S=u.readUshort(e,b);m.seqs.push(u.readUshorts(e,b+2,S))}}else if(4==s)for(m.vals=[],v=u.readUshort(e,l),l+=2,x=0;x<v;x++){var C=u.readUshort(e,l);l+=2,m.vals.push(r.GSUB.readLigatureSet(e,p+C))}else if(5==s&&2==m.fmt){if(2==m.fmt){var A=u.readUshort(e,l);l+=2,m.cDef=r._lctf.readClassDef(e,p+A),m.scset=[];var I=u.readUshort(e,l);for(l+=2,x=0;x<I;x++){var E=u.readUshort(e,l);l+=2,m.scset.push(0==E?null:r.GSUB.readSubClassSet(e,p+E))}}}else if(6==s&&3==m.fmt){if(3==m.fmt){for(x=0;x<3;x++){v=u.readUshort(e,l),l+=2;for(var R=[],B=0;B<v;B++)R.push(r._lctf.readCoverage(e,p+u.readUshort(e,l+2*B)));l+=2*v,0==x&&(m.backCvg=R),1==x&&(m.inptCvg=R),2==x&&(m.ahedCvg=R)}v=u.readUshort(e,l),l+=2,m.lookupRec=r.GSUB.readSubstLookupRecords(e,l,v)}}else{if(7==s&&1==m.fmt){var F=u.readUshort(e,l);l+=2;var D=u.readUint(e,l);if(l+=4,9==h.ltype)h.ltype=F;else if(h.ltype!=F)throw"invalid extension substitution";return r.GSUB.subt(e,h.ltype,p+D)}console.debug("unsupported GSUB table LookupType",s,"format",m.fmt)}return m},r.GSUB.readSubClassSet=function(e,s){var l=r._bin.readUshort,h=s,u=[],p=l(e,s);s+=2;for(var m=0;m<p;m++){var _=l(e,s);s+=2,u.push(r.GSUB.readSubClassRule(e,h+_))}return u},r.GSUB.readSubClassRule=function(e,s){var l=r._bin.readUshort,h={},u=l(e,s),p=l(e,s+=2);s+=2,h.input=[];for(var m=0;m<u-1;m++)h.input.push(l(e,s)),s+=2;return h.substLookupRecords=r.GSUB.readSubstLookupRecords(e,s,p),h},r.GSUB.readSubstLookupRecords=function(e,s,l){for(var h=r._bin.readUshort,u=[],p=0;p<l;p++)u.push(h(e,s),h(e,s+2)),s+=4;return u},r.GSUB.readChainSubClassSet=function(e,s){var l=r._bin,h=s,u=[],p=l.readUshort(e,s);s+=2;for(var m=0;m<p;m++){var _=l.readUshort(e,s);s+=2,u.push(r.GSUB.readChainSubClassRule(e,h+_))}return u},r.GSUB.readChainSubClassRule=function(e,s){for(var l=r._bin,h={},u=["backtrack","input","lookahead"],p=0;p<u.length;p++){var m=l.readUshort(e,s);s+=2,1==p&&m--,h[u[p]]=l.readUshorts(e,s,m),s+=2*h[u[p]].length}return m=l.readUshort(e,s),s+=2,h.subst=l.readUshorts(e,s,2*m),s+=2*h.subst.length,h},r.GSUB.readLigatureSet=function(e,s){var l=r._bin,h=s,u=[],p=l.readUshort(e,s);s+=2;for(var m=0;m<p;m++){var _=l.readUshort(e,s);s+=2,u.push(r.GSUB.readLigature(e,h+_))}return u},r.GSUB.readLigature=function(e,s){var l=r._bin,h={chain:[]};h.nglyph=l.readUshort(e,s),s+=2;var u=l.readUshort(e,s);s+=2;for(var p=0;p<u-1;p++)h.chain.push(l.readUshort(e,s)),s+=2;return h},r.head={},r.head.parse=function(e,s,l){var h=r._bin,u={};return h.readFixed(e,s),s+=4,u.fontRevision=h.readFixed(e,s),s+=4,h.readUint(e,s),s+=4,h.readUint(e,s),s+=4,u.flags=h.readUshort(e,s),s+=2,u.unitsPerEm=h.readUshort(e,s),s+=2,u.created=h.readUint64(e,s),s+=8,u.modified=h.readUint64(e,s),s+=8,u.xMin=h.readShort(e,s),s+=2,u.yMin=h.readShort(e,s),s+=2,u.xMax=h.readShort(e,s),s+=2,u.yMax=h.readShort(e,s),s+=2,u.macStyle=h.readUshort(e,s),s+=2,u.lowestRecPPEM=h.readUshort(e,s),s+=2,u.fontDirectionHint=h.readShort(e,s),s+=2,u.indexToLocFormat=h.readShort(e,s),s+=2,u.glyphDataFormat=h.readShort(e,s),s+=2,u},r.hhea={},r.hhea.parse=function(e,s,l){var h=r._bin,u={};return h.readFixed(e,s),s+=4,u.ascender=h.readShort(e,s),s+=2,u.descender=h.readShort(e,s),s+=2,u.lineGap=h.readShort(e,s),s+=2,u.advanceWidthMax=h.readUshort(e,s),s+=2,u.minLeftSideBearing=h.readShort(e,s),s+=2,u.minRightSideBearing=h.readShort(e,s),s+=2,u.xMaxExtent=h.readShort(e,s),s+=2,u.caretSlopeRise=h.readShort(e,s),s+=2,u.caretSlopeRun=h.readShort(e,s),s+=2,u.caretOffset=h.readShort(e,s),s+=2,s+=8,u.metricDataFormat=h.readShort(e,s),s+=2,u.numberOfHMetrics=h.readUshort(e,s),s+=2,u},r.hmtx={},r.hmtx.parse=function(e,s,l,h){for(var u=r._bin,p={aWidth:[],lsBearing:[]},m=0,_=0,v=0;v<h.maxp.numGlyphs;v++)v<h.hhea.numberOfHMetrics&&(m=u.readUshort(e,s),s+=2,_=u.readShort(e,s),s+=2),p.aWidth.push(m),p.lsBearing.push(_);return p},r.kern={},r.kern.parse=function(e,s,l,h){var u=r._bin,p=u.readUshort(e,s);if(s+=2,1==p)return r.kern.parseV1(e,s-2,l,h);var m=u.readUshort(e,s);s+=2;for(var _={glyph1:[],rval:[]},v=0;v<m;v++){s+=2,l=u.readUshort(e,s),s+=2;var x=u.readUshort(e,s);s+=2;var b=x>>>8;if(0!=(b&=15))throw"unknown kern table format: "+b;s=r.kern.readFormat0(e,s,_)}return _},r.kern.parseV1=function(e,s,l,h){var u=r._bin;u.readFixed(e,s),s+=4;var p=u.readUint(e,s);s+=4;for(var m={glyph1:[],rval:[]},_=0;_<p;_++){u.readUint(e,s),s+=4;var v=u.readUshort(e,s);s+=2,u.readUshort(e,s),s+=2;var x=v>>>8;if(0!=(x&=15))throw"unknown kern table format: "+x;s=r.kern.readFormat0(e,s,m)}return m},r.kern.readFormat0=function(e,s,l){var h=r._bin,u=-1,p=h.readUshort(e,s);s+=2,h.readUshort(e,s),s+=2,h.readUshort(e,s),s+=2,h.readUshort(e,s),s+=2;for(var m=0;m<p;m++){var _=h.readUshort(e,s);s+=2;var v=h.readUshort(e,s);s+=2;var x=h.readShort(e,s);s+=2,_!=u&&(l.glyph1.push(_),l.rval.push({glyph2:[],vals:[]}));var b=l.rval[l.rval.length-1];b.glyph2.push(v),b.vals.push(x),u=_}return s},r.loca={},r.loca.parse=function(e,s,l,h){var u=r._bin,p=[],m=h.head.indexToLocFormat,_=h.maxp.numGlyphs+1;if(0==m)for(var v=0;v<_;v++)p.push(u.readUshort(e,s+(v<<1))<<1);if(1==m)for(v=0;v<_;v++)p.push(u.readUint(e,s+(v<<2)));return p},r.maxp={},r.maxp.parse=function(e,s,l){var h=r._bin,u={},p=h.readUint(e,s);return s+=4,u.numGlyphs=h.readUshort(e,s),s+=2,65536==p&&(u.maxPoints=h.readUshort(e,s),s+=2,u.maxContours=h.readUshort(e,s),s+=2,u.maxCompositePoints=h.readUshort(e,s),s+=2,u.maxCompositeContours=h.readUshort(e,s),s+=2,u.maxZones=h.readUshort(e,s),s+=2,u.maxTwilightPoints=h.readUshort(e,s),s+=2,u.maxStorage=h.readUshort(e,s),s+=2,u.maxFunctionDefs=h.readUshort(e,s),s+=2,u.maxInstructionDefs=h.readUshort(e,s),s+=2,u.maxStackElements=h.readUshort(e,s),s+=2,u.maxSizeOfInstructions=h.readUshort(e,s),s+=2,u.maxComponentElements=h.readUshort(e,s),s+=2,u.maxComponentDepth=h.readUshort(e,s),s+=2),u},r.name={},r.name.parse=function(e,s,l){var h=r._bin,u={};h.readUshort(e,s),s+=2;var p=h.readUshort(e,s);s+=2,h.readUshort(e,s);for(var m,_=["copyright","fontFamily","fontSubfamily","ID","fullName","version","postScriptName","trademark","manufacturer","designer","description","urlVendor","urlDesigner","licence","licenceURL","---","typoFamilyName","typoSubfamilyName","compatibleFull","sampleText","postScriptCID","wwsFamilyName","wwsSubfamilyName","lightPalette","darkPalette"],v=s+=2,x=0;x<p;x++){var b=h.readUshort(e,s);s+=2;var S=h.readUshort(e,s);s+=2;var C=h.readUshort(e,s);s+=2;var A=h.readUshort(e,s);s+=2;var I=h.readUshort(e,s);s+=2;var E=h.readUshort(e,s);s+=2;var R,B=_[A],F=v+12*p+E;if(0==b)R=h.readUnicode(e,F,I/2);else if(3==b&&0==S)R=h.readUnicode(e,F,I/2);else if(0==S)R=h.readASCII(e,F,I);else if(1==S)R=h.readUnicode(e,F,I/2);else if(3==S)R=h.readUnicode(e,F,I/2);else{if(1!=b)throw"unknown encoding "+S+", platformID: "+b;R=h.readASCII(e,F,I),console.debug("reading unknown MAC encoding "+S+" as ASCII")}var D="p"+b+","+C.toString(16);null==u[D]&&(u[D]={}),u[D][void 0!==B?B:A]=R,u[D]._lang=C}for(var G in u)if(null!=u[G].postScriptName&&1033==u[G]._lang)return u[G];for(var G in u)if(null!=u[G].postScriptName&&0==u[G]._lang)return u[G];for(var G in u)if(null!=u[G].postScriptName&&3084==u[G]._lang)return u[G];for(var G in u)if(null!=u[G].postScriptName)return u[G];for(var G in u){m=G;break}return console.debug("returning name table with languageID "+u[m]._lang),u[m]},r["OS/2"]={},r["OS/2"].parse=function(e,s,l){var h=r._bin.readUshort(e,s);s+=2;var u={};if(0==h)r["OS/2"].version0(e,s,u);else if(1==h)r["OS/2"].version1(e,s,u);else if(2==h||3==h||4==h)r["OS/2"].version2(e,s,u);else{if(5!=h)throw"unknown OS/2 table version: "+h;r["OS/2"].version5(e,s,u)}return u},r["OS/2"].version0=function(e,s,l){var h=r._bin;return l.xAvgCharWidth=h.readShort(e,s),s+=2,l.usWeightClass=h.readUshort(e,s),s+=2,l.usWidthClass=h.readUshort(e,s),s+=2,l.fsType=h.readUshort(e,s),s+=2,l.ySubscriptXSize=h.readShort(e,s),s+=2,l.ySubscriptYSize=h.readShort(e,s),s+=2,l.ySubscriptXOffset=h.readShort(e,s),s+=2,l.ySubscriptYOffset=h.readShort(e,s),s+=2,l.ySuperscriptXSize=h.readShort(e,s),s+=2,l.ySuperscriptYSize=h.readShort(e,s),s+=2,l.ySuperscriptXOffset=h.readShort(e,s),s+=2,l.ySuperscriptYOffset=h.readShort(e,s),s+=2,l.yStrikeoutSize=h.readShort(e,s),s+=2,l.yStrikeoutPosition=h.readShort(e,s),s+=2,l.sFamilyClass=h.readShort(e,s),s+=2,l.panose=h.readBytes(e,s,10),s+=10,l.ulUnicodeRange1=h.readUint(e,s),s+=4,l.ulUnicodeRange2=h.readUint(e,s),s+=4,l.ulUnicodeRange3=h.readUint(e,s),s+=4,l.ulUnicodeRange4=h.readUint(e,s),s+=4,l.achVendID=[h.readInt8(e,s),h.readInt8(e,s+1),h.readInt8(e,s+2),h.readInt8(e,s+3)],s+=4,l.fsSelection=h.readUshort(e,s),s+=2,l.usFirstCharIndex=h.readUshort(e,s),s+=2,l.usLastCharIndex=h.readUshort(e,s),s+=2,l.sTypoAscender=h.readShort(e,s),s+=2,l.sTypoDescender=h.readShort(e,s),s+=2,l.sTypoLineGap=h.readShort(e,s),s+=2,l.usWinAscent=h.readUshort(e,s),s+=2,l.usWinDescent=h.readUshort(e,s),s+2},r["OS/2"].version1=function(e,s,l){var h=r._bin;return s=r["OS/2"].version0(e,s,l),l.ulCodePageRange1=h.readUint(e,s),s+=4,l.ulCodePageRange2=h.readUint(e,s),s+4},r["OS/2"].version2=function(e,s,l){var h=r._bin;return s=r["OS/2"].version1(e,s,l),l.sxHeight=h.readShort(e,s),s+=2,l.sCapHeight=h.readShort(e,s),s+=2,l.usDefault=h.readUshort(e,s),s+=2,l.usBreak=h.readUshort(e,s),s+=2,l.usMaxContext=h.readUshort(e,s),s+2},r["OS/2"].version5=function(e,s,l){var h=r._bin;return s=r["OS/2"].version2(e,s,l),l.usLowerOpticalPointSize=h.readUshort(e,s),s+=2,l.usUpperOpticalPointSize=h.readUshort(e,s),s+2},r.post={},r.post.parse=function(e,s,l){var h=r._bin,u={};return u.version=h.readFixed(e,s),s+=4,u.italicAngle=h.readFixed(e,s),s+=4,u.underlinePosition=h.readShort(e,s),s+=2,u.underlineThickness=h.readShort(e,s),s+=2,u},null==r&&(r={}),null==r.U&&(r.U={}),r.U.codeToGlyph=function(e,r){var s=e.cmap,l=-1;if(null!=s.p0e4?l=s.p0e4:null!=s.p3e1?l=s.p3e1:null!=s.p1e0?l=s.p1e0:null!=s.p0e3&&(l=s.p0e3),-1==l)throw"no familiar platform and encoding!";var h=s.tables[l];if(0==h.format)return r>=h.map.length?0:h.map[r];if(4==h.format){for(var u=-1,p=0;p<h.endCount.length;p++)if(r<=h.endCount[p]){u=p;break}return-1==u||h.startCount[u]>r?0:65535&(0!=h.idRangeOffset[u]?h.glyphIdArray[r-h.startCount[u]+(h.idRangeOffset[u]>>1)-(h.idRangeOffset.length-u)]:r+h.idDelta[u])}if(12==h.format){if(r>h.groups[h.groups.length-1][1])return 0;for(p=0;p<h.groups.length;p++){var m=h.groups[p];if(m[0]<=r&&r<=m[1])return m[2]+(r-m[0])}return 0}throw"unknown cmap table format "+h.format},r.U.glyphToPath=function(e,s){var l={cmds:[],crds:[]};if(e.SVG&&e.SVG.entries[s]){var h=e.SVG.entries[s];return null==h?l:("string"==typeof h&&(h=r.SVG.toPath(h),e.SVG.entries[s]=h),h)}if(e.CFF){var u={x:0,y:0,stack:[],nStems:0,haveWidth:!1,width:e.CFF.Private?e.CFF.Private.defaultWidthX:0,open:!1},p=e.CFF,m=e.CFF.Private;if(p.ROS){for(var _=0;p.FDSelect[_+2]<=s;)_+=2;m=p.FDArray[p.FDSelect[_+1]].Private}r.U._drawCFF(e.CFF.CharStrings[s],u,p,m,l)}else e.glyf&&r.U._drawGlyf(s,e,l);return l},r.U._drawGlyf=function(e,s,l){var h=s.glyf[e];null==h&&(h=s.glyf[e]=r.glyf._parseGlyf(s,e)),null!=h&&(h.noc>-1?r.U._simpleGlyph(h,l):r.U._compoGlyph(h,s,l))},r.U._simpleGlyph=function(e,s){for(var l=0;l<e.noc;l++){for(var h=0==l?0:e.endPts[l-1]+1,u=e.endPts[l],p=h;p<=u;p++){var m=p==h?u:p-1,_=p==u?h:p+1,v=1&e.flags[p],x=1&e.flags[m],b=1&e.flags[_],S=e.xs[p],C=e.ys[p];if(p==h)if(v){if(!x){r.U.P.moveTo(s,S,C);continue}r.U.P.moveTo(s,e.xs[m],e.ys[m])}else x?r.U.P.moveTo(s,e.xs[m],e.ys[m]):r.U.P.moveTo(s,(e.xs[m]+S)/2,(e.ys[m]+C)/2);v?x&&r.U.P.lineTo(s,S,C):b?r.U.P.qcurveTo(s,S,C,e.xs[_],e.ys[_]):r.U.P.qcurveTo(s,S,C,(S+e.xs[_])/2,(C+e.ys[_])/2)}r.U.P.closePath(s)}},r.U._compoGlyph=function(e,s,l){for(var h=0;h<e.parts.length;h++){var u={cmds:[],crds:[]},p=e.parts[h];r.U._drawGlyf(p.glyphIndex,s,u);for(var m=p.m,_=0;_<u.crds.length;_+=2){var v=u.crds[_],x=u.crds[_+1];l.crds.push(v*m.a+x*m.b+m.tx),l.crds.push(v*m.c+x*m.d+m.ty)}for(_=0;_<u.cmds.length;_++)l.cmds.push(u.cmds[_])}},r.U._getGlyphClass=function(e,s){var l=r._lctf.getInterval(s,e);return-1==l?0:s[l+2]},r.U._applySubs=function(e,s,l,h){for(var u=e.length-s-1,p=0;p<l.tabs.length;p++)if(null!=l.tabs[p]){var m,_=l.tabs[p];if(!_.coverage||-1!=(m=r._lctf.coverageIndex(_.coverage,e[s])))if(1==l.ltype)e[s],1==_.fmt?e[s]=e[s]+_.delta:e[s]=_.newg[m];else if(4==l.ltype)for(var v=_.vals[m],x=0;x<v.length;x++){var b=v[x],S=b.chain.length;if(!(S>u)){for(var C=!0,A=0,I=0;I<S;I++){for(;-1==e[s+A+(1+I)];)A++;b.chain[I]!=e[s+A+(1+I)]&&(C=!1)}if(C){for(e[s]=b.nglyph,I=0;I<S+A;I++)e[s+I+1]=-1;break}}}else if(5==l.ltype&&2==_.fmt)for(var E=r._lctf.getInterval(_.cDef,e[s]),R=_.cDef[E+2],B=_.scset[R],F=0;F<B.length;F++){var D=B[F],G=D.input;if(!(G.length>u)){for(C=!0,I=0;I<G.length;I++){var N=r._lctf.getInterval(_.cDef,e[s+1+I]);if(-1==E&&_.cDef[N+2]!=G[I]){C=!1;break}}if(C){var H=D.substLookupRecords;for(x=0;x<H.length;x+=2)H[x],H[x+1]}}}else if(6==l.ltype&&3==_.fmt){if(!r.U._glsCovered(e,_.backCvg,s-_.backCvg.length))continue;if(!r.U._glsCovered(e,_.inptCvg,s))continue;if(!r.U._glsCovered(e,_.ahedCvg,s+_.inptCvg.length))continue;var W=_.lookupRec;for(F=0;F<W.length;F+=2){E=W[F];var V=h[W[F+1]];r.U._applySubs(e,s+E,V,h)}}}},r.U._glsCovered=function(e,s,l){for(var h=0;h<s.length;h++)if(-1==r._lctf.coverageIndex(s[h],e[l+h]))return!1;return!0},r.U.glyphsToPath=function(e,s,l){for(var h={cmds:[],crds:[]},u=0,p=0;p<s.length;p++){var m=s[p];if(-1!=m){for(var _=p<s.length-1&&-1!=s[p+1]?s[p+1]:0,v=r.U.glyphToPath(e,m),x=0;x<v.crds.length;x+=2)h.crds.push(v.crds[x]+u),h.crds.push(v.crds[x+1]);for(l&&h.cmds.push(l),x=0;x<v.cmds.length;x++)h.cmds.push(v.cmds[x]);l&&h.cmds.push("X"),u+=e.hmtx.aWidth[m],p<s.length-1&&(u+=r.U.getPairAdjustment(e,m,_))}}return h},r.U.P={},r.U.P.moveTo=function(e,r,s){e.cmds.push("M"),e.crds.push(r,s)},r.U.P.lineTo=function(e,r,s){e.cmds.push("L"),e.crds.push(r,s)},r.U.P.curveTo=function(e,r,s,l,h,u,p){e.cmds.push("C"),e.crds.push(r,s,l,h,u,p)},r.U.P.qcurveTo=function(e,r,s,l,h){e.cmds.push("Q"),e.crds.push(r,s,l,h)},r.U.P.closePath=function(e){e.cmds.push("Z")},r.U._drawCFF=function(e,s,l,h,u){for(var p=s.stack,m=s.nStems,_=s.haveWidth,v=s.width,x=s.open,b=0,S=s.x,C=s.y,A=0,I=0,E=0,R=0,B=0,F=0,D=0,G=0,N=0,H=0,W={val:0,size:0};b<e.length;){r.CFF.getCharString(e,b,W);var V=W.val;if(b+=W.size,"o1"==V||"o18"==V)p.length%2!=0&&!_&&(v=p.shift()+h.nominalWidthX),m+=p.length>>1,p.length=0,_=!0;else if("o3"==V||"o23"==V)p.length%2!=0&&!_&&(v=p.shift()+h.nominalWidthX),m+=p.length>>1,p.length=0,_=!0;else if("o4"==V)p.length>1&&!_&&(v=p.shift()+h.nominalWidthX,_=!0),x&&r.U.P.closePath(u),C+=p.pop(),r.U.P.moveTo(u,S,C),x=!0;else if("o5"==V)for(;p.length>0;)S+=p.shift(),C+=p.shift(),r.U.P.lineTo(u,S,C);else if("o6"==V||"o7"==V)for(var j=p.length,z="o6"==V,X=0;X<j;X++){var q=p.shift();z?S+=q:C+=q,z=!z,r.U.P.lineTo(u,S,C)}else if("o8"==V||"o24"==V){j=p.length;for(var K=0;K+6<=j;)A=S+p.shift(),I=C+p.shift(),E=A+p.shift(),R=I+p.shift(),S=E+p.shift(),C=R+p.shift(),r.U.P.curveTo(u,A,I,E,R,S,C),K+=6;"o24"==V&&(S+=p.shift(),C+=p.shift(),r.U.P.lineTo(u,S,C))}else{if("o11"==V)break;if("o1234"==V||"o1235"==V||"o1236"==V||"o1237"==V)"o1234"==V&&(I=C,E=(A=S+p.shift())+p.shift(),H=R=I+p.shift(),F=R,G=C,S=(D=(B=(N=E+p.shift())+p.shift())+p.shift())+p.shift(),r.U.P.curveTo(u,A,I,E,R,N,H),r.U.P.curveTo(u,B,F,D,G,S,C)),"o1235"==V&&(A=S+p.shift(),I=C+p.shift(),E=A+p.shift(),R=I+p.shift(),N=E+p.shift(),H=R+p.shift(),B=N+p.shift(),F=H+p.shift(),D=B+p.shift(),G=F+p.shift(),S=D+p.shift(),C=G+p.shift(),p.shift(),r.U.P.curveTo(u,A,I,E,R,N,H),r.U.P.curveTo(u,B,F,D,G,S,C)),"o1236"==V&&(A=S+p.shift(),I=C+p.shift(),E=A+p.shift(),H=R=I+p.shift(),F=R,D=(B=(N=E+p.shift())+p.shift())+p.shift(),G=F+p.shift(),S=D+p.shift(),r.U.P.curveTo(u,A,I,E,R,N,H),r.U.P.curveTo(u,B,F,D,G,S,C)),"o1237"==V&&(A=S+p.shift(),I=C+p.shift(),E=A+p.shift(),R=I+p.shift(),N=E+p.shift(),H=R+p.shift(),B=N+p.shift(),F=H+p.shift(),D=B+p.shift(),G=F+p.shift(),Math.abs(D-S)>Math.abs(G-C)?S=D+p.shift():C=G+p.shift(),r.U.P.curveTo(u,A,I,E,R,N,H),r.U.P.curveTo(u,B,F,D,G,S,C));else if("o14"==V){if(p.length>0&&!_&&(v=p.shift()+l.nominalWidthX,_=!0),4==p.length){var $=p.shift(),Y=p.shift(),Z=p.shift(),J=p.shift(),Q=r.CFF.glyphBySE(l,Z),ee=r.CFF.glyphBySE(l,J);r.U._drawCFF(l.CharStrings[Q],s,l,h,u),s.x=$,s.y=Y,r.U._drawCFF(l.CharStrings[ee],s,l,h,u)}x&&(r.U.P.closePath(u),x=!1)}else if("o19"==V||"o20"==V)p.length%2!=0&&!_&&(v=p.shift()+h.nominalWidthX),m+=p.length>>1,p.length=0,_=!0,b+=m+7>>3;else if("o21"==V)p.length>2&&!_&&(v=p.shift()+h.nominalWidthX,_=!0),C+=p.pop(),S+=p.pop(),x&&r.U.P.closePath(u),r.U.P.moveTo(u,S,C),x=!0;else if("o22"==V)p.length>1&&!_&&(v=p.shift()+h.nominalWidthX,_=!0),S+=p.pop(),x&&r.U.P.closePath(u),r.U.P.moveTo(u,S,C),x=!0;else if("o25"==V){for(;p.length>6;)S+=p.shift(),C+=p.shift(),r.U.P.lineTo(u,S,C);A=S+p.shift(),I=C+p.shift(),E=A+p.shift(),R=I+p.shift(),S=E+p.shift(),C=R+p.shift(),r.U.P.curveTo(u,A,I,E,R,S,C)}else if("o26"==V)for(p.length%2&&(S+=p.shift());p.length>0;)A=S,I=C+p.shift(),S=E=A+p.shift(),C=(R=I+p.shift())+p.shift(),r.U.P.curveTo(u,A,I,E,R,S,C);else if("o27"==V)for(p.length%2&&(C+=p.shift());p.length>0;)I=C,E=(A=S+p.shift())+p.shift(),R=I+p.shift(),S=E+p.shift(),C=R,r.U.P.curveTo(u,A,I,E,R,S,C);else if("o10"==V||"o29"==V){var te="o10"==V?h:l;if(0==p.length)console.debug("error: empty stack");else{var ne=p.pop(),re=te.Subrs[ne+te.Bias];s.x=S,s.y=C,s.nStems=m,s.haveWidth=_,s.width=v,s.open=x,r.U._drawCFF(re,s,l,h,u),S=s.x,C=s.y,m=s.nStems,_=s.haveWidth,v=s.width,x=s.open}}else if("o30"==V||"o31"==V){var ie=p.length,se=(K=0,"o31"==V);for(K+=ie-(j=-3&ie);K<j;)se?(I=C,E=(A=S+p.shift())+p.shift(),C=(R=I+p.shift())+p.shift(),j-K==5?(S=E+p.shift(),K++):S=E,se=!1):(A=S,I=C+p.shift(),E=A+p.shift(),R=I+p.shift(),S=E+p.shift(),j-K==5?(C=R+p.shift(),K++):C=R,se=!0),r.U.P.curveTo(u,A,I,E,R,S,C),K+=4}else{if("o"==(V+"").charAt(0))throw console.debug("Unknown operation: "+V,e),V;p.push(V)}}}s.x=S,s.y=C,s.nStems=m,s.haveWidth=_,s.width=v,s.open=x};var s=r,l={Typr:s};return e.Typr=s,e.default=l,Object.defineProperty(e,"__esModule",{value:!0}),e}({}).Typr}
/*!
Custom bundle of woff2otf (https://github.com/arty-name/woff2otf) with fflate
(https://github.com/101arrowz/fflate) for use in Troika text rendering. 
Original licenses apply: 
- fflate: https://github.com/101arrowz/fflate/blob/master/LICENSE (MIT)
- woff2otf.js: https://github.com/arty-name/woff2otf/blob/master/woff2otf.js (Apache2)
*/,function(){return function(e){var r=Uint8Array,s=Uint16Array,l=Uint32Array,h=new r([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),u=new r([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),p=new r([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),f=function(e,r){for(var h=new s(31),u=0;u<31;++u)h[u]=r+=1<<e[u-1];var p=new l(h[30]);for(u=1;u<30;++u)for(var m=h[u];m<h[u+1];++m)p[m]=m-h[u]<<5|u;return[h,p]},m=f(h,2),_=m[0],v=m[1];_[28]=258,v[258]=28;for(var x=f(u,0)[0],b=new s(32768),S=0;S<32768;++S){var C=(43690&S)>>>1|(21845&S)<<1;C=(61680&(C=(52428&C)>>>2|(13107&C)<<2))>>>4|(3855&C)<<4,b[S]=((65280&C)>>>8|(255&C)<<8)>>>1}var w=function(e,r,l){for(var h=e.length,u=0,p=new s(r);u<h;++u)++p[e[u]-1];var m,_=new s(r);for(u=0;u<r;++u)_[u]=_[u-1]+p[u-1]<<1;if(l){m=new s(1<<r);var v=15-r;for(u=0;u<h;++u)if(e[u])for(var x=u<<4|e[u],S=r-e[u],C=_[e[u]-1]++<<S,A=C|(1<<S)-1;C<=A;++C)m[b[C]>>>v]=x}else for(m=new s(h),u=0;u<h;++u)e[u]&&(m[u]=b[_[e[u]-1]++]>>>15-e[u]);return m},A=new r(288);for(S=0;S<144;++S)A[S]=8;for(S=144;S<256;++S)A[S]=9;for(S=256;S<280;++S)A[S]=7;for(S=280;S<288;++S)A[S]=8;var I=new r(32);for(S=0;S<32;++S)I[S]=5;var E=w(A,9,1),R=w(I,5,1),y=function(e){for(var r=e[0],s=1;s<e.length;++s)e[s]>r&&(r=e[s]);return r},L=function(e,r,s){var l=r/8|0;return(e[l]|e[l+1]<<8)>>(7&r)&s},U=function(e,r){var s=r/8|0;return(e[s]|e[s+1]<<8|e[s+2]<<16)>>(7&r)},B=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],T=function(e,r,s){var l=new Error(r||B[e]);if(l.code=e,Error.captureStackTrace&&Error.captureStackTrace(l,T),!s)throw l;return l},O=function(e,m,v){var b=e.length;if(!b||v&&!v.l&&b<5)return m||new r(0);var S=!m||v,C=!v||v.i;v||(v={}),m||(m=new r(3*b));var A,d=function(e){var s=m.length;if(e>s){var l=new r(Math.max(2*s,e));l.set(m),m=l}},I=v.f||0,B=v.p||0,F=v.b||0,D=v.l,G=v.d,N=v.m,H=v.n,W=8*b;do{if(!D){v.f=I=L(e,B,1);var V=L(e,B+1,3);if(B+=3,!V){var j=e[(te=((A=B)/8|0)+(7&A&&1)+4)-4]|e[te-3]<<8,z=te+j;if(z>b){C&&T(0);break}S&&d(F+j),m.set(e.subarray(te,z),F),v.b=F+=j,v.p=B=8*z;continue}if(1==V)D=E,G=R,N=9,H=5;else if(2==V){var X=L(e,B,31)+257,q=L(e,B+10,15)+4,K=X+L(e,B+5,31)+1;B+=14;for(var $=new r(K),Y=new r(19),Z=0;Z<q;++Z)Y[p[Z]]=L(e,B+3*Z,7);B+=3*q;var J=y(Y),Q=(1<<J)-1,ee=w(Y,J,1);for(Z=0;Z<K;){var te,ne=ee[L(e,B,Q)];if(B+=15&ne,(te=ne>>>4)<16)$[Z++]=te;else{var re=0,ie=0;for(16==te?(ie=3+L(e,B,3),B+=2,re=$[Z-1]):17==te?(ie=3+L(e,B,7),B+=3):18==te&&(ie=11+L(e,B,127),B+=7);ie--;)$[Z++]=re}}var se=$.subarray(0,X),oe=$.subarray(X);N=y(se),H=y(oe),D=w(se,N,1),G=w(oe,H,1)}else T(1);if(B>W){C&&T(0);break}}S&&d(F+131072);for(var ae=(1<<N)-1,le=(1<<H)-1,he=B;;he=B){var ce=(re=D[U(e,B)&ae])>>>4;if((B+=15&re)>W){C&&T(0);break}if(re||T(2),ce<256)m[F++]=ce;else{if(256==ce){he=B,D=null;break}var de=ce-254;if(ce>264){var ue=h[Z=ce-257];de=L(e,B,(1<<ue)-1)+_[Z],B+=ue}var pe=G[U(e,B)&le],fe=pe>>>4;if(pe||T(3),B+=15&pe,oe=x[fe],fe>3&&(ue=u[fe],oe+=U(e,B)&(1<<ue)-1,B+=ue),B>W){C&&T(0);break}S&&d(F+131072);for(var ge=F+de;F<ge;F+=4)m[F]=m[F-oe],m[F+1]=m[F+1-oe],m[F+2]=m[F+2-oe],m[F+3]=m[F+3-oe];F=ge}}v.l=D,v.p=he,v.b=F,D&&(I=1,v.m=N,v.d=G,v.n=H)}while(!I);return F==m.length?m:function(e,h,u){(null==h||h<0)&&(h=0),(null==u||u>e.length)&&(u=e.length);var p=new(e instanceof s?s:e instanceof l?l:r)(u-h);return p.set(e.subarray(h,u)),p}(m,0,F)},F=new r(0),D="undefined"!=typeof TextDecoder&&new TextDecoder;try{D.decode(F,{stream:!0})}catch(e){}return e.convert_streams=function(e){var r=new DataView(e),s=0;function t(){var e=r.getUint16(s);return s+=2,e}function a(){var e=r.getUint32(s);return s+=4,e}function i(e){C.setUint16(A,e),A+=2}function o(e){C.setUint32(A,e),A+=4}for(var l={signature:a(),flavor:a(),length:a(),numTables:t(),reserved:t(),totalSfntSize:a(),majorVersion:t(),minorVersion:t(),metaOffset:a(),metaLength:a(),metaOrigLength:a(),privOffset:a(),privLength:a()},h=0;Math.pow(2,h)<=l.numTables;)h++;h--;for(var u=16*Math.pow(2,h),p=16*l.numTables-u,m=12,_=[],v=0;v<l.numTables;v++)_.push({tag:a(),offset:a(),compLength:a(),origLength:a(),origChecksum:a()}),m+=16;var x,b=new Uint8Array(12+16*_.length+_.reduce((function(e,r){return e+r.origLength+4}),0)),S=b.buffer,C=new DataView(S),A=0;return o(l.flavor),i(l.numTables),i(u),i(h),i(p),_.forEach((function(e){o(e.tag),o(e.origChecksum),o(m),o(e.origLength),e.outOffset=m,(m+=e.origLength)%4!=0&&(m+=4-m%4)})),_.forEach((function(r){var s,l=e.slice(r.offset,r.offset+r.compLength);if(r.compLength!=r.origLength){var h=new Uint8Array(r.origLength);s=new Uint8Array(l,2),O(s,h)}else h=new Uint8Array(l);b.set(h,r.outOffset);var u=0;(m=r.outOffset+r.origLength)%4!=0&&(u=4-m%4),b.set(new Uint8Array(u).buffer,r.outOffset+r.origLength),x=m+u})),S.slice(0,x)},Object.defineProperty(e,"__esModule",{value:!0}),e}({}).convert_streams},function(e,r){const s={M:2,L:2,Q:4,C:6,Z:0},l={C:"18g,ca,368,1kz",D:"17k,6,2,2+4,5+c,2+6,2+1,10+1,9+f,j+11,2+1,a,2,2+1,15+2,3,j+2,6+3,2+8,2,2,2+1,w+a,4+e,3+3,2,3+2,3+5,23+w,2f+4,3,2+9,2,b,2+3,3,1k+9,6+1,3+1,2+2,2+d,30g,p+y,1,1+1g,f+x,2,sd2+1d,jf3+4,f+3,2+4,2+2,b+3,42,2,4+2,2+1,2,3,t+1,9f+w,2,el+2,2+g,d+2,2l,2+1,5,3+1,2+1,2,3,6,16wm+1v",R:"17m+3,2,2,6+3,m,15+2,2+2,h+h,13,3+8,2,2,3+1,2,p+1,x,5+4,5,a,2,2,3,u,c+2,g+1,5,2+1,4+1,5j,6+1,2,b,2+2,f,2+1,1s+2,2,3+1,7,1ez0,2,2+1,4+4,b,4,3,b,42,2+2,4,3,2+1,2,o+3,ae,ep,x,2o+2,3+1,3,5+1,6",L:"x9u,jff,a,fd,jv",T:"4t,gj+33,7o+4,1+1,7c+18,2,2+1,2+1,2,21+a,2,1b+k,h,2u+6,3+5,3+1,2+3,y,2,v+q,2k+a,1n+8,a,p+3,2+8,2+2,2+4,18+2,3c+e,2+v,1k,2,5+7,5,4+6,b+1,u,1n,5+3,9,l+1,r,3+1,1m,5+1,5+1,3+2,4,v+1,4,c+1,1m,5+4,2+1,5,l+1,n+5,2,1n,3,2+3,9,8+1,c+1,v,1q,d,1f,4,1m+2,6+2,2+3,8+1,c+1,u,1n,3,7,6+1,l+1,t+1,1m+1,5+3,9,l+1,u,21,8+2,2,2j,3+6,d+7,2r,3+8,c+5,23+1,s,2,2,1k+d,2+4,2+1,6+a,2+z,a,2v+3,2+5,2+1,3+1,q+1,5+2,h+3,e,3+1,7,g,jk+2,qb+2,u+2,u+1,v+1,1t+1,2+6,9,3+a,a,1a+2,3c+1,z,3b+2,5+1,a,7+2,64+1,3,1n,2+6,2,2,3+7,7+9,3,1d+d,1,1+1,1s+3,1d,2+4,2,6,15+8,d+1,x+3,3+1,2+2,1l,2+1,4,2+2,1n+7,3+1,49+2,2+c,2+6,5,7,4+1,5j+1l,2+4,ek,3+1,r+4,1e+4,6+5,2p+c,1+3,1,1+2,1+b,2db+2,3y,2p+v,ff+3,30+1,n9x,1+2,2+9,x+1,29+1,7l,4,5,q+1,6,48+1,r+h,e,13+7,q+a,1b+2,1d,3+3,3+1,14,1w+5,3+1,3+1,d,9,1c,1g,2+2,3+1,6+1,2,17+1,9,6n,3,5,fn5,ki+f,h+f,5s,6y+2,ea,6b,46+4,1af+2,2+1,6+3,15+2,5,4m+1,fy+3,as+1,4a+a,4x,1j+e,1l+2,1e+3,3+1,1y+2,11+4,2+7,1r,d+1,1h+8,b+3,3,2o+2,3,2+1,7,4h,4+7,m+1,1m+1,4,12+6,4+4,5g+7,3+2,2,o,2d+5,2,5+1,2+1,6n+3,7+1,2+1,s+1,2e+7,3,2+1,2z,2,3+5,2,2u+2,3+3,2+4,78+8,2+1,75+1,2,5,41+3,3+1,5,x+9,15+5,3+3,9,a+5,3+2,1b+c,2+1,bb+6,2+5,2,2b+l,3+6,2+1,2+1,3f+5,4,2+1,2+6,2,21+1,4,2,9o+1,470+8,at4+4,1o+6,t5,1s+3,2a,f5l+1,2+3,43o+2,a+7,1+7,3+6,v+3,45+2,1j0+1i,5+1d,9,f,n+4,2+e,11t+6,2+g,3+6,2+1,2+4,7a+6,c6+3,15t+6,32+6,1,gzau,v+2n,3l+6n"},h=1,u=2,p=4,m=8,_=16,v=32;let x;function getCharJoiningType(e){if(!x){const e={R:u,L:h,D:p,C:_,U:v,T:m};x=new Map;for(let r in l){let s=0;l[r].split(",").forEach((l=>{let[h,u]=l.split("+");h=parseInt(h,36),u=u?parseInt(u,36):0,x.set(s+=h,e[r]);for(let l=u;l--;)x.set(++s,e[r])}))}}return x.get(e)||v}const b=1,S=2,C=3,A=4,I=[null,"isol","init","fina","medi"];function detectJoiningForms(e){const r=new Uint8Array(e.length);let s=v,l=b,x=-1;for(let I=0;I<e.length;I++){const E=e.codePointAt(I);let R=0|getCharJoiningType(E),B=b;R&m||(s&(h|p|_)?R&(u|p|_)?(B=C,l!==b&&l!==C||r[x]++):R&(h|v)&&(l!==S&&l!==A||r[x]--):s&(u|v)&&(l!==S&&l!==A||r[x]--),l=r[I]=B,s=R,x=I,E>65535&&I++)}return r}function getGlyphClass(r,s){const l=r.GDEF&&r.GDEF.glyphClassDef;return l?e.U._getGlyphClass(s,l):0}function firstNum(...e){for(let r=0;r<e.length;r++)if("number"==typeof e[r])return e[r]}function wrapFontObj(r){const l=Object.create(null),h=r["OS/2"],u=r.hhea,p=r.head.unitsPerEm,m=firstNum(h&&h.sTypoAscender,u&&u.ascender,p),_={unitsPerEm:p,ascender:m,descender:firstNum(h&&h.sTypoDescender,u&&u.descender,0),capHeight:firstNum(h&&h.sCapHeight,m),xHeight:firstNum(h&&h.sxHeight,m),lineGap:firstNum(h&&h.sTypoLineGap,u&&u.lineGap),supportsCodePoint:s=>e.U.codeToGlyph(r,s)>0,forEachGlyph(h,u,p,m){let v=0;const x=1/_.unitsPerEm*u,b=function(r,s){const l=[];for(let h=0;h<s.length;h++){const u=s.codePointAt(h);u>65535&&h++,l.push(e.U.codeToGlyph(r,u))}const h=r.GSUB;if(h){const{lookupList:r,featureList:u}=h;let p;const m=/^(rlig|liga|mset|isol|init|fina|medi|half|pres|blws|ccmp)$/,_=[];u.forEach((h=>{if(m.test(h.tag))for(let u=0;u<h.tab.length;u++){if(_[h.tab[u]])continue;_[h.tab[u]]=!0;const m=r[h.tab[u]],v=/^(isol|init|fina|medi)$/.test(h.tag);v&&!p&&(p=detectJoiningForms(s));for(let s=0;s<l.length;s++)p&&v&&I[p[s]]!==h.tag||e.U._applySubs(l,s,m,r)}}))}return l}(r,h);let S=0;const C=function(r,s){const l=new Int16Array(3*s.length);let h=0;for(;h<s.length;h++){const u=s[h];if(-1===u)continue;l[3*h+2]=r.hmtx.aWidth[u];const p=r.GPOS;if(p){const m=p.lookupList;for(let p=0;p<m.length;p++){const _=m[p];for(let p=0;p<_.tabs.length;p++){const m=_.tabs[p];if(1===_.ltype){if(-1!==e._lctf.coverageIndex(m.coverage,u)&&m.pos){applyValueRecord(m.pos,h);break}}else if(2===_.ltype){let r=null,l=getPrevGlyphIndex();if(-1!==l){const p=e._lctf.coverageIndex(m.coverage,s[l]);if(-1!==p){if(1===m.fmt){const e=m.pairsets[p];for(let s=0;s<e.length;s++)e[s].gid2===u&&(r=e[s])}else if(2===m.fmt){const h=e.U._getGlyphClass(s[l],m.classDef1),p=e.U._getGlyphClass(u,m.classDef2);r=m.matrix[h][p]}if(r){r.val1&&applyValueRecord(r.val1,l),r.val2&&applyValueRecord(r.val2,h);break}}}}else if(4===_.ltype){const r=e._lctf.coverageIndex(m.markCoverage,u);if(-1!==r){const u=getPrevGlyphIndex(isBaseGlyph),p=-1===u?-1:e._lctf.coverageIndex(m.baseCoverage,s[u]);if(-1!==p){const e=m.markArray[r],s=m.baseArray[p][e.markClass];l[3*h]=s.x-e.x+l[3*u]-l[3*u+2],l[3*h+1]=s.y-e.y+l[3*u+1];break}}}else if(6===_.ltype){const p=e._lctf.coverageIndex(m.mark1Coverage,u);if(-1!==p){const u=getPrevGlyphIndex();if(-1!==u){const _=s[u];if(3===getGlyphClass(r,_)){const r=e._lctf.coverageIndex(m.mark2Coverage,_);if(-1!==r){const e=m.mark1Array[p],s=m.mark2Array[r][e.markClass];l[3*h]=s.x-e.x+l[3*u]-l[3*u+2],l[3*h+1]=s.y-e.y+l[3*u+1];break}}}}}}}}else if(r.kern&&!r.cff){const e=getPrevGlyphIndex();if(-1!==e){const h=r.kern.glyph1.indexOf(s[e]);if(-1!==h){const s=r.kern.rval[h].glyph2.indexOf(u);-1!==s&&(l[3*e+2]+=r.kern.rval[h].vals[s])}}}}return l;function getPrevGlyphIndex(e){for(let r=h-1;r>=0;r--)if(-1!==s[r]&&(!e||e(s[r])))return r;return-1}function isBaseGlyph(e){return 1===getGlyphClass(r,e)}function applyValueRecord(e,r){for(let s=0;s<3;s++)l[3*r+s]+=e[s]||0}}(r,b);return b.forEach(((_,b)=>{if(-1!==_){let h=l[_];if(!h){const{cmds:u,crds:p}=e.U.glyphToPath(r,_);let m,v,x,b,S="",C=0;for(let e=0,r=u.length;e<r;e++){const r=s[u[e]];S+=u[e];for(let e=1;e<=r;e++)S+=(e>1?",":"")+p[C++]}if(p.length){m=v=1/0,x=b=-1/0;for(let e=0,r=p.length;e<r;e+=2){let r=p[e],s=p[e+1];r<m&&(m=r),s<v&&(v=s),r>x&&(x=r),s>b&&(b=s)}}else m=x=v=b=0;h=l[_]={index:_,advanceWidth:r.hmtx.aWidth[_],xMin:m,yMin:v,xMax:x,yMax:b,path:S}}m.call(null,h,v+C[3*b]*x,C[3*b+1]*x,S),v+=C[3*b+2]*x,p&&(v+=p*u)}S+=h.codePointAt(S)>65535?2:1})),v}};return _}return function(s){const l=new Uint8Array(s,0,4),h=e._bin.readASCII(l,0,4);if("wOFF"===h)s=r(s);else if("wOF2"===h)throw new Error("woff2 fonts not supported");return wrapFontObj(e.parse(s)[0])}}],init:(e,r,s)=>s(e(),r())});
/*!
Custom bundle of @unicode-font-resolver/client v1.0.2 (https://github.com/lojjic/unicode-font-resolver)
for use in Troika text rendering. 
Original MIT license applies
*/const ui=defineWorkerModule({name:"FontResolver",dependencies:[function(e,r){const s=Object.create(null),l=Object.create(null);function loadFont(r,h){let u=s[r];u?h(u):l[r]?l[r].push(h):(l[r]=[h],function(r,s){const onError=e=>{console.error(`Failure loading font ${r}`,e)};try{const l=new XMLHttpRequest;l.open("get",r,!0),l.responseType="arraybuffer",l.onload=function(){if(l.status>=400)onError(new Error(l.statusText));else if(l.status>0)try{const h=e(l.response);h.src=r,s(h)}catch(e){onError(e)}},l.onerror=onError,l.send()}catch(e){onError(e)}}(r,(e=>{e.src=r,s[r]=e,l[r].forEach((r=>r(e))),delete l[r]})))}return function(e,l,{lang:h,fonts:u=[],style:p="normal",weight:m="normal",unicodeFontsURL:_}={}){const v=new Uint8Array(e.length),x=[];e.length||allDone();const b=new Map,S=[];if("italic"!==p&&(p="normal"),"number"!=typeof m&&(m="bold"===m?700:400),u&&!Array.isArray(u)&&(u=[u]),(u=u.slice().filter((e=>!e.lang||e.lang.test(h))).reverse()).length){const r=1,l=2;let h=0;!function resolveUserFonts(p=0){for(let m=p,_=e.length;m<_;m++){const p=e.codePointAt(m);if(h===r&&x[v[m-1]].supportsCodePoint(p)||/\s/.test(e[m]))v[m]=v[m-1],h===l&&(S[S.length-1][1]=m);else for(let e=v[m],_=u.length;e<=_;e++)if(e===_){(h===l?S[S.length-1]:S[S.length]=[m,m])[1]=m,h=l}else{v[m]=e;const{src:l,unicodeRange:_}=u[e];if(!_||isCodeInRanges(p,_)){const e=s[l];if(!e)return void loadFont(l,(()=>{resolveUserFonts(m)}));if(e.supportsCodePoint(p)){let s=b.get(e);"number"!=typeof s&&(s=x.length,x.push(e),b.set(e,s)),v[m]=s,h=r;break}}}p>65535&&m+1<_&&(v[m+1]=v[m],m++,h===l&&(S[S.length-1][1]=m))}resolveFallbacks()}()}else S.push([0,e.length-1]),resolveFallbacks();function resolveFallbacks(){if(S.length){const s=S.map((r=>e.substring(r[0],r[1]+1))).join("\n");r.getFontsForString(s,{lang:h||void 0,style:p,weight:m,dataUrl:_}).then((({fontUrls:e,chars:r})=>{const s=x.length;let l=0;S.forEach((e=>{for(let h=0,u=e[1]-e[0];h<=u;h++)v[e[0]+h]=r[l++]+s;l++}));let h=0;e.forEach(((r,l)=>{loadFont(r,(r=>{x[l+s]=r,++h===e.length&&allDone()}))}))}))}else allDone()}function allDone(){l({chars:v,fonts:x})}function isCodeInRanges(e,r){for(let s=0;s<r.length;s++){const[l,h=l]=r[s];if(l<=e&&e<=h)return!0}return!1}}},di,function(){return function(e){var n=function(){this.buckets=new Map};n.prototype.add=function(e){var r=e>>5;this.buckets.set(r,(this.buckets.get(r)||0)|1<<(31&e))},n.prototype.has=function(e){var r=this.buckets.get(e>>5);return void 0!==r&&0!=(r&1<<(31&e))},n.prototype.serialize=function(){var e=[];return this.buckets.forEach((function(r,s){e.push((+s).toString(36)+":"+r.toString(36))})),e.join(",")},n.prototype.deserialize=function(e){var r=this;this.buckets.clear(),e.split(",").forEach((function(e){var s=e.split(":");r.buckets.set(parseInt(s[0],36),parseInt(s[1],36))}))};var r=Math.pow(2,8),s=r-1,l=~s;function a(e){var s=function(e){return e&l}(e).toString(16),h=function(e){return(e&l)+r-1}(e).toString(16);return"codepoint-index/plane"+(e>>16)+"/"+s+"-"+h+".json"}function i(e,r){var l=e&s,h=r.codePointAt(l/6|0);return 0!=((h=(h||48)-48)&1<<l%6)}function c(e,r){!function(e,r){var s;(s=e,s.replace(/U\+/gi,"").replace(/^,+|,+$/g,"").split(/,+/).map((function(e){return e.split("-").map((function(e){return parseInt(e.trim(),16)}))}))).forEach((function(e){var s=e[0],l=e[1];void 0===l&&(l=s),r(s,l)}))}(e,(function(e,s){for(var l=e;l<=s;l++)r(l)}))}var h={},u={},p=new WeakMap,m="https://cdn.jsdelivr.net/gh/lojjic/unicode-font-resolver@v1.0.1/packages/data";function d(e){var r=p.get(e);return r||(r=new n,c(e.ranges,(function(e){return r.add(e)})),p.set(e,r)),r}var _,v=new Map;function g(e,r,s){return e[r]?r:e[s]?s:function(e){for(var r in e)return r}(e)}function w(e,r){var s=r;if(!e.includes(s)){s=1/0;for(var l=0;l<e.length;l++)Math.abs(e[l]-r)<Math.abs(s-r)&&(s=e[l])}return s}function k(e){return _||(_=new Set,c("9-D,20,85,A0,1680,2000-200A,2028-202F,205F,3000",(function(e){_.add(e)}))),_.has(e)}return e.CodePointSet=n,e.clearCache=function(){h={},u={}},e.getFontsForString=function(e,r){void 0===r&&(r={});var s,l=r.lang;void 0===l&&(l=/\p{Script=Hangul}/u.test(s=e)?"ko":/\p{Script=Hiragana}|\p{Script=Katakana}/u.test(s)?"ja":"en");var p=r.category;void 0===p&&(p="sans-serif");var _=r.style;void 0===_&&(_="normal");var x=r.weight;void 0===x&&(x=400);var b=(r.dataUrl||m).replace(/\/$/g,""),S=new Map,C=new Uint8Array(e.length),A={},I={},E=new Array(e.length),R=new Map,B=!1;function M(e){var r=v.get(e);return r||(r=fetch(b+"/"+e).then((function(e){if(!e.ok)throw new Error(e.statusText);return e.json().then((function(e){if(!Array.isArray(e)||1!==e[0])throw new Error("Incorrect schema version; need 1, got "+e[0]);return e[1]}))})).catch((function(r){if(b!==m)return B||(console.error('unicode-font-resolver: Failed loading from dataUrl "'+b+'", trying default CDN. '+r.message),B=!0),b=m,v.delete(e),M(e);throw r})),v.set(e,r)),r}for(var P=function(r){var s=e.codePointAt(r),l=a(s);E[r]=l,h[l]||R.has(l)||R.set(l,M(l).then((function(e){h[l]=e}))),s>65535&&(r++,F=r)},F=0;F<e.length;F++)P(F);return Promise.all(R.values()).then((function(){R.clear();for(var n=function(s){var p=e.codePointAt(s),m=null,_=h[E[s]],v=void 0;for(var x in _){var b=I[x];if(void 0===b&&(b=I[x]=new RegExp(x).test(l||"en")),b){for(var S in v=x,_[x])if(i(p,_[x][S])){m=S;break}break}}if(!m)e:for(var C in _)if(C!==v)for(var A in _[C])if(i(p,_[C][A])){m=A;break e}m||(console.debug("No font coverage for U+"+p.toString(16)),m="latin"),E[s]=m,u[m]||R.has(m)||R.set(m,M("font-meta/"+m+".json").then((function(e){u[m]=e}))),p>65535&&(s++,r=s)},r=0;r<e.length;r++)n(r);return Promise.all(R.values())})).then((function(){for(var r,s=null,l=0;l<e.length;l++){var h=e.codePointAt(l);if(s&&(k(h)||d(s).has(h)))C[l]=C[l-1];else{s=u[E[l]];var m=A[s.id];if(!m){var v=s.typeforms,I=g(v,p,"sans-serif"),R=g(v[I],_,"normal"),B=w(null===(r=v[I])||void 0===r?void 0:r[R],x);m=A[s.id]=b+"/font-files/"+s.id+"/"+I+"."+R+"."+B+".woff"}var F=S.get(m);null==F&&(F=S.size,S.set(m,F)),C[l]=F}h>65535&&(l++,C[l]=C[l-1])}return{fontUrls:Array.from(S.keys()),chars:C}}))},Object.defineProperty(e,"__esModule",{value:!0}),e}({})}],init:(e,r,s)=>e(r,s())});const now=()=>(self.performance||Date).now(),pi=SDFGenerator();let fi;const gi=[];let mi=0;function nextChunk(){const e=now();for(;gi.length&&now()-e<5;)gi.shift()();mi=gi.length?setTimeout(nextChunk,0):0}const generateSDF_GL=(...e)=>new Promise(((r,s)=>{gi.push((()=>{const l=now();try{pi.webgl.generateIntoCanvas(...e),r({timing:now()-l})}catch(e){s(e)}})),mi||(mi=setTimeout(nextChunk,0))})),_i=4,yi=2e3,vi={};let xi=0;function generateSDF_JS_Worker(e,r,s,l,h,u,p,m,_,v){const x="TroikaTextSDFGenerator_JS_"+xi++%_i;let b=vi[x];return b||(b=vi[x]={workerModule:defineWorkerModule({name:x,workerId:x,dependencies:[SDFGenerator,now],init(e,r){const s=e().javascript.generate;return function(...e){const l=r();return{textureData:s(...e),timing:r()-l}}},getTransferables:e=>[e.textureData.buffer]}),requests:0,idleTimer:null}),b.requests++,clearTimeout(b.idleTimer),b.workerModule(e,r,s,l,h,u).then((({textureData:s,timing:l})=>{const h=now(),u=new Uint8Array(4*s.length);for(let e=0;e<s.length;e++)u[4*e+v]=s[e];return pi.webglUtils.renderImageData(p,u,m,_,e,r,1<<3-v),l+=now()-h,0==--b.requests&&(b.idleTimer=setTimeout((()=>{!function(e){ei[e]&&ei[e].forEach((function(e){e()})),Qr[e]&&(Qr[e].terminate(),delete Qr[e])}(x)}),yi)),{timing:l}}))}const bi=pi.webglUtils.resizeWebGLCanvasWithoutClearing,Ti={defaultFontURL:null,unicodeFontsURL:null,sdfGlyphSize:64,sdfMargin:1/16,sdfExponent:9,textureWidth:2048},wi=new le;let Si=!1;function now$1(){return(self.performance||Date).now()}const Ci=Object.create(null);function getTextRenderInfo(e,r){Si=!0,e=assign({},e);const s=now$1(),{defaultFontURL:l}=Ti,h=[];if(l&&h.push({label:"default",src:toAbsoluteURL(l)}),e.font&&h.push({label:"user",src:toAbsoluteURL(e.font)}),e.font=h,e.text=""+e.text,e.sdfGlyphSize=e.sdfGlyphSize||Ti.sdfGlyphSize,e.unicodeFontsURL=e.unicodeFontsURL||Ti.unicodeFontsURL,null!=e.colorRanges){let r={};for(let s in e.colorRanges)if(e.colorRanges.hasOwnProperty(s)){let l=e.colorRanges[s];"number"!=typeof l&&(l=wi.set(l).getHex()),r[s]=l}e.colorRanges=r}Object.freeze(e);const{textureWidth:u,sdfExponent:p}=Ti,{sdfGlyphSize:m}=e,_=u/m*4;let v=Ci[m];if(!v){const e=document.createElement("canvas");e.width=u,e.height=256*m/_,v=Ci[m]={glyphCount:0,sdfGlyphSize:m,sdfCanvas:e,sdfTexture:new qe(e,void 0,void 0,void 0,be,be),contextLost:!1,glyphsByFont:new Map},v.sdfTexture.generateMipmaps=!1,function(e){const r=e.sdfCanvas;r.addEventListener("webglcontextlost",(r=>{console.log("Context Lost",r),r.preventDefault(),e.contextLost=!0})),r.addEventListener("webglcontextrestored",(r=>{console.log("Context Restored",r),e.contextLost=!1;const s=[];e.glyphsByFont.forEach((r=>{r.forEach((r=>{s.push(generateGlyphSDF(r,e,!0))}))})),Promise.all(s).then((()=>{safariPre15Workaround(e),e.sdfTexture.needsUpdate=!0}))}))}(v)}const{sdfTexture:x,sdfCanvas:b}=v;Ei(e).then((l=>{const{glyphIds:h,glyphFontIndices:S,fontData:C,glyphPositions:A,fontSize:I,timings:E}=l,R=[],B=new Float32Array(4*h.length);let F=0,D=0;const G=now$1(),N=C.map((e=>{let r=v.glyphsByFont.get(e.src);return r||v.glyphsByFont.set(e.src,r=new Map),r}));h.forEach(((e,r)=>{const s=S[r],{src:u,unitsPerEm:p}=C[s];let _=N[s].get(e);if(!_){const{path:r,pathBounds:h}=l.glyphData[u][e],p=Math.max(h[2]-h[0],h[3]-h[1])/m*(Ti.sdfMargin*m+.5),x=v.glyphCount++,b=[h[0]-p,h[1]-p,h[2]+p,h[3]+p];N[s].set(e,_={path:r,atlasIndex:x,sdfViewBox:b}),R.push(_)}const{sdfViewBox:x}=_,b=A[D++],E=A[D++],G=I/p;B[F++]=b+x[0]*G,B[F++]=E+x[1]*G,B[F++]=b+x[2]*G,B[F++]=E+x[3]*G,h[r]=_.atlasIndex})),E.quads=(E.quads||0)+(now$1()-G);const H=now$1();E.sdf={};const W=b.height,V=Math.ceil(v.glyphCount/_),j=Math.pow(2,Math.ceil(Math.log2(V*m)));j>W&&(console.info(`Increasing SDF texture size ${W}->${j}`),bi(b,u,j),x.dispose()),Promise.all(R.map((r=>generateGlyphSDF(r,v,e.gpuAccelerateSDF).then((({timing:e})=>{E.sdf[r.atlasIndex]=e}))))).then((()=>{R.length&&!v.contextLost&&(safariPre15Workaround(v),x.needsUpdate=!0),E.sdfTotal=now$1()-H,E.total=now$1()-s,r(Object.freeze({parameters:e,sdfTexture:x,sdfGlyphSize:m,sdfExponent:p,glyphBounds:B,glyphAtlasIndices:h,glyphColors:l.glyphColors,caretPositions:l.caretPositions,chunkedBounds:l.chunkedBounds,ascender:l.ascender,descender:l.descender,lineHeight:l.lineHeight,capHeight:l.capHeight,xHeight:l.xHeight,topBaseline:l.topBaseline,blockBounds:l.blockBounds,visibleBounds:l.visibleBounds,timings:l.timings}))}))})),Promise.resolve().then((()=>{var e;v.contextLost||(e=b)._warm||(pi.webgl.isSupported(e),e._warm=!0)}))}function generateGlyphSDF({path:e,atlasIndex:r,sdfViewBox:s},{sdfGlyphSize:l,sdfCanvas:h,contextLost:u},p){if(u)return Promise.resolve({timing:-1});const{textureWidth:m,sdfExponent:_}=Ti,v=Math.max(s[2]-s[0],s[3]-s[1]),x=Math.floor(r/4);return function(e,r,s,l,h,u,p,m,_,v,x=!0){return x?generateSDF_GL(e,r,s,l,h,u,p,m,_,v).then(null,(x=>(fi||(console.warn("WebGL SDF generation failed, falling back to JS",x),fi=!0),generateSDF_JS_Worker(e,r,s,l,h,u,p,m,_,v)))):generateSDF_JS_Worker(e,r,s,l,h,u,p,m,_,v)}(l,l,e,s,v,_,h,x%(m/l)*l,Math.floor(x/(m/l))*l,r%4,p)}function assign(e,r){for(let s in r)r.hasOwnProperty(s)&&(e[s]=r[s]);return e}let Ai;function toAbsoluteURL(e){return Ai||(Ai="undefined"==typeof document?{}:document.createElement("a")),Ai.href=e,Ai.href}function safariPre15Workaround(e){if("function"!=typeof createImageBitmap){console.info("Safari<15: applying SDF canvas workaround");const{sdfCanvas:r,sdfTexture:s}=e,{width:l,height:h}=r,u=e.sdfCanvas.getContext("webgl");let p=s.image.data;p&&p.length===l*h*4||(p=new Uint8Array(l*h*4),s.image={width:l,height:h,data:p},s.flipY=!1,s.isDataTexture=!0),u.readPixels(0,0,l,h,u.RGBA,u.UNSIGNED_BYTE,p)}}const Ii=defineWorkerModule({name:"Typesetter",dependencies:[function(e,r){const s=1/0,l=/[\u00AD\u034F\u061C\u115F-\u1160\u17B4-\u17B5\u180B-\u180E\u200B-\u200F\u202A-\u202E\u2060-\u206F\u3164\uFE00-\uFE0F\uFEFF\uFFA0\uFFF0-\uFFF8]/,h="[^\\S\\u00A0]",u=new RegExp(`${h}|[\\-\\u007C\\u00AD\\u2010\\u2012-\\u2014\\u2027\\u2056\\u2E17\\u2E40]`);function typeset({text:p="",font:m,lang:_,sdfGlyphSize:v=64,fontSize:x=400,fontWeight:b=1,fontStyle:S="normal",letterSpacing:C=0,lineHeight:A="normal",maxWidth:I=s,direction:E,textAlign:R="left",textIndent:B=0,whiteSpace:F="normal",overflowWrap:D="normal",anchorX:G=0,anchorY:N=0,metricsOnly:H=!1,unicodeFontsURL:W,preResolvedFonts:V=null,includeCaretPositions:j=!1,chunkedBoundsSize:z=8192,colorRanges:X=null},q){const K=now(),$={fontLoad:0,typesetting:0};p.indexOf("\r")>-1&&(console.info("Typesetter: got text with \\r chars; normalizing to \\n"),p=p.replace(/\r\n/g,"\n").replace(/\r/g,"\n")),x=+x,C=+C,I=+I,A=A||"normal",B=+B,function({text:r,lang:s,fonts:l,style:h,weight:u,preResolvedFonts:p,unicodeFontsURL:m},_){const onResolved=({chars:e,fonts:r})=>{let s,l;const h=[];for(let u=0;u<e.length;u++)e[u]!==l?(l=e[u],h.push(s={start:u,end:u,fontObj:r[e[u]]})):s.end=u;_(h)};p?onResolved(p):e(r,onResolved,{lang:s,fonts:l,style:h,weight:u,unicodeFontsURL:m})}({text:p,lang:_,style:S,weight:b,fonts:"string"==typeof m?[{src:m}]:m,unicodeFontsURL:W,preResolvedFonts:V},(e=>{$.fontLoad=now()-K;const m=isFinite(I);let _=null,v=null,b=null,S=null,W=null,V=null,Y=null,Z=null,J=0,Q=0,ee="nowrap"!==F;const te=new Map,ne=now();let re=B,ie=0,se=new TextLine;const oe=[se];e.forEach((e=>{const{fontObj:r}=e,{ascender:s,descender:_,unitsPerEm:v,lineGap:b,capHeight:S,xHeight:E}=r;let R=te.get(r);if(!R){const e=x/v,l="normal"===A?(s-_+b)*e:A*x,h=(l-(s-_)*e)/2,u=Math.min(l,(s-_)*e),p=(s+_)/2*e+u/2;R={index:te.size,src:r.src,fontObj:r,fontSizeMult:e,unitsPerEm:v,ascender:s*e,descender:_*e,capHeight:S*e,xHeight:E*e,lineHeight:l,baseline:-h-s*e,caretTop:(s+_)/2*e+u/2,caretBottom:p-u},te.set(r,R)}const{fontSizeMult:F}=R,G=p.slice(e.start,e.end+1);let N,H;r.forEachGlyph(G,x,C,((r,s,_,v)=>{s+=ie,v+=e.start,N=s,H=r;const b=p.charAt(v),S=r.advanceWidth*F,A=se.count;let E;if("isEmpty"in r||(r.isWhitespace=!!b&&new RegExp(h).test(b),r.canBreakAfter=!!b&&u.test(b),r.isEmpty=r.xMin===r.xMax||r.yMin===r.yMax||l.test(b)),r.isWhitespace||r.isEmpty||Q++,ee&&m&&!r.isWhitespace&&s+S+re>I&&A){if(se.glyphAt(A-1).glyphObj.canBreakAfter)E=new TextLine,re=-s;else for(let e=A;e--;){if(0===e&&"break-word"===D){E=new TextLine,re=-s;break}if(se.glyphAt(e).glyphObj.canBreakAfter){E=se.splitAt(e+1);const r=E.glyphAt(0).x;re-=r;for(let e=E.count;e--;)E.glyphAt(e).x-=r;break}}E&&(se.isSoftWrapped=!0,se=E,oe.push(se),J=I)}let G=se.glyphAt(se.count);G.glyphObj=r,G.x=s+re,G.y=_,G.width=S,G.charIndex=v,G.fontData=R,"\n"===b&&(se=new TextLine,oe.push(se),re=-(s+S+C*x)+B)})),ie=N+H.advanceWidth*F+C*x}));let ae=0;oe.forEach((e=>{let r=!0;for(let s=e.count;s--;){const l=e.glyphAt(s);r&&!l.glyphObj.isWhitespace&&(e.width=l.x+l.width,e.width>J&&(J=e.width),r=!1);let{lineHeight:h,capHeight:u,xHeight:p,baseline:m}=l.fontData;h>e.lineHeight&&(e.lineHeight=h);const _=m-e.baseline;_<0&&(e.baseline+=_,e.cap+=_,e.ex+=_),e.cap=Math.max(e.cap,e.baseline+u),e.ex=Math.max(e.ex,e.baseline+p)}e.baseline-=ae,e.cap-=ae,e.ex-=ae,ae+=e.lineHeight}));let le=0,he=0;if(G&&("number"==typeof G?le=-G:"string"==typeof G&&(le=-J*("left"===G?0:"center"===G?.5:"right"===G?1:parsePercent(G)))),N&&("number"==typeof N?he=-N:"string"==typeof N&&(he="top"===N?0:"top-baseline"===N?-oe[0].baseline:"top-cap"===N?-oe[0].cap:"top-ex"===N?-oe[0].ex:"middle"===N?ae/2:"bottom"===N?ae:"bottom-baseline"===N?oe[oe.length-1].baseline:parsePercent(N)*ae)),!H){const e=r.getEmbeddingLevels(p,E);_=new Uint16Array(Q),v=new Uint8Array(Q),b=new Float32Array(2*Q),S={},Y=[s,s,-s,-s],Z=[],j&&(V=new Float32Array(4*p.length)),X&&(W=new Uint8Array(3*Q));let l,h,u=0,m=-1,x=-1;if(oe.forEach(((C,A)=>{let{count:I,width:E}=C;if(I>0){let A=0;for(let e=I;e--&&C.glyphAt(e).glyphObj.isWhitespace;)A++;let B=0,F=0;if("center"===R)B=(J-E)/2;else if("right"===R)B=J-E;else if("justify"===R&&C.isSoftWrapped){let e=0;for(let r=I-A;r--;)C.glyphAt(r).glyphObj.isWhitespace&&e++;F=(J-E)/e}if(F||B){let e=0;for(let r=0;r<I;r++){let s=C.glyphAt(r);const l=s.glyphObj;s.x+=B+e,0!==F&&l.isWhitespace&&r<I-A&&(e+=F,s.width+=F)}}const D=r.getReorderSegments(p,e,C.glyphAt(0).charIndex,C.glyphAt(C.count-1).charIndex);for(let e=0;e<D.length;e++){const[r,s]=D[e];let l=1/0,h=-1/0;for(let e=0;e<I;e++)if(C.glyphAt(e).charIndex>=r){let r=e,u=e;for(;u<I;u++){let e=C.glyphAt(u);if(e.charIndex>s)break;u<I-A&&(l=Math.min(l,e.x),h=Math.max(h,e.x+e.width))}for(let e=r;e<u;e++){const r=C.glyphAt(e);r.x=h-(r.x+r.width-l)}break}}let G;const setGlyphObj=e=>G=e;for(let A=0;A<I;A++){const I=C.glyphAt(A);G=I.glyphObj;const E=G.index,R=1&e.levels[I.charIndex];if(R){const e=r.getMirroredCharacter(p[I.charIndex]);e&&I.fontData.fontObj.forEachGlyph(e,0,0,setGlyphObj)}if(j){const{charIndex:e,fontData:r}=I,s=I.x+le,l=I.x+I.width+le;V[4*e]=R?l:s,V[4*e+1]=R?s:l,V[4*e+2]=C.baseline+r.caretBottom+he,V[4*e+3]=C.baseline+r.caretTop+he;const h=e-m;h>1&&fillLigatureCaretPositions(V,m,h),m=e}if(X){const{charIndex:e}=I;for(;e>x;)x++,X.hasOwnProperty(x)&&(h=X[x])}if(!G.isWhitespace&&!G.isEmpty){const e=u++,{fontSizeMult:r,src:p,index:m}=I.fontData,x=S[p]||(S[p]={});x[E]||(x[E]={path:G.path,pathBounds:[G.xMin,G.yMin,G.xMax,G.yMax]});const A=I.x+le,R=I.y+C.baseline+he;b[2*e]=A,b[2*e+1]=R;const B=A+G.xMin*r,F=R+G.yMin*r,D=A+G.xMax*r,N=R+G.yMax*r;B<Y[0]&&(Y[0]=B),F<Y[1]&&(Y[1]=F),D>Y[2]&&(Y[2]=D),N>Y[3]&&(Y[3]=N),e%z==0&&(l={start:e,end:e,rect:[s,s,-s,-s]},Z.push(l)),l.end++;const H=l.rect;if(B<H[0]&&(H[0]=B),F<H[1]&&(H[1]=F),D>H[2]&&(H[2]=D),N>H[3]&&(H[3]=N),_[e]=E,v[e]=m,X){const r=3*e;W[r]=h>>16&255,W[r+1]=h>>8&255,W[r+2]=255&h}}}}})),V){const e=p.length-m;e>1&&fillLigatureCaretPositions(V,m,e)}}const ce=[];te.forEach((({index:e,src:r,unitsPerEm:s,ascender:l,descender:h,lineHeight:u,capHeight:p,xHeight:m})=>{ce[e]={src:r,unitsPerEm:s,ascender:l,descender:h,lineHeight:u,capHeight:p,xHeight:m}})),$.typesetting=now()-ne,q({glyphIds:_,glyphFontIndices:v,glyphPositions:b,glyphData:S,fontData:ce,caretPositions:V,glyphColors:W,chunkedBounds:Z,fontSize:x,topBaseline:he+oe[0].baseline,blockBounds:[le,he-ae,le+J,he],visibleBounds:Y,timings:$})}))}function parsePercent(e){let r=e.match(/^([\d.]+)%$/),s=r?parseFloat(r[1]):NaN;return isNaN(s)?0:s/100}function fillLigatureCaretPositions(e,r,s){const l=e[4*r],h=e[4*r+1],u=e[4*r+2],p=e[4*r+3],m=(h-l)/s;for(let h=0;h<s;h++){const s=4*(r+h);e[s]=l+m*h,e[s+1]=l+m*(h+1),e[s+2]=u,e[s+3]=p}}function now(){return(self.performance||Date).now()}function TextLine(){this.data=[]}const p=["glyphObj","x","y","width","charIndex","fontData"];return TextLine.prototype={width:0,lineHeight:0,baseline:0,cap:0,ex:0,isSoftWrapped:!1,get count(){return Math.ceil(this.data.length/p.length)},glyphAt(e){let r=TextLine.flyweight;return r.data=this.data,r.index=e,r},splitAt(e){let r=new TextLine;return r.data=this.data.splice(e*p.length),r}},TextLine.flyweight=p.reduce(((e,r,s,l)=>(Object.defineProperty(e,r,{get(){return this.data[this.index*p.length+s]},set(e){this.data[this.index*p.length+s]=e}}),e)),{data:null,index:0}),{typeset:typeset,measure:function(e,r){typeset({...e,metricsOnly:!0},(e=>{const[s,l,h,u]=e.blockBounds;r({width:h-s,height:u-l})}))}}},ui,function(){var e=function(e){var r={R:"13k,1a,2,3,3,2+1j,ch+16,a+1,5+2,2+n,5,a,4,6+16,4+3,h+1b,4mo,179q,2+9,2+11,2i9+7y,2+68,4,3+4,5+13,4+3,2+4k,3+29,8+cf,1t+7z,w+17,3+3m,1t+3z,16o1+5r,8+30,8+mc,29+1r,29+4v,75+73",EN:"1c+9,3d+1,6,187+9,513,4+5,7+9,sf+j,175h+9,qw+q,161f+1d,4xt+a,25i+9",ES:"17,2,6dp+1,f+1,av,16vr,mx+1,4o,2",ET:"z+2,3h+3,b+1,ym,3e+1,2o,p4+1,8,6u,7c,g6,1wc,1n9+4,30+1b,2n,6d,qhx+1,h0m,a+1,49+2,63+1,4+1,6bb+3,12jj",AN:"16o+5,2j+9,2+1,35,ed,1ff2+9,87+u",CS:"18,2+1,b,2u,12k,55v,l,17v0,2,3,53,2+1,b",B:"a,3,f+2,2v,690",S:"9,2,k",WS:"c,k,4f4,1vk+a,u,1j,335",ON:"x+1,4+4,h+5,r+5,r+3,z,5+3,2+1,2+1,5,2+2,3+4,o,w,ci+1,8+d,3+d,6+8,2+g,39+1,9,6+1,2,33,b8,3+1,3c+1,7+1,5r,b,7h+3,sa+5,2,3i+6,jg+3,ur+9,2v,ij+1,9g+9,7+a,8m,4+1,49+x,14u,2+2,c+2,e+2,e+2,e+1,i+n,e+e,2+p,u+2,e+2,36+1,2+3,2+1,b,2+2,6+5,2,2,2,h+1,5+4,6+3,3+f,16+2,5+3l,3+81,1y+p,2+40,q+a,m+13,2r+ch,2+9e,75+hf,3+v,2+2w,6e+5,f+6,75+2a,1a+p,2+2g,d+5x,r+b,6+3,4+o,g,6+1,6+2,2k+1,4,2j,5h+z,1m+1,1e+f,t+2,1f+e,d+3,4o+3,2s+1,w,535+1r,h3l+1i,93+2,2s,b+1,3l+x,2v,4g+3,21+3,kz+1,g5v+1,5a,j+9,n+v,2,3,2+8,2+1,3+2,2,3,46+1,4+4,h+5,r+5,r+a,3h+2,4+6,b+4,78,1r+24,4+c,4,1hb,ey+6,103+j,16j+c,1ux+7,5+g,fsh,jdq+1t,4,57+2e,p1,1m,1m,1m,1m,4kt+1,7j+17,5+2r,d+e,3+e,2+e,2+10,m+4,w,1n+5,1q,4z+5,4b+rb,9+c,4+c,4+37,d+2g,8+b,l+b,5+1j,9+9,7+13,9+t,3+1,27+3c,2+29,2+3q,d+d,3+4,4+2,6+6,a+o,8+6,a+2,e+6,16+42,2+1i",BN:"0+8,6+d,2s+5,2+p,e,4m9,1kt+2,2b+5,5+5,17q9+v,7k,6p+8,6+1,119d+3,440+7,96s+1,1ekf+1,1ekf+1,1ekf+1,1ekf+1,1ekf+1,1ekf+1,1ekf+1,1ekf+1,1ekf+1,1ekf+1,1ekf+1,1ekf+75,6p+2rz,1ben+1,1ekf+1,1ekf+1",NSM:"lc+33,7o+6,7c+18,2,2+1,2+1,2,21+a,1d+k,h,2u+6,3+5,3+1,2+3,10,v+q,2k+a,1n+8,a,p+3,2+8,2+2,2+4,18+2,3c+e,2+v,1k,2,5+7,5,4+6,b+1,u,1n,5+3,9,l+1,r,3+1,1m,5+1,5+1,3+2,4,v+1,4,c+1,1m,5+4,2+1,5,l+1,n+5,2,1n,3,2+3,9,8+1,c+1,v,1q,d,1f,4,1m+2,6+2,2+3,8+1,c+1,u,1n,g+1,l+1,t+1,1m+1,5+3,9,l+1,u,21,8+2,2,2j,3+6,d+7,2r,3+8,c+5,23+1,s,2,2,1k+d,2+4,2+1,6+a,2+z,a,2v+3,2+5,2+1,3+1,q+1,5+2,h+3,e,3+1,7,g,jk+2,qb+2,u+2,u+1,v+1,1t+1,2+6,9,3+a,a,1a+2,3c+1,z,3b+2,5+1,a,7+2,64+1,3,1n,2+6,2,2,3+7,7+9,3,1d+g,1s+3,1d,2+4,2,6,15+8,d+1,x+3,3+1,2+2,1l,2+1,4,2+2,1n+7,3+1,49+2,2+c,2+6,5,7,4+1,5j+1l,2+4,k1+w,2db+2,3y,2p+v,ff+3,30+1,n9x+3,2+9,x+1,29+1,7l,4,5,q+1,6,48+1,r+h,e,13+7,q+a,1b+2,1d,3+3,3+1,14,1w+5,3+1,3+1,d,9,1c,1g,2+2,3+1,6+1,2,17+1,9,6n,3,5,fn5,ki+f,h+f,r2,6b,46+4,1af+2,2+1,6+3,15+2,5,4m+1,fy+3,as+1,4a+a,4x,1j+e,1l+2,1e+3,3+1,1y+2,11+4,2+7,1r,d+1,1h+8,b+3,3,2o+2,3,2+1,7,4h,4+7,m+1,1m+1,4,12+6,4+4,5g+7,3+2,2,o,2d+5,2,5+1,2+1,6n+3,7+1,2+1,s+1,2e+7,3,2+1,2z,2,3+5,2,2u+2,3+3,2+4,78+8,2+1,75+1,2,5,41+3,3+1,5,x+5,3+1,15+5,3+3,9,a+5,3+2,1b+c,2+1,bb+6,2+5,2d+l,3+6,2+1,2+1,3f+5,4,2+1,2+6,2,21+1,4,2,9o+1,f0c+4,1o+6,t5,1s+3,2a,f5l+1,43t+2,i+7,3+6,v+3,45+2,1j0+1i,5+1d,9,f,n+4,2+e,11t+6,2+g,3+6,2+1,2+4,7a+6,c6+3,15t+6,32+6,gzhy+6n",AL:"16w,3,2,e+1b,z+2,2+2s,g+1,8+1,b+m,2+t,s+2i,c+e,4h+f,1d+1e,1bwe+dp,3+3z,x+c,2+1,35+3y,2rm+z,5+7,b+5,dt+l,c+u,17nl+27,1t+27,4x+6n,3+d",LRO:"6ct",RLO:"6cu",LRE:"6cq",RLE:"6cr",PDF:"6cs",LRI:"6ee",RLI:"6ef",FSI:"6eg",PDI:"6eh"},s={},l={};s.L=1,l[1]="L",Object.keys(r).forEach((function(e,r){s[e]=1<<r+1,l[s[e]]=e})),Object.freeze(s);var h=s.LRI|s.RLI|s.FSI,u=s.L|s.R|s.AL,p=s.B|s.S|s.WS|s.ON|s.FSI|s.LRI|s.RLI|s.PDI,m=s.BN|s.RLE|s.LRE|s.RLO|s.LRO|s.PDF,_=s.S|s.WS|s.B|h|s.PDI|m,v=null;function getBidiCharType(e){return function(){if(!v){v=new Map;var loop=function(e){if(r.hasOwnProperty(e)){var l=0;r[e].split(",").forEach((function(r){var h=r.split("+"),u=h[0],p=h[1];u=parseInt(u,36),p=p?parseInt(p,36):0,v.set(l+=u,s[e]);for(var m=0;m<p;m++)v.set(++l,s[e])}))}};for(var e in r)loop(e)}}(),v.get(e.codePointAt(0))||s.L}var x,b,S,C={pairs:"14>1,1e>2,u>2,2wt>1,1>1,1ge>1,1wp>1,1j>1,f>1,hm>1,1>1,u>1,u6>1,1>1,+5,28>1,w>1,1>1,+3,b8>1,1>1,+3,1>3,-1>-1,3>1,1>1,+2,1s>1,1>1,x>1,th>1,1>1,+2,db>1,1>1,+3,3>1,1>1,+2,14qm>1,1>1,+1,4q>1,1e>2,u>2,2>1,+1",canonical:"6f1>-6dx,6dy>-6dx,6ec>-6ed,6ee>-6ed,6ww>2jj,-2ji>2jj,14r4>-1e7l,1e7m>-1e7l,1e7m>-1e5c,1e5d>-1e5b,1e5c>-14qx,14qy>-14qx,14vn>-1ecg,1ech>-1ecg,1edu>-1ecg,1eci>-1ecg,1eda>-1ecg,1eci>-1ecg,1eci>-168q,168r>-168q,168s>-14ye,14yf>-14ye"};function parseCharacterMap(e,r){var s,l=0,h=new Map,u=r&&new Map;return e.split(",").forEach((function visit(e){if(-1!==e.indexOf("+"))for(var p=+e;p--;)visit(s);else{s=e;var m=e.split(">"),_=m[0],v=m[1];_=String.fromCodePoint(l+=parseInt(_,36)),v=String.fromCodePoint(l+=parseInt(v,36)),h.set(_,v),r&&u.set(v,_)}})),{map:h,reverseMap:u}}function parse$1(){if(!x){var e=parseCharacterMap(C.pairs,!0),r=e.map,s=e.reverseMap;x=r,b=s,S=parseCharacterMap(C.canonical,!1).map}}function openingToClosingBracket(e){return parse$1(),x.get(e)||null}function closingToOpeningBracket(e){return parse$1(),b.get(e)||null}function getCanonicalBracket(e){return parse$1(),S.get(e)||null}var A=s.L,I=s.R,E=s.EN,R=s.ES,B=s.ET,F=s.AN,D=s.CS,G=s.B,N=s.S,H=s.ON,W=s.BN,V=s.NSM,j=s.AL,z=s.LRO,X=s.RLO,q=s.LRE,K=s.RLE,$=s.PDF,Y=s.LRI,Z=s.RLI,J=s.FSI,Q=s.PDI;var ee,te="14>1,j>2,t>2,u>2,1a>g,2v3>1,1>1,1ge>1,1wd>1,b>1,1j>1,f>1,ai>3,-2>3,+1,8>1k0,-1jq>1y7,-1y6>1hf,-1he>1h6,-1h5>1ha,-1h8>1qi,-1pu>1,6>3u,-3s>7,6>1,1>1,f>1,1>1,+2,3>1,1>1,+13,4>1,1>1,6>1eo,-1ee>1,3>1mg,-1me>1mk,-1mj>1mi,-1mg>1mi,-1md>1,1>1,+2,1>10k,-103>1,1>1,4>1,5>1,1>1,+10,3>1,1>8,-7>8,+1,-6>7,+1,a>1,1>1,u>1,u6>1,1>1,+5,26>1,1>1,2>1,2>2,8>1,7>1,4>1,1>1,+5,b8>1,1>1,+3,1>3,-2>1,2>1,1>1,+2,c>1,3>1,1>1,+2,h>1,3>1,a>1,1>1,2>1,3>1,1>1,d>1,f>1,3>1,1a>1,1>1,6>1,7>1,13>1,k>1,1>1,+19,4>1,1>1,+2,2>1,1>1,+18,m>1,a>1,1>1,lk>1,1>1,4>1,2>1,f>1,3>1,1>1,+3,db>1,1>1,+3,3>1,1>1,+2,14qm>1,1>1,+1,6>1,4j>1,j>2,t>2,u>2,2>1,+1";function getMirroredCharacter(e){return function(){if(!ee){var e=parseCharacterMap(te,!0),r=e.map;e.reverseMap.forEach((function(e,s){r.set(s,e)})),ee=r}}(),ee.get(e)||null}function getReorderSegments(e,r,s,l){var h=e.length;s=Math.max(0,null==s?0:+s),l=Math.min(h-1,null==l?h-1:+l);var u=[];return r.paragraphs.forEach((function(h){var p=Math.max(s,h.start),m=Math.min(l,h.end);if(p<m){for(var v=r.levels.slice(p,m+1),x=m;x>=p&&getBidiCharType(e[x])&_;x--)v[x]=h.level;for(var b=h.level,S=1/0,C=0;C<v.length;C++){var A=v[C];A>b&&(b=A),A<S&&(S=1|A)}for(var I=b;I>=S;I--)for(var E=0;E<v.length;E++)if(v[E]>=I){for(var R=E;E+1<v.length&&v[E+1]>=I;)E++;E>R&&u.push([R+p,E+p])}}})),u}function getReorderedIndices(e,r,s,l){for(var h=getReorderSegments(e,r,s,l),u=[],p=0;p<e.length;p++)u[p]=p;return h.forEach((function(e){for(var r=e[0],s=e[1],l=u.slice(r,s+1),h=l.length;h--;)u[s-h]=l[h]})),u}return e.closingToOpeningBracket=closingToOpeningBracket,e.getBidiCharType=getBidiCharType,e.getBidiCharTypeName=function(e){return l[getBidiCharType(e)]},e.getCanonicalBracket=getCanonicalBracket,e.getEmbeddingLevels=function(e,r){for(var s=new Uint32Array(e.length),l=0;l<e.length;l++)s[l]=getBidiCharType(e[l]);var v=new Map;function changeCharType(e,r){var l=s[e];s[e]=r,v.set(l,v.get(l)-1),l&p&&v.set(p,v.get(p)-1),v.set(r,(v.get(r)||0)+1),r&p&&v.set(p,(v.get(p)||0)+1)}for(var x=new Uint8Array(e.length),b=new Map,S=[],C=null,ee=0;ee<e.length;ee++)C||S.push(C={start:ee,end:e.length-1,level:"rtl"===r?1:"ltr"===r?0:determineAutoEmbedLevel(ee,!1)}),s[ee]&G&&(C.end=ee,C=null);for(var te=K|q|X|z|h|Q|$|G,nextEven=function(e){return e+(1&e?1:2)},nextOdd=function(e){return e+(1&e?2:1)},ne=0;ne<S.length;ne++){var re=[{_level:(C=S[ne]).level,_override:0,_isolate:0}],ie=void 0,se=0,oe=0,ae=0;v.clear();for(var le=C.start;le<=C.end;le++){var he=s[le];if(ie=re[re.length-1],v.set(he,(v.get(he)||0)+1),he&p&&v.set(p,(v.get(p)||0)+1),he&te)if(he&(K|q)){x[le]=ie._level;var ce=(he===K?nextOdd:nextEven)(ie._level);ce<=125&&!se&&!oe?re.push({_level:ce,_override:0,_isolate:0}):se||oe++}else if(he&(X|z)){x[le]=ie._level;var de=(he===X?nextOdd:nextEven)(ie._level);de<=125&&!se&&!oe?re.push({_level:de,_override:he&X?I:A,_isolate:0}):se||oe++}else if(he&h){he&J&&(he=1===determineAutoEmbedLevel(le+1,!0)?Z:Y),x[le]=ie._level,ie._override&&changeCharType(le,ie._override);var ue=(he===Z?nextOdd:nextEven)(ie._level);ue<=125&&0===se&&0===oe?(ae++,re.push({_level:ue,_override:0,_isolate:1,_isolInitIndex:le})):se++}else if(he&Q){if(se>0)se--;else if(ae>0){for(oe=0;!re[re.length-1]._isolate;)re.pop();var pe=re[re.length-1]._isolInitIndex;null!=pe&&(b.set(pe,le),b.set(le,pe)),re.pop(),ae--}ie=re[re.length-1],x[le]=ie._level,ie._override&&changeCharType(le,ie._override)}else he&$?(0===se&&(oe>0?oe--:!ie._isolate&&re.length>1&&(re.pop(),ie=re[re.length-1])),x[le]=ie._level):he&G&&(x[le]=C.level);else x[le]=ie._level,ie._override&&he!==W&&changeCharType(le,ie._override)}for(var fe=[],ge=null,me=C.start;me<=C.end;me++){var _e=s[me];if(!(_e&m)){var ye=x[me],ve=_e&h,xe=_e===Q;ge&&ye===ge._level?(ge._end=me,ge._endsWithIsolInit=ve):fe.push(ge={_start:me,_end:me,_level:ye,_startsWithPDI:xe,_endsWithIsolInit:ve})}}for(var be=[],Te=0;Te<fe.length;Te++){var we=fe[Te];if(!we._startsWithPDI||we._startsWithPDI&&!b.has(we._start)){for(var Se=[ge=we],Ce=void 0;ge&&ge._endsWithIsolInit&&null!=(Ce=b.get(ge._end));)for(var Ae=Te+1;Ae<fe.length;Ae++)if(fe[Ae]._start===Ce){Se.push(ge=fe[Ae]);break}for(var Ie=[],Ee=0;Ee<Se.length;Ee++)for(var ke=Se[Ee],Re=ke._start;Re<=ke._end;Re++)Ie.push(Re);for(var Me=x[Ie[0]],Be=C.level,Le=Ie[0]-1;Le>=0;Le--)if(!(s[Le]&m)){Be=x[Le];break}var Pe=Ie[Ie.length-1],Ue=x[Pe],Fe=C.level;if(!(s[Pe]&h))for(var De=Pe+1;De<=C.end;De++)if(!(s[De]&m)){Fe=x[De];break}be.push({_seqIndices:Ie,_sosType:Math.max(Be,Me)%2?I:A,_eosType:Math.max(Fe,Ue)%2?I:A})}}for(var Oe=0;Oe<be.length;Oe++){var Ge=be[Oe],Ne=Ge._seqIndices,He=Ge._sosType,We=Ge._eosType,Ve=1&x[Ne[0]]?I:A;if(v.get(V))for(var je=0;je<Ne.length;je++){var ze=Ne[je];if(s[ze]&V){for(var Xe=He,qe=je-1;qe>=0;qe--)if(!(s[Ne[qe]]&m)){Xe=s[Ne[qe]];break}changeCharType(ze,Xe&(h|Q)?H:Xe)}}if(v.get(E))for(var Ke=0;Ke<Ne.length;Ke++){var $e=Ne[Ke];if(s[$e]&E)for(var Ye=Ke-1;Ye>=-1;Ye--){var Ze=-1===Ye?He:s[Ne[Ye]];if(Ze&u){Ze===j&&changeCharType($e,F);break}}}if(v.get(j))for(var Je=0;Je<Ne.length;Je++){var Qe=Ne[Je];s[Qe]&j&&changeCharType(Qe,I)}if(v.get(R)||v.get(D))for(var et=1;et<Ne.length-1;et++){var tt=Ne[et];if(s[tt]&(R|D)){for(var nt=0,rt=0,it=et-1;it>=0&&(nt=s[Ne[it]])&m;it--);for(var st=et+1;st<Ne.length&&(rt=s[Ne[st]])&m;st++);nt===rt&&(s[tt]===R?nt===E:nt&(E|F))&&changeCharType(tt,nt)}}if(v.get(E))for(var ot=0;ot<Ne.length;ot++){var at=Ne[ot];if(s[at]&E){for(var lt=ot-1;lt>=0&&s[Ne[lt]]&(B|m);lt--)changeCharType(Ne[lt],E);for(ot++;ot<Ne.length&&s[Ne[ot]]&(B|m|E);ot++)s[Ne[ot]]!==E&&changeCharType(Ne[ot],E)}}if(v.get(B)||v.get(R)||v.get(D))for(var ht=0;ht<Ne.length;ht++){var ct=Ne[ht];if(s[ct]&(B|R|D)){changeCharType(ct,H);for(var dt=ht-1;dt>=0&&s[Ne[dt]]&m;dt--)changeCharType(Ne[dt],H);for(var ut=ht+1;ut<Ne.length&&s[Ne[ut]]&m;ut++)changeCharType(Ne[ut],H)}}if(v.get(E))for(var pt=0,ft=He;pt<Ne.length;pt++){var gt=Ne[pt],mt=s[gt];mt&E?ft===A&&changeCharType(gt,A):mt&u&&(ft=mt)}if(v.get(p)){for(var _t=I|E|F,yt=_t|A,vt=[],xt=[],bt=0;bt<Ne.length;bt++)if(s[Ne[bt]]&p){var Tt=e[Ne[bt]],wt=void 0;if(null!==openingToClosingBracket(Tt)){if(!(xt.length<63))break;xt.push({char:Tt,seqIndex:bt})}else if(null!==(wt=closingToOpeningBracket(Tt)))for(var St=xt.length-1;St>=0;St--){var Ct=xt[St].char;if(Ct===wt||Ct===closingToOpeningBracket(getCanonicalBracket(Tt))||openingToClosingBracket(getCanonicalBracket(Ct))===Tt){vt.push([xt[St].seqIndex,bt]),xt.length=St;break}}}vt.sort((function(e,r){return e[0]-r[0]}));for(var At=0;At<vt.length;At++){for(var It=vt[At],Et=It[0],kt=It[1],Rt=!1,Mt=0,Bt=Et+1;Bt<kt;Bt++){var Lt=Ne[Bt];if(s[Lt]&yt){Rt=!0;var Pt=s[Lt]&_t?I:A;if(Pt===Ve){Mt=Pt;break}}}if(Rt&&!Mt){Mt=He;for(var Ut=Et-1;Ut>=0;Ut--){var Ft=Ne[Ut];if(s[Ft]&yt){var Dt=s[Ft]&_t?I:A;Mt=Dt!==Ve?Dt:Ve;break}}}if(Mt){if(s[Ne[Et]]=s[Ne[kt]]=Mt,Mt!==Ve)for(var Ot=Et+1;Ot<Ne.length;Ot++)if(!(s[Ne[Ot]]&m)){getBidiCharType(e[Ne[Ot]])&V&&(s[Ne[Ot]]=Mt);break}if(Mt!==Ve)for(var Gt=kt+1;Gt<Ne.length;Gt++)if(!(s[Ne[Gt]]&m)){getBidiCharType(e[Ne[Gt]])&V&&(s[Ne[Gt]]=Mt);break}}}for(var Nt=0;Nt<Ne.length;Nt++)if(s[Ne[Nt]]&p){for(var Ht=Nt,Wt=Nt,Vt=He,jt=Nt-1;jt>=0;jt--){if(!(s[Ne[jt]]&m)){Vt=s[Ne[jt]]&_t?I:A;break}Ht=jt}for(var zt=We,Xt=Nt+1;Xt<Ne.length;Xt++){if(!(s[Ne[Xt]]&(p|m))){zt=s[Ne[Xt]]&_t?I:A;break}Wt=Xt}for(var qt=Ht;qt<=Wt;qt++)s[Ne[qt]]=Vt===zt?Vt:Ve;Nt=Wt}}}for(var Kt=C.start;Kt<=C.end;Kt++){var $t=x[Kt],Yt=s[Kt];if(1&$t?Yt&(A|E|F)&&x[Kt]++:Yt&I?x[Kt]++:Yt&(F|E)&&(x[Kt]+=2),Yt&m&&(x[Kt]=0===Kt?C.level:x[Kt-1]),Kt===C.end||getBidiCharType(e[Kt])&(N|G))for(var Zt=Kt;Zt>=0&&getBidiCharType(e[Zt])&_;Zt--)x[Zt]=C.level}}return{levels:x,paragraphs:S};function determineAutoEmbedLevel(r,l){for(var u=r;u<e.length;u++){var p=s[u];if(p&(I|j))return 1;if(p&(G|A)||l&&p===Q)return 0;if(p&h){var m=indexOfMatchingPDI(u);u=-1===m?e.length:m}}return 0}function indexOfMatchingPDI(r){for(var l=1,u=r+1;u<e.length;u++){var p=s[u];if(p&G)break;if(p&Q){if(0==--l)return u}else p&h&&l++}return-1}},e.getMirroredCharacter=getMirroredCharacter,e.getMirroredCharactersMap=function(e,r,s,l){var h=e.length;s=Math.max(0,null==s?0:+s),l=Math.min(h-1,null==l?h-1:+l);for(var u=new Map,p=s;p<=l;p++)if(1&r[p]){var m=getMirroredCharacter(e[p]);null!==m&&u.set(p,m)}return u},e.getReorderSegments=getReorderSegments,e.getReorderedIndices=getReorderedIndices,e.getReorderedString=function(e,r,s,l){var h=getReorderedIndices(e,r,s,l),u=[].concat(e);return h.forEach((function(s,l){u[l]=(1&r.levels[s]?getMirroredCharacter(e[s]):null)||e[s]})),u.join("")},e.openingToClosingBracket=openingToClosingBracket,Object.defineProperty(e,"__esModule",{value:!0}),e}({});return e}],init:(e,r,s)=>e(r,s())}),Ei=defineWorkerModule({name:"Typesetter",dependencies:[Ii],init:e=>function(r){return new Promise((s=>{e.typeset(r,s)}))},getTransferables(e){const r=[];for(let s in e)e[s]&&e[s].buffer&&r.push(e[s].buffer);return r}});const ki={};const Ri="aTroikaGlyphIndex";class GlyphsGeometry extends it{constructor(){super(),this.detail=1,this.curveRadius=0,this.groups=[{start:0,count:1/0,materialIndex:0},{start:0,count:1/0,materialIndex:1}],this.boundingSphere=new _,this.boundingBox=new u}computeBoundingSphere(){}computeBoundingBox(){}setSide(e){const r=this.getIndex().count;this.setDrawRange(e===Q?r/2:0,e===ee?r:r/2)}set detail(e){if(e!==this._detail){this._detail=e,("number"!=typeof e||e<1)&&(e=1);let r=function(e){let r=ki[e];if(!r){const s=new st(1,1,e,e),l=s.clone(),h=s.attributes,u=l.attributes,p=new N,m=h.uv.count;for(let e=0;e<m;e++)u.position.array[3*e]*=-1,u.normal.array[3*e+2]*=-1;["position","normal","uv"].forEach((e=>{p.setAttribute(e,new ot([...h[e].array,...u[e].array],h[e].itemSize))})),p.setIndex([...s.index.array,...l.index.array.map((e=>e+m))]),p.translate(.5,.5,0),r=ki[e]=p}return r}(e);["position","normal","uv"].forEach((e=>{this.attributes[e]=r.attributes[e].clone()})),this.setIndex(r.getIndex().clone())}}get detail(){return this._detail}set curveRadius(e){e!==this._curveRadius&&(this._curveRadius=e,this._updateBounds())}get curveRadius(){return this._curveRadius}updateGlyphs(e,r,s,l,h){updateBufferAttr(this,"aTroikaGlyphBounds",e,4),updateBufferAttr(this,Ri,r,1),updateBufferAttr(this,"aTroikaGlyphColor",h,3),this._blockBounds=s,this._chunkedBounds=l,this.instanceCount=r.length,this._updateBounds()}_updateBounds(){const e=this._blockBounds;if(e){const{curveRadius:r,boundingBox:s}=this;if(r){const{PI:l,floor:h,min:u,max:p,sin:m,cos:_}=Math,v=l/2,x=2*l,b=Math.abs(r),S=e[0]/b,C=e[2]/b,A=h((S+v)/x)!==h((C+v)/x)?-b:u(m(S)*b,m(C)*b),I=h((S-v)/x)!==h((C-v)/x)?b:p(m(S)*b,m(C)*b),E=h((S+l)/x)!==h((C+l)/x)?2*b:p(b-_(S)*b,b-_(C)*b);s.min.set(A,e[1],r<0?-E:0),s.max.set(I,e[3],r<0?0:E)}else s.min.set(e[0],e[1],0),s.max.set(e[2],e[3],0);s.getBoundingSphere(this.boundingSphere)}}applyClipRect(e){let r=this.getAttribute(Ri).count,s=this._chunkedBounds;if(s)for(let l=s.length;l--;){r=s[l].end;let h=s[l].rect;if(h[1]<e.w&&h[3]>e.y&&h[0]<e.z&&h[2]>e.x)break}this.instanceCount=r}}function updateBufferAttr(e,r,s,l){const h=e.getAttribute(r);s?h&&h.array.length===s.length?(h.array.set(s),h.needsUpdate=!0):(e.setAttribute(r,new me(s,l)),delete e._maxInstanceCount,e.dispose()):h&&e.deleteAttribute(r)}function createTextDerivedMaterial(e){const r=createDerivedMaterial(e,{chained:!0,extensions:{derivatives:!0},uniforms:{uTroikaSDFTexture:{value:null},uTroikaSDFTextureSize:{value:new s},uTroikaSDFGlyphSize:{value:0},uTroikaSDFExponent:{value:0},uTroikaTotalBounds:{value:new $(0,0,0,0)},uTroikaClipRect:{value:new $(0,0,0,0)},uTroikaDistanceOffset:{value:0},uTroikaOutlineOpacity:{value:0},uTroikaFillOpacity:{value:1},uTroikaPositionOffset:{value:new s},uTroikaCurveRadius:{value:0},uTroikaBlurRadius:{value:0},uTroikaStrokeWidth:{value:0},uTroikaStrokeColor:{value:new le},uTroikaStrokeOpacity:{value:1},uTroikaOrient:{value:new H},uTroikaUseGlyphColors:{value:!0},uTroikaSDFDebug:{value:!1}},vertexDefs:"\nuniform vec2 uTroikaSDFTextureSize;\nuniform float uTroikaSDFGlyphSize;\nuniform vec4 uTroikaTotalBounds;\nuniform vec4 uTroikaClipRect;\nuniform mat3 uTroikaOrient;\nuniform bool uTroikaUseGlyphColors;\nuniform float uTroikaDistanceOffset;\nuniform float uTroikaBlurRadius;\nuniform vec2 uTroikaPositionOffset;\nuniform float uTroikaCurveRadius;\nattribute vec4 aTroikaGlyphBounds;\nattribute float aTroikaGlyphIndex;\nattribute vec3 aTroikaGlyphColor;\nvarying vec2 vTroikaGlyphUV;\nvarying vec4 vTroikaTextureUVBounds;\nvarying float vTroikaTextureChannel;\nvarying vec3 vTroikaGlyphColor;\nvarying vec2 vTroikaGlyphDimensions;\n",vertexTransform:"\nvec4 bounds = aTroikaGlyphBounds;\nbounds.xz += uTroikaPositionOffset.x;\nbounds.yw -= uTroikaPositionOffset.y;\n\nvec4 outlineBounds = vec4(\n  bounds.xy - uTroikaDistanceOffset - uTroikaBlurRadius,\n  bounds.zw + uTroikaDistanceOffset + uTroikaBlurRadius\n);\nvec4 clippedBounds = vec4(\n  clamp(outlineBounds.xy, uTroikaClipRect.xy, uTroikaClipRect.zw),\n  clamp(outlineBounds.zw, uTroikaClipRect.xy, uTroikaClipRect.zw)\n);\n\nvec2 clippedXY = (mix(clippedBounds.xy, clippedBounds.zw, position.xy) - bounds.xy) / (bounds.zw - bounds.xy);\n\nposition.xy = mix(bounds.xy, bounds.zw, clippedXY);\n\nuv = (position.xy - uTroikaTotalBounds.xy) / (uTroikaTotalBounds.zw - uTroikaTotalBounds.xy);\n\nfloat rad = uTroikaCurveRadius;\nif (rad != 0.0) {\n  float angle = position.x / rad;\n  position.xz = vec2(sin(angle) * rad, rad - cos(angle) * rad);\n  normal.xz = vec2(sin(angle), cos(angle));\n}\n  \nposition = uTroikaOrient * position;\nnormal = uTroikaOrient * normal;\n\nvTroikaGlyphUV = clippedXY.xy;\nvTroikaGlyphDimensions = vec2(bounds[2] - bounds[0], bounds[3] - bounds[1]);\n\n\nfloat txCols = uTroikaSDFTextureSize.x / uTroikaSDFGlyphSize;\nvec2 txUvPerSquare = uTroikaSDFGlyphSize / uTroikaSDFTextureSize;\nvec2 txStartUV = txUvPerSquare * vec2(\n  mod(floor(aTroikaGlyphIndex / 4.0), txCols),\n  floor(floor(aTroikaGlyphIndex / 4.0) / txCols)\n);\nvTroikaTextureUVBounds = vec4(txStartUV, vec2(txStartUV) + txUvPerSquare);\nvTroikaTextureChannel = mod(aTroikaGlyphIndex, 4.0);\n",fragmentDefs:"\nuniform sampler2D uTroikaSDFTexture;\nuniform vec2 uTroikaSDFTextureSize;\nuniform float uTroikaSDFGlyphSize;\nuniform float uTroikaSDFExponent;\nuniform float uTroikaDistanceOffset;\nuniform float uTroikaFillOpacity;\nuniform float uTroikaOutlineOpacity;\nuniform float uTroikaBlurRadius;\nuniform vec3 uTroikaStrokeColor;\nuniform float uTroikaStrokeWidth;\nuniform float uTroikaStrokeOpacity;\nuniform bool uTroikaSDFDebug;\nvarying vec2 vTroikaGlyphUV;\nvarying vec4 vTroikaTextureUVBounds;\nvarying float vTroikaTextureChannel;\nvarying vec2 vTroikaGlyphDimensions;\n\nfloat troikaSdfValueToSignedDistance(float alpha) {\n  // Inverse of exponential encoding in webgl-sdf-generator\n  \n  float maxDimension = max(vTroikaGlyphDimensions.x, vTroikaGlyphDimensions.y);\n  float absDist = (1.0 - pow(2.0 * (alpha > 0.5 ? 1.0 - alpha : alpha), 1.0 / uTroikaSDFExponent)) * maxDimension;\n  float signedDist = absDist * (alpha > 0.5 ? -1.0 : 1.0);\n  return signedDist;\n}\n\nfloat troikaGlyphUvToSdfValue(vec2 glyphUV) {\n  vec2 textureUV = mix(vTroikaTextureUVBounds.xy, vTroikaTextureUVBounds.zw, glyphUV);\n  vec4 rgba = texture2D(uTroikaSDFTexture, textureUV);\n  float ch = floor(vTroikaTextureChannel + 0.5); //NOTE: can't use round() in WebGL1\n  return ch == 0.0 ? rgba.r : ch == 1.0 ? rgba.g : ch == 2.0 ? rgba.b : rgba.a;\n}\n\nfloat troikaGlyphUvToDistance(vec2 uv) {\n  return troikaSdfValueToSignedDistance(troikaGlyphUvToSdfValue(uv));\n}\n\nfloat troikaGetAADist() {\n  \n  #if defined(GL_OES_standard_derivatives) || __VERSION__ >= 300\n  return length(fwidth(vTroikaGlyphUV * vTroikaGlyphDimensions)) * 0.5;\n  #else\n  return vTroikaGlyphDimensions.x / 64.0;\n  #endif\n}\n\nfloat troikaGetFragDistValue() {\n  vec2 clampedGlyphUV = clamp(vTroikaGlyphUV, 0.5 / uTroikaSDFGlyphSize, 1.0 - 0.5 / uTroikaSDFGlyphSize);\n  float distance = troikaGlyphUvToDistance(clampedGlyphUV);\n \n  // Extrapolate distance when outside bounds:\n  distance += clampedGlyphUV == vTroikaGlyphUV ? 0.0 : \n    length((vTroikaGlyphUV - clampedGlyphUV) * vTroikaGlyphDimensions);\n\n  \n\n  return distance;\n}\n\nfloat troikaGetEdgeAlpha(float distance, float distanceOffset, float aaDist) {\n  #if defined(IS_DEPTH_MATERIAL) || defined(IS_DISTANCE_MATERIAL)\n  float alpha = step(-distanceOffset, -distance);\n  #else\n\n  float alpha = smoothstep(\n    distanceOffset + aaDist,\n    distanceOffset - aaDist,\n    distance\n  );\n  #endif\n\n  return alpha;\n}\n",fragmentColorTransform:"\nfloat aaDist = troikaGetAADist();\nfloat fragDistance = troikaGetFragDistValue();\nfloat edgeAlpha = uTroikaSDFDebug ?\n  troikaGlyphUvToSdfValue(vTroikaGlyphUV) :\n  troikaGetEdgeAlpha(fragDistance, uTroikaDistanceOffset, max(aaDist, uTroikaBlurRadius));\n\n#if !defined(IS_DEPTH_MATERIAL) && !defined(IS_DISTANCE_MATERIAL)\nvec4 fillRGBA = gl_FragColor;\nfillRGBA.a *= uTroikaFillOpacity;\nvec4 strokeRGBA = uTroikaStrokeWidth == 0.0 ? fillRGBA : vec4(uTroikaStrokeColor, uTroikaStrokeOpacity);\nif (fillRGBA.a == 0.0) fillRGBA.rgb = strokeRGBA.rgb;\ngl_FragColor = mix(fillRGBA, strokeRGBA, smoothstep(\n  -uTroikaStrokeWidth - aaDist,\n  -uTroikaStrokeWidth + aaDist,\n  fragDistance\n));\ngl_FragColor.a *= edgeAlpha;\n#endif\n\nif (edgeAlpha == 0.0) {\n  discard;\n}\n",customRewriter({vertexShader:e,fragmentShader:r}){let s=/\buniform\s+vec3\s+diffuse\b/;return s.test(r)&&(r=r.replace(s,"varying vec3 vTroikaGlyphColor").replace(/\bdiffuse\b/g,"vTroikaGlyphColor"),s.test(e)||(e=e.replace(ni,"uniform vec3 diffuse;\n$&\nvTroikaGlyphColor = uTroikaUseGlyphColors ? aTroikaGlyphColor / 255.0 : diffuse;\n"))),{vertexShader:e,fragmentShader:r}}});return r.transparent=!0,Object.defineProperties(r,{isTroikaTextMaterial:{value:!0},shadowSide:{get(){return this.side},set(){}}}),r}const Mi=new A({color:16777215,side:ee,transparent:!0}),Bi=8421504,Li=new v,Pi=new r,Ui=new r,Fi=[],Di=new r,Oi="+x+y";function first(e){return Array.isArray(e)?e[0]:e}let getFlatRaycastMesh=()=>{const e=new p(new st(1,1),Mi);return getFlatRaycastMesh=()=>e,e},getCurvedRaycastMesh=()=>{const e=new p(new st(1,1,32,1),Mi);return getCurvedRaycastMesh=()=>e,e};const Gi={type:"syncstart"},Ni={type:"synccomplete"},Hi=["font","fontSize","fontStyle","fontWeight","lang","letterSpacing","lineHeight","maxWidth","overflowWrap","text","direction","textAlign","textIndent","whiteSpace","anchorX","anchorY","colorRanges","sdfGlyphSize"],Wi=Hi.concat("material","color","depthOffset","clipRect","curveRadius","orientation","glyphGeometryDetail");class Text extends p{constructor(){super(new GlyphsGeometry,null),this.text="",this.anchorX=0,this.anchorY=0,this.curveRadius=0,this.direction="auto",this.font=null,this.unicodeFontsURL=null,this.fontSize=.1,this.fontWeight="normal",this.fontStyle="normal",this.lang=null,this.letterSpacing=0,this.lineHeight="normal",this.maxWidth=1/0,this.overflowWrap="normal",this.textAlign="left",this.textIndent=0,this.whiteSpace="normal",this.material=null,this.color=null,this.colorRanges=null,this.outlineWidth=0,this.outlineColor=0,this.outlineOpacity=1,this.outlineBlur=0,this.outlineOffsetX=0,this.outlineOffsetY=0,this.strokeWidth=0,this.strokeColor=Bi,this.strokeOpacity=1,this.fillOpacity=1,this.depthOffset=0,this.clipRect=null,this.orientation=Oi,this.glyphGeometryDetail=1,this.sdfGlyphSize=null,this.gpuAccelerateSDF=!0,this.debugSDF=!1}sync(e){this._needsSync&&(this._needsSync=!1,this._isSyncing?(this._queuedSyncs||(this._queuedSyncs=[])).push(e):(this._isSyncing=!0,this.dispatchEvent(Gi),getTextRenderInfo({text:this.text,font:this.font,lang:this.lang,fontSize:this.fontSize||.1,fontWeight:this.fontWeight||"normal",fontStyle:this.fontStyle||"normal",letterSpacing:this.letterSpacing||0,lineHeight:this.lineHeight||"normal",maxWidth:this.maxWidth,direction:this.direction||"auto",textAlign:this.textAlign,textIndent:this.textIndent,whiteSpace:this.whiteSpace,overflowWrap:this.overflowWrap,anchorX:this.anchorX,anchorY:this.anchorY,colorRanges:this.colorRanges,includeCaretPositions:!0,sdfGlyphSize:this.sdfGlyphSize,gpuAccelerateSDF:this.gpuAccelerateSDF,unicodeFontsURL:this.unicodeFontsURL},(r=>{this._isSyncing=!1,this._textRenderInfo=r,this.geometry.updateGlyphs(r.glyphBounds,r.glyphAtlasIndices,r.blockBounds,r.chunkedBounds,r.glyphColors);const s=this._queuedSyncs;s&&(this._queuedSyncs=null,this._needsSync=!0,this.sync((()=>{s.forEach((e=>e&&e()))}))),this.dispatchEvent(Ni),e&&e()}))))}onBeforeRender(e,r,s,l,h,u){this.sync(),h.isTroikaTextMaterial&&this._prepareForRender(h),h._hadOwnSide=h.hasOwnProperty("side"),this.geometry.setSide(h._actualSide=h.side),h.side=b}onAfterRender(e,r,s,l,h,u){h._hadOwnSide?h.side=h._actualSide:delete h.side}dispose(){this.geometry.dispose()}get textRenderInfo(){return this._textRenderInfo||null}get material(){let e=this._derivedMaterial;const r=this._baseMaterial||this._defaultMaterial||(this._defaultMaterial=Mi.clone());if(e&&e.baseMaterial===r||(e=this._derivedMaterial=createTextDerivedMaterial(r),r.addEventListener("dispose",(function onDispose(){r.removeEventListener("dispose",onDispose),e.dispose()}))),this.outlineWidth||this.outlineBlur||this.outlineOffsetX||this.outlineOffsetY){let r=e._outlineMtl;return r||(r=e._outlineMtl=Object.create(e,{id:{value:e.id+.1}}),r.isTextOutlineMaterial=!0,r.depthWrite=!1,r.map=null,e.addEventListener("dispose",(function onDispose(){e.removeEventListener("dispose",onDispose),r.dispose()}))),[r,e]}return e}set material(e){e&&e.isTroikaTextMaterial?(this._derivedMaterial=e,this._baseMaterial=e.baseMaterial):this._baseMaterial=e}get glyphGeometryDetail(){return this.geometry.detail}set glyphGeometryDetail(e){this.geometry.detail=e}get curveRadius(){return this.geometry.curveRadius}set curveRadius(e){this.geometry.curveRadius=e}get customDepthMaterial(){return first(this.material).getDepthMaterial()}get customDistanceMaterial(){return first(this.material).getDistanceMaterial()}_prepareForRender(e){const r=e.isTextOutlineMaterial,s=e.uniforms,l=this.textRenderInfo;if(l){const{sdfTexture:e,blockBounds:h}=l;s.uTroikaSDFTexture.value=e,s.uTroikaSDFTextureSize.value.set(e.image.width,e.image.height),s.uTroikaSDFGlyphSize.value=l.sdfGlyphSize,s.uTroikaSDFExponent.value=l.sdfExponent,s.uTroikaTotalBounds.value.fromArray(h),s.uTroikaUseGlyphColors.value=!r&&!!l.glyphColors;let u,p,m,_=0,v=0,x=0,b=0,S=0;if(r){let{outlineWidth:e,outlineOffsetX:r,outlineOffsetY:s,outlineBlur:l,outlineOpacity:h}=this;_=this._parsePercent(e)||0,v=Math.max(0,this._parsePercent(l)||0),u=h,b=this._parsePercent(r)||0,S=this._parsePercent(s)||0}else x=Math.max(0,this._parsePercent(this.strokeWidth)||0),x&&(m=this.strokeColor,s.uTroikaStrokeColor.value.set(null==m?Bi:m),p=this.strokeOpacity,null==p&&(p=1)),u=this.fillOpacity;s.uTroikaDistanceOffset.value=_,s.uTroikaPositionOffset.value.set(b,S),s.uTroikaBlurRadius.value=v,s.uTroikaStrokeWidth.value=x,s.uTroikaStrokeOpacity.value=p,s.uTroikaFillOpacity.value=null==u?1:u,s.uTroikaCurveRadius.value=this.curveRadius||0;let C=this.clipRect;if(C&&Array.isArray(C)&&4===C.length)s.uTroikaClipRect.value.fromArray(C);else{const e=100*(this.fontSize||.1);s.uTroikaClipRect.value.set(h[0]-e,h[1]-e,h[2]+e,h[3]+e)}this.geometry.applyClipRect(s.uTroikaClipRect.value)}s.uTroikaSDFDebug.value=!!this.debugSDF,e.polygonOffset=!!this.depthOffset,e.polygonOffsetFactor=e.polygonOffsetUnits=this.depthOffset||0;const h=r?this.outlineColor||0:this.color;if(null==h)delete e.color;else{const r=e.hasOwnProperty("color")?e.color:e.color=new le;h===r._input&&"object"!=typeof h||r.set(r._input=h)}let u=this.orientation||Oi;if(u!==e._orientation){let r=s.uTroikaOrient.value;u=u.replace(/[^-+xyz]/g,"");let l=u!==Oi&&u.match(/^([-+])([xyz])([-+])([xyz])$/);if(l){let[,e,s,h,u]=l;Pi.set(0,0,0)[s]="-"===e?1:-1,Ui.set(0,0,0)[u]="-"===h?-1:1,Li.lookAt(Di,Pi.cross(Ui),Ui),r.setFromMatrix4(Li)}else r.identity();e._orientation=u}}_parsePercent(e){if("string"==typeof e){let r=e.match(/^(-?[\d.]+)%$/),s=r?parseFloat(r[1]):NaN;e=(isNaN(s)?0:s/100)*this.fontSize}return e}localPositionToTextCoords(e,r=new s){r.copy(e);const l=this.curveRadius;return l&&(r.x=Math.atan2(e.x,Math.abs(l)-Math.abs(e.z))*Math.abs(l)),r}worldPositionToTextCoords(e,r=new s){return Pi.copy(e),this.localPositionToTextCoords(this.worldToLocal(Pi),r)}raycast(e,r){const{textRenderInfo:s,curveRadius:l}=this;if(s){const h=s.blockBounds,u=l?getCurvedRaycastMesh():getFlatRaycastMesh(),p=u.geometry,{position:m,uv:_}=p.attributes;for(let e=0;e<_.count;e++){let r=h[0]+_.getX(e)*(h[2]-h[0]);const s=h[1]+_.getY(e)*(h[3]-h[1]);let u=0;l&&(u=l-Math.cos(r/l)*l,r=Math.sin(r/l)*l),m.setXYZ(e,r,s,u)}p.boundingSphere=this.geometry.boundingSphere,p.boundingBox=this.geometry.boundingBox,u.matrixWorld=this.matrixWorld,u.material.side=this.material.side,Fi.length=0,u.raycast(e,Fi);for(let e=0;e<Fi.length;e++)Fi[e].object=this,r.push(Fi[e])}}copy(e){const r=this.geometry;return super.copy(e),this.geometry=r,Wi.forEach((r=>{this[r]=e[r]})),this}clone(){return(new this.constructor).copy(this)}}function getCaretAtPoint(e,r,s){let l=null;const h=function(e){let r=ji.get(e);if(!r){r=[];const{caretPositions:s}=e;let l;const visitCaret=(e,s,h,u)=>{(!l||h<(l.top+l.bottom)/2)&&r.push(l={bottom:s,top:h,carets:[]}),h>l.top&&(l.top=h),s<l.bottom&&(l.bottom=s),l.carets.push({x:e,y:s,height:h-s,charIndex:u})};let h=0;for(;h<s.length;h+=4)visitCaret(s[h],s[h+2],s[h+3],h/4);visitCaret(s[h-3],s[h-2],s[h-1],h/4)}return ji.set(e,r),r}(e);let u=null;return h.forEach((e=>{(!u||Math.abs(s-(e.top+e.bottom)/2)<Math.abs(s-(u.top+u.bottom)/2))&&(u=e)})),u.carets.forEach((e=>{(!l||Math.abs(r-e.x)<Math.abs(r-l.x))&&(l=e)})),l}Hi.forEach((e=>{const r="_private_"+e;Object.defineProperty(Text.prototype,e,{get(){return this[r]},set(e){e!==this[r]&&(this[r]=e,this._needsSync=!0)}})}));const Vi=new WeakMap;const ji=new WeakMap;var zi=Object.freeze({__proto__:null,GlyphsGeometry:GlyphsGeometry,Text:Text,configureTextBuilder:function(e){Si?console.warn("configureTextBuilder called after first font request; will be ignored."):assign(Ti,e)},createTextDerivedMaterial:createTextDerivedMaterial,dumpSDFTextures:function(){Object.keys(Ci).forEach((e=>{const r=Ci[e].sdfCanvas,{width:s,height:l}=r;console.log("%c.",`\n      background: url(${r.toDataURL()});\n      background-size: ${s}px ${l}px;\n      color: transparent;\n      font-size: 0;\n      line-height: ${l}px;\n      padding-left: ${s}px;\n    `)}))},fontResolverWorkerModule:ui,getCaretAtPoint:getCaretAtPoint,getSelectionRects:function(e,r,s){let l;if(e){let h=Vi.get(e);if(h&&h.start===r&&h.end===s)return h.rects;const{caretPositions:u}=e;if(s<r){const e=r;r=s,s=e}r=Math.max(r,0),s=Math.min(s,u.length+1),l=[];let p=null;for(let e=r;e<s;e++){const r=u[4*e],s=u[4*e+1],h=Math.min(r,s),m=Math.max(r,s),_=u[4*e+2],v=u[4*e+3];(!p||_!==p.bottom||v!==p.top||h>p.right||m<p.left)&&(p={left:1/0,right:-1/0,bottom:_,top:v},l.push(p)),p.left=Math.min(h,p.left),p.right=Math.max(m,p.right)}l.sort(((e,r)=>r.bottom-e.bottom||e.left-r.left));for(let e=l.length-1;e-- >0;){const r=l[e],s=l[e+1];r.bottom===s.bottom&&r.top===s.top&&r.left<=s.right&&r.right>=s.left&&(s.left=Math.min(s.left,r.left),s.right=Math.max(s.right,r.right),l.splice(e,1))}Vi.set(e,{start:r,end:s,rects:l})}return l},getTextRenderInfo:getTextRenderInfo,preloadFont:function({font:e,characters:r,sdfGlyphSize:s},l){getTextRenderInfo({font:e,sdfGlyphSize:s,text:Array.isArray(r)?r.join("\n"):""+r},l)},typesetterWorkerModule:Ii});class Checkbox extends InteractableComponent{constructor(...e){super(...e),this._defaults.backgroundVisible=!0,this._defaults.borderMaterial.color.set(5197647),this._defaults.borderMaterial.opacity=.9,this._defaults.borderWidth=.002,this._defaults.color=16777215,this._defaults.height=.08,this._defaults.width=.08,this._text=new Text,this._content.add(this._text),this._text.text=" ",this._text.color=this.color,this._text.lineHeight=1,this._text.textAlign="center",this._text.anchorX="center",this._text.anchorY="middle",this.onClick=this.onTouch=()=>this._change(),"visible"!=this.overflow&&(this._text.material.clippingPlanes=this._getClippingPlanes()),this.updateLayout()}updateLayout(){super.updateLayout(),this._text.fontSize=.65*Math.min(this.computedHeight,this.computedWidth)}_updateMaterialOffset(e){super._updateMaterialOffset(e),this._text.depthOffset=-1*this._materialOffset-1,this._text.renderOrder=100+this._materialOffset+1}_change(){this._checked=!this._checked,this._checked?(this._text.text="✔",this.material.color.set(12543),this._text.sync()):(this._text.text="",this.material.color.set(16777215)),this._onChange&&this._onChange(this._checked)}get checked(){return this._checked}get onChange(){return this._onChange}set checked(e){e!=this._checked&&(this._checked=e,e?(this._text.text="✔",this.material.color.set(12543)):(this._text.text="",this.material.color.set(16777215)),this._text.sync())}set onChange(e){this._onChange=e}}class Div extends ScrollableComponent{constructor(...e){super(...e),this.updateLayout()}}const Xi=new e.Vector3;let qi=class extends InteractableComponent{constructor(e,...r){super(...r),this._defaults.backgroundVisible=!0,this._defaults.textureFit="fill",this._imageHeight=0,this._imageWidth=0,this.updateLayout(),this.updateTexture(e)}_handleStyleUpdateForTextureFit(){this._updateFit(-1,1)}_computeDimension(e){if("auto"!=this[e])return super._computeDimension(e);let r="height"==e?"width":"height",s=capitalizeFirstLetter(e),l=capitalizeFirstLetter(r),h="computed"+s;if("auto"==this[r])this[h]=this["_image"+s]/100;else{"height"==e&&this._computeDimension("width");let r=this["computed"+l]/this["_image"+l];this[h]=this["_image"+s]*r||0}return this._computeUnpaddedAndMarginedDimensions(e,this[h]),this[h]}updateLayout(){let e=this.computedHeight,r=this.computedWidth;super.updateLayout(),this._updateFit(e,r)}_updateFit(e,r){let s=this.computedHeight,l=this.computedWidth;if((e!=this.computedHeight||r!=this.computedWidth)&&this?._texture?.image)if("cover"==this.textureFit){let h=l/s;if(h!=r/e){let e=this._texture.image.width/this._texture.image.height;h<e?(this._texture.repeat.x=h/e,this._texture.repeat.y=1,this._texture.offset.x=(1-this._texture.repeat.x)/2,this._texture.offset.y=0):(this._texture.repeat.x=1,this._texture.repeat.y=e/h,this._texture.offset.x=0,this._texture.offset.y=(1-this._texture.repeat.y)/2)}}else this._texture.repeat.x=1,this._texture.repeat.y=1,this._texture.offset.x=0,this._texture.offset.y=0}updateTexture(r){r?r instanceof e.Texture?this._updateTexture(r.bypassCloning?r:r.clone()):(new e.TextureLoader).load(r,(r=>{r.colorSpace=e.SRGBColorSpace,this._updateTexture(r)}),(()=>{}),(()=>{console.error("Couldn't load image :(")})):(this._texture&&this._texture.dispose(),this._texture=null,this.material.map=null,this.material.needsUpdate=!0)}_updateTexture(e){let r=this._texture;this._texture=e,this._imageWidth=e.image.width,this._imageHeight=e.image.height,this.material.map=e,this.material.needsUpdate=!0,this.updateLayout(),this._updateFit(-1,1),r&&r.dispose()}_createBackground(){super._createBackground();let e=this.computedWidth/2,r=this.computedHeight/2,s=this._background.geometry.attributes.position,l=this._background.geometry.attributes.uv;for(let h=0;h<s.count;h++)Xi.fromBufferAttribute(s,h),l.setXY(h,(Xi.x+e)/this.computedWidth,(Xi.y+r)/this.computedHeight)}};class HueSaturationWheel extends qi{constructor(e,...r){super(e,...r)}_createBackground(){this._defaults.borderRadius=Math.min(this.computedHeight,this.computedHeight)/2,super._createBackground()}}const Ki=new e.Plane,$i=new e.Vector3,Yi=256,Zi=128;class HSLColor{constructor(e){this._hue=171,this._saturation=1,this._lightness=.5,this._radius=e||.1,this._createTextures(),this._createCursors()}_createTextures(){let r=2*this._radius,s=document.createElement("canvas"),l=document.createElement("canvas");s.width=256,s.height=256,l.width=1,l.height=Yi,this._colorContext=s.getContext("2d"),this._lightnessContext=l.getContext("2d"),this._updateColorWheel(),this._updateLightnessBar(),this._colorTexture=new e.CanvasTexture(s),this._colorTexture.colorSpace=e.SRGBColorSpace,this._colorTexture.bypassCloning=!0,this._lightnessTexture=new e.CanvasTexture(l),this._lightnessTexture.colorSpace=e.SRGBColorSpace,this._lightnessTexture.bypassCloning=!0,this.hueSaturationWheel=new HueSaturationWheel(this._colorTexture,{height:r,width:r}),this.lightnessBar=new qi(this._lightnessTexture,{borderRadius:r/20,height:r,width:r/10}),this.hueSaturationWheel.pointerInteractable.addEventListener("down",(e=>this.hueSaturationWheel.pointerInteractable.capture(e.owner))),this.hueSaturationWheel.onClick=e=>{this._handleColorCursorDrag(e),this._onBlur&&this._onBlur(this.getColor())},this.hueSaturationWheel.onDrag=e=>{this._handleColorCursorDrag(e)},this.lightnessBar.pointerInteractable.addEventListener("down",(e=>this.lightnessBar.pointerInteractable.capture(e.owner))),this.lightnessBar.onClick=e=>{this._handleLightnessCursorDrag(e),this._onBlur&&this._onBlur(this.getColor())},this.lightnessBar.onDrag=e=>{this._handleLightnessCursorDrag(e)}}_updateColorWheel(){let e=this._colorContext.getImageData(0,0,256,256),r=e.data;this._drawColorWheel(r),this._colorContext.putImageData(e,0,0)}_drawColorWheel(e){let r=this._lightness;for(let s=-128;s<=Zi;s++){let l=s*s,h=Math.ceil(Math.sqrt(16384-l));for(let l=-h;l<=h;l++){let[h,u]=cartesianToPolar(s,l);if(h>Zi)continue;let p=4*(s+Zi+(l+Zi)*256),m=radiansToDegrees(u),_=h/Zi,[v,x,b]=hslToRGB(m,_,r);e[p]=v,e[p+1]=x,e[p+2]=b,e[p+3]=255}}}_updateLightnessBar(){let e=this._lightnessContext.getImageData(0,0,1,Yi),r=e.data;for(let e=0;e<1;e++)for(let s=0;s<Yi;s++){let l=4*(e+1*s),h=this._hue,u=this._saturation,p=1-s/Yi,[m,_,v]=hslToRGB(h,u,p);r[l]=m,r[l+1]=_,r[l+2]=v,r[l+3]=255}this._lightnessContext.putImageData(e,0,0)}_handleColorCursorDrag(e){let{owner:r,point:s}=e;s||(Ki.set($i.set(0,0,1),0),Ki.applyMatrix4(this.hueSaturationWheel.matrixWorld),s=r.raycaster.ray.intersectPlane(Ki,$i)),$i.copy(s),this.hueSaturationWheel.worldToLocal($i);let l=this.selectColorFromXY($i.x,$i.y);null!=l&&this._onChange&&(this._onChange(l),this._updateColorCursor(),this._colorCursor.visible||(this._colorCursor.visible=!0))}_handleLightnessCursorDrag(e){let{owner:r,point:s}=e;s||(Ki.set($i.set(0,0,1),0),Ki.applyMatrix4(this.lightnessBar.matrixWorld),s=r.raycaster.ray.intersectPlane(Ki,$i)),$i.copy(s),this.lightnessBar.worldToLocal($i);let l=this.selectLightnessFromXY($i.x,$i.y);null!=l&&this._onChange&&(this._onChange(l),this._updateLightnessCursor(),this._lightnessCursor.visible||(this._lightnessCursor.visible=!0))}_createCursors(){let r=new e.RingGeometry(this._radius/12,this._radius/10,16),s=new e.MeshBasicMaterial({color:16777215,side:e.FrontSide,transparent:!0,polygonOffset:!0,polygonOffsetFactor:-10,polygonOffsetUnits:-10});this._colorCursor=new e.Mesh(r,s),this._colorCursor.position.setZ(2e-8),this.hueSaturationWheel.add(this._colorCursor),this._colorCursor.visible=!1,r=new e.RingGeometry(this._radius/9,this._radius/7.5,4,1,Math.PI/4);let l=r.getAttribute("position");for(let e=0;e<l.count;e++){let r=l.getY(e);r>0&&l.setY(e,r-this._radius/20),r<0&&l.setY(e,r+this._radius/20)}this._lightnessCursor=new e.Mesh(r,s),this._lightnessCursor.position.setZ(2e-8),this.lightnessBar.add(this._lightnessCursor),this._lightnessCursor.visible=!1}_updateColorCursor(){let[e,r]=this.getXY(this._radius);$i.set(e,-r,0),this._colorCursor.position.setX($i.x),this._colorCursor.position.setY($i.y);let s=this._colorCursor.material,l=this.hueSaturationWheel._materialOffset+1;s.polygonOffsetFactor!=-1*l&&(s.polygonOffsetFactor=-1*l,s.polygonOffsetUnits=-1*l,this._colorCursor.renderOrder=100+l)}_updateLightnessCursor(){let e=this.getLightness(this._radius);$i.set(0,(e-.5)*this._radius*2,0),this._lightnessCursor.position.setX($i.x),this._lightnessCursor.position.setY($i.y)}getColorTexture(){return this._colorTexture}getLightnessTexture(){return this._lightnessTexture}getXY(r){return polarToCartesian(this._saturation*r,e.MathUtils.degToRad(this._hue+180))}getLightness(){return this._lightness}setFromHSL(e){this._hue=360*e.h,this._saturation=e.s,this._lightness=e.l,this._updateColorWheel(),this._updateColorCursor(),this._updateLightnessBar(),this._updateLightnessCursor(),this._colorTexture.needsUpdate=!0,this._lightnessTexture.needsUpdate=!0}selectColorFromXY(e,r){let[s,l]=cartesianToPolar(e,r);s>this._radius&&(s=this._radius);let h=radiansToDegrees(-l),u=s/this._radius;return this._hue=h,this._saturation=u,this._updateLightnessBar(),this._lightnessTexture.needsUpdate=!0,this.getColor()}selectLightnessFromXY(e,r){let s=r/(2*this._radius)+.5;return s<0&&(s=0),s>1&&(s=1),this._lightness=s,this._updateColorWheel(),this._colorTexture.needsUpdate=!0,this.getColor()}getColor(){let[e,r,s]=hslToRGB(this._hue,this._saturation,this._lightness);return rgbToHex(e,r,s)}isDragging(){return this.hueSaturationWheel.pointerInteractable.state==mr.SELECTED||mr.SELECTED==this.lightnessBar.pointerInteractable.state}get onBlur(){return this._onBlur}get onChange(){return this._onChange}get radius(){return this._radius}set onBlur(e){this._onBlur=e}set onChange(e){this._onChange=e}set radius(e){this._radius=e}}class Span extends ScrollableComponent{constructor(...e){super(...e),this._defaults.contentDirection="row",this.updateLayout()}}class TextComponent extends LayoutComponent{constructor(e,...r){super(...r),this._defaults.color=0,this._defaults.fontSize=.1,this._defaults.textAlign="left",this._text=new Text,this._content.add(this._text),this.font&&(this._text.font=this.font),this._text.color=this.color,this._text.fontSize=this.fontSize,this._text.textAlign=this.textAlign,this._text.anchorX="center",this._text.anchorY="middle",this._text.overflowWrap="break-word",typeof this.maxWidth==Number&&(this._text.maxWidth=this.maxWidth),this._text.addEventListener("synccomplete",(()=>this.updateLayout())),this._text.sync(),this._text.text=e||"",this._text.sync(),"visible"!=this.overflow&&(this._text.material.clippingPlanes=this._getClippingPlanes())}_handleStyleUpdateForColor(){this._text.color=this.color}_handleStyleUpdateForFont(){this._text.font=this.font,"auto"!=this.width&&"auto"!=this.height||this.updateLayout()}_handleStyleUpdateForFontSize(){this._text.fontSize=this.fontSize,"auto"!=this.width&&"auto"!=this.height||this.updateLayout()}_handleStyleUpdateForTextAlign(){this._text.textAlign=this.textAlign}_handleStyleUpdateForMaxWidth(){null!=this.maxWidth?"number"==typeof this.maxWidth&&(this._text.maxWidth=this.maxWidth):this._text.maxWidth=null,super._handleStyleUpdateForMaxWidth()}_computeDimension(e,r){if("auto"!=this[r||e]){let s=super._computeDimension(e,r);return"width"==e&&(this._text.maxWidth=s),s}let s=capitalizeFirstLetter(e),l="computed"+s,h="max"+s,u="min"+s,p=this._text.textRenderInfo;if(p){let r=p.blockBounds;this[l]="width"==e?Math.abs(r[0]-r[2]):Math.abs(r[1]-r[3])}if(r)return this[l];if(0==this[l]&&null!=this[u])this._computeDimension(e,u);else if("width"==e&&this[h]){let r=this[l];this._computeDimension(e,h),this._text.maxWidth=this[l],r<this[l]&&(this[l]=r)}return this._computeUnpaddedAndMarginedDimensions(e,this[l]),this[l]}_updateMaterialOffset(e){super._updateMaterialOffset(e),this._text.depthOffset=-1*this._materialOffset-1,this._text.renderOrder=100+this._materialOffset+1}get text(){return this._text.text}get troikaText(){return this._text}set text(e){this._text.text=e,this._text.sync()}}const Ji={name:"English",pages:[{style:{padding:.01},rows:[{keys:["q","w",{text:"e",type:"key",value:"e",additionalCharacters:["è","é","ë","ê"]},"r","t","y",{text:"u",type:"key",value:"u",additionalCharacters:["ù","ú","ü","û"]},{text:"i",type:"key",value:"i",additionalCharacters:["ì","í","ï","î"]},{text:"o",type:"key",value:"o",additionalCharacters:["ò","ó","ö","ô","ø"]},"p"]},{keys:[{text:"a",type:"key",value:"a",additionalCharacters:["à","á","ä","â"]},"s","d","f","g","h","j","k","l"]},{keys:[{text:"⇧",type:"shift",style:{width:.155}},"z","x",{text:"c",type:"key",value:"c",additionalCharacters:["ç"]},"v","b",{text:"n",type:"key",value:"n",additionalCharacters:["ñ"]},"m",{text:"⌫",type:"key",value:"Backspace",style:{width:.155}}]},{keys:[{text:"123",type:"page",page:1,style:{width:.155}},",",{text:"space",type:"key",value:" ",style:{width:.539}},".",{text:"⏎",type:"key",value:"Enter",style:{width:.155}}]}]},{style:{padding:.01},rows:[{keys:["1","2","3","4","5","6","7","8","9","0"]},{keys:["-","/",":",";","(",")","$","&","@",'"']},{keys:[{text:"#+=",type:"page",page:2,style:{width:.155,marginRight:.115}},".",",","?","!","'",{text:"⌫",type:"key",value:"Backspace",style:{width:.155,marginLeft:.115}}]},{keys:[{text:"ABC",type:"page",page:0,style:{width:.155}},{text:"space",type:"key",value:" ",style:{width:.759}},{text:"⏎",type:"key",value:"Enter",style:{width:.155}}]}]},{style:{padding:.01},rows:[{keys:["[","]","{","}","#","%","^","*","+","="]},{keys:["_","\\","|","~","<",">","€","£","¥","•"]},{style:{justifyContent:"spaceBetween",width:"100%"},keys:[{text:"123",type:"page",page:1,style:{width:.155,marginRight:.115}},".",",","?","!","'",{text:"⌫",type:"key",value:"Backspace",style:{width:.155,marginLeft:.115}}]},{keys:[{text:"ABC",type:"page",page:0,style:{width:.155}},{text:"space",type:"key",value:" ",style:{width:.759}},{text:"⏎",type:"key",value:"Enter",style:{width:.155}}]}]}]},Qi={name:"Numbers",pages:[{style:{padding:.01},rows:[{keys:["1","2","3"]},{keys:["4","5","6"]},{keys:["7","8","9"]},{keys:[".","0",{text:"⌫",type:"key",value:"Backspace"}]}]}]},es={name:"русский",pages:[{style:{padding:.01},rows:[{keys:["й","ц","у","к","е","н","г","ш","щ","з","х","ъ"]},{keys:["ф","ы","в","а","п","р","о","л","д","ж","э","ë"]},{keys:[{text:"⇧",type:"shift",style:{width:.155}},"я","ч","с","м","и","т","ь","б","ю",{text:"⌫",type:"key",value:"Backspace",style:{width:.155}}]},{keys:[{text:"123",type:"page",page:1,style:{width:.155}},",",{text:"space",type:"key",value:" ",style:{width:.539}},".",{text:"⏎",type:"key",value:"Enter",style:{width:.155}}]}]},{style:{padding:.01,marginLeft:.11,marginRight:.11},rows:[{keys:["1","2","3","4","5","6","7","8","9","0"]},{keys:["@","#",":",";","%","-","+","=","(",")"]},{keys:[{text:"~[<",type:"page",page:2,style:{width:.155}},".",",","?","!",'"',"'","₽",{text:"⌫",type:"key",value:"Backspace",style:{width:.155}}]},{keys:[{text:"АБВ",type:"page",page:0,style:{width:.155}},"\\",{text:"space",type:"key",value:" ",style:{width:.539}},"/",{text:"⏎",type:"key",value:"Enter",style:{width:.155}}]}]},{style:{padding:.01,marginLeft:.11,marginRight:.11},rows:[{keys:["[","]","{","}","`","^","*","&","«","»"]},{keys:["$","€","£","¥","•","_","|","~","<",">"]},{style:{justifyContent:"spaceBetween",width:"100%"},keys:[{text:"123",type:"page",page:1,style:{width:.155}},".",",","?","!",'"',"'","₽",{text:"⌫",type:"key",value:"Backspace",style:{width:.155}}]},{keys:[{text:"АБВ",type:"page",page:0,style:{width:.155}},"\\",{text:"space",type:"key",value:" ",style:{width:.539}},"/",{text:"⏎",type:"key",value:"Enter",style:{width:.155}}]}]}]},ts={name:"😀",pages:[{style:{padding:.01},rows:[{keys:["😀","😃","😄","😁","😆","😅","🤣","😂","🙂","🙃"]},{keys:["🫠","😉","😊","😇","🥰","😍","🤩","😘","😗","☺"]},{keys:["😚","😙","🥲","😋","😛","😜","🤪","😝","🤑","🤗"]},{keys:[{text:"←",type:"page",page:3,style:{width:.155}},{text:"→",type:"page",page:1,style:{width:.155}},{text:"space",type:"key",value:" ",style:{width:.429}},{text:"⏎",type:"key",value:"Enter",style:{width:.155}},{text:"⌫",type:"key",value:"Backspace",style:{width:.155}}]}]},{style:{padding:.01},rows:[{keys:["🤭","🫢","🫣","🤫","🤔","🫡","🤐","🤨","😐","😑"]},{keys:["😶","🫥","😶‍🌫","😏","😒","🙄","😬","😮‍💨","🤥","😌"]},{keys:["😔","😪","🤤","😴","😷","🤒","🤕","🤢","🤮","🤧"]},{keys:[{text:"←",type:"page",page:0,style:{width:.155}},{text:"→",type:"page",page:2,style:{width:.155}},{text:"space",type:"key",value:" ",style:{width:.429}},{text:"⏎",type:"key",value:"Enter",style:{width:.155}},{text:"⌫",type:"key",value:"Backspace",style:{width:.155}}]}]},{style:{padding:.01},rows:[{keys:["🥵","🥶","🥴","😵","😵‍💫","🤯","🤠","🥳","🥸","😎"]},{keys:["🤓","🧐","😕","🫤","😟","🙁","☹","😮","😯","😲"]},{keys:["😳","🥺","🥹","😦","😧","😨","😰","😥","😢","😭"]},{keys:[{text:"←",type:"page",page:1,style:{width:.155}},{text:"→",type:"page",page:3,style:{width:.155}},{text:"space",type:"key",value:" ",style:{width:.429}},{text:"⏎",type:"key",value:"Enter",style:{width:.155}},{text:"⌫",type:"key",value:"Backspace",style:{width:.155}}]}]},{style:{padding:.01},rows:[{keys:["😱","😖","😣","😞","😓","😩","😫","🥱","😤","😡"]},{keys:["😠","🤬","😈","👿","💀","☠","💩","","",""]},{keys:["","","","","","","","","",""]},{keys:[{text:"←",type:"page",page:2,style:{width:.155}},{text:"→",type:"page",page:0,style:{width:.155}},{text:"space",type:"key",value:" ",style:{width:.429}},{text:"⏎",type:"key",value:"Enter",style:{width:.155}},{text:"⌫",type:"key",value:"Backspace",style:{width:.155}}]}]}]},ns=new Style({backgroundVisible:!0,borderRadius:.01,height:.1,justifyContent:"center",margin:.005,paddingLeft:.02,paddingRight:.02,width:.1}),rs=new Style({material:new e.MeshBasicMaterial({color:15790320,side:e.DoubleSide,transparent:!0,polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:1})}),is={fontSize:.065},ss="UNSHIFTED",os="SHIFTED",as="CAPS_LOCK";function getComponentBody(e){for(;e&&!(e instanceof Body);)e=e.parent;return e}let ls=new class extends InteractableComponent{constructor(...e){super(...e),this.bypassContentPositioning=!0,this._defaults.backgroundVisible=!0,this._defaults.materialColor=12633550,this._layouts={},this._keyboardPageLayouts=[],this._timeoutIds=new Map,this._updateListeners=new Map,this._setupGrabBar(),this._createOptionsPanel(),this._addLayout(Ji),this._addLayout(es),this._addLayout(ts),this._setLayout(Ji),this.types={NUMBER:"NUMBER"},this.onClick=()=>{},this.updateLayout()}_createBackground(){this._defaults.borderRadius=Math.min(this.computedHeight,this.computedHeight)/20,super._createBackground()}_createOptionsPanel(){this._optionsPanelParent=new e.Object3D,this.add(this._optionsPanelParent),this._optionsPanel=new Div({backgroundVisible:!0,borderRadius:.06,height:.12,justifyContent:"center",materialColor:12633550,width:.12});let r=new Div({backgroundVisible:!0,borderRadius:.05,height:.1,justifyContent:"center",width:.1}),s=new TextComponent("🌐",is);this._optionsPanel.add(r),r.add(s),r.pointerInteractable.addHoveredCallback((e=>{e?r.addStyle(rs):r.removeStyle(rs)})),r.onClick=r.onTouch=()=>{this._setLanguagesPage()}}_addOptionsPanel(){this._optionsPanelParent.add(this._optionsPanel),this._optionsPanelParent.position.x=this.computedWidth/-2-.1}_addLayout(e){this._layouts[e.name]=e}_setLayout(e){if("string"!=typeof e||(e=this._layouts[e])){for(let e of this._content.children)e instanceof LayoutComponent&&this.remove(e);this._keyboardLayout=e,this._keyboardPageLayouts=[],this._keyboardPage=null,this._shiftState=ss,this._setPage(0)}}_setPage(e){if(this._keyboardPage==e)return;for(let e of this._content.children)e instanceof LayoutComponent&&this.remove(e);if(this._keyboardPage=e,this._keyboardPageLayouts[e])return this.add(this._keyboardPageLayouts[e]),void this._addOptionsPanel();let r=new Div(this._keyboardLayout.pages[e].style);for(let s of this._keyboardLayout.pages[e].rows){let l=new Span(s.style);for(let r of s.keys){let s=new Div(ns,r.style),h=r;"string"!=typeof r&&(h=r.text);let u=new TextComponent(h,is);s.add(u),l.add(s),s.pointerInteractable.addHoveredCallback((e=>{e?s.addStyle(rs):s.removeStyle(rs)})),"string"!=typeof r&&r.additionalCharacters&&this._addAdditionalCharacters(s,r);let listener=()=>{if(this._registeredComponent)if("string"==typeof r){let r=this._shiftState==ss?h:h.toUpperCase();this._registeredComponent.handleKey(r),this._shiftState==os&&r!=h&&(this._shiftState=ss,this._shiftCase(e,!1))}else if("key"==r.type){let s=this._shiftState==ss||r.value.length>1?r.value:r.value.toUpperCase();this._registeredComponent.handleKey(s),this._shiftState==os&&s!=r.value&&(this._shiftState=ss,this._shiftCase(e,!1))}else"page"==r.type?(this._shiftState!=ss&&(this._shiftState=ss,this._shiftCase(e,!1)),this._setPage(r.page)):"shift"==r.type&&(this._shiftState==ss?(this._shiftState=os,this._shiftCase(e,!0)):this._shiftState==os?this._shiftState=as:this._shiftState==as&&(this._shiftState=ss,this._shiftCase(e,!1)))};s.pointerInteractable.addEventListener("click",listener),s.touchInteractable.addEventListener("click",listener)}r.add(l)}this._keyboardPageLayouts[e]=r,this.add(r),this._addOptionsPanel(),this._reposition()}_addAdditionalCharacters(e,r){e.pointerInteractable.addEventListener("down",(s=>{let l=s.owner;if(s.additionalCharactersOwner)return;this._timeoutIds.set(l,setTimeout((()=>{this._displayAdditionalCharacters(e,r),this._timeoutIds.delete(l)}),500)),e.additionalCharactersOwner=l;let outCallback=r=>{r.owner==l&&(this._timeoutIds.has(l)&&(clearTimeout(this._timeoutIds.get(l)),this._timeoutIds.delete(l),dr.remove(this._updateListeners.get(l)),delete e.additionalCharactersOwner),e.pointerInteractable.removeEventListener("out",outCallback))};e.pointerInteractable.addEventListener("out",outCallback),this._updateListeners.set(l,(()=>{let r;r="XR"==yr.active?this._isXRControllerPressed(l):"POINTER"==yr.active?Vr.isPointerPressed():Vr.isScreenTouched(),r||(this._timeoutIds.has(l)&&(clearTimeout(this._timeoutIds.get(l)),this._timeoutIds.delete(l)),e.additionalCharactersSpan&&e.remove(e.additionalCharactersSpan),e.pointerInteractable.removeEventListener("out",outCallback),dr.remove(this._updateListeners.get(l)),delete e.additionalCharactersOwner)})),dr.add(this._updateListeners.get(l))}))}_isXRControllerPressed(e){let r=e.object.xrInputDeviceType,s=e.object.handedness;if(r==xr.HAND){let e=Vr.getXRControllerModel(r,s);return 1==e?.motionController?.isPinching}{let e=Vr.getXRGamepad(s);return null!=e?.buttons&&e.buttons[0].pressed}}_displayAdditionalCharacters(e,r){if(e.additionalCharactersSpan)return e.additionalCharactersSpan.borderRadius=this.borderRadius,e.additionalCharactersSpan._updateMaterialOffset(e._materialOffset+1),void e.add(e.additionalCharactersSpan);let s=r.additionalCharacters,l=new Span({backgroundVisible:!0,materialColor:12633550});l.bypassContentPositioning=!0,l.position.y=e.computedHeight;for(let e of s){let s=new Div(ns,r.style),h=new TextComponent(e,is);this._shiftState!=ss&&(h.text=h.text.toUpperCase()),s.add(h),l.add(s),s.pointerInteractable.addEventListener("over",(()=>{s.addStyle(rs)})),s.pointerInteractable.addEventListener("out",(()=>{s.removeStyle(rs)})),s.pointerInteractable.addEventListener("up",(()=>{let r=this._shiftState==ss?e:e.toUpperCase();this._registeredComponent.handleKey(r),this._shiftState==os&&(this._shiftState=ss,this._shiftCase(this._keyboardPage,!1))}))}l.borderRadius=this.borderRadius;let h=e?.parentComponent?.parentComponent?.padding;h&&(l.padding=h,l.position.y+=h),l._updateMaterialOffset(e._materialOffset+1),e.additionalCharactersSpan=l,e.add(l)}_setLanguagesPage(){for(let e of this._content.children)e instanceof LayoutComponent&&this.remove(e);let e,r=0,s=new Div({padding:.01});for(let l in this._layouts){r%2==0&&(e=new Span,s.add(e)),r++;let h=new Div(ns,{width:.3}),u=new TextComponent(l,is);h.add(u),e.add(h),h.pointerInteractable.addHoveredCallback((e=>{e?h.addStyle(rs):h.removeStyle(rs)})),h.onClick=h.onTouch=()=>{this._setLayout(l)}}this.add(s),this._optionsPanelParent.remove(this._optionsPanel),this._reposition()}_setNumberPage(){this._lastKeyboardLayout||(this._lastKeyboardLayout=this._keyboardLayout),this._setLayout(Qi),this._optionsPanelParent.remove(this._optionsPanel)}_shiftCase(e,r){let s=r?"toUpperCase":"toLowerCase";for(let r of this._keyboardPageLayouts[e]._content.children)for(let e of r._content.children){let r=e._content.children[0];if(1==r.text.length&&(r.text=r.text[s]()),e.additionalCharactersSpan){let r=e.additionalCharactersSpan._content.children;for(let e of r){let r=e._content.children[0];r.text=r.text[s]()}}}}_reposition(){if(this._placeGrabBar(),!this._onPopup&&this._registeredComponent){let e=getComponentBody(this._registeredComponent);if(e||(e=this._registeredComponent),this.parent!=e)return;this.position.set(0,(-e.computedHeight-this.computedHeight*this.scale.y)/2-.025,0)}}register(e,r){this._registeredComponent&&this._registeredComponent.blur(),this._registeredComponent=e;let s=getComponentBody(e);r==this.types.NUMBER&&this._setNumberPage(),this._placeGrabBar(),this._onPopup?this._onPopup(e,s):(s||(s=e),this.position.set(0,(-s.computedHeight-this.computedHeight*this.scale.y)/2-.025,0),this.rotation.set(0,0,0),s.add(this),this._updateMaterialOffset(e._materialOffset))}unregister(e){this._registeredComponent==e&&(this._registeredComponent=null,this.parent&&this.parent.remove(this),this._grabBarOwner=this._priorParent=null),this._lastKeyboardLayout&&(this._setLayout(this._lastKeyboardLayout),this._lastKeyboardLayout=null)}_placeGrabBar(){this._grabBar.position.y=-this.computedHeight/2-.025}_setupGrabBar(){this._grabBar=new Body({backgroundVisible:!1,borderRadius:.025,height:.05,justifyContent:"center",width:.21});let e=new Div({backgroundVisible:!0,borderRadius:.01,height:.02,materialColor:12633550,width:.2});this._grabBar.pointerInteractable.addHoveredCallback((r=>{e.material.color.set(r?16777215:12633550)})),this._grabBar.pointerInteractable.addEventListener("down",(e=>{this._grabBarOwner||(this._priorParent=this.parent),this._grabBarOwner=e.owner,e.owner.object.attach(this),this._grabBar.pointerInteractable.capture(e.owner)})),this._grabBar.pointerInteractable.addEventListener("click",(e=>{this.parent==e.owner.object&&(this._priorParent.attach(this),this._grabBarOwner=this._priorParent=null)})),this._grabBar.add(e),this.add(this._grabBar)}get onPopup(){return this._onPopup}set onPopup(e){this._onPopup=e}};let hs=new class{constructor(){this._listeners=new Set}setup(){"XR"!=yr.active&&(this._eventType="TOUCH_SCREEN"==yr.active?"touchend":"click",this._clickListener=()=>{setTimeout((()=>{for(let e of this._listeners)e(),this._listeners.delete(e)}),30)},document.addEventListener(this._eventType,this._clickListener))}trigger(e){this._listeners.add(e)}};var cs;!function(e){e[e.HIGH_SURROGATE_START=55296]="HIGH_SURROGATE_START",e[e.HIGH_SURROGATE_END=56319]="HIGH_SURROGATE_END",e[e.LOW_SURROGATE_START=56320]="LOW_SURROGATE_START",e[e.REGIONAL_INDICATOR_START=127462]="REGIONAL_INDICATOR_START",e[e.REGIONAL_INDICATOR_END=127487]="REGIONAL_INDICATOR_END",e[e.FITZPATRICK_MODIFIER_START=127995]="FITZPATRICK_MODIFIER_START",e[e.FITZPATRICK_MODIFIER_END=127999]="FITZPATRICK_MODIFIER_END",e[e.VARIATION_MODIFIER_START=65024]="VARIATION_MODIFIER_START",e[e.VARIATION_MODIFIER_END=65039]="VARIATION_MODIFIER_END",e[e.DIACRITICAL_MARKS_START=8400]="DIACRITICAL_MARKS_START",e[e.DIACRITICAL_MARKS_END=8447]="DIACRITICAL_MARKS_END",e[e.SUBDIVISION_INDICATOR_START=127988]="SUBDIVISION_INDICATOR_START",e[e.TAGS_START=917504]="TAGS_START",e[e.TAGS_END=917631]="TAGS_END",e[e.ZWJ=8205]="ZWJ"}(cs||(cs={}));const ds=Object.freeze([776,2359,2367,2984,3007,3021,3633,3635,3648,3657,4352,4449,4520]);var us;function runes(e){if("string"!=typeof e)throw new TypeError("string cannot be undefined or null");const r=[];let s=0,l=0;for(;s<e.length;)l+=nextUnits(s+l,e),isGrapheme(e[s+l])&&l++,isVariationSelector(e[s+l])&&l++,isDiacriticalMark(e[s+l])&&l++,isZeroWidthJoiner(e[s+l])?l++:(r.push(e.substring(s,s+l)),s+=l,l=0);return r}function nextUnits(e,r){const s=r[e];if(!function(e){return e&&betweenInclusive(e[0].charCodeAt(0),55296,56319)}(s)||e===r.length-1)return 1;const l=s+r[e+1];let h=r.substring(e+2,e+5);return isRegionalIndicator(l)&&isRegionalIndicator(h)?4:function(e){return betweenInclusive(codePointFromSurrogatePair(e),127988,127988)}(l)&&function(e){const r=e.codePointAt(0);return"string"==typeof e&&"number"==typeof r&&betweenInclusive(r,917504,917631)}(h)?r.slice(e).indexOf(String.fromCodePoint(917631))+2:function(e){return betweenInclusive(codePointFromSurrogatePair(e),127995,127999)}(h)?4:2}function isRegionalIndicator(e){return betweenInclusive(codePointFromSurrogatePair(e),127462,127487)}function isVariationSelector(e){return"string"==typeof e&&betweenInclusive(e.charCodeAt(0),65024,65039)}function isDiacriticalMark(e){return"string"==typeof e&&betweenInclusive(e.charCodeAt(0),8400,8447)}function isGrapheme(e){return"string"==typeof e&&ds.includes(e.charCodeAt(0))}function isZeroWidthJoiner(e){return"string"==typeof e&&8205===e.charCodeAt(0)}function codePointFromSurrogatePair(e){return(e.charCodeAt(0)-55296<<10)+(e.charCodeAt(1)-56320)+65536}function betweenInclusive(e,r,s){return e>=r&&e<=s}!function(e){e[e.unit_1=1]="unit_1",e[e.unit_2=2]="unit_2",e[e.unit_4=4]="unit_4"}(us||(us={}));const ps=new e.Vector3,fs=new Set,gs=new Set;fs.add("ArrowLeft"),fs.add("ArrowRight"),fs.add("ArrowUp"),fs.add("ArrowDown"),gs.add("Alt"),gs.add("Backspace"),gs.add("CapsLock"),gs.add("Control"),gs.add("Enter"),gs.add("Escape"),gs.add("Meta"),gs.add("Shift"),gs.add("Tab");class TextArea extends ScrollableComponent{constructor(...e){super(...e),this._defaults.alignItems="start",this._defaults.backgroundVisible=!0,this._defaults.borderMaterial.color.set(5197647),this._defaults.borderWidth=.002,this._defaults.color=0,this._defaults.contentDirection="row",this._defaults.justifyContent="start",this._defaults.fontSize=.06,this._defaults.overflow="scroll",this._defaults.paddingLeft=.01,this._defaults.height=.1,this._defaults.width=.4,this._latestValue.overflow=null,this._value=[],this._runeLengths=[],this._textStyle=new Style({color:this.color,fontSize:this.fontSize,textAlign:"left",maxWidth:0,minHeight:0}),this._text=new TextComponent("",this._textStyle),this._placeholder=new TextComponent("",this._textStyle,{color:8421504}),this._placeholder.troikaText.material.opacity=.75,this._content.add(this._text),this._content.add(this._placeholder),this._createCaret(),this.onClick=e=>this._select(e),this.onTouch=e=>this._selectTouch(e),this._keyListener=e=>this.handleKey(e.key),this._pasteListener=e=>this._handlePaste(e),this._downListener=e=>{let r=e.target;for(;r;){if(r==ls||r==this)return;r=r.parent}this.blur()},this._syncCompleteListener=()=>{this._updateCaret(),this._checkForCaretScroll()},this.updateLayout(),"visible"==this.overflow||this.clippingPlanes||this._createClippingPlanes()}_handleStyleUpdateForColor(){this._textStyle.color=this.color}_handleStyleUpdateForFontSize(){this._textStyle.fontSize=this.fontSize}_computeUnpaddedAndMarginedDimensions(e,r){super._computeUnpaddedAndMarginedDimensions(e,r),"width"==e&&this._textStyle.maxWidth!=this.unpaddedWidth&&(this._textStyle.maxWidth=this.unpaddedWidth)}_updateMaterialOffset(e){super._updateMaterialOffset(e),this._caret._updateMaterialOffset(this._materialOffset+1)}_selectTouch(e){let r=this.touchInteractable.getClosestPointTo(e.owner.object),s=r[1].object,l=s.bvhGeometry.index.array[3*r[1].faceIndex],h=s.bvhGeometry.getAttribute("position");ps.fromBufferAttribute(h,l),s.localToWorld(ps),this._select({point:ps})}_select(e){let{point:r}=e;if(!r)return;this._textStyle.minHeight!=this._caret.computedHeight&&(this._textStyle.minHeight=this._caret.computedHeight),this._text._content.add(this._caretParent);let s=this._text._text;s.worldToLocal(ps.copy(r));let l=getCaretAtPoint(s.textRenderInfo,ps.x,ps.y);this._setCaretIndexFromCharIndex(l.charIndex),this._updateCaret(),this._hasListeners||this._addListeners()}_addListeners(){this._hasListeners=!0,"XR"==yr.active?(ls.register(this),zr.addEventListener("down",this._downListener)):"TOUCH_SCREEN"==yr.active?this._displayMobileTextArea():(document.addEventListener("keydown",this._keyListener),document.addEventListener("paste",this._pasteListener),zr.addEventListener("down",this._downListener)),this._text._text.addEventListener("synccomplete",this._syncCompleteListener),this._onFocus&&this._onFocus()}_removeListeners(){this._hasListeners=!1,"XR"==yr.active?(ls.unregister(this),zr.removeEventListener("down",this._downListener)):"TOUCH_SCREEN"==yr.active?document.body.removeChild(this._mobileTextAreaParent):(document.removeEventListener("keydown",this._keyListener),document.removeEventListener("paste",this._pasteListener),zr.removeEventListener("down",this._downListener)),this._text._text.removeEventListener("synccomplete",this._syncCompleteListener),this._text._content.remove(this._caretParent),this._triggerBlurCallback()}_triggerBlurCallback(){this._onBlur&&this._onBlur(this._text.text)}_triggerChangeCallback(){this._onChange&&this._onChange(this._text.text)}_displayMobileTextArea(){if(!this._mobileTextArea){let e=document.createElement("div"),r=document.createElement("textarea");r.rows=5,r.style.fontSize="16px",r.style.minWidth="250px",r.style.width="33%",e.style.width="100%",e.style.height="100%",e.style.position="fixed",e.style.top="0px",e.style.left="0px",e.style.display="flex",e.style.justifyContent="center",e.style.alignItems="center",e.style.backgroundColor="#00000069",e.appendChild(r),e.onclick=s=>{s.target==e&&(this._text.text=r.value,this.blur())},r.onblur=()=>{this._text.text=r.value,this.blur()},r.addEventListener("compositionend",(()=>{this._text.text!=r.value&&(this._text.text=r.value,this._triggerChangeCallback())})),r.onkeyup=()=>{this._text.text!=r.value&&(this._text.text=r.value,this._triggerChangeCallback())},this._mobileTextAreaParent=e,this._mobileTextArea=r}document.body.appendChild(this._mobileTextAreaParent),hs.trigger((()=>this._mobileTextArea.click()))}_createCaret(){this._caretParent=new e.Object3D,this._caret=new TextComponent("|",this._textStyle),this._caret._text.fillOpacity=.75,this._caretParent.add(this._caret)}_getCharIndex(e=this._caretIndex){let r=0;for(let s=0;s<e;s++)r+=this._runeLengths[s];return r}_setCaretIndexFromCharIndex(e=0){let r,s=0,l=0;for(r=0;r<this._runeLengths.length&&s<e;r++)l=s,s+=this._runeLengths[r];let h=Math.abs(e-s),u=Math.abs(e-l);this._caretIndex=s==e||h<u?r:r-1}_updateCaret(){let e=this._getCharIndex(),r=4*e,s=0;if(e==this._text.text.length){if(0==e)return void this._caretParent.position.set(0,0,0);r-=4,s=1}let l=this._text._text.textRenderInfo.caretPositions,h=l[r+s],u=(l[r+2]+l[r+3])/2;isNaN(u)||this._caretParent.position.set(h,u,0)}handleKey(e){Vr.isKeyPressed("Control")||Vr.isKeyPressed("Meta")||("Backspace"==e?this._deleteChar():"Enter"==e?this.insertContent("\n"):"Escape"==e?this.blur():fs.has(e)?this._moveCaret(e):gs.has(e)||this.insertContent(e))}_handlePaste(e){if(e.clipboardData.types.indexOf("text/plain")<0)return;let r=e.clipboardData.getData("text/plain");this.insertContent(r),e.preventDefault()}_moveCaret(e){if("ArrowLeft"==e)this._caretIndex>0&&(this._caretIndex--,this._updateCaret());else if("ArrowRight"==e)this._caretIndex<this._value.length&&(this._caretIndex++,this._updateCaret());else{let r=this._getCharIndex(),s=this._text.text,l="ArrowUp"==e?1:-1,h=4*r,u=0;this._caretIndex==s.length&&0!=this._caretIndex&&(h-=4,u=1);let p=this._text._text,m=p.textRenderInfo.caretPositions,_=m[h+u],v=(m[h+2]+m[h+3])/2,x=Math.abs(m[h+2]-m[h+3]),b=getCaretAtPoint(p.textRenderInfo,_,v+l*x);this._setCaretIndexFromCharIndex(b.charIndex),this._updateCaret()}this._checkForCaretScroll()}_deleteChar(){0!=this._caretIndex&&(this._value.splice(this._caretIndex-1,1),this._runeLengths.splice(this._caretIndex-1,1),this._text.text=this._value.join(""),this._caretIndex--,this._updateCaret(),0!=this._value.length||this._placeholder.parentComponent||this._content.add(this._placeholder),this._triggerChangeCallback())}_checkForCaretScroll(){if(!this._scrollable&&0!=this._content.position.y)return void(this._content.position.y=0);ps.copy(this._caretParent.position),this._caretParent.parent.localToWorld(ps),this.worldToLocal(ps);let e=this.computedHeight/2,r=this._caret.computedHeight/2;ps.y+r>e?this._content.position.y+=e-ps.y-r:ps.y-r<this.computedHeight/-2&&(this._content.position.y+=-e-ps.y+r)}_sanitizeText(){}blur(){this._hasListeners&&this._removeListeners()}insertContent(e){let r=runes(e);this._value.splice(this._caretIndex,0,...r),this._text.text=this._value.join("");for(let e=0;e<r.length;e++)this._runeLengths.splice(this._caretIndex,0,r[e].length),this._caretIndex++;this._sanitizeText(),this._placeholder.parentComponent&&this._content.remove(this._placeholder),this._triggerChangeCallback()}get onBlur(){return this._onBlur}get onChange(){return this._onChange}get onFocus(){return this._onFocus}get placeholder(){return this._placeholder.text}get value(){return this._text.text}set onBlur(e){this._onBlur=e}set onChange(e){this._onChange=e}set onFocus(e){this._onFocus=e}set placeholder(e){this._placeholder.text=e}set value(e){e||(e=""),this._value=runes(e),this._text.text=e,this._runeLengths=[];for(let e=0;e<this._value.length;e++)this._runeLengths.push(this._value[e].length);0==this._value.length?this._placeholder.parentComponent||this._content.add(this._placeholder):this._placeholder.parentComponent&&this._content.remove(this._placeholder)}}const ms=new e.Vector3,_s=new Set,ys=new Set;_s.add("ArrowLeft"),_s.add("ArrowRight"),ys.add("ArrowUp"),ys.add("ArrowDown"),ys.add("Alt"),ys.add("Backspace"),ys.add("CapsLock"),ys.add("Control"),ys.add("Enter"),ys.add("Escape"),ys.add("Meta"),ys.add("Shift"),ys.add("Tab");class TextInput extends TextArea{constructor(...e){super(...e),this._defaults.alignItems="center",this._latestValue.alignItems=null,this._text._overrideStyle.maxWidth=null,this._text._text.whiteSpace="nowrap",this.updateLayout()}_displayMobileTextArea(){if(!this._mobileTextArea){let e=document.createElement("div"),r=document.createElement("input");r.type="text",r.style.fontSize="16px",r.style.minWidth="250px",r.style.width="33%",e.style.width="100%",e.style.height="100%",e.style.position="fixed",e.style.top="0px",e.style.left="0px",e.style.display="flex",e.style.justifyContent="center",e.style.alignItems="center",e.style.backgroundColor="#00000069",e.appendChild(r),e.onclick=s=>{s.target==e&&(this._text.text=r.value,this.blur())},r.onblur=()=>{this._text.text=r.value,this.blur()},r.addEventListener("compositionend",(()=>{this._text.text!=r.value&&(this._text.text=r.value,this._triggerChangeCallback())})),r.onkeyup=e=>{"Enter"!=e.code?this._text.text!=r.value&&(this._text.text=r.value,this._triggerChangeCallback()):this._onEnter&&this._onEnter(this._text.text)},this._mobileTextAreaParent=e,this._mobileTextArea=r}document.body.appendChild(this._mobileTextAreaParent),hs.trigger((()=>this._mobileTextArea.click()))}handleKey(e){Vr.isKeyPressed("Control")||Vr.isKeyPressed("Meta")||("Backspace"==e?this._deleteChar():"Enter"==e?this._onEnter&&this._onEnter(this._text.text):"Escape"==e?this.blur():_s.has(e)?this._moveCaret(e):ys.has(e)||this.insertContent(e))}_handlePaste(e){if(e.clipboardData.types.indexOf("text/plain")<0)return;let r=e.clipboardData.getData("text/plain");this.insertContent(r.replaceAll("\n"," ")),e.preventDefault()}_moveCaret(e){"ArrowLeft"==e?this._caretIndex>0&&(this._caretIndex--,this._updateCaret()):"ArrowRight"==e&&this._caretIndex<this._value.length&&(this._caretIndex++,this._updateCaret()),this._checkForCaretScroll()}_checkForCaretScroll(){if(!this._scrollable&&0!=this._content.position.x)return void(this._content.position.x=0);ms.copy(this._caretParent.position),this._caretParent.parent.localToWorld(ms),this.worldToLocal(ms);let e=this.computedWidth/2,r=this._caret.computedWidth/2;ms.x+r>e?this._content.position.x+=e-ms.x-r:ms.x-r<this.computedWidth/-2&&(this._content.position.x+=-e-ms.x+r)}get onEnter(){return this._onEnter}get value(){return super.value}set onEnter(e){this._onEnter=e}set value(e){e||(e=""),e=e.replaceAll("\n"," "),super.value=e}}const vs=new e.Vector3,xs=new Set,bs=new Set;xs.add("ArrowLeft"),xs.add("ArrowRight"),bs.add("e"),bs.add("E"),bs.add("+");class NumberInput extends TextInput{constructor(...e){super(...e),this._defaults.alignItems="center",this._latestValue.alignItems=null,this._text._overrideStyle.maxWidth=null,this._text._text.whiteSpace="nowrap",this._minValue=-1/0,this._maxValue=1/0,this._lastValidValue="",this.updateLayout()}_addListeners(){this._hasListeners=!0,"XR"==yr.active?(ls.register(this,ls.types.NUMBER),zr.addEventListener("down",this._downListener)):"TOUCH_SCREEN"==yr.active?this._displayMobileTextArea():(document.addEventListener("keydown",this._keyListener),document.addEventListener("paste",this._pasteListener),zr.addEventListener("down",this._downListener)),this._text._text.addEventListener("synccomplete",this._syncCompleteListener),this._onFocus&&this._onFocus()}_displayMobileTextArea(){if(!this._mobileTextArea){let e=document.createElement("div"),r=document.createElement("input");r.type="text",r.inputMode="decimal",r.style.fontSize="16px",r.style.minWidth="250px",r.style.width="33%",e.style.width="100%",e.style.height="100%",e.style.position="fixed",e.style.top="0px",e.style.left="0px",e.style.display="flex",e.style.justifyContent="center",e.style.alignItems="center",e.style.backgroundColor="#00000069",e.appendChild(r),e.onclick=s=>{s.target==e&&(this._text.text=r.value,this.blur())},r.onblur=()=>{this._text.text=r.value,this.blur()},r.onkeydown=e=>{(bs.has(e.key)||r.value.includes(".")&&"."==e.key||!e.key.match(/^[0-9.-]*$/)&&"Backspace"!=e.key&&"Enter"!=e.key)&&e.preventDefault()},r.onkeyup=e=>{"Enter"!=e.key?this._text.text!=r.value&&(this._text.text=r.value,this._triggerChangeCallback()):this._onEnter&&this._onEnter(this._text.text)},this._mobileTextAreaParent=e,this._mobileTextArea=r}document.body.appendChild(this._mobileTextAreaParent),hs.trigger((()=>this._mobileTextArea.click()))}handleKey(e){Vr.isKeyPressed("Control")||Vr.isKeyPressed("Meta")||("Backspace"==e?this._deleteChar():"Enter"==e?this._onEnter&&this._onEnter(this._text.text):"Escape"==e?this.blur():xs.has(e)?this._moveCaret(e):e.match(/^[0-9.-]*$/)&&this.insertContent(e))}_handlePaste(e){if(e.clipboardData.types.indexOf("text/plain")<0)return;let r=e.clipboardData.getData("text/plain");this.insertContent(r),e.preventDefault()}_checkForCaretScroll(){if(!this._scrollable&&0!=this._content.position.x)return void(this._content.position.x=0);vs.copy(this._caretParent.position),this._caretParent.parent.localToWorld(vs),this.worldToLocal(vs);let e=this.computedWidth/2,r=this._caret.computedWidth/2;vs.x+r>e?this._content.position.x+=e-vs.x-r:vs.x-r<this.computedWidth/-2&&(this._content.position.x+=-e-vs.x+r)}_triggerBlurCallback(){let e=Number.parseFloat(this._text.text);isNaN(e)?this.value=this._lastValidValue:"number"==typeof this._minValue&&e<this._minValue?this.value=this._minValue:"number"==typeof this._maxValue&&e>this._maxValue&&(this.value=this._maxValue),this._lastValidValue=this._text.text,this._onBlur&&this._onBlur(this._text.text)}_triggerChangeCallback(){let e=Number.parseFloat(this._text.text);isNaN(e)||"number"==typeof this._minValue&&e<this._minValue||"number"==typeof this._maxValue&&e>this._maxValue||(this._lastValidValue=this._text.text,this._onChange&&this._onChange(this._text.text))}_sanitizeIncomingText(e,r){let s=!1,l=!1;return e=e.replaceAll(/[^0-9.-]/g,""),r&&(-1!=r.indexOf(".")&&(s=!0),-1!=r.indexOf("-")&&(l=!0)),s?e=e.replaceAll(".",""):-1!=e.indexOf(".")&&(e=e.split(".")[0]+"."+e.split(".").slice(1).join("")),l?e=e.replaceAll("-",""):-1!=e.indexOf("-")&&(e="-"+e.replaceAll("-","")),e}_sanitizeText(){this._text.text.indexOf("-")>0&&(this.value="-"+this._text.text.replaceAll("-",""))}insertContent(e){e=this._sanitizeIncomingText(e,this._text.text),super.insertContent(e)}get maxValue(){return this._maxValue}get minValue(){return this._minValue}get onEnter(){return this._onEnter}get value(){return super.value}set maxValue(e){this._maxValue=e}set minValue(e){this._minValue=e}set onEnter(e){this._onEnter=e}set value(e){null==e&&(e=Math.max(this._minValue,0)),e=this._sanitizeIncomingText(String(e)),super.value=e,this._lastValidValue=this._text.text}}const Ts={},ws=new e.MeshBasicMaterial({color:12543,side:e.DoubleSide,transparent:!0,polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:1});class Radio extends InteractableComponent{constructor(e,...r){super(...r),this._defaults.backgroundVisible=!0,this._defaults.borderMaterial.color.set(5197647),this._defaults.borderWidth=.002,this._defaults.height=.08,this._defaults.materialColor=16777215,this._defaults.width=.08,this._name=e,this._toggleMaterial=ws.clone(),this.onClick=this.onTouch=()=>this._select(),this.updateLayout(),e in Ts||(Ts[e]=new Set),Ts[e].add(this)}_createBackground(){this._defaults.borderRadius=Math.min(this.computedHeight,this.computedHeight)/2,super._createBackground(),this._toggleChild?.parent&&this._toggleChild.parent.remove(this._toggleChild),this._toggleChild=new e.Mesh(this._background.geometry,this._toggleMaterial),this._background.add(this._toggleChild),this._toggleChild.scale.set(.75,.75,.75),this._toggleChild.visible=!!this._selected,this.borderMaterial.color.set(this._selected?12543:5197647)}_updateMaterialOffset(e){super._updateMaterialOffset(e),this._toggleMaterial.polygonOffsetFactor=this._toggleMaterial.polygonOffsetUnits=-1*this._materialOffset-1,this._toggleChild&&(this._toggleChild.renderOrder=100+this._materialOffset+1)}_select(e){for(let e of Ts[this._name])e!=this&&e.unselect();this._selected=!0,this.borderMaterial.color.set(12543),this._toggleChild.visible=!0,e||(this._onChange&&this._onChange(this._selected),this._onSelect&&this._onSelect())}_unselect(e){this._selected=!1,this.borderMaterial.color.set(5197647),this._toggleChild.visible=!1,this._onChange&&!e&&this._onChange(this._selected)}select(){this._select()}unselect(){this._unselect()}get onChange(){return this._onChange}get onSelect(){return this._onSelect}get selected(){return this._selected}set onChange(e){this._onChange=e}set onSelect(e){this._onSelect=e}set selected(e){e!=this._selected&&(e?this._select(!0):this.unselect(!0))}}const Ss=new e.MeshBasicMaterial({color:12543,side:e.DoubleSide,transparent:!0,polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:1}),Cs=new e.Vector3,As=new e.Plane;class Range extends InteractableComponent{constructor(...e){super(...e),this._defaults.backgroundVisible=!0,this._defaults.borderMaterial.color.set(5197647),this._defaults.borderWidth=.002,this._defaults.height=.02,this._defaults.materialColor=16777215,this._defaults.width=.4,this._value=0,this._scrubberMaterial=Ss.clone(),this._scrubbingOwner,this.pointerInteractable.addEventListener("down",(e=>this.pointerInteractable.capture(e.owner))),this.onClick=e=>this._select(e),this.onTouch=e=>this._touchSelect(e),this.onDrag=e=>this._drag(e),this.onTouchDrag=e=>this._touchDrag(e),this.updateLayout()}_createBackground(){this._defaults.borderRadius=Math.min(this.computedHeight,this.computedWidth)/2,super._createBackground(),this._scrubberChild?.parent&&this._scrubberChild.parent.remove(this._scrubberChild),this._scrubberValue?.parent&&this._scrubberValue.parent.remove(this._scrubberValue);let r=new e.CircleGeometry(1.5*this.computedHeight);this._scrubberChild=new e.Mesh(r,this._scrubberMaterial),this._scrubberValue=new e.Mesh(this._background.geometry,this._scrubberMaterial),this._background.add(this._scrubberChild),this._background.add(this._scrubberValue),this._updateScrubber()}_updateScrubber(){this._scrubberChild.position.setX((this._value-.5)*this.width),this._scrubberValue.scale.setX(this._value),this._scrubberValue.position.setX(this.width*(this._value-1)/2)}_updateMaterialOffset(e){super._updateMaterialOffset(e),this._scrubberMaterial.polygonOffsetFactor=this._scrubberMaterial.polygonOffsetUnits=-1*this._materialOffset-1,this._scrubberChild&&(this._scrubberChild.renderOrder=100+this._materialOffset+1)}_select(e){let{owner:r,point:s}=e;this._scrubbingOwner==r&&(this._updateValue(r,s),this._scrubbingOwner=null,this._onBlur&&this._onBlur(this._value))}_touchSelect(e){this._scrubbingOwner==e.owner&&(this._scrubbingOwner=null,this._onBlur&&this._onBlur(this._value))}_drag(e){let{owner:r,point:s}=e;this._updateValue(r,s)&&this._onChange&&this._onChange(this._value)}_touchDrag(e){let r=e.owner;this._updateValueFromTouch(r)&&this._onChange&&this._onChange(this._value)}_updateValue(e,r){if(this._scrubbingOwner){if(this._scrubbingOwner!=e)return!1}else this._scrubbingOwner=e;if(r?r=Cs.copy(r):(As.set(Cs.set(0,0,1),0),As.applyMatrix4(this.matrixWorld),r=e.raycaster.ray.intersectPlane(As,Cs)),r){let e=(r=this.worldToLocal(r)).x/this.width+.5;e=Math.max(0,Math.min(e,1));let s=this._value!=e;return this._value=e,s&&this._updateScrubber(),s}return!1}_updateValueFromTouch(e){if(this._scrubbingOwner){if(this._scrubbingOwner!=e)return!1}else{this._scrubbingOwner=e;let r=this.touchInteractable.getClosestPointTo(e.object);this._touchController=r[1].object,this._scrollVertex=this._touchController.bvhGeometry.index.array[3*r[1].faceIndex]}let r=this._touchController.bvhGeometry.getAttribute("position");Cs.fromBufferAttribute(r,this._scrollVertex),this._touchController.localToWorld(Cs),this.worldToLocal(Cs);let s=Cs.x/this.width+.5;s=Math.max(0,Math.min(s,1));let l=this._value!=s;return this._value=s,l&&this._updateScrubber(),l}get onBlur(){return this._onBlur}get onChange(){return this._onChange}get value(){return this._value}set onBlur(e){this._onBlur=e}set onChange(e){this._onChange=e}set value(e){this._value=Math.max(0,Math.min(e,1)),this._updateScrubber()}}class Select extends ScrollableComponent{constructor(...e){super(...e),this._defaults.backgroundVisible=!0,this._defaults.borderMaterial.color.set(5197647),this._defaults.borderWidth=.002,this._defaults.height=.1,this._defaults.width=.4,this._optionsDivStyle=new Style({backgroundVisible:this.backgroundVisible,borderMaterial:this.borderMaterial.clone(),borderWidth:this.borderWidth,overflow:"scroll",paddingBottom:this.borderWidth,paddingTop:this.borderWidth,width:this.width}),this._optionsDiv=new Div(this._optionsDivStyle),this._optionsStyle=new Style({backgroundVisible:this.backgroundVisible,width:"90%"}),this._optionsTextStyle=new Style({maxWidth:"100%"}),this.padding&&(this._optionsTextStyle.padding=this.padding),this._value,this._options=[],this._textSpan=new Span({alignItems:"start",justifyContent:"spaceBetween",height:"100%",overflow:"hidden",width:"90%"}),this._text=new TextComponent(" ",this._optionsTextStyle,{maxWidth:"85%",minWidth:"85%"}),this._text._text.lineHeight=1/.55,this._caret=new TextComponent("⌄"),this._caret._text.anchorY="85%",this._content.add(this._textSpan),this._textSpan.add(this._text),this._textSpan.add(this._caret),this._downListener=e=>{let r=e.target;for(;r;){if(r==this)return;r=r.parent}this.hideOptions()},this.onClick=this.onTouch=()=>this._select(),this.updateLayout()}updateLayout(){super.updateLayout(),this._optionsStyle.minHeight!=this.computedHeight&&(this._optionsStyle.minHeight=this.computedHeight),this._optionsTextStyle.minWidth!=.9*this.unpaddedWidth&&(this._optionsTextStyle.minWidth=.9*this.unpaddedWidth),this._optionsTextStyle.fontSize!=.55*this.unpaddedHeight&&(this._optionsTextStyle.fontSize=.55*this.unpaddedHeight,this._caret.fontSize=.8*this.unpaddedHeight)}_handleStyleUpdateForWidth(){super._handleStyleUpdateForWidth(),this._optionsDivStyle.width=this.width}_select(){this.remove(this._textSpan),this.add(this._optionsDiv),this._optionsDiv._updateMaterialOffset(this._materialOffset+1),this.onClick=this.onTouch=null,zr.addEventListener("down",this._downListener)}_selectOption(e){let r=this._value!=e;this._value=e,this._text.text=e,this.hideOptions(),r&&this._onChange&&this._onChange(this._value)}addOptions(...e){for(let r of e){let e=new Span(this._optionsStyle),s=new TextComponent(r,this._optionsTextStyle);e.onClick=e.onTouch=()=>this._selectOption(s.text),e.add(s),e.pointerInteractable.addStateCallback((r=>{r==mr.HOVERED?e.material.color.set(30207):r==mr.IDLE&&e.material.color.set(16777215)})),this._optionsDiv.add(e)}}hideOptions(){this.remove(this._optionsDiv),this.add(this._textSpan),this.onClick=this.onTouch=()=>this._select(),zr.removeEventListener("down",this._downListener)}get maxDisplayOptions(){return this._maxDisplayOptions}get onChange(){return this._onChange}get value(){return this._value}set maxDisplayOptions(e){this._maxDisplayOptions=e,this._optionsDivStyle.maxHeight=null==e?null:100*this._maxDisplayOptions+"%"}set onChange(e){this._onChange=e}set value(e){this._value=e,this._text.text=e}}const Is=new e.MeshBasicMaterial({color:16777215,side:e.DoubleSide,transparent:!0,polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:1});class Toggle extends InteractableComponent{constructor(...e){super(...e),this._defaults.backgroundVisible=!0,this._defaults.color=16777215,this._defaults.height=.08,this._defaults.materialColor=13421772,this._defaults.width=.14,this._toggleMaterial=Is.clone(),this.onClick=this.onTouch=()=>this._change(),this.updateLayout()}_createBackground(){super._createBackground(),this._toggleChild?.parent&&this._toggleChild.parent.remove(this._toggleChild);let r=this.borderRadius||0,s=numberOr(this.borderTopLeftRadius,r),l=numberOr(this.borderTopRightRadius,r),h=numberOr(this.borderBottomLeftRadius,r),u=numberOr(this.borderBottomRightRadius,r),p=.24*this.computedHeight,m=this.computedHeight-p,_=(this.computedWidth-p)/2;this._toggleOffset=(this.computedWidth-_-p)/2,s=Math.max(s-p/2,0),l=Math.max(l-p/2,0),h=Math.max(h-p/2,0),u=Math.max(u-p/2,0);let v=100+this._materialOffset+1,x=Toggle.createShape(_,m,s,l,h,u),b=new e.ShapeGeometry(x);this._toggleChild=new e.Mesh(b,this._toggleMaterial),this._toggleChild.renderOrder=v,this._background.add(this._toggleChild),this._checked?this._toggleChild.position.setX(this._toggleOffset):this._toggleChild.position.setX(-this._toggleOffset)}_updateMaterialOffset(e){super._updateMaterialOffset(e),this._toggleMaterial.polygonOffsetFactor=this._toggleMaterial.polygonOffsetUnits=-1*this._materialOffset-1,this._toggleChild&&(this._toggleChild.renderOrder=100+this._materialOffset+1)}_change(){this._checked=!this._checked,this._checked?(this.material.color.set(12543),this._toggleChild.position.setX(this._toggleOffset)):(this.material.color.set(13421772),this._toggleChild.position.setX(-this._toggleOffset)),this._onChange&&this._onChange(this._checked)}get checked(){return this._checked}get onChange(){return this._onChange}set checked(e){e!=this._checked&&(this._checked=e,e?(this.material.color.set(12543),this._toggleChild.position.setX(this._toggleOffset)):(this.material.color.set(13421772),this._toggleChild.position.setX(-this._toggleOffset)))}set onChange(e){this._onChange=e}}const Es=new e.Vector3;class GripInteractable extends Interactable{constructor(e){super(e),e&&(e.gripInteractable=this),this._createBoundingObject()}_createBoundingObject(){this._boundingBox=new e.Box3}_getBoundingObject(){return this._boundingBox.setFromObject(this._object),this._boundingBox}intersectsSphere(e){let r,s=this._getBoundingObject();return r=!!s&&e.intersectsBox(s),r}distanceToSphere(e){return e.distanceToPoint(this._boundingBox.getCenter(Es))}}let ks=new class extends InteractableHandler{constructor(){super()}init(r){super.init(),this._scene=r,this._sphere=new e.Sphere,this._box3=new e.Box3}_getBoundingSphere(e){return e?(this._box3.setFromObject(e).getBoundingSphere(this._sphere),this._sphere):null}_isXRControllerPressed(e,r){if(e==xr.HAND){let s=Vr.getXRControllerModel(e,r);return 1==s?.motionController?.isGrabbing}{let e=Vr.getXRGamepad(r);return null!=e?.buttons&&e.buttons[1].pressed}}_scopeInteractables(e,r){let s=e.boundingSphere;if(null!=s)for(let l of r){if((0!=l.children.size&&this._scopeInteractables(e,l.children),null!=l.object&&!l.isOnlyGroup())&&l.intersectsSphere(s)){let r=l.distanceToSphere(s);r<e.closestPointDistance&&(e.closestPointDistance=r,e.closestInteractable=l)}}}_updateInteractables(e){let r=e.owner,s=e.isPressed,l=this._hoveredInteractables.get(r),h=this._selectedInteractables.get(r),u=this._overInteractables.get(r),p=e.closestInteractable;p!=l&&(l&&(l.removeHoveredBy(r),this._hoveredInteractables.delete(r)),!p||(h||s)&&p!=h||(p.addHoveredBy(r),this._hoveredInteractables.set(r,p),l=p));let m={owner:r};h?(s||(h.removeSelectedBy(r),this._selectedInteractables.delete(r)),h==p?(u!=p&&(u&&u.out(m),p.over(m),this._overInteractables.set(r,p)),p.move(m),p.drag(m),s||(this._trigger("up",m,p),p.click(m))):h.isCapturedBy(r)?(h!=u&&(u&&u.out(m),h.over(m),this._overInteractables.set(r,h),u=h),h.move(m),h.drag(m),s||(this._trigger("up",m,h),h.click(m),u&&u.out(m),p?(p.over(m),this._overInteractables.set(r,p)):this._overInteractables.delete(r))):p?(u!=p&&(u&&u.out(m),p.over(m),this._overInteractables.set(r,p)),p.move(m),s||this._trigger("up",m,p)):u&&(u.out(m),this._overInteractables.delete(r))):p?(u!=p&&(u&&u.out(m),p.over(m),this._overInteractables.set(r,p)),p.move(m),s&&!this._wasPressed.get(r)?(this._trigger("down",m,p),p.addSelectedBy(r),this._selectedInteractables.set(r,p)):!s&&this._wasPressed.get(r)&&this._trigger("up",m,p)):(u&&(u.out(m),this._overInteractables.delete(r)),s?this._wasPressed.get(r)||this._trigger("down",m):this._wasPressed.get(r)&&this._trigger("up",m)),this._wasPressed.set(r,s)}_updateForXR(){for(let e in vr){let r=!1;for(let s of[xr.CONTROLLER,xr.HAND]){let l=Vr.getXRController(s,e,"grip"),h=Vr.getXRControllerModel(s,e);if(!l)continue;let u,p,m=this._getOwner(l),_=isDescendant(this._scene,l);if(_&&(s==xr.CONTROLLER?r=!0:r&&(_=!1)),_){u=isDescendant(l,h)?this._getBoundingSphere(h):this._getBoundingSphere(l),p=this._isXRControllerPressed(s,e)}let v={owner:m,boundingSphere:u,isPressed:p,closestPointDistance:Number.MAX_SAFE_INTEGER},x=!1;this._toolHandlers[this._tool]&&(x=this._toolHandlers[this._tool](v)),x||(this._scopeInteractables(v,this._interactables),this._updateInteractables(v))}}}};const{computeBoundsTree:Rs,disposeBoundsTree:Ms,acceleratedRaycast:Bs}=hr;e.BufferGeometry.prototype.computeBoundsTree=Rs,e.BufferGeometry.prototype.disposeBoundsTree=Ms,e.Mesh.prototype.raycast=Bs;const Ls="0.0.1",addGripInteractable=e=>{ks.addInteractable(e)},removeGripInteractable=e=>{ks.removeInteractable(e)},addPointerInteractable=e=>{zr.addInteractable(e)},removePointerInteractable=e=>{zr.removeInteractable(e)},addTouchInteractable=e=>{qr.addInteractable(e)},removeTouchInteractable=e=>{qr.removeInteractable(e)};const init=async(e,r,s,l,h,u)=>{h||(await async function(){if(navigator.userAgent){let e=navigator.userAgent.toLowerCase();if(e.indexOf("iphone")>=0||e.indexOf("ipad")>=0)return!1}return"xr"in navigator&&(await navigator.xr.isSessionSupported("immersive-vr")||await navigator.xr.isSessionSupported("immersive-ar"))}()?(h="XR",r.xr.enabled||(r.xr.enabled=!0)):h="ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0?"TOUCH_SCREEN":"POINTER"),yr.active=h,r.localClippingEnabled=!0,Vr.init(e,r),zr.init(r,s,l,u),ks.init(s),qr.init(s),"XR"!=h&&hs.setup()},update=e=>{"XR"==yr.active&&(Vr.update(e),ks.update(),qr.update()),zr.update(),dr.update()};export{Body,Checkbox,hs as DelayedClickHandler,yr as DeviceTypes,Div,GripInteractable,ks as GripInteractableHandler,HSLColor,vr as Handedness,qi as Image,Vr as InputHandler,Interactable,mr as InteractableStates,gr as InteractionToolHandler,ls as Keyboard,NumberInput,PointerInteractable,zr as PointerInteractableHandler,Radio,Range,Select,Span,Style,TextComponent as Text,TextArea,TextInput,hr as ThreeMeshBVH,Toggle,TouchInteractable,qr as TouchInteractableHandler,zi as TroikaThreeText,dr as UpdateHandler,xr as XRInputDeviceTypes,addGripInteractable,addPointerInteractable,addTouchInteractable,init,removeGripInteractable,removePointerInteractable,removeTouchInteractable,update,cr as utils,Ls as version};
